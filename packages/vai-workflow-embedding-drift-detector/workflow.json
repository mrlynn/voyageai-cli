{
  "name": "embedding-drift-detector",
  "description": "Re-embed a sample of documents and compare against stored embeddings to detect drift from model changes or configuration issues.",
  "version": "1.0.0",
  "inputs": {
    "collection": {
      "type": "string",
      "required": true
    },
    "sample_query": {
      "type": "string",
      "default": "general knowledge"
    },
    "model": {
      "type": "string",
      "default": "voyage-4-large"
    },
    "sample_size": {
      "type": "number",
      "default": 10
    }
  },
  "defaults": {},
  "steps": [
    {
      "id": "sample_docs",
      "tool": "search",
      "name": "Sample documents from collection",
      "inputs": {
        "query": "{{ inputs.sample_query }}",
        "collection": "{{ inputs.collection }}",
        "limit": "{{ inputs.sample_size }}"
      }
    },
    {
      "id": "re_embed",
      "tool": "embed",
      "name": "Generate fresh embeddings for sampled documents",
      "inputs": {
        "texts": "{{ sample_docs.output.results }}",
        "model": "{{ inputs.model }}",
        "inputType": "document"
      }
    },
    {
      "id": "compare",
      "tool": "similarity",
      "name": "Compare stored vs fresh embeddings",
      "inputs": {
        "text1": "{{ sample_docs.output.results }}",
        "text2": "{{ re_embed.output.embeddings }}"
      }
    },
    {
      "id": "report",
      "tool": "generate",
      "name": "Generate drift analysis report",
      "inputs": {
        "prompt": "Analyze the following embedding drift results. For each document, a similarity score of 1.0 means no drift (identical embeddings), and lower scores indicate drift. Provide:\n1. Overall drift assessment (healthy, warning, critical)\n2. Documents with the most drift\n3. Possible causes\n4. Recommended actions\n\nCollection: {{ inputs.collection }}\nModel: {{ inputs.model }}\nSample size: {{ inputs.sample_size }}",
        "context": "{{ compare.output }}"
      }
    }
  ],
  "output": {
    "report": "{{ report.output.response }}",
    "drift_scores": "{{ compare.output }}",
    "sample_count": "{{ inputs.sample_size }}"
  }
}
