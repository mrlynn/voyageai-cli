{
  "name": "query-quality-scorer",
  "description": "Evaluate retrieval quality for a query by measuring semantic similarity between the query and its top results. Provides a quality score and recommendations without requiring labeled ground truth.",
  "version": "1.0.0",
  "inputs": {
    "query": {
      "type": "string",
      "required": true
    },
    "collection": {
      "type": "string",
      "required": true
    },
    "limit": {
      "type": "number",
      "default": 10
    }
  },
  "defaults": {},
  "steps": [
    {
      "id": "retrieve",
      "tool": "query",
      "name": "Run full retrieval pipeline",
      "inputs": {
        "query": "{{ inputs.query }}",
        "collection": "{{ inputs.collection }}",
        "limit": "{{ inputs.limit }}"
      }
    },
    {
      "id": "score_relevance",
      "tool": "similarity",
      "name": "Score query-result similarity for each result",
      "inputs": {
        "text1": "{{ inputs.query }}",
        "text2": "{{ retrieve.output.results }}"
      }
    },
    {
      "id": "format_results",
      "tool": "transform",
      "name": "Format results with scores for analysis",
      "inputs": {
        "data": "{{ retrieve.output.results }}",
        "pick": [
          "text",
          "score",
          "metadata"
        ]
      }
    },
    {
      "id": "quality_report",
      "tool": "generate",
      "name": "Generate quality assessment report",
      "inputs": {
        "prompt": "Analyze the following retrieval quality results for the query. The similarity scores show how semantically close each retrieved document is to the original query.\n\nProvide:\n1. Overall quality grade (A/B/C/D/F) based on the score distribution\n2. Whether the results are topically coherent or scattered\n3. Whether the top results are significantly better than the bottom results (good reranking signal)\n4. Specific recommendations for improving retrieval quality (e.g., better chunking, different model, more documents)\n\nQuery: {{ inputs.query }}\nCollection: {{ inputs.collection }}",
        "context": {
          "retrieval_results": "{{ format_results.output.results }}",
          "similarity_scores": "{{ score_relevance.output }}"
        }
      }
    }
  ],
  "output": {
    "grade": "{{ quality_report.output.response }}",
    "similarity_scores": "{{ score_relevance.output }}",
    "top_results": "{{ format_results.output.results }}"
  }
}
