{
  "name": "batch-quality-gate",
  "description": "Evaluate incoming documents against exemplar documents from the collection and only ingest those that meet a quality/relevance threshold.",
  "version": "1.0.0",
  "inputs": {
    "document": {
      "type": "string",
      "required": true
    },
    "collection": {
      "type": "string",
      "required": true
    },
    "exemplar_query": {
      "type": "string",
      "default": "high quality relevant content"
    },
    "quality_threshold": {
      "type": "number",
      "default": 0.6
    }
  },
  "defaults": {},
  "steps": [
    {
      "id": "get_exemplars",
      "tool": "search",
      "name": "Retrieve exemplar documents from collection",
      "inputs": {
        "query": "{{ inputs.exemplar_query }}",
        "collection": "{{ inputs.collection }}",
        "limit": 5
      }
    },
    {
      "id": "score_quality",
      "tool": "similarity",
      "name": "Score incoming document against exemplars",
      "inputs": {
        "text1": "{{ inputs.document }}",
        "text2": "{{ get_exemplars.output.results[0].text }}"
      }
    },
    {
      "id": "ingest_if_quality",
      "tool": "ingest",
      "name": "Ingest document if quality meets threshold",
      "condition": "{{ score_quality.output.similarity >= inputs.quality_threshold }}",
      "inputs": {
        "text": "{{ inputs.document }}",
        "collection": "{{ inputs.collection }}"
      }
    },
    {
      "id": "rejection_report",
      "tool": "generate",
      "name": "Generate rejection explanation",
      "condition": "{{ score_quality.output.similarity < inputs.quality_threshold }}",
      "inputs": {
        "prompt": "The following document was rejected from ingestion into the {{ inputs.collection }} collection because its quality/relevance score ({{ score_quality.output.similarity }}) fell below the threshold ({{ inputs.quality_threshold }}). Briefly explain why the document may not be a good fit and suggest improvements.",
        "context": {
          "rejected_document": "{{ inputs.document }}",
          "exemplar_snippet": "{{ get_exemplars.output.results[0].text }}"
        }
      }
    }
  ],
  "output": {
    "action": "{{ ingest_if_quality.output ? 'ingested' : 'rejected' }}",
    "quality_score": "{{ score_quality.output.similarity }}",
    "details": "{{ ingest_if_quality.output || rejection_report.output.response }}"
  }
}
