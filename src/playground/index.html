<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voyage AI Playground</title>
<link rel="icon" type="image/png" sizes="32x32" href="/icons/dark/32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/dark/16.png">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* MongoDB Design System — Dark Mode Palette (default) */
  --bg: #001E2B;            /* MDB Black */
  --bg-surface: #112733;    /* Gray Dark 4 */
  --bg-card: #1C2D38;       /* Gray Dark 3 */
  --bg-input: #112733;      /* Gray Dark 4 */
  --accent: #00ED64;        /* Green Base — interactive elements only */
  --accent-text: #FFFFFF;   /* Bright white — headings/labels in dark mode */
  --accent-dim: #00A35C;    /* Green Dark 1 */
  --accent-glow: rgba(0, 237, 100, 0.12);
  --text: #E8EDEB;          /* Gray Light 2 */
  --text-dim: #C1C7C6;      /* Gray Light 1 */
  --text-muted: #889397;    /* Gray Base */
  --border: #3D4F58;        /* Gray Dark 2 */
  --error: #FF6960;         /* Red Light 1 */
  --warning: #FFC010;       /* Yellow Base */
  --success: #00ED64;       /* Green Base */
  --red: #FF6960;           /* Red Light 1 */
  --yellow: #FFC010;        /* Yellow Base */
  --green: #00ED64;         /* Green Base */
  --blue: #0498EC;          /* Blue Light 1 (links) */
  --purple: #B45AF2;        /* Purple Base */
  --green-dark: #023430;    /* Green Dark 3 */
  --radius: 8px;
  --font: 'Euclid Circular A', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  --mono: 'Source Code Pro', 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
}

/* MongoDB Design System — Light Mode Palette */
[data-theme="light"] {
  --bg: #FFFFFF;             /* White */
  --bg-surface: #F9FBFA;    /* Gray Light 3 */
  --bg-card: #FFFFFF;        /* White */
  --bg-input: #F9FBFA;      /* Gray Light 3 */
  --accent: #00A35C;         /* Green Dark 1 — interactive elements */
  --accent-text: #001E2B;   /* MDB Black — headings/labels in light mode */
  --accent-dim: #00684A;     /* Green Dark 2 */
  --accent-glow: rgba(0, 163, 92, 0.08);
  --text: #001E2B;           /* MDB Black */
  --text-dim: #5C6C75;       /* Gray Dark 1 */
  --text-muted: #889397;     /* Gray Base */
  --border: #E8EDEB;         /* Gray Light 2 */
  --error: #DB3030;          /* Red Base */
  --warning: #944F01;        /* Yellow Dark 2 */
  --success: #00684A;        /* Green Dark 2 */
  --red: #DB3030;            /* Red Base */
  --yellow: #944F01;         /* Yellow Dark 2 */
  --green: #00684A;          /* Green Dark 2 */
  --blue: #016BF8;           /* Blue Base */
  --purple: #5E0C9E;         /* Purple Dark 2 */
  --green-dark: #023430;     /* Green Dark 3 */
}
/* Light mode shadow + card adjustments */
[data-theme="light"] .explore-card,
[data-theme="light"] .card,
[data-theme="light"] .cost-strategy,
[data-theme="light"] .cost-summary-card {
  box-shadow: 0 1px 4px rgba(0, 30, 43, 0.08);
}
[data-theme="light"] .explore-card:hover {
  box-shadow: 0 4px 16px rgba(0, 163, 92, 0.12);
}
[data-theme="light"] .cost-modal,
[data-theme="light"] .explore-modal {
  box-shadow: 0 20px 60px rgba(0, 30, 43, 0.2);
}
[data-theme="light"] .cost-modal-overlay,
[data-theme="light"] .explore-modal-overlay {
  background: rgba(0, 30, 43, 0.4);
}
[data-theme="light"] .sidebar {
  box-shadow: 1px 0 3px rgba(0, 30, 43, 0.06);
}
/* Light mode gradient overrides */
[data-theme="light"] .quant-bar-fill.storage { background: linear-gradient(90deg, #00A35C, #00ED64); }
[data-theme="light"] .quant-bar-fill.latency { background: linear-gradient(90deg, #016BF8, #0498EC); }
[data-theme="light"] .quant-meter-fill.perfect { background: linear-gradient(90deg, #00A35C, #00ED64); }
[data-theme="light"] .quant-meter-fill.good { background: linear-gradient(90deg, #944F01, #FFC010); }
[data-theme="light"] .quant-meter-fill.degraded { background: linear-gradient(90deg, #DB3030, #FF6960); }
/* Light mode button text */
[data-theme="light"] .btn { color: #FFFFFF; }
[data-theme="light"] .btn:hover { background: #00684A; }

html, body { height: 100%; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
}

/* ── Update banner ── */
.update-banner {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 8px 16px;
  background: linear-gradient(135deg, rgba(0,163,92,0.12), rgba(4,152,236,0.12));
  border-bottom: 1px solid rgba(0,237,100,0.2);
  font-size: 13px;
  color: var(--text);
  flex-shrink: 0;
}
.update-banner.show { display: flex; }
.update-banner-icon { font-size: 16px; }
.update-banner-text { flex: 1; }
.update-banner-text strong { color: var(--accent); }
.update-banner-btn {
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: var(--font);
  transition: opacity 0.15s;
}
.update-banner-btn:hover { opacity: 0.85; }
.update-banner-dismiss {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 0 4px;
}
.update-banner-dismiss:hover { color: var(--text); }
.update-progress { display: flex; align-items: center; gap: 8px; flex: 1; }
.update-progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; }
[data-theme="light"] .update-progress-bar { background: rgba(0,0,0,0.1); }
.update-progress-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s ease; width: 0%; }
.update-progress-label { font-size: 12px; font-family: var(--mono); color: var(--accent); min-width: 40px; text-align: right; }

/* ── Onboarding Walkthrough ── */
.onboarding-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 10000;
}
.onboarding-overlay.active { display: block; }
.onboarding-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  transition: opacity 0.3s;
}
.onboarding-spotlight {
  position: absolute;
  border-radius: var(--radius);
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  z-index: 10001;
  pointer-events: none;
}
.onboarding-tooltip {
  position: absolute;
  z-index: 10002;
  background: var(--bg-card);
  border: 1px solid var(--accent);
  border-radius: 12px;
  padding: 24px 28px 20px;
  width: 380px;
  max-width: 90vw;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,237,100,0.15);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  opacity: 0;
  transform: translateY(10px);
}
.onboarding-tooltip.visible {
  opacity: 1;
  transform: translateY(0);
}
.onboarding-tooltip-arrow {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--bg-card);
  border: 1px solid var(--accent);
  transform: rotate(45deg);
}
.onboarding-tooltip-arrow.top {
  top: -7px;
  left: 30px;
  border-right: none;
  border-bottom: none;
}
.onboarding-tooltip-arrow.bottom {
  bottom: -7px;
  left: 30px;
  border-left: none;
  border-top: none;
}
.onboarding-tooltip-arrow.left {
  left: -7px;
  top: 24px;
  border-right: none;
  border-top: none;
}
.onboarding-step-icon {
  font-size: 28px;
  margin-bottom: 8px;
}
.onboarding-step-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent-text);
  margin-bottom: 6px;
}
.onboarding-step-body {
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.6;
  margin-bottom: 18px;
}
.onboarding-step-body strong { color: var(--accent); }
.onboarding-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.onboarding-dots {
  display: flex;
  gap: 6px;
}
.onboarding-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: background 0.2s;
}
.onboarding-dot.active { background: var(--accent); }
.onboarding-dot.completed { background: var(--accent-dim); }
.onboarding-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}
.onboarding-skip {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 12px;
  cursor: pointer;
  font-family: var(--font);
  padding: 6px 10px;
  border-radius: 6px;
  transition: color 0.15s;
}
.onboarding-skip:hover { color: var(--text); }
.onboarding-next {
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 6px;
  padding: 8px 20px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: var(--font);
  transition: opacity 0.15s;
}
.onboarding-next:hover { opacity: 0.85; }
.onboarding-welcome-center {
  position: fixed;
  inset: 0;
  z-index: 10002;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}
.onboarding-welcome-card {
  background: var(--bg-card);
  border: 1px solid var(--accent);
  border-radius: 16px;
  padding: 40px 44px 32px;
  width: 460px;
  max-width: 90vw;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 80px rgba(0,237,100,0.08);
  pointer-events: auto;
  opacity: 0;
  transform: scale(0.95);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
}
.onboarding-welcome-card.visible {
  opacity: 1;
  transform: scale(1);
}
.onboarding-welcome-logo {
  width: 64px;
  height: 64px;
  margin-bottom: 16px;
}
.onboarding-welcome-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent-text);
  margin-bottom: 8px;
}
.onboarding-welcome-sub {
  font-size: 14px;
  color: var(--text-dim);
  line-height: 1.6;
  margin-bottom: 28px;
}
[data-theme="light"] .onboarding-tooltip {
  box-shadow: 0 12px 40px rgba(0,30,43,0.15), 0 0 0 1px rgba(0,163,92,0.2);
}
[data-theme="light"] .onboarding-welcome-card {
  box-shadow: 0 20px 60px rgba(0,30,43,0.18), 0 0 80px rgba(0,163,92,0.06);
}
[data-theme="light"] .onboarding-backdrop {
  background: rgba(0,30,43,0.45);
}

/* ── App Shell: sidebar + content layout ── */
.app-shell {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ── Sidebar ── */
.sidebar {
  width: 220px;
  min-width: 220px;
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 100;
}

.sidebar-drag-region {
  -webkit-app-region: drag;
  height: 78px;
  min-height: 78px;
  padding: 0 16px;
  padding-top: 52px; /* Clear macOS traffic lights fully */
  display: flex;
  align-items: center;
  gap: 10px;
}
body:not(.is-electron) .sidebar-drag-region {
  height: auto;
  min-height: auto;
  padding-top: 16px;
  padding-bottom: 12px;
}

.sidebar-logo {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  flex-shrink: 0;
  object-fit: contain;
}

.sidebar-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--accent-text);
  white-space: nowrap;
  letter-spacing: -0.2px;
  flex: 1;
}

.sidebar-settings-btn {
  -webkit-app-region: no-drag;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-muted);
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  flex-shrink: 0;
}
.sidebar-settings-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }
.sidebar-settings-btn.active { color: var(--accent); }
[data-theme="light"] .sidebar-settings-btn:hover { background: rgba(0,0,0,0.04); }

.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 1px;
}

.sidebar-nav-group {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.sidebar-nav-divider {
  height: 1px;
  background: var(--border);
  margin: 8px 12px;
  opacity: 0.5;
}
.sidebar-nav-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  padding: 10px 12px 4px;
}

.tab-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background: none;
  border: none;
  border-left: 3px solid transparent;
  border-radius: 0 6px 6px 0;
  color: var(--text-dim);
  padding: 10px 12px;
  font-size: 13px;
  font-weight: 500;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  text-align: left;
  position: relative;
}
.tab-btn:hover {
  color: var(--text);
  background: rgba(255,255,255,0.05);
}
.tab-btn:hover .tab-btn-icon {
  transform: scale(1.1);
}
.tab-btn.active {
  color: var(--accent);
  background: var(--accent-glow);
  border-left-color: var(--accent);
  font-weight: 600;
}
.tab-btn-icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  transition: transform 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.tab-btn-icon svg {
  width: 16px;
  height: 16px;
}
[data-theme="light"] .tab-btn:hover { background: rgba(0,30,43,0.04); }
[data-theme="light"] .tab-btn.active { background: rgba(0,163,92,0.08); }

.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sidebar-model-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.sidebar-model-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}
.nav-model-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 10px;
  border-radius: var(--radius);
  font-size: 12px;
  font-family: var(--mono);
  cursor: pointer;
  width: 100%;
}

.sidebar-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.theme-toggle {
  background: none;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.theme-toggle:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--text-muted);
  transition: background 0.3s;
}
.status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--accent-glow); }
.status-dot.error { background: var(--error); }

.status-label {
  font-size: 11px;
  color: var(--text-dim);
}

/* ── Content area ── */
.content-area {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.content-drag-region {
  -webkit-app-region: drag;
  height: 38px;
  min-height: 38px;
  flex-shrink: 0;
}

/* Web mode: hide Electron-only elements */
body:not(.is-electron) .content-drag-region { display: none; }
body:not(.is-electron) .update-banner { display: none !important; }

/* Main */
.main { padding: 24px; max-width: 1200px; margin: 0 auto; width: 100%; }

/* Legacy compat — hide old horizontal bar (replaced by sidebar) */
.nav { display: none; }
.tab-bar-horizontal { display: none; }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Shared Components */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--accent-text);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

textarea, input[type="text"], input[type="number"] {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 10px 14px;
  border-radius: var(--radius);
  font-family: var(--mono);
  font-size: 13px;
  resize: vertical;
  transition: border-color 0.2s;
}
textarea:focus, input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--font);
  cursor: pointer;
}
select:focus { outline: none; border-color: var(--accent); }

.btn {
  background: var(--accent);
  color: var(--green-dark);
  border: none;
  padding: 10px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.btn:hover { background: #71F6BA; transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-secondary {
  background: transparent;
  color: var(--accent);
  border: 1px solid var(--accent-dim);
}
.btn-secondary:hover { background: var(--accent-glow); }

.btn-small {
  padding: 6px 14px;
  font-size: 12px;
}

/* Subtabs - segmented control style */
.subtabs {
  display: flex;
  background: var(--card);
  border-radius: var(--radius);
  padding: 4px;
  gap: 4px;
  margin-bottom: 20px;
  border: 1px solid var(--accent-dim);
}
.subtab {
  flex: 1;
  background: transparent;
  color: var(--text-secondary);
  border: none;
  padding: 10px 20px;
  border-radius: calc(var(--radius) - 2px);
  font-size: 14px;
  font-weight: 500;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.subtab:hover {
  color: var(--text);
  background: rgba(0, 237, 100, 0.05);
}
.subtab.active {
  background: var(--accent);
  color: var(--green-dark);
  font-weight: 600;
}
.subtab svg {
  width: 16px;
  height: 16px;
}
[data-theme="light"] .subtab.active { color: #FFFFFF; }

.options-row {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  margin: 12px 0;
}

.option-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.option-label {
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.error-msg {
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  color: var(--error);
  padding: 10px 14px;
  border-radius: var(--radius);
  font-size: 13px;
  margin-top: 12px;
  display: none;
}
.error-msg.visible { display: block; }

.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.result-section {
  margin-top: 16px;
  display: none;
}
.result-section.visible { display: block; }

.stat {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg-input);
  padding: 6px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  margin-right: 8px;
  margin-bottom: 8px;
}
.stat-label { color: var(--text-dim); }
.stat-value { color: var(--accent-text); font-weight: 600; font-family: var(--mono); }

.vector-preview {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  background: var(--bg-input);
  padding: 12px;
  border-radius: var(--radius);
  overflow-x: auto;
  white-space: nowrap;
  margin-top: 8px;
}

.heatmap {
  height: 24px;
  border-radius: 4px;
  margin-top: 8px;
  overflow: hidden;
  display: flex;
}
.heatmap-bar {
  flex: 1;
  min-width: 1px;
}

/* Compare tab */
.compare-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.similarity-display {
  text-align: center;
  padding: 32px 0;
}
.similarity-score {
  font-size: 72px;
  font-weight: 800;
  font-family: var(--mono);
  line-height: 1;
}
.similarity-label {
  font-size: 14px;
  color: var(--text-dim);
  margin-top: 8px;
}
.similarity-bar-outer {
  width: 100%;
  max-width: 400px;
  height: 8px;
  background: var(--bg-input);
  border-radius: 4px;
  margin: 16px auto 0;
  overflow: hidden;
}
.similarity-bar-inner {
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s ease, background 0.6s ease;
}
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 24px;
}
.metric-card {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px 16px;
  text-align: center;
  transition: border-color 0.2s;
}
.metric-card.primary {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.metric-card-value {
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
}
.metric-card-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-top: 10px;
}
.metric-card-desc {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  line-height: 1.4;
}
.metric-bar {
  width: 100%;
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  margin-top: 12px;
  overflow: hidden;
}
.metric-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease, background 0.6s ease;
}
.metric-note {
  text-align: center;
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 16px;
  padding: 10px 16px;
  background: var(--bg-input);
  border-radius: 8px;
  line-height: 1.6;
}

/* Search tab */
.search-results {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.search-results.single-col {
  grid-template-columns: 1fr;
}

.result-item {
  display: flex;
  gap: 12px;
  padding: 12px;
  background: var(--bg-input);
  border-radius: var(--radius);
  margin-bottom: 8px;
  border-left: 3px solid var(--border);
  transition: border-color 0.3s;
}
.result-item.moved-up { border-left-color: var(--green); }
.result-item.moved-down { border-left-color: var(--red); }

.result-rank {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-text);
  font-family: var(--mono);
  min-width: 30px;
}
.result-body { flex: 1; min-width: 0; }
.result-text {
  font-size: 13px;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.result-score-bar {
  height: 4px;
  background: var(--bg-surface);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.result-score-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--accent);
}
.result-score-text {
  font-size: 11px;
  font-family: var(--mono);
  color: var(--text-dim);
  margin-top: 4px;
}
.result-movement {
  font-size: 11px;
  font-family: var(--mono);
  margin-top: 2px;
}

/* Explore tab */
.explore-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 16px;
}

.explore-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
}
.explore-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 237, 100, 0.1);
}
.explore-card.expanded {
  border-color: var(--accent);
}

.explore-card-icon {
  font-size: 28px;
  margin-bottom: 8px;
}
.explore-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}
.explore-card-summary {
  font-size: 13px;
  color: var(--text-dim);
}
.explore-card-content {
  display: none;
}
.explore-card-actions {
  display: none;
}

/* Explore modal */
.explore-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
.explore-modal-overlay.open {
  opacity: 1;
  pointer-events: auto;
}
.explore-modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  max-width: 720px;
  width: 92%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
  animation: exploreModalIn 0.2s ease-out;
}
@keyframes exploreModalIn {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.explore-modal::-webkit-scrollbar { width: 6px; }
.explore-modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.explore-modal-header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 24px 28px 16px;
  border-bottom: 1px solid var(--border);
}
.explore-modal-icon { font-size: 32px; }
.explore-modal-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}
.explore-modal-summary {
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 2px;
}
.explore-modal-close {
  position: absolute;
  top: 16px; right: 18px;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.15s;
  z-index: 1;
}
.explore-modal-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
.explore-modal-body {
  padding: 20px 28px 24px;
  font-size: 14px;
  line-height: 1.75;
  color: var(--text);
  white-space: pre-wrap;
}
.explore-modal-links {
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}
.explore-modal-links-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}
.explore-modal-links a {
  display: block;
  color: var(--blue);
  font-size: 12px;
  word-break: break-all;
  margin-bottom: 4px;
  text-decoration: none;
}
.explore-modal-links a:hover { text-decoration: underline; }
.explore-modal-tryit {
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}
.explore-modal-tryit-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.explore-modal-tryit-cmd {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  background: var(--bg);
  padding: 6px 10px;
  border-radius: 5px;
  margin-bottom: 4px;
}
.explore-modal-actions {
  display: flex;
  gap: 8px;
  padding: 0 28px 24px;
}

/* Benchmark tab */
.bench-panels { display: flex; gap: 8px; margin-bottom: 16px; }
.bench-panel-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 8px 18px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
}
.bench-panel-btn:hover { color: var(--text); border-color: var(--text-dim); }
.bench-panel-btn.active { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }

.bench-view { display: none; }
.bench-view.active { display: block; }

.latency-chart { margin-top: 16px; }
.latency-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.latency-model {
  font-family: var(--mono);
  font-size: 13px;
  min-width: 170px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.latency-bar-outer {
  flex: 1;
  height: 28px;
  background: var(--bg-input);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.latency-bar-inner {
  height: 100%;
  border-radius: 4px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  display: flex;
  align-items: center;
  padding: 0 10px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--green-dark);
  font-weight: 600;
  white-space: nowrap;
}
.latency-bar-inner.running {
  background: var(--border) !important;
  width: 100% !important;
  animation: pulse-bar 1.2s ease-in-out infinite;
}
@keyframes pulse-bar {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}
.latency-stats {
  min-width: 90px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  text-align: right;
}
.latency-badge {
  font-size: 14px;
  min-width: 20px;
  text-align: center;
}

/* Ranking diff */
.rank-comparison { margin-top: 16px; }
.rank-row {
  display: grid;
  grid-template-columns: 30px 1fr 40px 1fr;
  gap: 8px;
  align-items: start;
  margin-bottom: 8px;
  padding: 8px;
  background: var(--bg-input);
  border-radius: var(--radius);
}
.rank-num {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent-text);
  font-family: var(--mono);
  text-align: center;
}
.rank-item {
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 4px;
  border-left: 3px solid var(--border);
}
.rank-item .rank-score {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 2px;
}
.rank-match { border-left-color: var(--green); }
.rank-differ { border-left-color: var(--yellow); }
.rank-arrow { text-align: center; color: var(--text-muted); font-size: 18px; padding-top: 4px; }

/* Quantization charts */
.quant-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 768px) { .quant-charts { grid-template-columns: 1fr; } }

.quant-bar-group { margin-bottom: 14px; }
.quant-bar-label {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 4px; font-size: 13px;
}
.quant-bar-label .dtype-name { color: var(--accent-text); font-weight: 600; font-family: var(--mono); }
.quant-bar-label .dtype-value { color: var(--text-dim); font-family: var(--mono); font-size: 12px; }
.quant-bar-track {
  height: 32px; background: var(--bg-input); border-radius: 6px;
  overflow: hidden; position: relative;
}
.quant-bar-fill {
  height: 100%; border-radius: 6px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  display: flex; align-items: center; padding: 0 10px;
  font-family: var(--mono); font-size: 12px; font-weight: 600;
  color: var(--green-dark); white-space: nowrap; min-width: fit-content;
}
.quant-bar-fill.storage { background: linear-gradient(90deg, #00ED64, #71F6BA); }
.quant-bar-fill.latency { background: linear-gradient(90deg, #0498EC, #016BF8); }
.quant-bar-badge {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  font-size: 12px; color: var(--text-dim); font-family: var(--mono);
}

.quant-quality-meter { margin-bottom: 14px; }
.quant-meter-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 6px;
}
.quant-meter-header .dtype-name { color: var(--accent-text); font-weight: 600; font-family: var(--mono); font-size: 13px; }
.quant-meter-header .verdict-badge {
  font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
}
.quant-meter-header .verdict-badge.perfect { background: rgba(0,212,170,0.15); color: var(--green); }
.quant-meter-header .verdict-badge.good { background: rgba(255,217,61,0.15); color: var(--yellow); }
.quant-meter-header .verdict-badge.degraded { background: rgba(255,107,107,0.15); color: var(--red); }
.quant-meter-track {
  height: 10px; background: var(--bg-input); border-radius: 5px; overflow: hidden;
}
.quant-meter-fill {
  height: 100%; border-radius: 5px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
}
.quant-meter-fill.perfect { background: linear-gradient(90deg, #00ED64, #71F6BA); }
.quant-meter-fill.good { background: linear-gradient(90deg, #FFC010, #FFEC9E); }
.quant-meter-fill.degraded { background: linear-gradient(90deg, #FF6960, #FFCDC7); }
.quant-meter-detail { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-family: var(--mono); }

.quant-rank-cols {
  display: grid; gap: 12px;
}
.quant-rank-col-header {
  font-weight: 600; color: var(--accent-text); font-size: 13px; font-family: var(--mono);
  margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
}
.quant-rank-item {
  padding: 8px 10px; margin-bottom: 4px; border-radius: 6px;
  font-size: 12px; position: relative; border-left: 3px solid transparent;
  transition: background 0.2s;
}
.quant-rank-item:hover { background: rgba(255,255,255,0.03); }
.quant-rank-item.match { border-left-color: var(--green); background: rgba(0,212,170,0.06); }
.quant-rank-item.differ { border-left-color: var(--red); background: rgba(255,107,107,0.06); }
.quant-rank-item.baseline { border-left-color: var(--border); background: var(--bg-input); }
.quant-rank-pos {
  display: inline-block; width: 22px; height: 22px; line-height: 22px;
  text-align: center; border-radius: 50%; background: var(--bg-surface);
  color: var(--accent-text); font-weight: 700; font-size: 11px; font-family: var(--mono);
  margin-right: 8px;
}
.quant-rank-score { color: var(--text-muted); font-size: 11px; font-family: var(--mono); margin-top: 3px; }

/* Cost calculator */
.cost-controls {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px 32px;
  margin-bottom: 20px;
}
.cost-controls-full { grid-column: 1 / -1; }
.cost-slider-row {
  display: flex;
  align-items: center;
  gap: 12px;
}
.cost-slider-label {
  font-size: 12px;
  color: var(--text-dim);
  min-width: 110px;
}
.cost-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  background: var(--bg-input);
  border-radius: 3px;
  outline: none;
}
.cost-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  box-shadow: 0 0 8px var(--accent-glow);
}
.cost-slider-value {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--accent-text);
  min-width: 70px;
  text-align: right;
  font-weight: 600;
}
.cost-mode-toggle {
  display: flex;
  gap: 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  width: fit-content;
}
.cost-mode-btn {
  padding: 8px 20px;
  background: transparent;
  border: none;
  color: var(--text-dim);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: var(--mono);
}
.cost-mode-btn.active {
  background: var(--accent);
  color: var(--bg);
  font-weight: 600;
}
.cost-mode-btn:hover:not(.active) {
  background: rgba(0, 237, 100, 0.1);
  color: var(--text);
}
.cost-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  padding: 6px 10px;
  min-width: 160px;
}
.cost-select:focus { border-color: var(--accent); outline: none; }
.cost-model-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.cost-model-label {
  font-size: 12px;
  color: var(--text-dim);
  min-width: 110px;
}
.cost-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.cost-summary-card {
  background: var(--bg-input);
  border-radius: 8px;
  padding: 14px 16px;
  border: 1px solid var(--border);
}
.cost-summary-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.cost-summary-value {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-text);
}
.cost-summary-detail {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 4px;
  font-family: var(--mono);
}
.cost-strategy-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
  margin-top: 16px;
}
.cost-strategy {
  background: var(--bg-input);
  border-radius: 10px;
  padding: 18px;
  border: 1px solid var(--border);
  transition: border-color 0.2s, box-shadow 0.2s;
  position: relative;
}
.cost-strategy.recommended {
  border-color: var(--accent);
  box-shadow: 0 0 16px var(--accent-glow);
}
.cost-strategy-badge {
  position: absolute;
  top: -10px;
  right: 16px;
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.cost-strategy-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
}
.cost-strategy-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 12px;
}
.cost-strategy-row-label { color: var(--text-dim); }
.cost-strategy-row-value { font-family: var(--mono); color: var(--text); font-weight: 500; }
.cost-strategy-total {
  border-top: 1px solid var(--border);
  margin-top: 10px;
  padding-top: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.cost-strategy-total-label { font-size: 13px; font-weight: 600; color: var(--text); }
.cost-strategy-total-value { font-family: var(--mono); font-size: 18px; font-weight: 700; color: var(--accent-text); }
.cost-savings {
  font-size: 11px;
  color: var(--success);
  font-weight: 600;
  margin-top: 6px;
  text-align: right;
}
.cost-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 12px;
}
.cost-table th {
  text-align: left;
  padding: 8px 12px;
  color: var(--text-dim);
  font-weight: 500;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.cost-table td {
  padding: 8px 12px;
  border-bottom: 1px solid rgba(42, 53, 80, 0.3);
  font-family: var(--mono);
}
.cost-table tr:hover { background: rgba(0, 237, 100, 0.03); }
.cost-highlight {
  color: var(--accent-text);
  font-weight: 600;
}
.cost-bar-cell { position: relative; }
.cost-bar {
  position: absolute;
  left: 0; top: 50%;
  transform: translateY(-50%);
  height: 20px;
  background: var(--accent-glow);
  border-radius: 3px;
  transition: width 0.4s ease;
}
.cost-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin: 20px 0 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.cost-tip {
  font-size: 12px;
  color: var(--text-muted);
  background: rgba(0, 237, 100, 0.05);
  border-left: 3px solid var(--accent);
  padding: 10px 14px;
  border-radius: 0 6px 6px 0;
  margin-top: 16px;
}
.cost-help-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 1.5px solid var(--accent);
  background: transparent;
  color: var(--accent);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  margin-left: 8px;
  transition: all 0.2s;
  vertical-align: middle;
  font-family: var(--mono);
  line-height: 1;
}
.cost-help-btn:hover {
  background: var(--accent);
  color: var(--bg);
  box-shadow: 0 0 10px var(--accent-glow);
}
.cost-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
.cost-modal-overlay.open {
  opacity: 1;
  pointer-events: auto;
}
.cost-modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  max-width: 680px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 32px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
}
.cost-modal::-webkit-scrollbar { width: 6px; }
.cost-modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.cost-modal-close {
  position: absolute;
  top: 14px; right: 16px;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.15s;
}
.cost-modal-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
.cost-modal h2 {
  font-size: 18px;
  color: var(--text);
  margin: 0 0 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.cost-modal h3 {
  font-size: 14px;
  color: var(--accent-text);
  margin: 22px 0 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.cost-modal p, .cost-modal li {
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.7;
}
.cost-modal ul { padding-left: 20px; margin: 6px 0; }
.cost-modal li { margin-bottom: 4px; }
.cost-modal code {
  background: var(--bg-input);
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 12px;
  color: var(--accent-text);
  font-family: var(--mono);
}
.cost-modal .formula {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 18px;
  margin: 10px 0;
  font-family: var(--mono);
  font-size: 13px;
  color: var(--text);
  line-height: 1.8;
}
.cost-modal .formula .label {
  color: var(--text-muted);
  font-size: 11px;
}
.cost-modal .formula .accent { color: var(--accent); font-weight: 600; }
.cost-modal .example {
  background: rgba(0, 237, 100, 0.05);
  border-left: 3px solid var(--accent);
  border-radius: 0 8px 8px 0;
  padding: 12px 16px;
  margin: 12px 0;
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--mono);
  line-height: 1.8;
}

/* History chart */
.history-empty {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
  font-size: 14px;
}
.history-chart {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  height: 120px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.history-bar-group {
  flex: 1;
  display: flex;
  gap: 2px;
  align-items: flex-end;
  height: 100%;
  min-width: 0;
}
.history-bar {
  flex: 1;
  border-radius: 3px 3px 0 0;
  min-width: 4px;
  transition: height 0.4s ease;
  cursor: pointer;
  position: relative;
}
.history-bar:hover { opacity: 0.8; }
.history-legend {
  display: flex;
  gap: 16px;
  justify-content: center;
  margin-top: 8px;
  font-size: 12px;
  color: var(--text-dim);
}
.history-legend-dot {
  display: inline-block;
  width: 10px; height: 10px;
  border-radius: 2px;
  margin-right: 4px;
  vertical-align: middle;
}
.history-labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* About page */
.about-container { max-width: 680px; margin: 0 auto; }
.about-header { display: flex; gap: 24px; align-items: center; margin-bottom: 24px; }
.about-avatar {
  width: 120px; height: 120px;
  border-radius: 50%;
  border: 3px solid var(--accent);
  box-shadow: 0 0 20px var(--accent-glow);
  flex-shrink: 0;
}
.about-name { font-size: 24px; font-weight: 700; color: var(--text); }
.about-role { font-size: 14px; color: var(--accent-text); margin-top: 4px; }
.about-links { display: flex; gap: 12px; margin-top: 8px; }
.about-links a {
  color: var(--text-dim);
  font-size: 13px;
  text-decoration: none;
  transition: color 0.2s;
}
.about-links a:hover { color: var(--accent); }
.about-section { margin-bottom: 24px; }
.about-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.about-text { font-size: 14px; line-height: 1.8; color: var(--text); }
.about-text a { color: var(--blue); text-decoration: none; }
.about-text a:hover { text-decoration: underline; }
.about-disclaimer {
  background: rgba(255, 215, 61, 0.08);
  border: 1px solid rgba(255, 215, 61, 0.2);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-top: 24px;
}
.about-disclaimer-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--warning);
  margin-bottom: 6px;
}
.about-disclaimer-text {
  font-size: 13px;
  line-height: 1.7;
  color: var(--text-dim);
}

/* ── Page Headers ── */
.page-header {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.page-header-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--accent-text, var(--text));
  margin: 0 0 4px;
  letter-spacing: -0.3px;
}
.page-header-subtitle {
  font-size: 14px;
  color: var(--text-dim);
  margin: 0 0 6px;
  font-weight: 500;
}
.page-header-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin: 0;
  line-height: 1.5;
}

/* ── Settings page ── */
.settings-container { max-width: 640px; margin: 0 auto; }
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
[data-theme="light"] .settings-section {
  box-shadow: 0 1px 4px rgba(0,30,43,0.07);
  border-color: #DDE4E2;
}
.settings-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
/* API key alert banner */
.settings-api-banner {
  background: rgba(255,192,16,0.08);
  border: 1px solid rgba(255,192,16,0.25);
  border-radius: var(--radius);
  padding: 14px 18px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--warning);
  line-height: 1.5;
}
.settings-api-banner.success {
  background: rgba(0,237,100,0.06);
  border-color: rgba(0,237,100,0.2);
  color: var(--success);
}
[data-theme="light"] .settings-api-banner {
  background: rgba(148,79,1,0.06);
  border-color: rgba(148,79,1,0.2);
}
[data-theme="light"] .settings-api-banner.success {
  background: rgba(0,104,74,0.06);
  border-color: rgba(0,104,74,0.2);
}
.settings-api-banner-icon { font-size: 20px; flex-shrink: 0; }
/* Heatmap preview swatches */
.heatmap-preview {
  display: inline-block;
  width: 80px;
  height: 12px;
  border-radius: 3px;
  vertical-align: middle;
  margin-left: 8px;
  border: 1px solid var(--border);
}
.heatmap-opt {
  display: flex;
  align-items: center;
  gap: 6px;
}
/* Get a key link as button */
.settings-key-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  color: var(--blue);
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  padding: 4px 10px;
  border: 1px solid var(--blue);
  border-radius: 4px;
  transition: all 0.15s;
  white-space: nowrap;
}
.settings-key-link:hover {
  background: rgba(4,152,236,0.1);
  text-decoration: none;
}
/* API key field integration */
.settings-api-field {
  display: flex;
  align-items: center;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-input);
  overflow: hidden;
  transition: border-color 0.2s;
}
.settings-api-field:focus-within { border-color: var(--accent); }
.settings-api-field input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 8px 12px;
  font-size: 13px;
  font-family: var(--mono);
  color: var(--text);
  min-width: 0;
}
.settings-api-field input:focus { outline: none; }
.settings-api-field button {
  background: none;
  border: none;
  border-left: 1px solid var(--border);
  padding: 8px 10px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-dim);
  transition: all 0.15s;
  flex-shrink: 0;
}
.settings-api-field button:hover { color: var(--text); background: rgba(255,255,255,0.05); }
[data-theme="light"] .settings-api-field button:hover { background: rgba(0,0,0,0.03); }
/* Version badges */
.version-badge {
  display: inline-block;
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  background: rgba(0,237,100,0.08);
  border: 1px solid rgba(0,237,100,0.2);
  border-radius: 6px;
  padding: 4px 12px;
  letter-spacing: 0.3px;
}
[data-theme="light"] .version-badge {
  background: rgba(0,104,74,0.06);
  border-color: rgba(0,104,74,0.2);
  color: #00684A;
}
.settings-api-field .save-btn {
  color: var(--accent);
  font-size: 12px;
  font-weight: 600;
  font-family: var(--font);
  padding: 8px 14px;
}
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.settings-row:last-child { border-bottom: none; }
[data-theme="light"] .settings-row { border-bottom-color: rgba(0,0,0,0.04); }
.settings-label {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.settings-label-text {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}
.settings-label-hint {
  font-size: 12px;
  color: var(--text-muted);
}
.settings-control { flex-shrink: 0; }
.settings-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--mono);
  cursor: pointer;
  min-width: 180px;
}
.settings-select:focus { outline: none; border-color: var(--accent); }
.settings-input {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--mono);
  min-width: 180px;
}
.settings-input:focus { outline: none; border-color: var(--accent); }
.settings-toggle {
  position: relative;
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: background 0.2s;
  padding: 0;
}
.settings-toggle.active { background: var(--accent); }
.settings-toggle::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s;
}
.settings-toggle.active::after { transform: translateX(20px); }
.settings-saved {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: var(--success);
  opacity: 0;
  transition: opacity 0.3s;
}
.settings-saved.show { opacity: 1; }
.settings-reset-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 8px 16px;
  border-radius: var(--radius);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}
.settings-reset-btn:hover { border-color: var(--error); color: var(--error); }
.settings-toggle-vis {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 8px;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  transition: all 0.2s;
  color: var(--text-dim);
}
.settings-toggle-vis:hover { border-color: var(--accent); }
.settings-api-key-active { color: var(--success); }
.settings-api-key-missing { color: var(--warning); }
.settings-row .settings-select, .settings-row .settings-input { text-align: right; }

/* ── Chat Tab ── */
.chat-container {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 140px);
  max-width: 900px;
  margin: 0 auto;
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.chat-message {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 12px;
  line-height: 1.6;
  font-size: 14px;
  white-space: pre-wrap;
  word-break: break-word;
}
.chat-message.user {
  align-self: flex-end;
  background: var(--accent);
  color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-message.assistant {
  align-self: flex-start;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}
.chat-message.system-msg {
  align-self: center;
  background: none;
  color: var(--text-muted);
  font-size: 12px;
  padding: 4px 8px;
}
.chat-sources {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-muted);
}
.chat-sources summary { cursor: pointer; }
.chat-sources ul { margin: 4px 0 0 16px; padding: 0; }
.chat-sources li { margin: 2px 0; }
.chat-input-area {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  align-items: flex-end;
}
.chat-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  resize: none;
  min-height: 40px;
  max-height: 120px;
  outline: none;
}
.chat-input:focus { border-color: var(--accent); }
.chat-send-btn {
  padding: 10px 20px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}
.chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--text-muted);
}
.chat-header-status { display: flex; gap: 8px; align-items: center; }
.chat-header-status span { opacity: 0.7; }
.chat-config-toggle {
  background: none; border: none; color: var(--text-muted);
  cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 14px;
  display: flex; align-items: center; gap: 4px;
}
.chat-config-toggle:hover { background: rgba(255,255,255,0.06); color: var(--text); }
[data-theme="light"] .chat-config-toggle:hover { background: rgba(0,0,0,0.04); }
.chat-config-toggle.active { color: var(--accent); }
.chat-config-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.2s ease-out;
  border-bottom: 1px solid transparent;
}
.chat-config-panel.open {
  max-height: 300px;
  border-bottom-color: var(--border);
}
.chat-config-bar {
  padding: 8px 16px;
  display: flex;
  gap: 12px;
  align-items: center;
  font-size: 12px;
  color: var(--text-muted);
  flex-wrap: wrap;
}
.chat-config-bar select, .chat-config-bar input {
  padding: 4px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 12px;
}
.chat-config-bar label { display: flex; align-items: center; gap: 4px; }
.chat-typing {
  align-self: flex-start;
  color: var(--text-muted);
  font-size: 13px;
  padding: 8px 16px;
}
.chat-typing::after {
  content: '';
  animation: chatDots 1.4s infinite;
}
@keyframes chatDots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}

/* ── Multimodal Tab ── */
.mm-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.mm-drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  background: var(--bg-input);
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
}
.mm-drop-zone:hover {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.mm-drop-zone.drag-active {
  border-color: var(--accent);
  background: var(--accent-glow);
  box-shadow: 0 0 0 4px var(--accent-glow);
}
.mm-drop-zone .mm-drop-icon {
  font-size: 40px;
  opacity: 0.6;
}
.mm-drop-zone .mm-drop-text {
  color: var(--text-dim);
  font-size: 14px;
}
.mm-drop-zone .mm-drop-hint {
  color: var(--text-muted);
  font-size: 12px;
}
.mm-preview {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 16px;
}
.mm-preview.visible { display: flex; }
.mm-preview img {
  max-height: 300px;
  max-width: 100%;
  object-fit: contain;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.mm-preview .mm-file-info {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--mono);
}
.mm-preview .mm-clear-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 6px;
  padding: 4px 14px;
  font-size: 12px;
  cursor: pointer;
  font-family: var(--font);
  transition: border-color 0.15s, color 0.15s;
}
.mm-preview .mm-clear-btn:hover {
  border-color: var(--error);
  color: var(--error);
}
.mm-gallery-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}
.mm-gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.mm-gallery-slot {
  aspect-ratio: 1;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  background: var(--bg-input);
  position: relative;
  overflow: hidden;
}
.mm-gallery-slot:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.mm-gallery-slot.filled {
  border-style: solid;
  cursor: default;
  padding: 0;
}
.mm-gallery-slot.filled img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: calc(var(--radius) - 2px);
}
.mm-gallery-slot .mm-slot-remove {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 13px;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.mm-gallery-slot.filled:hover .mm-slot-remove { display: flex; }
.mm-gallery-slot .mm-slot-add {
  font-size: 28px;
  color: var(--text-muted);
  pointer-events: none;
}
.mm-gallery-slot.query-selected {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.mm-result-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.mm-result-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: border-color 0.15s;
}
.mm-result-item:first-child {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.mm-result-item .mm-result-rank {
  font-family: var(--mono);
  font-weight: 700;
  font-size: 18px;
  color: var(--text-muted);
  min-width: 28px;
  text-align: center;
}
.mm-result-item:first-child .mm-result-rank { color: var(--accent); }
.mm-result-item .mm-result-thumb {
  width: 48px;
  height: 48px;
  border-radius: 6px;
  object-fit: cover;
  border: 1px solid var(--border);
  flex-shrink: 0;
}
.mm-result-item .mm-result-content {
  flex: 1;
  min-width: 0;
}
.mm-result-item .mm-result-text {
  font-size: 14px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.mm-result-item .mm-result-type {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.mm-result-item .mm-result-score {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
}
.mm-search-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}
.mm-search-row input[type="text"] {
  flex: 1;
}
.mm-search-mode {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
}
.mm-search-mode button {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 6px;
  padding: 4px 12px;
  font-size: 12px;
  cursor: pointer;
  font-family: var(--font);
  transition: all 0.15s;
}
.mm-search-mode button.active {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-glow);
}

@media (max-width: 768px) {
  .mm-grid { grid-template-columns: 1fr; }
  .mm-gallery-grid { grid-template-columns: repeat(3, 1fr); }
  .compare-grid, .search-results { grid-template-columns: 1fr; }
  .sidebar { width: 56px; min-width: 56px; }
  .sidebar-title, .status-label { display: none; }
  .tab-btn { justify-content: center; padding: 10px; }
  .tab-btn span:not(.tab-btn-icon) { display: none; }
  .main { padding: 16px; }
  .settings-row { flex-direction: column; align-items: flex-start; gap: 8px; }
  .settings-select, .settings-input { min-width: 100%; }
}
</style>
</head>
<body>

<!-- LeafyGreen Icon Sprites (mongodb.design) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <symbol id="lg-lightning" viewBox="0 0 16 16">
    <path d="M9.22274 1.99296C9.22274 1.49561 8.56293 1.31233 8.30107 1.73667L4.07384 8.58696C3.87133 8.91513 4.10921 9.33717 4.49748 9.33717H6.77682L6.77682 14.0066C6.77682 14.504 7.43627 14.6879 7.69813 14.2635L11.9262 7.4118C12.1288 7.08363 11.8903 6.66244 11.5021 6.66244H9.22274V1.99296Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-arrows" viewBox="0 0 16 16">
    <path d="M5 8.57279V13.4272C5 13.9565 4.39241 14.2015 4.0721 13.8014L2.12898 11.3742C1.95701 11.1594 1.95701 10.8406 2.12898 10.6258L4.0721 8.19856C4.39241 7.79846 5 8.04351 5 8.57279Z" fill="currentColor"/>
    <path d="M5 10H12.5C12.7761 10 13 10.2239 13 10.5V11.5C13 11.7761 12.7761 12 12.5 12H5V10Z" fill="currentColor"/>
    <path d="M11 7.42721V2.57279C11 2.04351 11.6076 1.79846 11.9279 2.19856L13.871 4.62577C14.043 4.84058 14.043 5.15942 13.871 5.37423L11.9279 7.80144C11.6076 8.20154 11 7.95649 11 7.42721Z" fill="currentColor"/>
    <path d="M3 4.5C3 4.22386 3.22386 4 3.5 4H11V6H3.5C3.22386 6 3 5.77614 3 5.5V4.5Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-search" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.3234 9.81874C4.07618 11.5715 6.75062 11.8398 8.78588 10.6244L12.93 14.7685C13.4377 15.2762 14.2608 15.2762 14.7685 14.7685C15.2762 14.2608 15.2762 13.4377 14.7685 12.93L10.6244 8.78588C11.8398 6.75062 11.5715 4.07619 9.81873 2.32341C7.74896 0.253628 4.39318 0.253628 2.3234 2.32341C0.253624 4.39319 0.253624 7.74896 2.3234 9.81874ZM7.98026 4.16188C9.03467 5.2163 9.03467 6.92585 7.98026 7.98026C6.92584 9.03468 5.2163 9.03468 4.16188 7.98026C3.10746 6.92585 3.10746 5.2163 4.16188 4.16188C5.2163 3.10747 6.92584 3.10747 7.98026 4.16188Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-gauge" viewBox="0 0 16 16">
    <path d="M1.041 10.2514C0.996713 10.6632 1.33666 11 1.75088 11H4.2449C4.65912 11 4.98569 10.6591 5.08798 10.2577C5.22027 9.73864 5.49013 9.25966 5.87533 8.87446C6.43906 8.31073 7.20364 7.99403 8.00088 7.99403C8.27011 7.99403 8.53562 8.03015 8.79093 8.0997L11.7818 5.10887C10.6623 4.39046 9.35172 4 8.00088 4C6.14436 4 4.36388 4.7375 3.05113 6.05025C1.91604 7.18534 1.21104 8.67012 1.041 10.2514Z" fill="currentColor"/>
    <path d="M13.2967 6.42237L10.455 9.26409C10.6678 9.56493 10.8231 9.90191 10.9138 10.2577C11.0161 10.6591 11.3426 11 11.7568 11L14.2509 11C14.6651 11 15.005 10.6632 14.9608 10.2514C14.8087 8.83759 14.229 7.50093 13.2967 6.42237Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-bulb" viewBox="0 0 16 16">
    <path d="M12.3311 8.5C12.7565 7.76457 13 6.91072 13 6C13 3.23858 10.7614 1 8 1C5.23858 1 3 3.23858 3 6C3 6.94628 3.26287 7.83117 3.71958 8.58561L5.40749 11.501C5.58628 11.8099 5.91607 12 6.27291 12H6.5V6C6.5 5.17157 7.17157 4.5 8 4.5C8.82843 4.5 9.5 5.17157 9.5 6V12H9.72368C10.0793 12 10.4082 11.8111 10.5874 11.5039L12.34 8.5H12.3311Z" fill="currentColor"/>
    <path d="M7.5 6V12H8.5V6C8.5 5.72386 8.27614 5.5 8 5.5C7.72386 5.5 7.5 5.72386 7.5 6Z" fill="currentColor"/>
    <path d="M10 14V13H6V14C6 14.5523 6.44772 15 7 15H9C9.55228 15 10 14.5523 10 14Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-info" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 15C11.866 15 15 11.866 15 8C15 4.13401 11.866 1 8 1C4.13401 1 1 4.13401 1 8C1 11.866 4.13401 15 8 15ZM9 4C9 4.55228 8.55228 5 8 5C7.44772 5 7 4.55228 7 4C7 3.44772 7.44772 3 8 3C8.55228 3 9 3.44772 9 4ZM8 6C8.55228 6 9 6.44772 9 7V11H9.5C9.77614 11 10 11.2239 10 11.5C10 11.7761 9.77614 12 9.5 12H6.5C6.22386 12 6 11.7761 6 11.5C6 11.2239 6.22386 11 6.5 11H7V7H6.5C6.22386 7 6 6.77614 6 6.5C6 6.22386 6.22386 6 6.5 6H8Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-image" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M2 3C2 2.44772 2.44772 2 3 2H13C13.5523 2 14 2.44772 14 3V13C14 13.5523 13.5523 14 13 14H3C2.44772 14 2 13.5523 2 13V3ZM4 4V9.586L5.793 7.793C6.183 7.403 6.817 7.403 7.207 7.793L8.5 9.086L10.293 7.293C10.683 6.903 11.317 6.903 11.707 7.293L12 7.586V4H4ZM12 10.414L10.5 8.914L8.207 11.207C7.817 11.597 7.183 11.597 6.793 11.207L5.5 9.914L4 11.414V12H12V10.414ZM10 5.5C10 6.328 10.672 7 11.5 7C11.776 7 12 6.776 12 6.5V5C12 4.724 11.776 4.5 11.5 4.5H10.5C10.224 4.5 10 4.724 10 5V5.5Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-config" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M6.5 1.5A.5.5 0 0 1 7 1h2a.5.5 0 0 1 .5.5v1.05a5 5 0 0 1 1.37.57l.74-.74a.5.5 0 0 1 .7 0l1.42 1.42a.5.5 0 0 1 0 .7l-.74.74c.25.43.44.89.57 1.37H14.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-1.05a5 5 0 0 1-.57 1.37l.74.74a.5.5 0 0 1 0 .7l-1.42 1.42a.5.5 0 0 1-.7 0l-.74-.74a5 5 0 0 1-1.37.57V14.5a.5.5 0 0 1-.5.5H7a.5.5 0 0 1-.5-.5v-1.05a5 5 0 0 1-1.37-.57l-.74.74a.5.5 0 0 1-.7 0L2.27 12.2a.5.5 0 0 1 0-.7l.74-.74a5 5 0 0 1-.57-1.37H1.5A.5.5 0 0 1 1 9V7a.5.5 0 0 1 .5-.5h1.05c.13-.48.32-.94.57-1.37l-.74-.74a.5.5 0 0 1 0-.7L3.8 2.27a.5.5 0 0 1 .7 0l.74.74A5 5 0 0 1 6.6 2.44V1.5zM8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-code" viewBox="0 0 16 16">
    <path fill="currentColor" d="M5.854 4.146a.5.5 0 0 1 0 .708L2.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm4.292 0a.5.5 0 0 0 0 .708L13.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/>
  </symbol>
</svg>

<div class="app-shell">

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-drag-region">
    <img class="sidebar-logo" id="sidebarLogo" src="/icons/dark/64.png" alt="Vai">
    <span class="sidebar-title">Vai</span>
    <button class="sidebar-settings-btn" data-tab="settings" title="Settings"><svg width="16" height="16" viewBox="0 0 16 16"><use href="#lg-config"/></svg></button>
  </div>
  <nav class="sidebar-nav">
    <div class="sidebar-nav-group" role="tablist" aria-label="Tools">
      <div class="sidebar-nav-label" id="nav-tools-label">Tools</div>
      <button class="tab-btn active" data-tab="embed" role="tab" aria-selected="true" aria-controls="tab-embed" id="tab-btn-embed"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-lightning"/></svg></span><span>Embed</span></button>
      <button class="tab-btn" data-tab="compare" role="tab" aria-selected="false" aria-controls="tab-compare" id="tab-btn-compare"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-arrows"/></svg></span><span>Compare</span></button>
      <button class="tab-btn" data-tab="search" role="tab" aria-selected="false" aria-controls="tab-search" id="tab-btn-search"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-search"/></svg></span><span>Search</span></button>
      <button class="tab-btn" data-tab="multimodal" role="tab" aria-selected="false" aria-controls="tab-multimodal" id="tab-btn-multimodal"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-image"/></svg></span><span>Multimodal</span></button>
      <button class="tab-btn" data-tab="generate" role="tab" aria-selected="false" aria-controls="tab-generate" id="tab-btn-generate"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-code"/></svg></span><span>Generate</span></button>
      <button class="tab-btn" data-tab="chat" role="tab" aria-selected="false" aria-controls="tab-chat" id="tab-btn-chat"><span class="tab-btn-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 16 16"><path d="M2 2h12v9H5l-3 3V2z" fill="none" stroke="currentColor" stroke-width="1.5"/></svg></span><span>Chat</span></button>
    </div>
    <div class="sidebar-nav-divider"></div>
    <div class="sidebar-nav-group" role="tablist" aria-label="Learn">
      <div class="sidebar-nav-label" id="nav-learn-label">Learn</div>
      <button class="tab-btn" data-tab="benchmark" role="tab" aria-selected="false" aria-controls="tab-benchmark" id="tab-btn-benchmark"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-gauge"/></svg></span><span>Benchmark</span></button>
      <button class="tab-btn" data-tab="explore" role="tab" aria-selected="false" aria-controls="tab-explore" id="tab-btn-explore"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-bulb"/></svg></span><span>Explore</span></button>
      <button class="tab-btn" data-tab="about" role="tab" aria-selected="false" aria-controls="tab-about" id="tab-btn-about"><span class="tab-btn-icon" aria-hidden="true"><svg><use href="#lg-info"/></svg></span><span>About</span></button>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:5px;">
        <div class="status-dot" id="statusDot"></div>
        <span class="status-label" id="statusLabel">Checking...</span>
      </div>
      <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">🌙</button>
    </div>
    <div id="appVersionLabel" style="font-size:10px;color:var(--text-muted);text-align:center;"></div>
  </div>
</aside>

<!-- Content -->
<div class="content-area">
  <div class="content-drag-region"></div>
  <div class="update-banner" id="updateBanner">
    <span class="update-banner-icon">🚀</span>
    <span class="update-banner-text" id="updateBannerText">
      <strong>Vai <span id="updateVersion"></span></strong> is available.
      You're on <span id="currentVersion"></span>.
    </span>
    <div class="update-progress" id="updateProgress" style="display:none;">
      <div class="update-progress-bar"><div class="update-progress-fill" id="updateProgressFill"></div></div>
      <span class="update-progress-label" id="updateProgressLabel">0%</span>
    </div>
    <button class="update-banner-btn" id="updateDownloadBtn">Download &amp; Install</button>
    <button class="update-banner-btn" id="updateInstallBtn" style="display:none;">Restart &amp; Update</button>
    <button class="update-banner-dismiss" id="updateDismissBtn" title="Dismiss">×</button>
  </div>
  <div class="main">

<!-- ========== EMBED TAB ========== -->
<div class="tab-panel active" id="tab-embed" role="tabpanel" aria-labelledby="tab-btn-embed" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Embed</h2>
    <p class="page-header-subtitle">Generate vector embeddings for text</p>
    <p class="page-header-hint">Paste or type text below, choose a model, and hit Embed to see the raw vectors and token usage.</p>
  </div>
  <div class="card">
    <div class="card-title">Input Text</div>
    <textarea id="embedInput" rows="5" placeholder="Enter text to embed..." aria-label="Text to embed">MongoDB Atlas provides powerful vector search capabilities for AI applications.</textarea>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Model</span>
      <select id="embedModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Input Type</span>
      <select id="embedInputType">
        <option value="">None</option>
        <option value="query">Query</option>
        <option value="document">Document</option>
      </select>
    </div>
    <div class="option-group">
      <span class="option-label">Dimensions</span>
      <select id="embedDimensions">
        <option value="">Default</option>
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
      </select>
    </div>
    <div class="option-group">
      <span class="option-label">Output Type</span>
      <select id="embedOutputDtype">
        <option value="float">float (32-bit)</option>
        <option value="int8">int8 (4× smaller)</option>
        <option value="uint8">uint8 (4× smaller)</option>
        <option value="binary">binary (32× smaller)</option>
        <option value="ubinary">ubinary (32× smaller)</option>
      </select>
    </div>
    <button class="btn" id="embedBtn" onclick="doEmbed()">⚡ Embed</button>
  </div>

  <div class="error-msg" id="embedError"></div>

  <div class="result-section" id="embedResult">
    <div class="card">
      <div class="card-title">Result</div>
      <div id="embedStats"></div>
      <div class="vector-preview" id="embedVector"></div>
      <div style="margin-top:8px;">
        <button class="btn btn-secondary btn-small" onclick="copyVector()">📋 Copy Full Vector</button>
      </div>
      <div class="card-title" style="margin-top:16px;">Vector Heatmap</div>
      <div class="heatmap" id="embedHeatmap"></div>
    </div>
  </div>
</div>

<!-- ========== COMPARE TAB ========== -->
<div class="tab-panel" id="tab-compare" role="tabpanel" aria-labelledby="tab-btn-compare" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Compare</h2>
    <p class="page-header-subtitle">Visualize similarity between text pairs</p>
    <p class="page-header-hint">Enter two texts and compare their embeddings — see cosine similarity, a heatmap of vector dimensions, and a visual diff.</p>
  </div>
  <div class="compare-grid">
    <div class="card">
      <div class="card-title">Text A</div>
      <textarea id="compareA" rows="5" placeholder="Enter first text...">MongoDB is a popular NoSQL database</textarea>
    </div>
    <div class="card">
      <div class="card-title">Text B</div>
      <textarea id="compareB" rows="5" placeholder="Enter second text...">Document databases store data as JSON-like objects</textarea>
    </div>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Model</span>
      <select id="compareModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Dimensions</span>
      <select id="compareDimensions">
        <option value="">Default</option>
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
      </select>
    </div>
    <button class="btn" id="compareBtn" onclick="doCompare()">⚖️ Compare</button>
  </div>

  <div class="error-msg" id="compareError"></div>

  <div class="result-section" id="compareResult">
    <div class="card">
      <div class="similarity-display">
        <div class="similarity-score" id="simScore">—</div>
        <div class="similarity-label">Cosine Similarity</div>
        <div class="similarity-bar-outer">
          <div class="similarity-bar-inner" id="simBar" style="width:0%"></div>
        </div>
      </div>
      <div class="metrics-grid" id="metricsGrid"></div>
      <div class="metric-note" id="metricNote"></div>
      <div id="compareStats" style="text-align:center;margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- ========== SEARCH TAB ========== -->
<div class="tab-panel" id="tab-search" role="tabpanel" aria-labelledby="tab-btn-search" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Rerank</h2>
    <p class="page-header-subtitle">Re-order documents by relevance to a query</p>
    <p class="page-header-hint">Enter a search query and a set of documents — the reranker scores and sorts them by semantic relevance.</p>
  </div>
  <div class="card">
    <div class="card-title">Query</div>
    <input type="text" id="searchQuery" placeholder="Enter your search query..." value="How do I build AI-powered search?" aria-label="Search query">
  </div>

  <div class="card">
    <div class="card-title">Documents (one per line)</div>
    <textarea id="searchDocs" rows="8" placeholder="Enter documents, one per line...">MongoDB Atlas provides vector search capabilities
The recipe calls for two cups of flour and three eggs
Voyage AI embeddings power semantic retrieval for modern applications
Python is a popular programming language for data science
Atlas Search combines full-text and vector search in one platform
Machine learning models can be deployed at the edge
Semantic search understands meaning beyond keyword matching</textarea>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Embedding Model</span>
      <select id="searchEmbedModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Rerank Model</span>
      <select id="searchRerankModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Top K</span>
      <select id="searchTopK">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="10">10</option>
      </select>
    </div>
    <button class="btn" id="searchBtn" onclick="doSearch(false)">🔍 Search</button>
    <button class="btn btn-secondary" id="searchRerankBtn" onclick="doSearch(true)">🔍+ Rerank</button>
  </div>

  <div class="error-msg" id="searchError"></div>

  <div class="result-section" id="searchResult">
    <div class="search-results" id="searchResultGrid"></div>
  </div>
</div>

<!-- ========== MULTIMODAL TAB ========== -->
<div class="tab-panel" id="tab-multimodal" role="tabpanel" aria-labelledby="tab-btn-multimodal" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Multimodal</h2>
    <p class="page-header-subtitle">Compare images and text in the same vector space</p>
    <p class="page-header-hint">Voyage AI's multimodal models embed images and text into a unified vector space — so you can compare them directly with cosine similarity.</p>
  </div>

  <!-- Section A: Image ↔ Text Similarity -->
  <div class="mm-grid">
    <div class="card">
      <div class="card-title">Image</div>
      <div class="mm-drop-zone" id="mmDropZone">
        <div class="mm-drop-icon">🖼️</div>
        <div class="mm-drop-text">Drop an image here or click to browse</div>
        <div class="mm-drop-hint">PNG, JPEG, WebP, GIF — max 20 MB · Paste from clipboard (⌘V)</div>
      </div>
      <input type="file" id="mmFileInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none">
      <div class="mm-preview" id="mmPreview">
        <img id="mmPreviewImg" src="" alt="Preview">
        <div class="mm-file-info" id="mmFileInfo"></div>
        <button class="mm-clear-btn" onclick="clearMultimodalImage()">✕ Clear</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Text</div>
      <textarea id="mmText" rows="8" placeholder="Describe what you see, or enter any text to compare against the image..."></textarea>
    </div>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Model</span>
      <select id="mmModel">
        <option value="voyage-multimodal-3.5">voyage-multimodal-3.5</option>
        <option value="voyage-multimodal-3">voyage-multimodal-3</option>
      </select>
    </div>
    <div class="option-group">
      <span class="option-label">Dimensions</span>
      <select id="mmDimensions">
        <option value="">Default</option>
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
      </select>
    </div>
    <button class="btn" id="mmCompareBtn" onclick="doMultimodalCompare()">🔮 Compare</button>
  </div>

  <div class="error-msg" id="mmError"></div>

  <div class="result-section" id="mmResult">
    <div class="card">
      <div class="similarity-display">
        <div class="similarity-score" id="mmSimScore">—</div>
        <div class="similarity-label">Cosine Similarity</div>
        <div class="similarity-bar-outer">
          <div class="similarity-bar-inner" id="mmSimBar" style="width:0%"></div>
        </div>
      </div>
      <div id="mmStats" style="text-align:center;margin-top:16px;"></div>
      <div class="metric-note" id="mmNote" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- Section B: Cross-Modal Gallery -->
  <div class="mm-gallery-section">
    <h3 style="color:var(--accent-text);margin-bottom:4px;">Cross-Modal Gallery</h3>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:16px;">Build a mini corpus of images and texts, then search across both modalities at once.</p>

    <div class="card">
      <div class="card-title">Image Corpus (up to 6)</div>
      <div class="mm-gallery-grid" id="mmGalleryGrid"></div>
      <input type="file" id="mmGalleryFileInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none">
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="card-title">Text Corpus (one per line)</div>
      <textarea id="mmCorpusText" rows="5" placeholder="A sunset over the ocean&#10;A cat sitting on a windowsill&#10;Abstract geometric patterns&#10;A city skyline at night"></textarea>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="card-title">Search Query</div>
      <div class="mm-search-mode" id="mmSearchMode">
        <button class="active" data-mode="text" onclick="setMmSearchMode('text')">📝 Text Query</button>
        <button data-mode="image" onclick="setMmSearchMode('image')">🖼️ Image Query</button>
      </div>
      <div id="mmSearchTextWrap">
        <div class="mm-search-row">
          <input type="text" id="mmSearchQuery" placeholder="Enter a search query...">
          <button class="btn" id="mmSearchBtn" onclick="doMultimodalSearch()">🔮 Search Corpus</button>
        </div>
      </div>
      <div id="mmSearchImageWrap" style="display:none;">
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">Click an image in the corpus above to use it as the search query, then:</p>
        <div style="display:flex;gap:8px;align-items:center;">
          <span id="mmSearchImageLabel" style="font-size:13px;color:var(--text-muted);">No image selected</span>
          <button class="btn" id="mmSearchImgBtn" onclick="doMultimodalSearch()">🔮 Search Corpus</button>
        </div>
      </div>
    </div>

    <div class="error-msg" id="mmSearchError"></div>

    <div class="result-section" id="mmSearchResult">
      <div class="card">
        <div class="card-title">Search Results</div>
        <div class="mm-result-list" id="mmSearchResultList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== BENCHMARK TAB ========== -->
<div class="tab-panel" id="tab-benchmark" role="tabpanel" aria-labelledby="tab-btn-benchmark" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Benchmark</h2>
    <p class="page-header-subtitle">Compare model speed, cost, and quality</p>
    <p class="page-header-hint">Run latency tests, compare ranking accuracy, analyze quantization trade-offs, and estimate costs across models.</p>
  </div>

  <!-- Sub-panel switcher -->
  <div class="bench-panels">
    <button class="bench-panel-btn active" data-bench="latency">⚡ Latency</button>
    <button class="bench-panel-btn" data-bench="ranking">🏆 Ranking</button>
    <button class="bench-panel-btn" data-bench="competitors">⚔️ vs Competitors</button>
    <button class="bench-panel-btn" data-bench="quantization">⚗️ Quantization</button>
    <button class="bench-panel-btn" data-bench="cost">💰 Cost</button>
    <button class="bench-panel-btn" data-bench="history">📊 History</button>
  </div>

  <!-- ── Latency Panel ── -->
  <div class="bench-view active" id="bench-latency">
    <div class="card">
      <div class="card-title">Embedding Latency Benchmark</div>
      <textarea id="benchLatencyInput" rows="3" placeholder="Enter text to benchmark (or leave for built-in sample)..."></textarea>
      <div class="options-row">
        <div class="option-group">
          <span class="option-label">Models</span>
          <div id="benchModelChecks" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>
        <div class="option-group">
          <span class="option-label">Rounds</span>
          <select id="benchRounds">
            <option value="1">1</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
        <button class="btn" id="benchLatencyBtn" onclick="doBenchLatency()">⚡ Run Benchmark</button>
      </div>
    </div>

    <div class="error-msg" id="benchLatencyError"></div>

    <div class="result-section" id="benchLatencyResult">
      <div class="card">
        <div class="card-title">Results</div>
        <div id="benchLatencyStats"></div>
        <div class="latency-chart" id="benchLatencyChart"></div>
      </div>
    </div>
  </div>

  <!-- ── Ranking Panel ── -->
  <div class="bench-view" id="bench-ranking">
    <div class="card">
      <div class="card-title">Model Ranking Comparison</div>
      <div style="margin-bottom:12px;">
        <input type="text" id="benchRankQuery" placeholder="Search query..." value="How do I search for similar documents using embeddings?">
      </div>
      <textarea id="benchRankDocs" rows="6" placeholder="Documents (one per line)...">Vector search finds documents by computing similarity between embedding vectors in high-dimensional space.
MongoDB Atlas Vector Search lets you index and query vector embeddings alongside your operational data.
Traditional full-text search uses inverted indexes to match keyword terms in documents.
Cosine similarity measures the angle between two vectors, commonly used for semantic search.
Database sharding distributes data across multiple servers for horizontal scalability.
Embedding models convert text into dense numerical vectors that capture meaning.
Approximate nearest neighbor algorithms like HNSW enable fast similarity search at scale.
Reranking models rescore initial search results to improve relevance ordering.</textarea>
      <div class="options-row">
        <div class="option-group">
          <span class="option-label">Model A</span>
          <select id="benchRankModelA"></select>
        </div>
        <div class="option-group">
          <span class="option-label">Model B</span>
          <select id="benchRankModelB"></select>
        </div>
        <div class="option-group">
          <span class="option-label">Mode</span>
          <select id="benchRankMode">
            <option value="embed">Embedding Similarity</option>
            <option value="rerank">Reranking</option>
          </select>
        </div>
        <div class="option-group">
          <span class="option-label">Top K</span>
          <select id="benchRankTopK">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="8">8</option>
          </select>
        </div>
        <button class="btn" id="benchRankBtn" onclick="doBenchRanking()">🏆 Compare Rankings</button>
      </div>
    </div>

    <div class="error-msg" id="benchRankError"></div>

    <div class="result-section" id="benchRankResult">
      <div class="card">
        <div class="card-title">Ranking Comparison</div>
        <div id="benchRankVerdict" style="margin-bottom:12px;font-size:14px;"></div>
        <div class="rank-comparison" id="benchRankGrid"></div>
      </div>
    </div>
  </div>

  <!-- ── Competitors Panel ── -->
  <div class="bench-view" id="bench-competitors">
    <div class="card">
      <div class="card-title">Why Voyage AI? — Competitive Comparison</div>
      <p style="color:var(--text-dim);font-size:13px;margin-bottom:16px;">
        See how Voyage AI compares to other embedding providers on quality, cost, and features.
      </p>
    </div>

    <!-- MTEB Retrieval Benchmark -->
    <div class="card" style="margin-top:16px;">
      <div class="card-title">🏆 MTEB Retrieval Benchmark (nDCG@10)</div>
      <p style="color:var(--text-dim);font-size:13px;margin-bottom:16px;">
        Industry-standard benchmark for retrieval quality. Higher is better.
      </p>
      <div id="mtebChart" style="display:flex;flex-direction:column;gap:8px;">
        <!-- Voyage AI -->
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="min-width:140px;font-weight:600;color:var(--accent);">Voyage-3</span>
          <div style="flex:1;height:24px;background:var(--surface);border-radius:4px;overflow:hidden;">
            <div style="width:67.4%;height:100%;background:var(--accent);border-radius:4px;"></div>
          </div>
          <span style="min-width:50px;text-align:right;font-family:var(--mono);color:var(--accent);font-weight:600;">67.4</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="min-width:140px;font-weight:600;color:var(--accent);">Voyage-3-lite</span>
          <div style="flex:1;height:24px;background:var(--surface);border-radius:4px;overflow:hidden;">
            <div style="width:64.3%;height:100%;background:var(--accent);opacity:0.7;border-radius:4px;"></div>
          </div>
          <span style="min-width:50px;text-align:right;font-family:var(--mono);color:var(--accent);">64.3</span>
        </div>
        <!-- Competitors -->
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="min-width:140px;color:var(--text-dim);">OpenAI text-3-large</span>
          <div style="flex:1;height:24px;background:var(--surface);border-radius:4px;overflow:hidden;">
            <div style="width:64.6%;height:100%;background:#666;border-radius:4px;"></div>
          </div>
          <span style="min-width:50px;text-align:right;font-family:var(--mono);color:var(--text-dim);">64.6</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="min-width:140px;color:var(--text-dim);">OpenAI text-3-small</span>
          <div style="flex:1;height:24px;background:var(--surface);border-radius:4px;overflow:hidden;">
            <div style="width:62.3%;height:100%;background:#666;border-radius:4px;"></div>
          </div>
          <span style="min-width:50px;text-align:right;font-family:var(--mono);color:var(--text-dim);">62.3</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="min-width:140px;color:var(--text-dim);">Cohere embed-v3</span>
          <div style="flex:1;height:24px;background:var(--surface);border-radius:4px;overflow:hidden;">
            <div style="width:64.1%;height:100%;background:#666;border-radius:4px;"></div>
          </div>
          <span style="min-width:50px;text-align:right;font-family:var(--mono);color:var(--text-dim);">64.1</span>
        </div>
      </div>
      <p style="color:var(--text-dim);font-size:11px;margin-top:12px;">
        Source: <a href="https://huggingface.co/spaces/mteb/leaderboard" target="_blank" style="color:var(--accent);">MTEB Leaderboard</a> (Retrieval Average, Jan 2025)
      </p>
    </div>

    <!-- Cost Comparison -->
    <div class="card" style="margin-top:16px;">
      <div class="card-title">💰 Cost per Million Tokens</div>
      <p style="color:var(--text-dim);font-size:13px;margin-bottom:16px;">
        Voyage AI offers significant cost savings, especially with asymmetric retrieval strategies.
      </p>
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="border-bottom:1px solid var(--border);">
            <th style="text-align:left;padding:8px 12px;color:var(--text-dim);">Provider / Model</th>
            <th style="text-align:right;padding:8px 12px;color:var(--text-dim);">Price</th>
            <th style="text-align:right;padding:8px 12px;color:var(--text-dim);">vs Voyage-3</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px 12px;font-weight:600;color:var(--accent);">Voyage-3-lite</td>
            <td style="text-align:right;padding:8px 12px;font-family:var(--mono);color:var(--accent);">$0.02</td>
            <td style="text-align:right;padding:8px 12px;color:var(--success);font-weight:600;">83% cheaper</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px 12px;font-weight:600;color:var(--accent);">Voyage-3</td>
            <td style="text-align:right;padding:8px 12px;font-family:var(--mono);color:var(--accent);">$0.06</td>
            <td style="text-align:right;padding:8px 12px;color:var(--text-dim);">baseline</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px 12px;color:var(--text-dim);">OpenAI text-3-large</td>
            <td style="text-align:right;padding:8px 12px;font-family:var(--mono);">$0.13</td>
            <td style="text-align:right;padding:8px 12px;color:var(--error);">2.2x more</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:8px 12px;color:var(--text-dim);">OpenAI text-3-small</td>
            <td style="text-align:right;padding:8px 12px;font-family:var(--mono);">$0.02</td>
            <td style="text-align:right;padding:8px 12px;color:var(--text-dim);">same</td>
          </tr>
          <tr>
            <td style="padding:8px 12px;color:var(--text-dim);">Cohere embed-v3</td>
            <td style="text-align:right;padding:8px 12px;font-family:var(--mono);">$0.10</td>
            <td style="text-align:right;padding:8px 12px;color:var(--error);">1.7x more</td>
          </tr>
        </tbody>
      </table>
      <div style="margin-top:16px;padding:12px;background:var(--accent-glow);border-radius:8px;border-left:3px solid var(--accent);">
        <strong style="color:var(--accent);">💡 Pro Tip: Asymmetric Retrieval</strong>
        <p style="margin:8px 0 0 0;font-size:13px;color:var(--text);">
          Embed your document corpus with <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">voyage-3-lite</code> ($0.02/M) and 
          query with <code style="background:var(--surface);padding:2px 6px;border-radius:4px;">voyage-3</code> ($0.06/M). 
          Because all Voyage-3 models share the same embedding space, you get top-tier retrieval quality at a fraction of the cost.
        </p>
      </div>
    </div>

    <!-- Key Differentiators -->
    <div class="card" style="margin-top:16px;">
      <div class="card-title">🚀 Voyage AI Advantages</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;margin-top:12px;">
        <div style="padding:16px;background:var(--surface);border-radius:8px;border:1px solid var(--border);">
          <div style="font-size:20px;margin-bottom:8px;">🔗</div>
          <div style="font-weight:600;margin-bottom:4px;">Shared Embedding Space</div>
          <div style="font-size:13px;color:var(--text-dim);">
            All Voyage-3 models produce compatible embeddings. Mix <code>voyage-3-large</code> for queries 
            with <code>voyage-3-lite</code> for documents — they work together seamlessly.
          </div>
        </div>
        <div style="padding:16px;background:var(--surface);border-radius:8px;border:1px solid var(--border);">
          <div style="font-size:20px;margin-bottom:8px;">🏢</div>
          <div style="font-weight:600;margin-bottom:4px;">Domain-Specific Models</div>
          <div style="font-size:13px;color:var(--text-dim);">
            Specialized models for code (<code>voyage-code-3</code>), finance, law, and multilingual content 
            that outperform general-purpose alternatives.
          </div>
        </div>
        <div style="padding:16px;background:var(--surface);border-radius:8px;border:1px solid var(--border);">
          <div style="font-size:20px;margin-bottom:8px;">⚡</div>
          <div style="font-weight:600;margin-bottom:4px;">Two-Stage Retrieval</div>
          <div style="font-size:13px;color:var(--text-dim);">
            Combine embedding search with <code>rerank-2</code> to dramatically boost precision. 
            The cross-encoder re-scores candidates for better relevance.
          </div>
        </div>
        <div style="padding:16px;background:var(--surface);border-radius:8px;border:1px solid var(--border);">
          <div style="font-size:20px;margin-bottom:8px;">🖼️</div>
          <div style="font-weight:600;margin-bottom:4px;">Multimodal Embeddings</div>
          <div style="font-size:13px;color:var(--text-dim);">
            <code>voyage-multimodal-3</code> embeds both text and images in the same space, 
            enabling cross-modal search (find images with text queries and vice versa).
          </div>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="card" style="margin-top:16px;text-align:center;padding:24px;">
      <div style="font-size:18px;font-weight:600;margin-bottom:8px;">Ready to try Voyage AI?</div>
      <p style="color:var(--text-dim);margin-bottom:16px;">Get a free API key and start building in minutes.</p>
      <a href="https://dash.voyageai.com" target="_blank" class="btn" style="display:inline-block;text-decoration:none;">
        Get API Key →
      </a>
      <span style="margin:0 12px;color:var(--text-dim);">or</span>
      <a href="https://docs.voyageai.com" target="_blank" style="color:var(--accent);">Read the Docs</a>
    </div>
  </div>

  <!-- ── Quantization Panel ── -->
  <div class="bench-view" id="bench-quantization">
    <div class="card">
      <div class="card-title">Quantization Benchmark</div>
      <p style="color:var(--text-dim);font-size:13px;margin-bottom:12px;">
        Compare how different output data types (float, int8, binary) affect storage size and ranking quality.
        Embeds the same corpus with each dtype and measures the tradeoff.
      </p>
      <div class="options-row" style="flex-wrap:wrap;">
        <div class="option-group">
          <span class="option-label">Model</span>
          <select id="quantModel"></select>
        </div>
        <div class="option-group">
          <span class="option-label">Dimensions</span>
          <select id="quantDimensions">
            <option value="">Default</option>
            <option value="256">256</option>
            <option value="512">512</option>
            <option value="1024">1024</option>
            <option value="2048">2048</option>
          </select>
        </div>
        <div class="option-group">
          <span class="option-label">Data Types</span>
          <div id="quantDtypeChecks" style="display:flex;gap:8px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="float" checked style="accent-color:var(--accent);">float
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="int8" checked style="accent-color:var(--accent);">int8
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="uint8" style="accent-color:var(--accent);">uint8
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="ubinary" checked style="accent-color:var(--accent);">ubinary
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="binary" style="accent-color:var(--accent);">binary
            </label>
          </div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <span class="option-label">Query</span>
        <input type="text" id="quantQuery" placeholder="Search query..." value="How do I search for similar documents using embeddings?" style="width:100%;margin-bottom:8px;">
      </div>
      <div>
        <span class="option-label">Corpus (one document per line)</span>
        <textarea id="quantCorpus" rows="5" placeholder="Documents to embed...">Vector search finds documents by computing similarity between embedding vectors in high-dimensional space.
MongoDB Atlas Vector Search lets you index and query vector embeddings alongside your operational data.
Traditional full-text search uses inverted indexes to match keyword terms in documents.
Cosine similarity measures the angle between two vectors, commonly used for semantic search.
Database sharding distributes data across multiple servers for horizontal scalability.
Embedding models convert text into dense numerical vectors that capture meaning.
Approximate nearest neighbor algorithms like HNSW enable fast similarity search at scale.
Reranking models rescore initial search results to improve relevance ordering.</textarea>
      </div>
      <div style="margin-top:12px;">
        <button class="btn" id="quantBtn" onclick="doBenchQuantization()">⚗️ Run Quantization Benchmark</button>
      </div>
    </div>

    <div class="error-msg" id="quantError"></div>

    <div class="result-section" id="quantResult">
      <div class="quant-charts">
        <div class="card">
          <div class="card-title">📦 Storage per Vector</div>
          <div id="quantStorageChart"></div>
        </div>
        <div class="card">
          <div class="card-title">⏱ API Latency</div>
          <div id="quantLatencyChart"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">🎯 Ranking Quality vs Float Baseline</div>
        <div id="quantQualityMeters" style="margin-bottom:16px;"></div>
        <div id="quantRankGrid"></div>
      </div>
    </div>
  </div>

  <!-- ── Cost Panel ── -->
  <div class="bench-view" id="bench-cost">
    <div class="card">
      <div class="card-title">💰 RAG Cost Calculator <button class="cost-help-btn" id="costHelpBtn" title="How the math works">?</button></div>

      <!-- Mode toggle -->
      <div style="margin-bottom: 20px;">
        <div class="cost-mode-toggle">
          <button class="cost-mode-btn active" data-mode="simple" id="costModeSimple">Simple</button>
          <button class="cost-mode-btn" data-mode="rag" id="costModeRag">RAG Planner</button>
        </div>
      </div>

      <!-- Simple mode (query cost comparison) -->
      <div id="costSimpleMode">
        <div class="cost-controls cost-controls-full">
          <div class="cost-slider-row">
            <span class="cost-slider-label">Tokens / query</span>
            <input type="range" class="cost-slider" id="costTokens" min="50" max="5000" value="500" step="50">
            <span class="cost-slider-value" id="costTokensValue">500</span>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Queries / day</span>
            <input type="range" class="cost-slider" id="costQueries" min="10" max="500000" value="1000" step="10">
            <span class="cost-slider-value" id="costQueriesValue">1,000</span>
          </div>
        </div>
        <table class="cost-table" id="costTable">
          <thead>
            <tr>
              <th>Model</th>
              <th>Type</th>
              <th>$/1M tokens</th>
              <th>Daily Cost</th>
              <th>Monthly Cost</th>
              <th style="width:30%">Relative</th>
            </tr>
          </thead>
          <tbody id="costTableBody"></tbody>
        </table>
      </div>

      <!-- RAG Planner mode (full TCO) -->
      <div id="costRagMode" style="display:none;">
        <div class="cost-section-title">📄 Documents (one-time ingestion)</div>
        <div class="cost-controls">
          <div class="cost-slider-row">
            <span class="cost-slider-label">Documents</span>
            <input type="range" class="cost-slider" id="ragDocs" min="1000" max="10000000" value="100000" step="1000">
            <span class="cost-slider-value" id="ragDocsValue">100K</span>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Tokens / doc</span>
            <input type="range" class="cost-slider" id="ragDocTokens" min="50" max="5000" value="500" step="50">
            <span class="cost-slider-value" id="ragDocTokensValue">500</span>
          </div>
        </div>

        <div class="cost-section-title">🔍 Queries (recurring)</div>
        <div class="cost-controls">
          <div class="cost-slider-row">
            <span class="cost-slider-label">Queries / month</span>
            <input type="range" class="cost-slider" id="ragQueries" min="1000" max="50000000" value="1000000" step="1000">
            <span class="cost-slider-value" id="ragQueriesValue">1M</span>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Tokens / query</span>
            <input type="range" class="cost-slider" id="ragQueryTokens" min="10" max="500" value="30" step="5">
            <span class="cost-slider-value" id="ragQueryTokensValue">30</span>
          </div>
        </div>

        <div class="cost-section-title">⚙️ Configuration</div>
        <div class="cost-controls">
          <div class="cost-model-row">
            <span class="cost-model-label">Doc model</span>
            <select class="cost-select" id="ragDocModel"></select>
          </div>
          <div class="cost-model-row">
            <span class="cost-model-label">Query model</span>
            <select class="cost-select" id="ragQueryModel"></select>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Projection</span>
            <input type="range" class="cost-slider" id="ragMonths" min="1" max="36" value="12" step="1">
            <span class="cost-slider-value" id="ragMonthsValue">12 mo</span>
          </div>
        </div>

        <!-- Summary cards -->
        <div class="cost-summary" id="ragSummary"></div>

        <!-- Strategy comparison -->
        <div class="cost-section-title">📊 Strategy Comparison</div>
        <div class="cost-strategy-cards" id="ragStrategies"></div>

        <!-- Per-model table -->
        <div class="cost-section-title">📋 Per-Model Breakdown</div>
        <table class="cost-table" id="ragTable">
          <thead>
            <tr>
              <th>Model</th>
              <th>Doc Cost</th>
              <th>Query $/mo</th>
              <th>Total (projected)</th>
              <th style="width:25%">Relative</th>
            </tr>
          </thead>
          <tbody id="ragTableBody"></tbody>
        </table>

        <div class="cost-tip" id="ragTip"></div>
      </div>
    </div>
  </div>

  <!-- ── History Panel ── -->
  <div class="bench-view" id="bench-history">
    <div class="card">
      <div class="card-title">Benchmark History</div>
      <div id="benchHistoryContent">
        <div class="history-empty">No benchmarks recorded yet. Run a latency benchmark to start tracking.</div>
      </div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn btn-secondary btn-small" onclick="clearHistory()">🗑 Clear History</button>
      </div>
    </div>
  </div>

</div>

<!-- ========== CHAT TAB ========== -->
<div class="tab-panel" id="tab-chat" role="tabpanel" aria-labelledby="tab-btn-chat" tabindex="0">
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-header-status" id="chatHeaderStatus">
        <span id="chatStatusProvider">No provider</span>
        <span>·</span>
        <span id="chatStatusDb">No database</span>
      </div>
      <button class="chat-config-toggle" id="chatConfigToggle" onclick="toggleChatConfig()" title="Chat settings">
        <svg width="14" height="14" viewBox="0 0 16 16"><use href="#lg-config"/></svg>
        Settings
      </button>
    </div>
    <div class="chat-config-panel" id="chatConfigPanel">
      <div class="chat-config-bar">
        <label>Provider:
          <select id="chatProvider" onchange="chatProviderChanged()">
            <option value="">Not configured</option>
            <option value="anthropic">Anthropic</option>
            <option value="openai">OpenAI</option>
            <option value="ollama">Ollama</option>
          </select>
        </label>
        <label>Model:
          <select id="chatModel" style="width:200px">
            <option value="">Loading...</option>
          </select>
        </label>
        <label>DB: <input type="text" id="chatDb" placeholder="database" style="width:120px" oninput="updateChatStatus()"></label>
        <label>Collection: <input type="text" id="chatCollection" placeholder="collection" style="width:120px" oninput="updateChatStatus()"></label>
      </div>
      <div class="chat-config-bar" style="padding-top:0">
        <label>Max docs: <input type="number" id="chatMaxDocs" value="5" min="1" max="20" style="width:50px"></label>
        <label><input type="checkbox" id="chatRerank" checked> Rerank</label>
      </div>
      <div class="chat-config-bar" style="padding-top:0">
        <label style="flex:1">Custom instructions: <input type="text" id="chatSystemPrompt" placeholder="e.g. You are a movie expert. Be enthusiastic." style="flex:1;width:100%"></label>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message system-msg">Chat with your knowledge base. Click <strong>Settings</strong> above to configure your LLM provider and database.</div>
    </div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" placeholder="Ask a question about your documents..." rows="1" onkeydown="chatInputKeydown(event)"></textarea>
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
    </div>
  </div>
</div>

<!-- ========== ABOUT TAB ========== -->
<div class="tab-panel" id="tab-about" role="tabpanel" aria-labelledby="tab-btn-about" tabindex="0">
  <div class="about-container">
    <div class="card">
      <div class="about-header">
        <img src="https://avatars.githubusercontent.com/u/192552?v=4" alt="Michael Lynn" class="about-avatar">
        <div>
          <div class="about-name">Michael Lynn</div>
          <div class="about-role">Principal Staff Developer Advocate · MongoDB</div>
          <div class="about-links">
            <a href="https://github.com/mrlynn" target="_blank" rel="noopener">🔗 GitHub</a>
            <a href="https://mlynn.org" target="_blank" rel="noopener">🌐 mlynn.org</a>
            <a href="https://www.npmjs.com/package/voyageai-cli" target="_blank" rel="noopener">📦 npm</a>
          </div>
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">About This Project</div>
        <div class="about-text">
          <strong>voyageai-cli</strong> (<code style="color:var(--accent);">vai</code>) is a community-built command-line tool for working with
          <a href="https://www.mongodb.com/docs/voyageai/" target="_blank">Voyage AI</a> embeddings, reranking, and
          <a href="https://www.mongodb.com/products/platform/atlas-vector-search" target="_blank">MongoDB Atlas Vector Search</a>.
          It was created to make it easier for developers to explore, benchmark, and integrate
          Voyage AI models into their applications — right from the terminal or this playground.
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">About Michael</div>
        <div class="about-text">
          Michael Lynn is a Principal Staff Developer Advocate at MongoDB with 25+ years in enterprise
          infrastructure and over a decade at MongoDB. He focuses on strategic developer relations,
          creating educational content around Vector Search, AI enablement, and developer tooling.
          He builds tools like this to help developers get hands-on with new technology faster.
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">What You Can Do Here</div>
        <div class="about-text">
          <strong>⚡ Embed</strong> — Generate vector embeddings for any text<br>
          <strong>⚖️ Compare</strong> — Measure similarity with cosine, dot product &amp; euclidean distance<br>
          <strong>🔍 Search</strong> — Semantic search with optional reranking<br>
          <strong>🔮 Multimodal</strong> — Compare images and text in the same vector space with voyage-multimodal-3.5<br>
          <strong>⏱ Benchmark</strong> — Compare model latency, ranking quality, and costs<br>
          <strong>📚 Explore</strong> — Learn about embeddings, vector search, multimodal, RAG, and more
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">Supported Models</div>
        <div class="about-text" style="font-size:13px;">
          <strong style="color:var(--accent);">Text Embeddings</strong> — voyage-4-large, voyage-4, voyage-4-lite, voyage-code-3, voyage-finance-2, voyage-law-2<br>
          <strong style="color:var(--accent);">Multimodal</strong> — voyage-multimodal-3.5 (text + images + video in one vector space)<br>
          <strong style="color:var(--accent);">Reranking</strong> — rerank-2.5, rerank-2.5-lite<br><br>
          All models are accessible via the <a href="https://docs.voyageai.com/" target="_blank" style="color:var(--blue);">Voyage AI API</a>
          or through <a href="https://www.mongodb.com/docs/atlas/atlas-vector-search/" target="_blank" style="color:var(--blue);">MongoDB Atlas Vector Search</a>.
        </div>
      </div>

      <div class="about-disclaimer">
        <div class="about-disclaimer-title">⚠️ Community Tool Disclaimer</div>
        <div class="about-disclaimer-text">
          This tool is <strong>not</strong> an official product of MongoDB, Inc. or Voyage AI.
          It is independently built and maintained by Michael Lynn as a community resource.
          It is not supported, endorsed, or guaranteed by either company. Use at your own discretion.
          For official documentation, visit
          <a href="https://www.mongodb.com/docs/voyageai/" target="_blank" style="color:var(--warning);">mongodb.com/docs/voyageai</a>.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="about-section" style="padding-bottom:0;">
        <div class="about-section-title">What's New</div>
        <div class="about-text" style="font-size:13px;">
          <strong>v1.2</strong> — Multimodal tab (image ↔ text similarity, cross-modal gallery search),
          4 new Explore concepts (multimodal embeddings, cross-modal search, modality gap, multimodal RAG),
          auto-update with in-app download &amp; restart, and a hidden easter egg 🕹️
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--text-muted);">
      Made with ☕ and curiosity · <a href="https://github.com/mrlynn/voyageai-cli" target="_blank" style="color:var(--text-dim);">Source on GitHub</a>
      · <a href="https://github.com/mrlynn/voyageai-cli/releases" target="_blank" style="color:var(--text-dim);">Releases</a>
    </div>
  </div>
</div>

<!-- ========== GENERATE TAB ========== -->
<div class="tab-panel" id="tab-generate" role="tabpanel" aria-labelledby="tab-btn-generate" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Generate</h2>
    <p class="page-header-subtitle">Generate code and scaffold projects</p>
  </div>

  <!-- Mode Toggle -->
  <div class="subtabs" role="tablist">
    <button class="subtab active" id="genModeCode" onclick="setGenerateMode('code')" role="tab" aria-selected="true">
      <svg viewBox="0 0 16 16"><path fill="currentColor" d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/></svg>
      Generate Code
    </button>
    <button class="subtab" id="genModeScaffold" onclick="setGenerateMode('scaffold')" role="tab" aria-selected="false">
      <svg viewBox="0 0 16 16"><path fill="currentColor" d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/><path fill="currentColor" d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8zm0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-1-5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zM4 8a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0zm0 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/></svg>
      Scaffold Project
    </button>
  </div>

  <!-- Generate Code Panel -->
  <div id="generateCodePanel" style="display:block;">
    <div class="card">
      <div class="card-header"><h3>Generate Code Snippet</h3></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Target Framework</span>
            <select id="genTarget" onchange="updateGenComponents()" style="width:100%;">
              <option value="vanilla">Node.js + Express</option>
              <option value="nextjs">Next.js + MUI</option>
              <option value="python">Python + Flask</option>
            </select>
          </label>
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Component</span>
            <select id="genComponent" style="width:100%;">
              <option value="client">API Client</option>
              <option value="connection">MongoDB Connection</option>
              <option value="retrieval">RAG Retrieval</option>
              <option value="ingest">Document Ingest</option>
              <option value="search-api">Search API</option>
            </select>
          </label>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Model</span>
            <select id="genModel" style="width:100%;">
              <option value="voyage-4-large">voyage-4-large</option>
              <option value="voyage-4">voyage-4</option>
              <option value="voyage-4-lite">voyage-4-lite</option>
              <option value="voyage-3-large">voyage-3-large</option>
            </select>
          </label>
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Database</span>
            <input type="text" id="genDb" value="myapp" style="width:100%;">
          </label>
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Collection</span>
            <input type="text" id="genCollection" value="documents" style="width:100%;">
          </label>
        </div>

        <label style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
          <input type="checkbox" id="genRerank" checked>
          <span>Include reranking</span>
        </label>

        <button class="btn btn-primary" onclick="generateCode()" id="genCodeBtn">
          Generate Code
        </button>
      </div>
    </div>

    <!-- Generated Code Output -->
    <div class="card" id="genOutputCard" style="margin-top:16px;display:none;">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="genOutputFilename">Generated Code</h3>
        <button class="btn btn-outline" onclick="copyGeneratedCode()" style="padding:4px 12px;">Copy</button>
      </div>
      <div class="card-body" style="padding:0;">
        <pre id="genOutputCode" style="margin:0;padding:16px;overflow:auto;max-height:500px;background:var(--surface-darker);border-radius:0 0 8px 8px;font-size:13px;"></pre>
      </div>
    </div>
  </div>

  <!-- Scaffold Project Panel -->
  <div id="scaffoldPanel" style="display:none;">
    <div class="card">
      <div class="card-header"><h3>Scaffold New Project</h3></div>
      <div class="card-body">
        <p style="margin-bottom:16px;color:var(--text-dim);">Create a complete, ready-to-run project with all files pre-configured.</p>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Project Name</span>
            <input type="text" id="scaffoldName" value="my-rag-app" placeholder="my-rag-app" style="width:100%;">
          </label>
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Target Framework</span>
            <select id="scaffoldTarget" onchange="updateScaffoldPreview()" style="width:100%;">
              <option value="vanilla">Node.js + Express (9 files)</option>
              <option value="nextjs">Next.js + MUI (13 files)</option>
              <option value="python">Python + Flask (8 files)</option>
            </select>
          </label>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Model</span>
            <select id="scaffoldModel" style="width:100%;">
              <option value="voyage-4-large">voyage-4-large</option>
              <option value="voyage-4">voyage-4</option>
              <option value="voyage-4-lite">voyage-4-lite</option>
            </select>
          </label>
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Database</span>
            <input type="text" id="scaffoldDb" value="myapp" style="width:100%;">
          </label>
          <label>
            <span style="display:block;margin-bottom:4px;font-weight:500;">Collection</span>
            <input type="text" id="scaffoldCollection" value="documents" style="width:100%;">
          </label>
        </div>

        <!-- Location Picker (Electron only) -->
        <div id="scaffoldLocationSection" style="margin-bottom:16px;display:none;">
          <span style="display:block;margin-bottom:4px;font-weight:500;">Location</span>
          <div style="display:flex;gap:8px;">
            <input type="text" id="scaffoldPath" readonly placeholder="Choose a folder..." style="flex:1;background:var(--surface-darker);">
            <button class="btn btn-outline" onclick="pickScaffoldDirectory()">Browse...</button>
          </div>
        </div>

        <!-- Web Mode: Download ZIP -->
        <div id="scaffoldWebSection" style="margin-bottom:16px;display:none;">
          <div style="padding:12px;background:var(--surface-darker);border-radius:8px;margin-bottom:12px;">
            <p style="margin:0;font-size:14px;">📦 <strong>Web Mode</strong> — Download as ZIP or use CLI</p>
            <p style="margin:8px 0 0;font-size:13px;color:var(--text-dim);">
              CLI: <code style="padding:4px 8px;background:var(--surface);border-radius:4px;">vai scaffold <span id="scaffoldCliName">my-rag-app</span> --target <span id="scaffoldCliTarget">vanilla</span></code>
            </p>
          </div>
        </div>

        <!-- Buttons: different for Electron vs Web -->
        <div id="scaffoldElectronButtons" style="display:none;">
          <button class="btn btn-primary" onclick="createScaffold()" id="scaffoldBtn" disabled>
            Create Project
          </button>
        </div>
        <div id="scaffoldWebButtons" style="display:none;">
          <button class="btn btn-primary" onclick="downloadScaffoldZip()" id="scaffoldDownloadBtn">
            <svg width="16" height="16" viewBox="0 0 16 16" style="margin-right:6px;"><path fill="currentColor" d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path fill="currentColor" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
            Download ZIP
          </button>
        </div>
      </div>
    </div>

    <!-- Scaffold Progress/Result -->
    <div class="card" id="scaffoldResultCard" style="margin-top:16px;display:none;">
      <div class="card-header"><h3>Project Created</h3></div>
      <div class="card-body">
        <div id="scaffoldResult"></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== EXPLORE TAB ========== -->
<div class="tab-panel" id="tab-explore" role="tabpanel" aria-labelledby="tab-btn-explore" tabindex="0">
  <div class="page-header">
    <h2 class="page-header-title">Explore</h2>
    <p class="page-header-subtitle">Learn embedding and vector search concepts</p>
    <p class="page-header-hint">Browse interactive explanations of key topics — from cosine similarity to quantization to RAG pipelines.</p>
  </div>
  <div style="margin-bottom:16px;">
    <input type="text" id="exploreSearch" placeholder="🔍 Search concepts..." oninput="filterExplore()" style="max-width:400px;" aria-label="Search concepts">
  </div>
  <div class="explore-grid" id="exploreGrid"></div>
</div>

<!-- Explore Concept Modal -->
<div class="explore-modal-overlay" id="exploreModal" role="dialog" aria-modal="true" aria-labelledby="exploreModalTitle" aria-describedby="exploreModalSummary">
  <div class="explore-modal">
    <button class="explore-modal-close" id="exploreModalClose" aria-label="Close modal">&times;</button>
    <div class="explore-modal-header">
      <div class="explore-modal-icon" id="exploreModalIcon" aria-hidden="true"></div>
      <div>
        <div class="explore-modal-title" id="exploreModalTitle"></div>
        <div class="explore-modal-summary" id="exploreModalSummary"></div>
      </div>
    </div>
    <div class="explore-modal-body" id="exploreModalBody"></div>
    <div class="explore-modal-actions" id="exploreModalActions"></div>
  </div>
</div>

<!-- Hidden global model select (used by JS for model sync) -->
<select id="globalModel" style="display:none;"></select>

<!-- ========== SETTINGS TAB ========== -->
<div class="tab-panel" id="tab-settings">
  <div class="settings-container">
    <div class="page-header">
      <h2 class="page-header-title">Settings</h2>
      <p class="page-header-subtitle">Configure appearance, models, and API access</p>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Appearance</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Theme</span>
          <span class="settings-label-hint">Controls the color scheme of the interface</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsTheme">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Vector Heatmap Colors</span>
          <span class="settings-label-hint">Color palette for embedding visualizations</span>
        </div>
        <div class="settings-control" style="display:flex;align-items:center;gap:8px;">
          <select class="settings-select" id="settingsHeatmap">
            <option value="viridis">Viridis</option>
            <option value="plasma">Plasma</option>
            <option value="inferno">Inferno</option>
            <option value="magma">Magma</option>
            <option value="cividis">Cividis</option>
            <option value="turbo">Turbo</option>
          </select>
          <span class="heatmap-preview" id="heatmapPreview"></span>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Models</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Default Embedding Model</span>
          <span class="settings-label-hint">Pre-selected model for Embed and Compare tabs</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsDefaultModel"></select>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Default Input Type</span>
          <span class="settings-label-hint">Pre-selected input type for embedding requests</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsInputType">
            <option value="document">document</option>
            <option value="query">query</option>
          </select>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">API</div>
      <div class="settings-api-banner" id="settingsApiBanner">
        <span class="settings-api-banner-icon" id="settingsApiBannerIcon">⚠️</span>
        <span id="settingsApiKeyMsg">No API key configured — add your key below to get started.</span>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">API Key</span>
          <span class="settings-label-hint">Encrypted via OS keychain · <a href="https://dash.voyageai.com" target="_blank" class="settings-key-link">🔑 Get a key</a></span>
        </div>
        <div class="settings-control" style="min-width:260px;">
          <div class="settings-api-field">
            <input type="password" id="settingsApiKey" placeholder="pa-..." autocomplete="off" spellcheck="false">
            <button type="button" id="settingsApiKeyToggle" title="Show/hide key">👁</button>
            <button type="button" id="settingsApiKeySave" class="save-btn" title="Save key">Save</button>
          </div>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">API Base URL</span>
          <span class="settings-label-hint">Override the default endpoint (leave empty for default)</span>
        </div>
        <div class="settings-control">
          <input type="text" class="settings-input" id="settingsApiBase" placeholder="https://api.voyageai.com/v1">
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Request Timeout</span>
          <span class="settings-label-hint">Max seconds to wait for API responses</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsTimeout">
            <option value="15">15 seconds</option>
            <option value="30" selected>30 seconds</option>
            <option value="60">60 seconds</option>
            <option value="120">120 seconds</option>
          </select>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Benchmark Defaults</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Iterations per Model</span>
          <span class="settings-label-hint">Number of runs when benchmarking latency</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsBenchIter">
            <option value="3">3 runs</option>
            <option value="5" selected>5 runs</option>
            <option value="10">10 runs</option>
            <option value="20">20 runs</option>
          </select>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Show Detailed Timings</span>
          <span class="settings-label-hint">Display p50/p95/p99 in benchmark results</span>
        </div>
        <div class="settings-control">
          <button class="settings-toggle" id="settingsDetailedTimings" type="button"></button>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Help</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Welcome Tour</span>
          <span class="settings-label-hint">Replay the onboarding walkthrough</span>
        </div>
        <div class="settings-control">
          <button class="settings-reset-btn" id="settingsShowTour" style="background:var(--accent);color:var(--bg);">Show Welcome Tour</button>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Data &amp; Privacy</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Persist Embeddings Locally</span>
          <span class="settings-label-hint">Cache embedding results in browser storage to avoid re-fetching</span>
        </div>
        <div class="settings-control">
          <button class="settings-toggle active" id="settingsCacheEmbeddings" type="button"></button>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Clear Cached Data</span>
          <span class="settings-label-hint">Remove all locally stored embeddings and preferences</span>
        </div>
        <div class="settings-control">
          <button class="settings-reset-btn" id="settingsClearCache">Clear All Data</button>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Anonymous Usage Analytics</span>
          <span class="settings-label-hint">Help improve Vai by sharing anonymous usage data (version, platform, features used). No API keys or personal data.</span>
        </div>
        <div class="settings-control">
          <button class="settings-toggle active" id="settingsTelemetry" type="button"></button>
        </div>
      </div>
    </div>

    <!-- Version Info (visible in Electron only) -->
    <div class="settings-section" id="settingsVersionSection" style="display:none;">
      <div class="settings-section-title">Version</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Vai Desktop</span>
          <span class="settings-label-hint">Electron desktop application</span>
        </div>
        <div class="settings-control">
          <span class="version-badge" id="settingsAppVersion">—</span>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Vai CLI Engine</span>
          <span class="settings-label-hint">Underlying CLI powering embeddings, search &amp; reranking</span>
        </div>
        <div class="settings-control">
          <span class="version-badge" id="settingsCliVersion">—</span>
        </div>
      </div>
    </div>

    <div style="text-align:center;padding:8px 0;">
      <span class="settings-saved" id="settingsSavedMsg">✓ Saved</span>
    </div>

  </div>
</div>

</div><!-- .main -->
</div><!-- .content-area -->
</div><!-- .app-shell -->

<!-- Onboarding Walkthrough Overlay -->
<div class="onboarding-overlay" id="onboardingOverlay">
  <div class="onboarding-backdrop" id="onboardingBackdrop"></div>
  <div class="onboarding-spotlight" id="onboardingSpotlight"></div>
  <!-- Welcome card (step 0) -->
  <div class="onboarding-welcome-center" id="onboardingWelcomeWrap">
    <div class="onboarding-welcome-card" id="onboardingWelcomeCard">
      <img class="onboarding-welcome-logo" id="onboardingLogo" src="/icons/dark/64.png" alt="Vai">
      <div class="onboarding-welcome-title">Welcome to Vai</div>
      <div class="onboarding-welcome-sub">Explore embeddings, compare text similarity, and search with vector models — all from one playground.</div>
      <div class="onboarding-footer" style="justify-content:center;">
        <button class="onboarding-skip" id="onboardingWelcomeSkip">Skip tour</button>
        <button class="onboarding-next" id="onboardingWelcomeNext">Take the tour →</button>
      </div>
    </div>
  </div>
  <!-- Tooltip for steps 1-4 -->
  <div class="onboarding-tooltip" id="onboardingTooltip">
    <div class="onboarding-tooltip-arrow top" id="onboardingArrow"></div>
    <div class="onboarding-step-icon" id="onboardingIcon"></div>
    <div class="onboarding-step-title" id="onboardingTitle"></div>
    <div class="onboarding-step-body" id="onboardingBody"></div>
    <div class="onboarding-footer">
      <div class="onboarding-dots" id="onboardingDots"></div>
      <div class="onboarding-actions">
        <button class="onboarding-skip" id="onboardingSkip">Skip</button>
        <button class="onboarding-next" id="onboardingNext">Next</button>
      </div>
    </div>
  </div>
</div>

<script>
// Apply saved theme immediately to prevent flash
(function() {
  var t = localStorage.getItem('vai-theme') || 'dark';
  if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
  // Set correct logo immediately
  var logo = document.getElementById('sidebarLogo');
  if (logo) logo.src = '/icons/' + (t === 'light' ? 'light' : 'dark') + '/64.png';
})();
</script>
<script>
(function() {
'use strict';

// ── Theme Toggle ──
function initThemeToggle() {
  const toggle = document.getElementById('themeToggle');
  const saved = localStorage.getItem('vai-theme') || 'dark';
  let current = saved;

  function applyTheme(theme) {
    current = theme;
    const logo = document.getElementById('sidebarLogo');
    if (theme === 'light') {
      document.documentElement.setAttribute('data-theme', 'light');
      toggle.textContent = '☀️';
      toggle.title = 'Switch to dark mode';
      if (logo) logo.src = '/icons/light/64.png';
    } else {
      document.documentElement.removeAttribute('data-theme');
      toggle.textContent = '🌙';
      toggle.title = 'Switch to light mode';
      if (logo) logo.src = '/icons/dark/64.png';
    }
    localStorage.setItem('vai-theme', theme);
  }

  applyTheme(current);
  toggle.addEventListener('click', () => {
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    // Sync settings panel dropdown
    const themeSel = document.getElementById('settingsTheme');
    if (themeSel) themeSel.value = next;
  });
}

// ── State ──
let allModels = [];
let embedModels = [];
let rerankModels = [];
let lastEmbedding = null;

// ── Init ──
// ── Anonymous Telemetry ──
const TELEMETRY_URL = 'https://vai.mlynn.org/api/telemetry';
const TELEMETRY_KEY = 'vai-telemetry-enabled';

function isTelemetryEnabled() {
  const stored = localStorage.getItem(TELEMETRY_KEY);
  return stored === null ? true : stored === 'true'; // default on
}

function sendTelemetry(event, extra = {}) {
  if (!isTelemetryEnabled()) return;
  try {
    const isElectron = !!(window.vai && window.vai.isElectron);
    const payload = {
      event,
      version: document.getElementById('appVersionLabel')?.textContent?.replace('v','') || 'web',
      context: isElectron ? 'electron' : 'web',
      platform: navigator.platform || undefined,
      locale: navigator.language || undefined,
      ...extra,
    };
    // Use sendBeacon for fire-and-forget (survives page unload)
    if (navigator.sendBeacon) {
      navigator.sendBeacon(TELEMETRY_URL, JSON.stringify(payload));
    } else {
      fetch(TELEMETRY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        keepalive: true,
      }).catch(() => {});
    }
  } catch { /* telemetry should never break the app */ }
}

function initTelemetryToggle() {
  const toggle = document.getElementById('settingsTelemetry');
  if (!toggle) return;
  const enabled = isTelemetryEnabled();
  toggle.classList.toggle('active', enabled);
  toggle.addEventListener('click', () => {
    const nowEnabled = !toggle.classList.contains('active');
    toggle.classList.toggle('active', nowEnabled);
    localStorage.setItem(TELEMETRY_KEY, String(nowEnabled));
    showSettingsSaved();
  });
}

async function init() {
  // Mark body for Electron vs Web styling
  if (window.vai && window.vai.isElectron) {
    document.body.classList.add('is-electron');
  }
  setupTabs();
  await loadConfig();
  await Promise.all([loadModels(), loadConcepts()]);
  populateModelSelects();
  buildExploreCards();

  // Telemetry
  initTelemetryToggle();
  sendTelemetry('app_launch');
}

// ── Tabs ──
function setupTabs() {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabList = Array.from(tabBtns);
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      switchTab(btn.dataset.tab);
    });
    
    // Keyboard navigation for accessibility
    btn.addEventListener('keydown', (e) => {
      const currentIndex = tabList.indexOf(btn);
      let nextIndex = -1;
      
      if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
        e.preventDefault();
        nextIndex = (currentIndex + 1) % tabList.length;
      } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
        e.preventDefault();
        nextIndex = (currentIndex - 1 + tabList.length) % tabList.length;
      } else if (e.key === 'Home') {
        e.preventDefault();
        nextIndex = 0;
      } else if (e.key === 'End') {
        e.preventDefault();
        nextIndex = tabList.length - 1;
      }
      
      if (nextIndex >= 0) {
        tabList[nextIndex].focus();
        switchTab(tabList[nextIndex].dataset.tab);
      }
    });
  });

  // Settings cog in header
  const settingsCog = document.querySelector('.sidebar-settings-btn');
  if (settingsCog) {
    settingsCog.addEventListener('click', () => {
      switchTab(settingsCog.dataset.tab);
    });
  }
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    const isActive = b.dataset.tab === tab;
    b.classList.toggle('active', isActive);
    // Update ARIA attributes for accessibility
    b.setAttribute('aria-selected', isActive ? 'true' : 'false');
    b.setAttribute('tabindex', isActive ? '0' : '-1');
  });
  document.querySelectorAll('.tab-panel').forEach(p => {
    const isActive = p.id === 'tab-' + tab;
    p.classList.toggle('active', isActive);
    // Hide inactive panels from screen readers
    p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
  });
  // Sync settings cog highlight
  const settingsBtn = document.querySelector('.sidebar-settings-btn');
  if (settingsBtn) settingsBtn.classList.toggle('active', tab === 'settings');
  // Track tab views
  sendTelemetry('tab_view', { tab });
}
// Expose globally so Electron main process can call it
window.switchTab = switchTab;

// ── Config ──
async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    const data = await res.json();
    const dot = document.getElementById('statusDot');
    const label = document.getElementById('statusLabel');
    if (data.hasKey) {
      dot.className = 'status-dot connected';
      label.textContent = 'Connected';
    } else {
      dot.className = 'status-dot error';
      label.textContent = 'No API Key';
    }
  } catch {
    document.getElementById('statusDot').className = 'status-dot error';
    document.getElementById('statusLabel').textContent = 'Error';
  }
}

// ── Models ──
async function loadModels() {
  try {
    const res = await fetch('/api/models');
    const data = await res.json();
    allModels = data.models || [];
    embedModels = allModels.filter(m => m.type === 'embedding');
    rerankModels = allModels.filter(m => m.type === 'reranking');
  } catch {
    console.error('Failed to load models');
  }
}

function populateModelSelects() {
  const saved = localStorage.getItem('vai-playground-model');
  const embedSelects = ['globalModel', 'embedModel', 'compareModel', 'searchEmbedModel'];
  embedSelects.forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    embedModels.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name + ' — ' + m.shortFor;
      sel.appendChild(opt);
    });
    if (saved) sel.value = saved;
  });

  const rerankSel = document.getElementById('searchRerankModel');
  rerankSel.innerHTML = '';
  rerankModels.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.name;
    opt.textContent = m.name + ' — ' + m.shortFor;
    rerankSel.appendChild(opt);
  });

  // Sync global model to others
  document.getElementById('globalModel').addEventListener('change', function() {
    const v = this.value;
    localStorage.setItem('vai-playground-model', v);
    ['embedModel', 'compareModel', 'searchEmbedModel'].forEach(id => {
      document.getElementById(id).value = v;
    });
  });
}

// ── API Helpers ──
function formatBytesUI(bytes) {
  if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  if (bytes >= 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return bytes + ' B';
}

async function apiPost(url, body) {
  let res;
  try {
    res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
  } catch (fetchErr) {
    throw new Error('Failed to connect to server. Is the playground still running?');
  }
  const data = await res.json();
  if (!res.ok) {
    if (data.code === 'NO_API_KEY') {
      throw new Error('🔑 No API key configured. Open Settings (⚙) to add your Voyage AI API key, or run: vai config set api-key <your-key>');
    }
    throw new Error(data.error || data.detail || 'API error');
  }
  return data;
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = '⚠ ' + msg;
  el.classList.add('visible');
}

function hideError(id) {
  document.getElementById(id).classList.remove('visible');
}

function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if (loading) {
    btn.disabled = true;
    btn._origHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span> Working...';
  } else {
    btn.disabled = false;
    btn.innerHTML = btn._origHTML || btn.innerHTML;
  }
}

// ── Embed ──
window.doEmbed = async function() {
  hideError('embedError');
  const text = document.getElementById('embedInput').value.trim();
  if (!text) { showError('embedError', 'Enter some text to embed'); return; }
  sendTelemetry('api_call', { endpoint: 'embed', model: document.getElementById('embedModel').value });

  setLoading('embedBtn', true);
  try {
    const model = document.getElementById('embedModel').value;
    const inputType = document.getElementById('embedInputType').value || undefined;
    const dims = document.getElementById('embedDimensions').value;
    const dimensions = dims ? parseInt(dims, 10) : undefined;

    const outputDtype = document.getElementById('embedOutputDtype').value;
    const body = { texts: [text], model, inputType, dimensions };
    if (outputDtype && outputDtype !== 'float') body.output_dtype = outputDtype;

    const data = await apiPost('/api/embed', body);
    const emb = data.data[0].embedding;
    lastEmbedding = emb;

    // Stats
    const dtype = outputDtype || 'float';
    const bytesPerDim = (dtype === 'binary' || dtype === 'ubinary') ? 0.125 : (dtype === 'int8' || dtype === 'uint8') ? 1 : 4;
    const totalBytes = emb.length * bytesPerDim;
    const storageLine = dtype !== 'float'
      ? `<br><span style="color:var(--success)">📦 ${dtype}: ${formatBytesUI(totalBytes)}/vector (${(4 * emb.length / totalBytes).toFixed(0)}× smaller than float)</span>`
      : '';

    const statsEl = document.getElementById('embedStats');
    statsEl.innerHTML = `
      <span class="stat"><span class="stat-label">Model</span><span class="stat-value">${data.model}</span></span>
      <span class="stat"><span class="stat-label">Dimensions</span><span class="stat-value">${emb.length}</span></span>
      <span class="stat"><span class="stat-label">Tokens</span><span class="stat-value">${data.usage?.total_tokens || '—'}</span></span>
      <span class="stat"><span class="stat-label">Type</span><span class="stat-value">${dtype}</span></span>
      ${storageLine}
    `;

    // Vector preview
    const preview = emb.slice(0, 20).map(v => v.toFixed(6)).join(', ');
    document.getElementById('embedVector').textContent = `[${preview}, ... ] (${emb.length} values)`;

    // Heatmap
    buildHeatmap(emb, document.getElementById('embedHeatmap'));

    document.getElementById('embedResult').classList.add('visible');
  } catch (err) {
    showError('embedError', err.message);
  } finally {
    setLoading('embedBtn', false);
  }
};

window.copyVector = function() {
  if (!lastEmbedding) return;
  navigator.clipboard.writeText(JSON.stringify(lastEmbedding)).then(() => {
    const btn = document.querySelector('[onclick="copyVector()"]');
    const orig = btn.textContent;
    btn.textContent = '✅ Copied!';
    setTimeout(() => btn.textContent = orig, 1500);
  });
};

function buildHeatmap(vec, container) {
  container.innerHTML = '';
  // Sample down to ~200 bars for visual
  const step = Math.max(1, Math.floor(vec.length / 200));
  const sampled = [];
  for (let i = 0; i < vec.length; i += step) sampled.push(vec[i]);

  const min = Math.min(...sampled);
  const max = Math.max(...sampled);
  const range = max - min || 1;

  sampled.forEach(v => {
    const bar = document.createElement('div');
    bar.className = 'heatmap-bar';
    const norm = (v - min) / range; // 0-1
    const h = Math.round(norm * 160); // hue: 0=red, 80=yellow-green, 160=cyan/teal
    bar.style.background = `hsl(${h}, 80%, 50%)`;
    container.appendChild(bar);
  });
}

// ── Compare ──
window.doCompare = async function() {
  hideError('compareError');
  sendTelemetry('api_call', { endpoint: 'compare', model: document.getElementById('compareModel').value });
  const a = document.getElementById('compareA').value.trim();
  const b = document.getElementById('compareB').value.trim();
  if (!a || !b) { showError('compareError', 'Enter text in both fields'); return; }

  setLoading('compareBtn', true);
  try {
    const model = document.getElementById('compareModel').value;
    const dims = document.getElementById('compareDimensions').value;
    const dimensions = dims ? parseInt(dims, 10) : undefined;

    const data = await apiPost('/api/similarity', { texts: [a, b], model, dimensions });

    // Get raw embeddings for all metrics
    const vecA = data.embeddings[0].embedding;
    const vecB = data.embeddings[1].embedding;

    const cosine = cosineSim(vecA, vecB);
    const dot = dotProduct(vecA, vecB);
    const euclid = euclideanDist(vecA, vecB);

    // Hero display — cosine similarity
    const cosinePct = Math.max(0, cosine * 100);
    let cosineColor;
    if (cosine > 0.7) cosineColor = 'var(--green)';
    else if (cosine > 0.4) cosineColor = 'var(--yellow)';
    else cosineColor = 'var(--red)';

    const scoreEl = document.getElementById('simScore');
    scoreEl.textContent = cosine.toFixed(4);
    scoreEl.style.color = cosineColor;

    const barEl = document.getElementById('simBar');
    barEl.style.width = cosinePct + '%';
    barEl.style.background = cosineColor;

    // Metric cards — all three
    const dotColor = dot > 0.7 ? 'var(--green)' : dot > 0.4 ? 'var(--yellow)' : 'var(--red)';
    // Euclidean: 0 = identical, ~2 = max for normalized vectors. Invert for color.
    const euclidColor = euclid < 0.6 ? 'var(--green)' : euclid < 1.0 ? 'var(--yellow)' : 'var(--red)';
    // For euclidean bar, invert: 0 dist = 100% bar, 2.0 dist = 0%
    const euclidPct = Math.max(0, Math.min(100, (1 - euclid / 2) * 100));

    const metricsEl = document.getElementById('metricsGrid');
    metricsEl.innerHTML = `
      <div class="metric-card primary">
        <div class="metric-card-value" style="color:${cosineColor}">${cosine.toFixed(4)}</div>
        <div class="metric-card-name">Cosine Similarity</div>
        <div class="metric-card-desc">Angle between vectors (−1 to 1). Standard for semantic search.</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${cosinePct}%;background:${cosineColor}"></div></div>
      </div>
      <div class="metric-card">
        <div class="metric-card-value" style="color:${dotColor}">${dot.toFixed(4)}</div>
        <div class="metric-card-name">Dot Product</div>
        <div class="metric-card-desc">Sum of element-wise products. Equals cosine for normalized vectors.</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${Math.max(0, dot * 100)}%;background:${dotColor}"></div></div>
      </div>
      <div class="metric-card">
        <div class="metric-card-value" style="color:${euclidColor}">${euclid.toFixed(4)}</div>
        <div class="metric-card-name">Euclidean Distance</div>
        <div class="metric-card-desc">Straight-line distance (0 = identical). Lower is more similar.</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${euclidPct}%;background:${euclidColor}"></div></div>
      </div>
    `;

    // Insight note
    const noteEl = document.getElementById('metricNote');
    const diff = Math.abs(cosine - dot);
    if (diff < 0.001) {
      noteEl.innerHTML = '💡 <strong>Cosine ≈ Dot Product</strong> — these vectors are L2-normalized (as Voyage AI models produce), so cosine similarity and dot product give identical results. Euclidean distance is <code>√(2 − 2·cosine)</code> for normalized vectors.';
    } else {
      noteEl.innerHTML = '💡 Cosine and dot product differ because these vectors are not perfectly L2-normalized. Atlas Vector Search uses cosine by default.';
    }

    // Stats
    const statsEl = document.getElementById('compareStats');
    statsEl.innerHTML = `
      <span class="stat"><span class="stat-label">Model</span><span class="stat-value">${data.model}</span></span>
      <span class="stat"><span class="stat-label">Dimensions</span><span class="stat-value">${vecA.length}</span></span>
      <span class="stat"><span class="stat-label">Tokens</span><span class="stat-value">${data.usage?.total_tokens || '—'}</span></span>
    `;

    document.getElementById('compareResult').classList.add('visible');
  } catch (err) {
    showError('compareError', err.message);
  } finally {
    setLoading('compareBtn', false);
  }
};

// ── Search ──
window.doSearch = async function(withRerank) {
  hideError('searchError');
  sendTelemetry('api_call', { endpoint: withRerank ? 'rerank' : 'search' });
  const query = document.getElementById('searchQuery').value.trim();
  const docsText = document.getElementById('searchDocs').value.trim();
  if (!query || !docsText) { showError('searchError', 'Enter a query and documents'); return; }

  const documents = docsText.split('\n').map(d => d.trim()).filter(d => d);
  if (documents.length < 2) { showError('searchError', 'Enter at least 2 documents'); return; }

  const btnId = withRerank ? 'searchRerankBtn' : 'searchBtn';
  setLoading('searchBtn', true);
  setLoading('searchRerankBtn', true);

  try {
    const embedModel = document.getElementById('searchEmbedModel').value;
    const topK = parseInt(document.getElementById('searchTopK').value, 10);

    // Embed query + docs
    const allTexts = [query, ...documents];
    const embedData = await apiPost('/api/embed', { texts: allTexts, model: embedModel });
    const vecs = embedData.data.map(d => d.embedding);
    const queryVec = vecs[0];
    const docVecs = vecs.slice(1);

    // Compute similarity
    const scores = docVecs.map((dv, i) => ({
      index: i,
      text: documents[i],
      score: cosineSim(queryVec, dv),
    }));
    scores.sort((a, b) => b.score - a.score);
    const embeddingResults = scores.slice(0, topK);

    let rerankResults = null;
    if (withRerank) {
      const rerankModel = document.getElementById('searchRerankModel').value;
      const rerankData = await apiPost('/api/rerank', { query, documents, model: rerankModel, topK });
      rerankResults = rerankData.data.map(r => ({
        index: r.index,
        text: documents[r.index],
        score: r.relevance_score,
      }));
    }

    renderSearchResults(embeddingResults, rerankResults);
    document.getElementById('searchResult').classList.add('visible');
  } catch (err) {
    showError('searchError', err.message);
  } finally {
    setLoading('searchBtn', false);
    setLoading('searchRerankBtn', false);
  }
};

function cosineSim(a, b) {
  let dot = 0, normA = 0, normB = 0;
  for (let i = 0; i < a.length; i++) {
    dot += a[i] * b[i];
    normA += a[i] * a[i];
    normB += b[i] * b[i];
  }
  return dot / (Math.sqrt(normA) * Math.sqrt(normB));
}

function dotProduct(a, b) {
  let sum = 0;
  for (let i = 0; i < a.length; i++) sum += a[i] * b[i];
  return sum;
}

function euclideanDist(a, b) {
  let sum = 0;
  for (let i = 0; i < a.length; i++) sum += (a[i] - b[i]) ** 2;
  return Math.sqrt(sum);
}

function renderSearchResults(embResults, rerankResults) {
  const grid = document.getElementById('searchResultGrid');
  grid.innerHTML = '';
  grid.className = rerankResults ? 'search-results' : 'search-results single-col';

  const maxEmbScore = Math.max(...embResults.map(r => r.score));

  // Embedding column
  const embCol = document.createElement('div');
  embCol.innerHTML = '<div class="card-title">Embedding Search</div>';
  embResults.forEach((r, i) => {
    embCol.appendChild(createResultItem(i + 1, r, maxEmbScore));
  });
  grid.appendChild(embCol);

  // Rerank column
  if (rerankResults) {
    const maxRerankScore = Math.max(...rerankResults.map(r => r.score));
    const embRankMap = {};
    embResults.forEach((r, i) => { embRankMap[r.index] = i + 1; });

    const rerankCol = document.createElement('div');
    rerankCol.innerHTML = '<div class="card-title">After Reranking</div>';
    rerankResults.forEach((r, i) => {
      const newRank = i + 1;
      const oldRank = embRankMap[r.index];
      const movement = oldRank !== undefined ? oldRank - newRank : 0;
      rerankCol.appendChild(createResultItem(newRank, r, maxRerankScore, movement));
    });
    grid.appendChild(rerankCol);
  }
}

function createResultItem(rank, result, maxScore, movement) {
  const item = document.createElement('div');
  let moveClass = '';
  if (movement > 0) moveClass = ' moved-up';
  else if (movement < 0) moveClass = ' moved-down';

  const pct = maxScore > 0 ? (result.score / maxScore * 100) : 0;
  const truncText = result.text.length > 80 ? result.text.slice(0, 77) + '...' : result.text;
  let moveHTML = '';
  if (movement !== undefined && movement !== 0) {
    const arrow = movement > 0 ? '↑' : '↓';
    const color = movement > 0 ? 'var(--green)' : 'var(--red)';
    moveHTML = `<div class="result-movement" style="color:${color}">${arrow}${Math.abs(movement)}</div>`;
  }

  item.className = 'result-item' + moveClass;
  item.innerHTML = `
    <div class="result-rank">#${rank}</div>
    <div class="result-body">
      <div class="result-text" title="${result.text.replace(/"/g, '&quot;')}">${truncText}</div>
      <div class="result-score-bar"><div class="result-score-fill" style="width:${pct}%"></div></div>
      <div class="result-score-text">${result.score.toFixed(4)}</div>
      ${moveHTML}
    </div>
  `;
  return item;
}

// ── Explore ──
// ── Generate & Scaffold ──

let generateMode = 'code';

function setGenerateMode(mode) {
  generateMode = mode;
  const codeBtn = document.getElementById('genModeCode');
  const scaffoldBtn = document.getElementById('genModeScaffold');
  codeBtn.classList.toggle('active', mode === 'code');
  codeBtn.setAttribute('aria-selected', mode === 'code');
  scaffoldBtn.classList.toggle('active', mode === 'scaffold');
  scaffoldBtn.setAttribute('aria-selected', mode === 'scaffold');
  document.getElementById('generateCodePanel').style.display = mode === 'code' ? 'block' : 'none';
  document.getElementById('scaffoldPanel').style.display = mode === 'scaffold' ? 'block' : 'none';
}

function updateGenComponents() {
  const target = document.getElementById('genTarget').value;
  const select = document.getElementById('genComponent');
  const components = {
    vanilla: ['client', 'connection', 'retrieval', 'ingest', 'search-api'],
    nextjs: ['client', 'connection', 'retrieval', 'ingest', 'search-page'],
    python: ['client', 'connection', 'retrieval', 'ingest'],
  };
  const labels = {
    client: 'API Client',
    connection: 'MongoDB Connection',
    retrieval: 'RAG Retrieval',
    ingest: 'Document Ingest',
    'search-api': 'Search API',
    'search-page': 'Search Page (MUI)',
  };
  select.innerHTML = (components[target] || []).map(c =>
    `<option value="${c}">${labels[c] || c}</option>`
  ).join('');
}

async function generateCode() {
  const btn = document.getElementById('genCodeBtn');
  const outputCard = document.getElementById('genOutputCard');
  
  btn.disabled = true;
  btn.textContent = 'Generating...';
  
  try {
    const config = {
      model: document.getElementById('genModel').value,
      db: document.getElementById('genDb').value,
      collection: document.getElementById('genCollection').value,
      rerank: document.getElementById('genRerank').checked,
    };
    
    const target = document.getElementById('genTarget').value;
    const component = document.getElementById('genComponent').value;
    
    // Check if running in Electron with vai.generate
    if (window.vai && window.vai.generate) {
      const result = await window.vai.generate.code({ target, component, config });
      if (result.error) throw new Error(result.error);
      
      document.getElementById('genOutputFilename').textContent = result.filename;
      document.getElementById('genOutputCode').textContent = result.code;
      outputCard.style.display = 'block';
    } else {
      // Web fallback - call the API
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target, component, config }),
      });
      const result = await res.json();
      if (result.error) throw new Error(result.error);
      
      document.getElementById('genOutputFilename').textContent = result.filename || `${component}.js`;
      document.getElementById('genOutputCode').textContent = result.code;
      outputCard.style.display = 'block';
    }
  } catch (err) {
    alert('Error generating code: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Generate Code';
  }
}

function copyGeneratedCode() {
  const code = document.getElementById('genOutputCode').textContent;
  navigator.clipboard.writeText(code);
  // Brief feedback
  const btn = event.target;
  btn.textContent = 'Copied!';
  setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
}

// Scaffold functions
function initScaffold() {
  const isElectron = window.vai && window.vai.scaffold;
  
  // Show/hide mode-specific sections
  document.getElementById('scaffoldLocationSection').style.display = isElectron ? 'block' : 'none';
  document.getElementById('scaffoldWebSection').style.display = isElectron ? 'none' : 'block';
  document.getElementById('scaffoldElectronButtons').style.display = isElectron ? 'block' : 'none';
  document.getElementById('scaffoldWebButtons').style.display = isElectron ? 'none' : 'block';
  
  // Update CLI command preview on input
  document.getElementById('scaffoldName').addEventListener('input', updateScaffoldPreview);
  document.getElementById('scaffoldTarget').addEventListener('change', updateScaffoldPreview);
}

function updateScaffoldPreview() {
  const name = document.getElementById('scaffoldName').value || 'my-rag-app';
  const target = document.getElementById('scaffoldTarget').value;
  document.getElementById('scaffoldCliName').textContent = name;
  document.getElementById('scaffoldCliTarget').textContent = target;
}

async function downloadScaffoldZip() {
  const btn = document.getElementById('scaffoldDownloadBtn');
  const projectName = document.getElementById('scaffoldName').value || 'my-rag-app';
  const target = document.getElementById('scaffoldTarget').value;
  const config = {
    model: document.getElementById('scaffoldModel').value,
    db: document.getElementById('scaffoldDb').value,
    collection: document.getElementById('scaffoldCollection').value,
  };
  
  btn.disabled = true;
  btn.innerHTML = '<span style="margin-right:6px;">⏳</span> Generating...';
  
  try {
    const res = await fetch('/api/scaffold', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ projectName, target, config }),
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to generate scaffold');
    }
    
    // Download the ZIP
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${projectName}.zip`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Show success
    btn.innerHTML = '<span style="margin-right:6px;">✓</span> Downloaded!';
    setTimeout(() => {
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" style="margin-right:6px;"><path fill="currentColor" d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path fill="currentColor" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Download ZIP';
      btn.disabled = false;
    }, 2000);
  } catch (err) {
    alert('Error: ' + err.message);
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" style="margin-right:6px;"><path fill="currentColor" d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path fill="currentColor" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Download ZIP';
    btn.disabled = false;
  }
}

async function pickScaffoldDirectory() {
  if (!window.vai || !window.vai.scaffold) return;
  
  const result = await window.vai.scaffold.pickDirectory();
  if (!result.canceled) {
    document.getElementById('scaffoldPath').value = result.path;
    document.getElementById('scaffoldBtn').disabled = false;
  }
}

async function createScaffold() {
  if (!window.vai || !window.vai.scaffold) return;
  
  const btn = document.getElementById('scaffoldBtn');
  const resultCard = document.getElementById('scaffoldResultCard');
  const resultDiv = document.getElementById('scaffoldResult');
  
  const dirPath = document.getElementById('scaffoldPath').value;
  const projectName = document.getElementById('scaffoldName').value || 'my-rag-app';
  const target = document.getElementById('scaffoldTarget').value;
  
  if (!dirPath) {
    alert('Please choose a location first.');
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Creating...';
  resultCard.style.display = 'none';
  
  try {
    // Check if directory exists
    const check = await window.vai.scaffold.checkDirectory({ dirPath, projectName });
    if (check.exists && check.fileCount > 0) {
      const confirm = await window.vai.scaffold.confirmOverwrite({ projectName });
      if (!confirm.confirmed) {
        btn.disabled = false;
        btn.textContent = 'Create Project';
        return;
      }
    }
    
    // Listen for progress
    const cleanup = window.vai.scaffold.onProgress((data) => {
      resultDiv.innerHTML = `<p>Creating: ${data.file} (${data.current}/${data.total})</p>`;
      resultCard.style.display = 'block';
    });
    
    // Create the project
    const config = {
      model: document.getElementById('scaffoldModel').value,
      db: document.getElementById('scaffoldDb').value,
      collection: document.getElementById('scaffoldCollection').value,
    };
    
    const result = await window.vai.scaffold.create({ dirPath, projectName, target, config });
    cleanup();
    
    if (result.error) throw new Error(result.error);
    
    // Show success
    resultDiv.innerHTML = `
      <p style="color:var(--primary);">✓ Created ${result.files.length} files in <code>${projectName}/</code></p>
      <div style="margin:12px 0;padding:12px;background:var(--surface-darker);border-radius:8px;">
        <p style="margin:0 0 8px;font-weight:500;">Next steps:</p>
        <code style="display:block;margin-bottom:4px;">cd ${projectName}</code>
        <code style="display:block;margin-bottom:4px;">cp .env.example .env</code>
        <code style="display:block;margin-bottom:4px;">${result.postInstall}</code>
        <code style="display:block;">${result.startCommand}</code>
      </div>
      <button class="btn btn-outline" onclick="window.vai.scaffold.openDirectory({ dirPath: '${result.projectDir.replace(/'/g, "\\'")}' })">
        Open in Finder
      </button>
    `;
    resultCard.style.display = 'block';
    
  } catch (err) {
    resultDiv.innerHTML = `<p style="color:var(--error);">Error: ${err.message}</p>`;
    resultCard.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Create Project';
  }
}

// Initialize scaffold on load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(initScaffold, 100);
});

// ── Explore: icons and tab mappings per concept ──
const CONCEPT_META = {
  embeddings:          { icon: '🧮', tab: 'embed' },
  reranking:           { icon: '🏆', tab: 'search' },
  'vector-search':     { icon: '🔎', tab: 'search' },
  rag:                 { icon: '🤖', tab: 'search' },
  'cosine-similarity': { icon: '📐', tab: 'compare' },
  'two-stage-retrieval': { icon: '🎯', tab: 'search' },
  'input-type':        { icon: '🏷️', tab: 'embed' },
  models:              { icon: '🧠', tab: 'embed' },
  'api-keys':          { icon: '🔑', tab: 'embed' },
  'api-access':        { icon: '🌐', tab: 'embed' },
  'batch-processing':  { icon: '📦', tab: 'embed' },
  benchmarking:        { icon: '⏱', tab: 'benchmark' },
  quantization:        { icon: '⚗️', tab: 'benchmark' },
  'mixture-of-experts': { icon: '🧩', tab: 'embed' },
  'shared-embedding-space': { icon: '🔗', tab: 'compare' },
  'rteb-benchmarks':   { icon: '📊', tab: 'benchmark' },
  'voyage-4-nano':     { icon: '🔬', tab: 'embed' },
  'rerank-eval':       { icon: '📐', tab: 'benchmark' },
  'multimodal-embeddings': { icon: '🖼️', tab: 'multimodal' },
  'cross-modal-search':    { icon: '🔀', tab: 'multimodal' },
  'modality-gap':          { icon: '🕳️', tab: 'multimodal' },
  'multimodal-rag':        { icon: '📄', tab: 'multimodal' },
  'provider-comparison':   { icon: '⚖️', tab: 'explore' },
  // Code generation & scaffolding
  'code-generation':   { icon: '💻', tab: 'explore' },
  scaffolding:         { icon: '🏗️', tab: 'explore' },
  'eval-comparison':   { icon: '📊', tab: 'benchmark' },
  // MongoDB Auto-Embedding
  'auto-embedding':        { icon: '⚡', tab: 'explore' },
  'vai-vs-auto-embedding': { icon: '🔄', tab: 'explore' },
};

let exploreConcepts = {};

async function loadConcepts() {
  try {
    const res = await fetch('/api/concepts');
    const data = await res.json();
    exploreConcepts = data.concepts || {};
  } catch {
    console.error('Failed to load concepts');
  }
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function buildExploreCards() {
  const grid = document.getElementById('exploreGrid');
  grid.innerHTML = '';

  for (const [key, concept] of Object.entries(exploreConcepts)) {
    const meta = CONCEPT_META[key] || { icon: '📚', tab: 'embed' };
    const card = document.createElement('div');
    card.className = 'explore-card';
    card.dataset.key = key;

    card.innerHTML = `
      <div class="explore-card-icon">${meta.icon}</div>
      <div class="explore-card-title">${escapeHtml(concept.title)}</div>
      <div class="explore-card-summary">${escapeHtml(concept.summary)}</div>
    `;
    card.addEventListener('click', () => openExploreModal(key));
    grid.appendChild(card);
  }

  // Modal close handlers
  const modal = document.getElementById('exploreModal');
  document.getElementById('exploreModalClose').addEventListener('click', closeExploreModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeExploreModal(); });
  
  // Close modal on Escape key for accessibility
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('open')) {
      closeExploreModal();
    }
  });
}

// Store previously focused element for modal focus management
let exploreModalPreviousFocus = null;

function openExploreModal(key) {
  const concept = exploreConcepts[key];
  if (!concept) return;
  const meta = CONCEPT_META[key] || { icon: '📚', tab: 'embed' };

  // Save the currently focused element to restore when modal closes
  exploreModalPreviousFocus = document.activeElement;

  document.getElementById('exploreModalIcon').textContent = meta.icon;
  document.getElementById('exploreModalTitle').textContent = concept.title;
  document.getElementById('exploreModalSummary').textContent = concept.summary;

  // Build body: content + links + tryIt
  let bodyHtml = escapeHtml(concept.content);

  if (concept.links && concept.links.length > 0) {
    bodyHtml += '<div class="explore-modal-links">' +
      '<div class="explore-modal-links-title">Learn More</div>' +
      concept.links.map(url =>
        `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a>`
      ).join('') + '</div>';
  }

  if (concept.tryIt && concept.tryIt.length > 0) {
    bodyHtml += '<div class="explore-modal-tryit">' +
      '<div class="explore-modal-tryit-title">Try It</div>' +
      concept.tryIt.map(cmd =>
        `<div class="explore-modal-tryit-cmd">$ ${escapeHtml(cmd)}</div>`
      ).join('') + '</div>';
  }

  document.getElementById('exploreModalBody').innerHTML = bodyHtml;

  // Actions
  const actionsEl = document.getElementById('exploreModalActions');
  actionsEl.innerHTML = `<button class="btn btn-small" id="exploreModalTry">Try it in playground →</button>`;
  actionsEl.querySelector('#exploreModalTry').addEventListener('click', () => {
    closeExploreModal();
    if (meta.tab) switchTab(meta.tab);
  });

  const modal = document.getElementById('exploreModal');
  modal.classList.add('open');
  
  // Focus the close button for accessibility
  setTimeout(() => {
    document.getElementById('exploreModalClose').focus();
  }, 100);
}

function closeExploreModal() {
  document.getElementById('exploreModal').classList.remove('open');
  
  // Restore focus to the previously focused element
  if (exploreModalPreviousFocus && typeof exploreModalPreviousFocus.focus === 'function') {
    exploreModalPreviousFocus.focus();
    exploreModalPreviousFocus = null;
  }
}

window.tryTopic = function(key) {
  const meta = CONCEPT_META[key];
  if (meta) switchTab(meta.tab);
};

window.filterExplore = function() {
  const q = document.getElementById('exploreSearch').value.toLowerCase().trim();
  document.querySelectorAll('#exploreGrid .explore-card').forEach(card => {
    if (!q) { card.style.display = ''; return; }
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(q) ? '' : 'none';
  });
};

// ── Benchmark: Sub-panel switching ──
document.querySelectorAll('.bench-panel-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.bench-panel-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.bench-view').forEach(v => v.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('bench-' + btn.dataset.bench).classList.add('active');
  });
});

// ── Benchmark: Model checkboxes ──
function buildModelCheckboxes() {
  const container = document.getElementById('benchModelChecks');
  container.innerHTML = '';
  const defaults = ['voyage-4-large', 'voyage-4', 'voyage-4-lite'];
  embedModels.forEach(m => {
    const label = document.createElement('label');
    label.style.cssText = 'display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = m.name;
    cb.checked = defaults.includes(m.name);
    cb.style.accentColor = 'var(--accent)';
    label.appendChild(cb);
    label.appendChild(document.createTextNode(m.name));
    container.appendChild(label);
  });
}

function populateBenchRankSelects() {
  const selA = document.getElementById('benchRankModelA');
  const selB = document.getElementById('benchRankModelB');
  [selA, selB].forEach(sel => {
    sel.innerHTML = '';
    [...embedModels, ...rerankModels].forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      sel.appendChild(opt);
    });
  });
  // Sensible defaults
  if (embedModels.length >= 2) {
    selA.value = embedModels[0].name;
    selB.value = embedModels[embedModels.length > 2 ? 2 : 1].name;
  }
}

// ── Benchmark: Latency ──
const BENCH_SAMPLE_TEXTS = [
  'MongoDB Atlas provides a fully managed cloud database service with built-in vector search capabilities.',
  'Kubernetes orchestrates containerized applications across clusters of machines for high availability.',
  'Machine learning models transform raw data into embeddings that capture semantic meaning.',
  'RESTful APIs use HTTP methods like GET, POST, PUT, and DELETE to manage resources.',
  'Natural language processing enables computers to understand and generate human language.',
];

const MODEL_COLORS = [
  '#00ED64', '#71F6BA', '#0498EC', '#B45AF2', '#FFC010',
  '#FF6960', '#B45AF2', '#FFC010', '#016BF8', '#C0FAE6',
];

window.doBenchLatency = async function() {
  hideError('benchLatencyError');
  const checks = document.querySelectorAll('#benchModelChecks input:checked');
  const models = Array.from(checks).map(c => c.value);
  if (models.length === 0) { showError('benchLatencyError', 'Select at least one model'); return; }

  const rounds = parseInt(document.getElementById('benchRounds').value, 10);
  const customText = document.getElementById('benchLatencyInput').value.trim();
  const texts = customText ? [customText] : BENCH_SAMPLE_TEXTS;

  setLoading('benchLatencyBtn', true);
  document.getElementById('benchLatencyResult').classList.add('visible');

  const chart = document.getElementById('benchLatencyChart');
  const statsEl = document.getElementById('benchLatencyStats');

  // Build placeholder bars
  chart.innerHTML = '';
  models.forEach((model, i) => {
    const row = document.createElement('div');
    row.className = 'latency-row';
    row.innerHTML = `
      <span class="latency-model">${model}</span>
      <div class="latency-bar-outer">
        <div class="latency-bar-inner running" id="bench-bar-${i}" style="background:${MODEL_COLORS[i % MODEL_COLORS.length]}"></div>
      </div>
      <span class="latency-stats" id="bench-stats-${i}">Running...</span>
      <span class="latency-badge" id="bench-badge-${i}"></span>
    `;
    chart.appendChild(row);
  });
  statsEl.innerHTML = `<span class="stat"><span class="stat-label">Texts</span><span class="stat-value">${texts.length}</span></span>
    <span class="stat"><span class="stat-label">Rounds</span><span class="stat-value">${rounds}</span></span>`;

  const results = [];

  for (let mi = 0; mi < models.length; mi++) {
    const model = models[mi];
    const latencies = [];
    let tokens = 0, dims = 0;

    for (let r = 0; r < rounds; r++) {
      try {
        const data = await apiPost('/api/benchmark/embed', { texts, model, inputType: 'document' });
        latencies.push(data.elapsed);
        tokens = data.tokens;
        dims = data.dimensions;
      } catch (err) {
        document.getElementById(`bench-stats-${mi}`).textContent = 'Error';
        document.getElementById(`bench-bar-${mi}`).classList.remove('running');
        document.getElementById(`bench-bar-${mi}`).style.width = '0%';
        break;
      }
    }

    if (latencies.length > 0) {
      const avg = latencies.reduce((a, b) => a + b, 0) / latencies.length;
      const sorted = [...latencies].sort((a, b) => a - b);
      const p50 = sorted[Math.floor(sorted.length / 2)];
      results.push({ model, avg, p50, min: sorted[0], max: sorted[sorted.length - 1], tokens, dims, idx: mi });
    }
  }

  // Animate bars to final widths
  if (results.length > 0) {
    const maxAvg = Math.max(...results.map(r => r.avg));
    const minAvg = Math.min(...results.map(r => r.avg));

    results.forEach(r => {
      const bar = document.getElementById(`bench-bar-${r.idx}`);
      const stats = document.getElementById(`bench-stats-${r.idx}`);
      const badge = document.getElementById(`bench-badge-${r.idx}`);
      bar.classList.remove('running');
      const pct = Math.max(15, (r.avg / maxAvg) * 100);
      bar.style.width = pct + '%';
      bar.textContent = r.avg.toFixed(0) + 'ms';
      stats.textContent = `p50: ${r.p50.toFixed(0)}ms`;
      stats.title = `min: ${r.min.toFixed(0)}ms, max: ${r.max.toFixed(0)}ms`;
      if (r.avg === minAvg) badge.textContent = '⚡';
    });

    // Update stats
    const fastest = results.reduce((a, b) => a.avg < b.avg ? a : b);
    const price = getModelPrice(fastest.model);
    statsEl.innerHTML += `
      <span class="stat"><span class="stat-label">Fastest</span><span class="stat-value">${fastest.model}</span></span>
      <span class="stat"><span class="stat-label">Avg</span><span class="stat-value">${fastest.avg.toFixed(0)}ms</span></span>
      <span class="stat"><span class="stat-label">Dims</span><span class="stat-value">${fastest.dims}</span></span>
      ${price ? `<span class="stat"><span class="stat-label">Price</span><span class="stat-value">${price}</span></span>` : ''}
    `;

    // Save to history
    saveBenchHistory(results, texts.length, rounds);
    renderHistory();
  }

  setLoading('benchLatencyBtn', false);
};

function getModelPrice(name) {
  const m = allModels.find(m => m.name === name);
  return m ? m.price : null;
}

function getModelPriceNum(name) {
  const m = allModels.find(m => m.name === name);
  if (!m) return null;
  const match = m.price.match(/\$([0-9.]+)\/1M/);
  return match ? parseFloat(match[1]) : null;
}

// ── Benchmark: Ranking Comparison ──
window.doBenchRanking = async function() {
  hideError('benchRankError');
  const query = document.getElementById('benchRankQuery').value.trim();
  const docsText = document.getElementById('benchRankDocs').value.trim();
  if (!query || !docsText) { showError('benchRankError', 'Enter a query and documents'); return; }

  const documents = docsText.split('\n').map(d => d.trim()).filter(Boolean);
  if (documents.length < 2) { showError('benchRankError', 'Enter at least 2 documents'); return; }

  const modelA = document.getElementById('benchRankModelA').value;
  const modelB = document.getElementById('benchRankModelB').value;
  const mode = document.getElementById('benchRankMode').value;
  const topK = parseInt(document.getElementById('benchRankTopK').value, 10);

  setLoading('benchRankBtn', true);

  try {
    let rankedA, rankedB;

    if (mode === 'embed') {
      // Embedding similarity mode
      const [dataA, dataB] = await Promise.all([
        apiPost('/api/benchmark/embed', { texts: [query, ...documents], model: modelA, inputType: 'document' }),
        apiPost('/api/benchmark/embed', { texts: [query, ...documents], model: modelB, inputType: 'document' }),
      ]);

      rankedA = rankBySimilarity(dataA.embeddings, documents, topK);
      rankedB = rankBySimilarity(dataB.embeddings, documents, topK);
    } else {
      // Rerank mode
      const [dataA, dataB] = await Promise.all([
        apiPost('/api/benchmark/rerank', { query, documents, model: modelA, topK }),
        apiPost('/api/benchmark/rerank', { query, documents, model: modelB, topK }),
      ]);

      rankedA = dataA.results.slice(0, topK).map(r => ({
        index: r.index,
        text: documents[r.index],
        score: r.relevance_score,
      }));
      rankedB = dataB.results.slice(0, topK).map(r => ({
        index: r.index,
        text: documents[r.index],
        score: r.relevance_score,
      }));
    }

    // Render comparison
    renderRankComparison(modelA, modelB, rankedA, rankedB, topK);
    document.getElementById('benchRankResult').classList.add('visible');
  } catch (err) {
    showError('benchRankError', err.message);
  } finally {
    setLoading('benchRankBtn', false);
  }
};

function rankBySimilarity(embeddings, documents, topK) {
  const queryVec = embeddings[0];
  const docVecs = embeddings.slice(1);
  const scores = docVecs.map((dv, i) => ({
    index: i,
    text: documents[i],
    score: cosineSim(queryVec, dv),
  }));
  scores.sort((a, b) => b.score - a.score);
  return scores.slice(0, topK);
}

function renderRankComparison(modelA, modelB, rankedA, rankedB, topK) {
  const grid = document.getElementById('benchRankGrid');
  const verdict = document.getElementById('benchRankVerdict');
  grid.innerHTML = '';

  // Header
  const header = document.createElement('div');
  header.className = 'rank-row';
  header.style.background = 'none';
  header.style.fontWeight = '600';
  header.style.fontSize = '13px';
  header.style.color = 'var(--accent)';
  header.innerHTML = `<div></div><div>${modelA}</div><div></div><div>${modelB}</div>`;
  grid.appendChild(header);

  const orderA = rankedA.map(r => r.index);
  const orderB = rankedB.map(r => r.index);
  let matches = 0;

  const k = Math.min(topK, rankedA.length, rankedB.length);
  for (let i = 0; i < k; i++) {
    const a = rankedA[i];
    const b = rankedB[i];
    const same = a.index === b.index;
    if (same) matches++;

    const truncA = a.text.length > 60 ? a.text.slice(0, 57) + '...' : a.text;
    const truncB = b.text.length > 60 ? b.text.slice(0, 57) + '...' : b.text;

    const row = document.createElement('div');
    row.className = 'rank-row';
    row.innerHTML = `
      <div class="rank-num">${i + 1}</div>
      <div class="rank-item ${same ? 'rank-match' : 'rank-differ'}">
        <div title="${a.text.replace(/"/g, '&quot;')}">${truncA}</div>
        <div class="rank-score">${a.score.toFixed(4)} [doc ${a.index}]</div>
      </div>
      <div class="rank-arrow">${same ? '=' : '≠'}</div>
      <div class="rank-item ${same ? 'rank-match' : 'rank-differ'}">
        <div title="${b.text.replace(/"/g, '&quot;')}">${truncB}</div>
        <div class="rank-score">${b.score.toFixed(4)} [doc ${b.index}]</div>
      </div>
    `;
    grid.appendChild(row);
  }

  // Compute overlap
  const setA = new Set(orderA.slice(0, k));
  const setB = new Set(orderB.slice(0, k));
  const overlap = [...setA].filter(x => setB.has(x)).length;
  const overlapPct = ((overlap / k) * 100).toFixed(0);
  const agreePct = ((matches / k) * 100).toFixed(0);

  if (matches === k) {
    verdict.innerHTML = `<span style="color:var(--green)">✓ Models agree on all ${k} positions — the cheaper model is likely sufficient.</span>`;
  } else if (overlap === k) {
    verdict.innerHTML = `<span style="color:var(--yellow)">⚠ Same ${k} documents in top-${k}, but in different order (${agreePct}% exact match).</span>`;
  } else {
    verdict.innerHTML = `<span style="color:var(--warning)">⚠ ${overlapPct}% overlap in top-${k} results — models see different relevance signals.</span>`;
  }
}

// ── Benchmark: Quantization ──
function populateQuantModelSelect() {
  const sel = document.getElementById('quantModel');
  sel.innerHTML = '';
  embedModels.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.name;
    opt.textContent = m.name;
    sel.appendChild(opt);
  });
  // Default to voyage-4-large if available
  const preferred = embedModels.find(m => m.name === 'voyage-4-large');
  if (preferred) sel.value = preferred.name;
}

function hammingSimUI(a, b) {
  // For binary/ubinary packed embeddings, compute agreement via dot product
  let dot = 0;
  for (let i = 0; i < a.length; i++) dot += a[i] * b[i];
  return dot;
}

window.doBenchQuantization = async function() {
  hideError('quantError');
  const model = document.getElementById('quantModel').value;
  const dimsVal = document.getElementById('quantDimensions').value;
  const dimensions = dimsVal ? parseInt(dimsVal, 10) : undefined;
  const query = document.getElementById('quantQuery').value.trim();
  const corpusText = document.getElementById('quantCorpus').value.trim();

  if (!query) { showError('quantError', 'Enter a query'); return; }
  if (!corpusText) { showError('quantError', 'Enter at least 2 documents'); return; }

  const corpus = corpusText.split('\n').map(d => d.trim()).filter(Boolean);
  if (corpus.length < 2) { showError('quantError', 'Enter at least 2 documents'); return; }

  const checks = document.querySelectorAll('#quantDtypeChecks input:checked');
  const dtypes = Array.from(checks).map(c => c.value);
  if (dtypes.length === 0) { showError('quantError', 'Select at least one data type'); return; }

  setLoading('quantBtn', true);

  try {
    const allTexts = [query, ...corpus];
    const resultsByDtype = {};

    for (const dtype of dtypes) {
      const body = { texts: allTexts, model, inputType: 'document' };
      if (dimensions) body.dimensions = dimensions;
      if (dtype !== 'float') body.output_dtype = dtype;

      const start = performance.now();
      const data = await apiPost('/api/embed', body);
      const elapsed = performance.now() - start;

      const embeddings = data.data.map(d => d.embedding);
      const queryEmbed = embeddings[0];
      const dims = embeddings[0].length;
      const isBinary = (dtype === 'binary' || dtype === 'ubinary');

      // Rank corpus documents by similarity
      const ranked = corpus.map((text, i) => {
        const docEmbed = embeddings[i + 1];
        let sim;
        if (isBinary) {
          sim = hammingSimUI(queryEmbed, docEmbed);
        } else {
          sim = cosineSim(queryEmbed, docEmbed);
        }
        return { index: i, text, similarity: sim };
      }).sort((a, b) => b.similarity - a.similarity);

      // Calculate storage
      const actualDims = isBinary ? dims * 8 : dims;
      let bytesPerVec;
      if (dtype === 'float') bytesPerVec = dims * 4;
      else if (dtype === 'int8' || dtype === 'uint8') bytesPerVec = dims * 1;
      else bytesPerVec = dims; // binary/ubinary: dims is already 1/8th

      resultsByDtype[dtype] = {
        dtype, latency: elapsed, dims, actualDims, bytesPerVec,
        tokens: data.usage?.total_tokens || 0, ranked,
      };
    }

    const completed = Object.values(resultsByDtype);
    if (completed.length === 0) {
      showError('quantError', 'No data types completed successfully');
      return;
    }

    // ── Render Charts ──
    const baseline = completed.find(r => r.dtype === 'float') || completed[0];
    const maxBytes = Math.max(...completed.map(r => r.bytesPerVec));
    const maxLatency = Math.max(...completed.map(r => r.latency));
    const DTYPE_COLORS = { float: '#00ED64', int8: '#71F6BA', uint8: '#0498EC', ubinary: '#FFC010', binary: '#FF6960' };

    // ── Storage Bar Chart ──
    let storageHTML = '';
    for (const r of completed) {
      const pct = Math.max(8, (r.bytesPerVec / maxBytes) * 100);
      const totalMB = (r.bytesPerVec * 1_000_000) / (1024 * 1024);
      const sizeStr = totalMB >= 1024 ? `${(totalMB / 1024).toFixed(1)} GB` : `${totalMB.toFixed(0)} MB`;
      const savings = r.bytesPerVec < baseline.bytesPerVec
        ? `${(baseline.bytesPerVec / r.bytesPerVec).toFixed(0)}× smaller`
        : 'baseline';
      const color = DTYPE_COLORS[r.dtype] || '#0498EC';
      storageHTML += `<div class="quant-bar-group">
        <div class="quant-bar-label">
          <span class="dtype-name">${r.dtype}</span>
          <span class="dtype-value">${formatBytesUI(r.bytesPerVec)}/vec · ${sizeStr} @ 1M</span>
        </div>
        <div class="quant-bar-track">
          <div class="quant-bar-fill storage" style="width:${pct}%;background:linear-gradient(90deg, ${color}, ${color}cc);">${savings}</div>
        </div>
      </div>`;
    }
    document.getElementById('quantStorageChart').innerHTML = storageHTML;

    // ── Latency Bar Chart ──
    let latencyHTML = '';
    const minLatency = Math.min(...completed.map(r => r.latency));
    for (const r of completed) {
      const pct = Math.max(8, (r.latency / maxLatency) * 100);
      const color = DTYPE_COLORS[r.dtype] || '#0498EC';
      const badge = r.latency === minLatency ? ' ⚡' : '';
      latencyHTML += `<div class="quant-bar-group">
        <div class="quant-bar-label">
          <span class="dtype-name">${r.dtype}</span>
          <span class="dtype-value">${r.latency.toFixed(0)}ms${badge}</span>
        </div>
        <div class="quant-bar-track">
          <div class="quant-bar-fill latency" style="width:${pct}%;background:linear-gradient(90deg, ${color}, ${color}cc);">${r.latency.toFixed(0)}ms</div>
        </div>
      </div>`;
    }
    document.getElementById('quantLatencyChart').innerHTML = latencyHTML;

    // ── Quality Meters + Ranking Grid ──
    const topK = Math.min(5, corpus.length);
    const metersEl = document.getElementById('quantQualityMeters');
    const gridEl = document.getElementById('quantRankGrid');
    gridEl.innerHTML = '';
    metersEl.innerHTML = '';

    if (completed.length >= 2 && baseline) {
      const baselineRanking = baseline.ranked.slice(0, topK).map(r => r.index);

      // Quality meters for each non-baseline dtype
      let metersHTML = '';
      for (const r of completed) {
        if (r.dtype === baseline.dtype) continue;
        const otherRanking = r.ranked.slice(0, topK).map(x => x.index);
        const overlap = baselineRanking.filter(idx => otherRanking.includes(idx)).length;
        const overlapPct = (overlap / topK) * 100;
        const exactMatch = baselineRanking.every((idx, pos) => otherRanking[pos] === idx);
        const positionMatches = baselineRanking.filter((idx, pos) => otherRanking[pos] === idx).length;
        const posMatchPct = (positionMatches / topK) * 100;

        let grade, gradeLabel, detail;
        if (exactMatch) {
          grade = 'perfect'; gradeLabel = '✓ Perfect';
          detail = `Identical ranking — all ${topK} positions match float baseline`;
        } else if (overlap === topK) {
          grade = 'good'; gradeLabel = '≈ Reordered';
          detail = `Same ${topK} documents, ${positionMatches}/${topK} in same position`;
        } else {
          grade = overlap >= topK * 0.6 ? 'good' : 'degraded';
          gradeLabel = `${overlapPct.toFixed(0)}% overlap`;
          detail = `${overlap}/${topK} documents match, ${positionMatches}/${topK} positions match`;
        }

        metersHTML += `<div class="quant-quality-meter">
          <div class="quant-meter-header">
            <span class="dtype-name">${r.dtype}</span>
            <span class="verdict-badge ${grade}">${gradeLabel}</span>
          </div>
          <div class="quant-meter-track">
            <div class="quant-meter-fill ${grade}" style="width:${exactMatch ? 100 : posMatchPct}%"></div>
          </div>
          <div class="quant-meter-detail">${detail}</div>
        </div>`;
      }
      metersEl.innerHTML = metersHTML;

      // Side-by-side ranking columns
      let rankHTML = `<div class="quant-rank-cols" style="grid-template-columns:repeat(${completed.length},1fr);">`;
      for (const r of completed) {
        rankHTML += `<div><div class="quant-rank-col-header">${r.dtype}${r === baseline ? ' (baseline)' : ''}</div>`;
        r.ranked.slice(0, topK).forEach((item, pos) => {
          const trunc = item.text.length > 55 ? item.text.slice(0, 52) + '…' : item.text;
          let cls = 'baseline';
          if (r !== baseline) {
            cls = (baseline.ranked[pos] && item.index === baseline.ranked[pos].index) ? 'match' : 'differ';
          }
          rankHTML += `<div class="quant-rank-item ${cls}" title="${item.text.replace(/"/g, '&quot;')}">
            <span class="quant-rank-pos">${pos + 1}</span>${trunc}
            <div class="quant-rank-score">${item.similarity.toFixed(4)} · doc ${item.index}</div>
          </div>`;
        });
        rankHTML += '</div>';
      }
      rankHTML += '</div>';
      gridEl.innerHTML = rankHTML;
    } else {
      metersEl.innerHTML = '<span style="color:var(--text-dim)">Select multiple data types (including float) to compare rankings.</span>';
    }

    document.getElementById('quantResult').classList.add('visible');
  } catch (err) {
    showError('quantError', err.message);
  } finally {
    setLoading('quantBtn', false);
  }
};

// ── Benchmark: Cost Calculator ──
// ── Cost Calculator: Shared Helpers ──

function costFormatDollars(n) {
  if (n === 0) return '$0.00';
  if (n < 0.01 && n > 0) return '$' + n.toFixed(4);
  if (n < 1) return '$' + n.toFixed(2);
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function costShortNum(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(n % 1e9 === 0 ? 0 : 1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(n % 1e6 === 0 ? 0 : 1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(n % 1e3 === 0 ? 0 : 1) + 'K';
  return String(n);
}

function costGetPricePerM(model) {
  const match = model.price.match(/\$([0-9.]+)\/1M/);
  return match ? parseFloat(match[1]) : null;
}

function costGetV4Models() {
  return allModels.filter(m => !m.legacy && !m.unreleased && costGetPricePerM(m) !== null);
}

// ── Cost Mode Toggle ──

let currentCostMode = 'simple';

function setCostMode(mode) {
  currentCostMode = mode;
  document.querySelectorAll('.cost-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
  document.getElementById('costSimpleMode').style.display = mode === 'simple' ? '' : 'none';
  document.getElementById('costRagMode').style.display = mode === 'rag' ? '' : 'none';
  if (mode === 'rag') updateRagCalculator();
}

// ── Simple Mode (query-only comparison) ──

function initCostCalculator() {
  // Mode toggle buttons
  document.getElementById('costModeSimple').addEventListener('click', () => setCostMode('simple'));
  document.getElementById('costModeRag').addEventListener('click', () => setCostMode('rag'));

  // Help modal
  const helpModal = document.getElementById('costHelpModal');
  document.getElementById('costHelpBtn').addEventListener('click', () => helpModal.classList.add('open'));
  document.getElementById('costHelpClose').addEventListener('click', () => helpModal.classList.remove('open'));
  helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.classList.remove('open'); });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      helpModal.classList.remove('open');
      closeExploreModal();
    }
  });

  // Simple mode sliders
  const tokSlider = document.getElementById('costTokens');
  const qSlider = document.getElementById('costQueries');
  const tokValue = document.getElementById('costTokensValue');
  const qValue = document.getElementById('costQueriesValue');

  function updateCost() {
    const tokens = parseInt(tokSlider.value, 10);
    const queries = parseInt(qSlider.value, 10);
    tokValue.textContent = tokens.toLocaleString();
    qValue.textContent = queries.toLocaleString();
    renderCostTable(tokens, queries);
  }

  tokSlider.addEventListener('input', updateCost);
  qSlider.addEventListener('input', updateCost);
  updateCost();

  // RAG mode init
  initRagCalculator();
}

function renderCostTable(tokensPerQuery, queriesPerDay) {
  const tbody = document.getElementById('costTableBody');
  tbody.innerHTML = '';

  const models = allModels.filter(m => !m.legacy && !m.unreleased);
  const rows = [];

  models.forEach(m => {
    const pricePerM = costGetPricePerM(m);
    if (pricePerM === null) return;
    const dailyTokens = tokensPerQuery * queriesPerDay;
    const dailyCost = (dailyTokens / 1_000_000) * pricePerM;
    const monthlyCost = dailyCost * 30;
    rows.push({ name: m.name, type: m.type === 'embedding' ? 'embed' : 'rerank', pricePerM, dailyCost, monthlyCost });
  });

  rows.sort((a, b) => a.monthlyCost - b.monthlyCost);
  const maxMonthly = Math.max(...rows.map(r => r.monthlyCost), 0.01);

  rows.forEach(r => {
    const tr = document.createElement('tr');
    const barPct = Math.max(2, (r.monthlyCost / maxMonthly) * 100);
    const monthlyStr = r.monthlyCost < 0.01 ? '<$0.01' : '$' + (r.monthlyCost < 1 ? r.monthlyCost.toFixed(2) : r.monthlyCost < 100 ? r.monthlyCost.toFixed(1) : r.monthlyCost.toFixed(0));
    const dailyStr = r.dailyCost < 0.01 ? '<$0.01' : '$' + r.dailyCost.toFixed(2);

    tr.innerHTML = `
      <td style="color:var(--text)">${r.name}</td>
      <td style="color:var(--text-dim)">${r.type}</td>
      <td>$${r.pricePerM.toFixed(2)}</td>
      <td>${dailyStr}</td>
      <td class="cost-highlight">${monthlyStr}</td>
      <td class="cost-bar-cell" style="position:relative;padding-left:8px;">
        <div class="cost-bar" style="width:${barPct}%;"></div>
        <span style="position:relative;z-index:1;font-size:12px;color:var(--text-dim);">${monthlyStr}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ── RAG Planner Mode (full TCO with strategies) ──

function initRagCalculator() {
  // Populate model dropdowns
  const embeddingModels = allModels.filter(m =>
    m.type === 'embedding' && !m.legacy && !m.unreleased && costGetPricePerM(m) !== null
  );

  const docSelect = document.getElementById('ragDocModel');
  const querySelect = document.getElementById('ragQueryModel');

  embeddingModels.forEach(m => {
    const pricePerM = costGetPricePerM(m);
    const opt1 = document.createElement('option');
    opt1.value = m.name;
    opt1.textContent = `${m.name} ($${pricePerM.toFixed(2)}/1M)`;
    docSelect.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = m.name;
    opt2.textContent = `${m.name} ($${pricePerM.toFixed(2)}/1M)`;
    querySelect.appendChild(opt2);
  });

  // Set defaults: voyage-4-large for docs, voyage-4-lite for queries
  docSelect.value = 'voyage-4-large';
  querySelect.value = 'voyage-4-lite';

  // Bind all sliders and selects
  const ids = ['ragDocs', 'ragDocTokens', 'ragQueries', 'ragQueryTokens', 'ragMonths'];
  ids.forEach(id => {
    document.getElementById(id).addEventListener('input', updateRagCalculator);
  });
  docSelect.addEventListener('change', updateRagCalculator);
  querySelect.addEventListener('change', updateRagCalculator);

  updateRagCalculator();
}

function updateRagCalculator() {
  const numDocs = parseInt(document.getElementById('ragDocs').value, 10);
  const docTokens = parseInt(document.getElementById('ragDocTokens').value, 10);
  const numQueries = parseInt(document.getElementById('ragQueries').value, 10);
  const queryTokens = parseInt(document.getElementById('ragQueryTokens').value, 10);
  const months = parseInt(document.getElementById('ragMonths').value, 10);
  const docModelName = document.getElementById('ragDocModel').value;
  const queryModelName = document.getElementById('ragQueryModel').value;

  // Update slider display values
  document.getElementById('ragDocsValue').textContent = costShortNum(numDocs);
  document.getElementById('ragDocTokensValue').textContent = docTokens.toLocaleString();
  document.getElementById('ragQueriesValue').textContent = costShortNum(numQueries);
  document.getElementById('ragQueryTokensValue').textContent = queryTokens.toLocaleString();
  document.getElementById('ragMonthsValue').textContent = months + ' mo';

  const docTotalTokens = numDocs * docTokens;
  const queryTotalTokensPerMonth = numQueries * queryTokens;

  // Get model prices
  const docModel = allModels.find(m => m.name === docModelName);
  const queryModel = allModels.find(m => m.name === queryModelName);
  const docPrice = docModel ? costGetPricePerM(docModel) : 0;
  const queryPrice = queryModel ? costGetPricePerM(queryModel) : 0;

  // ── Build strategies (same logic as CLI) ──
  const strategies = [];
  const v4Embedding = allModels.filter(m =>
    m.type === 'embedding' && !m.legacy && !m.unreleased &&
    (m.sharedSpace === 'voyage-4' || m.name.startsWith('voyage-4')) &&
    costGetPricePerM(m) !== null && costGetPricePerM(m) > 0
  );

  // Strategy group 1: Symmetric with each V4 model
  v4Embedding.forEach(m => {
    const price = costGetPricePerM(m);
    const docCost = (docTotalTokens / 1e6) * price;
    const queryCostPerMonth = (queryTotalTokensPerMonth / 1e6) * price;
    const totalCost = docCost + (queryCostPerMonth * months);
    strategies.push({
      name: `Symmetric: ${m.name}`,
      type: 'symmetric',
      docModel: m.name,
      queryModel: m.name,
      docCost,
      queryCostPerMonth,
      totalCost,
      months,
    });
  });

  // Strategy 2: Asymmetric — user-selected combo
  const asymDocCost = (docTotalTokens / 1e6) * docPrice;
  const asymQueryCostPerMonth = (queryTotalTokensPerMonth / 1e6) * queryPrice;
  const asymTotalCost = asymDocCost + (asymQueryCostPerMonth * months);

  // Only add if it's actually asymmetric (different models)
  if (docModelName !== queryModelName) {
    strategies.push({
      name: `Asymmetric: ${docModelName} + ${queryModelName}`,
      type: 'asymmetric',
      docModel: docModelName,
      queryModel: queryModelName,
      docCost: asymDocCost,
      queryCostPerMonth: asymQueryCostPerMonth,
      totalCost: asymTotalCost,
      months,
      recommended: true,
    });
  }

  // Strategy 3: Asymmetric with nano (local, free queries)
  strategies.push({
    name: `Asymmetric: ${docModelName} + nano (local)`,
    type: 'asymmetric-local',
    docModel: docModelName,
    queryModel: 'voyage-4-nano',
    docCost: asymDocCost,
    queryCostPerMonth: 0,
    totalCost: asymDocCost,
    months,
    localNote: 'Query cost = $0 (runs locally via HuggingFace)',
  });

  strategies.sort((a, b) => a.totalCost - b.totalCost);
  const maxCost = Math.max(...strategies.map(s => s.totalCost), 0.01);

  // ── Render summary cards ──
  const summaryEl = document.getElementById('ragSummary');
  summaryEl.innerHTML = `
    <div class="cost-summary-card">
      <div class="cost-summary-label">Document tokens</div>
      <div class="cost-summary-value">${costShortNum(docTotalTokens)}</div>
      <div class="cost-summary-detail">${costShortNum(numDocs)} docs × ${docTokens.toLocaleString()} tok</div>
    </div>
    <div class="cost-summary-card">
      <div class="cost-summary-label">Query tokens / mo</div>
      <div class="cost-summary-value">${costShortNum(queryTotalTokensPerMonth)}</div>
      <div class="cost-summary-detail">${costShortNum(numQueries)} queries × ${queryTokens} tok</div>
    </div>
    <div class="cost-summary-card">
      <div class="cost-summary-label">Best ${months}-mo total</div>
      <div class="cost-summary-value">${costFormatDollars(strategies[0].totalCost)}</div>
      <div class="cost-summary-detail">${strategies[0].name}</div>
    </div>
    <div class="cost-summary-card">
      <div class="cost-summary-label">Max potential savings</div>
      <div class="cost-summary-value" style="color:var(--success)">${maxCost > 0 ? ((1 - strategies[0].totalCost / maxCost) * 100).toFixed(0) + '%' : '0%'}</div>
      <div class="cost-summary-detail">vs ${strategies[strategies.length - 1].name.split(':')[1]?.trim() || 'most expensive'}</div>
    </div>
  `;

  // ── Render strategy cards ──
  const stratEl = document.getElementById('ragStrategies');
  stratEl.innerHTML = strategies.map(s => {
    const savings = maxCost > 0 ? ((1 - s.totalCost / maxCost) * 100) : 0;
    const savingsHtml = savings > 0 ? `<div class="cost-savings">↓ ${savings.toFixed(0)}% savings</div>` : '';
    const badgeHtml = s.recommended ? '<div class="cost-strategy-badge">★ Recommended</div>' : '';
    const localHtml = s.localNote ? `<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">⚡ ${s.localNote}</div>` : '';

    return `
      <div class="cost-strategy${s.recommended ? ' recommended' : ''}">
        ${badgeHtml}
        <div class="cost-strategy-name">${s.name}</div>
        <div class="cost-strategy-row">
          <span class="cost-strategy-row-label">Doc embedding</span>
          <span class="cost-strategy-row-value">${costFormatDollars(s.docCost)} <span style="color:var(--text-muted);font-size:11px">(one-time)</span></span>
        </div>
        <div class="cost-strategy-row">
          <span class="cost-strategy-row-label">Query cost</span>
          <span class="cost-strategy-row-value">${costFormatDollars(s.queryCostPerMonth)}/mo</span>
        </div>
        <div class="cost-strategy-total">
          <span class="cost-strategy-total-label">${s.months}-month total</span>
          <span class="cost-strategy-total-value">${costFormatDollars(s.totalCost)}</span>
        </div>
        ${savingsHtml}
        ${localHtml}
      </div>
    `;
  }).join('');

  // ── Render per-model table ──
  const ragTbody = document.getElementById('ragTableBody');
  ragTbody.innerHTML = '';

  const allEmbedding = allModels.filter(m =>
    m.type === 'embedding' && !m.legacy && !m.unreleased && costGetPricePerM(m) !== null && costGetPricePerM(m) > 0
  );

  const tableRows = allEmbedding.map(m => {
    const price = costGetPricePerM(m);
    const dCost = (docTotalTokens / 1e6) * price;
    const qCostMo = (queryTotalTokensPerMonth / 1e6) * price;
    const total = dCost + (qCostMo * months);
    return { name: m.name, dCost, qCostMo, total };
  }).sort((a, b) => a.total - b.total);

  const maxTable = Math.max(...tableRows.map(r => r.total), 0.01);

  tableRows.forEach(r => {
    const tr = document.createElement('tr');
    const barPct = Math.max(2, (r.total / maxTable) * 100);
    tr.innerHTML = `
      <td style="color:var(--text)">${r.name}</td>
      <td>${costFormatDollars(r.dCost)}</td>
      <td>${costFormatDollars(r.qCostMo)}</td>
      <td class="cost-highlight">${costFormatDollars(r.total)}</td>
      <td class="cost-bar-cell" style="position:relative;padding-left:8px;">
        <div class="cost-bar" style="width:${barPct}%;"></div>
        <span style="position:relative;z-index:1;font-size:12px;color:var(--text-dim);">${costFormatDollars(r.total)}</span>
      </td>
    `;
    ragTbody.appendChild(tr);
  });

  // ── Tip ──
  const bestSym = strategies.find(s => s.type === 'symmetric' && s.docModel === 'voyage-4-large');
  const bestAsym = strategies.find(s => s.recommended);
  const tipEl = document.getElementById('ragTip');
  if (bestSym && bestAsym && bestSym.totalCost > bestAsym.totalCost) {
    const saved = bestSym.totalCost - bestAsym.totalCost;
    const pct = ((saved / bestSym.totalCost) * 100).toFixed(0);
    tipEl.innerHTML = `💡 <strong>Asymmetric retrieval saves ${costFormatDollars(saved)} (${pct}%)</strong> over symmetric voyage-4-large — same document quality, lower query costs. The shared embedding space makes this possible. <code>vai explain shared-space</code>`;
  } else {
    tipEl.innerHTML = '💡 Try selecting different doc and query models to see asymmetric cost savings. <code>vai explain shared-space</code>';
  }
}

// ── Benchmark: History ──
const HISTORY_KEY = 'vai-bench-history';

function saveBenchHistory(results, textCount, rounds) {
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  history.push({
    timestamp: Date.now(),
    textCount,
    rounds,
    results: results.map(r => ({ model: r.model, avg: r.avg, p50: r.p50, dims: r.dims })),
  });
  // Keep last 20
  if (history.length > 20) history.splice(0, history.length - 20);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

function renderHistory() {
  const container = document.getElementById('benchHistoryContent');
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

  if (history.length === 0) {
    container.innerHTML = '<div class="history-empty">No benchmarks recorded yet. Run a latency benchmark to start tracking.</div>';
    return;
  }

  // Collect all models that appear
  const modelSet = new Set();
  history.forEach(h => h.results.forEach(r => modelSet.add(r.model)));
  const models = [...modelSet];
  const colorMap = {};
  models.forEach((m, i) => { colorMap[m] = MODEL_COLORS[i % MODEL_COLORS.length]; });

  // Find global max for scale
  const maxAvg = Math.max(...history.flatMap(h => h.results.map(r => r.avg)));

  let html = '<div class="history-chart">';
  history.forEach((h, hi) => {
    html += '<div class="history-bar-group" title="' + new Date(h.timestamp).toLocaleString() + '">';
    models.forEach(m => {
      const r = h.results.find(r => r.model === m);
      const height = r ? Math.max(4, (r.avg / maxAvg) * 100) : 0;
      const label = r ? `${m}: ${r.avg.toFixed(0)}ms` : '';
      html += `<div class="history-bar" style="height:${height}%;background:${colorMap[m]};" title="${label}"></div>`;
    });
    html += '</div>';
  });
  html += '</div>';

  // Legend
  html += '<div class="history-legend">';
  models.forEach(m => {
    html += `<span><span class="history-legend-dot" style="background:${colorMap[m]}"></span>${m}</span>`;
  });
  html += '</div>';

  // Time labels
  if (history.length > 1) {
    const first = new Date(history[0].timestamp);
    const last = new Date(history[history.length - 1].timestamp);
    html += `<div class="history-labels"><span>${first.toLocaleDateString()} ${first.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span><span>${last.toLocaleDateString()} ${last.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span></div>`;
  }

  container.innerHTML = html;
}

window.clearHistory = function() {
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
};

// ── Settings ──
const SETTINGS_KEY = 'vai-settings';

function getSettings() {
  try {
    return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
  } catch { return {}; }
}

function saveSetting(key, value) {
  const s = getSettings();
  s[key] = value;
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  flashSaved();
}

function flashSaved() {
  const el = document.getElementById('settingsSavedMsg');
  if (!el) return;
  el.classList.add('show');
  clearTimeout(el._timer);
  el._timer = setTimeout(() => el.classList.remove('show'), 1500);
}

function initSettings() {
  const s = getSettings();

  // Theme sync
  const themeSelect = document.getElementById('settingsTheme');
  const currentTheme = localStorage.getItem('vai-theme') || 'dark';
  if (themeSelect) {
    themeSelect.value = currentTheme;
    themeSelect.addEventListener('change', () => {
      const t = themeSelect.value;
      saveSetting('theme', t);
      localStorage.setItem('vai-theme', t);
      // Reuse existing applyTheme by clicking the toggle if needed
      const toggle = document.getElementById('themeToggle');
      const cur = localStorage.getItem('vai-theme');
      if (cur === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        if (toggle) { toggle.textContent = '☀️'; toggle.title = 'Switch to dark mode'; }
      } else {
        document.documentElement.removeAttribute('data-theme');
        if (toggle) { toggle.textContent = '🌙'; toggle.title = 'Switch to light mode'; }
      }
      const logo = document.getElementById('sidebarLogo');
      if (logo) logo.src = '/icons/' + (t === 'light' ? 'light' : 'dark') + '/64.png';
    });
  }

  // Heatmap palette — handled below with preview swatch

  // Default model — populate from global model select
  const settingsModel = document.getElementById('settingsDefaultModel');
  const globalModel = document.getElementById('globalModel');
  if (settingsModel && globalModel) {
    // Clone options from globalModel
    settingsModel.innerHTML = globalModel.innerHTML;
    const savedModel = s.defaultModel || globalModel.value;
    settingsModel.value = savedModel;
    settingsModel.addEventListener('change', () => {
      saveSetting('defaultModel', settingsModel.value);
      globalModel.value = settingsModel.value;
      // Update individual tab selects too
      ['embedModel', 'compareModel', 'searchEmbedModel'].forEach(id => {
        const sel = document.getElementById(id);
        if (sel) sel.value = settingsModel.value;
      });
    });
  }

  // Default input type
  const inputTypeSel = document.getElementById('settingsInputType');
  if (inputTypeSel) {
    inputTypeSel.value = s.inputType || 'document';
    inputTypeSel.addEventListener('change', () => {
      saveSetting('inputType', inputTypeSel.value);
      const embedType = document.getElementById('embedInputType');
      if (embedType) embedType.value = inputTypeSel.value;
    });
  }

  // API base URL
  const apiBaseInput = document.getElementById('settingsApiBase');
  if (apiBaseInput) {
    apiBaseInput.value = s.apiBase || '';
    apiBaseInput.addEventListener('change', () => saveSetting('apiBase', apiBaseInput.value));
  }

  // Timeout
  const timeoutSel = document.getElementById('settingsTimeout');
  if (timeoutSel) {
    timeoutSel.value = s.timeout || '30';
    timeoutSel.addEventListener('change', () => saveSetting('timeout', timeoutSel.value));
  }

  // Benchmark iterations
  const benchIterSel = document.getElementById('settingsBenchIter');
  if (benchIterSel) {
    benchIterSel.value = s.benchIter || '5';
    benchIterSel.addEventListener('change', () => saveSetting('benchIter', benchIterSel.value));
  }

  // Toggle buttons
  function initToggle(id, settingKey, defaultVal) {
    const btn = document.getElementById(id);
    if (!btn) return;
    const val = s[settingKey] !== undefined ? s[settingKey] : defaultVal;
    btn.classList.toggle('active', val);
    btn.addEventListener('click', () => {
      const isActive = btn.classList.toggle('active');
      saveSetting(settingKey, isActive);
    });
  }
  initToggle('settingsDetailedTimings', 'detailedTimings', false);
  initToggle('settingsCacheEmbeddings', 'cacheEmbeddings', true);

  // API Key (Electron only — uses safeStorage via preload bridge)
  const apiKeyInput = document.getElementById('settingsApiKey');
  const apiKeyToggle = document.getElementById('settingsApiKeyToggle');
  const apiKeySave = document.getElementById('settingsApiKeySave');
  const apiKeyMsg = document.getElementById('settingsApiKeyMsg');
  const apiBanner = document.getElementById('settingsApiBanner');
  const apiBannerIcon = document.getElementById('settingsApiBannerIcon');

  function updateApiBanner(hasKey, key) {
    if (hasKey) {
      apiBanner.className = 'settings-api-banner success';
      apiBannerIcon.textContent = '🔐';
      apiKeyMsg.textContent = 'API key stored securely in OS keychain';
      apiKeyInput.placeholder = window.vai ? window.vai.apiKey.mask(key) : '••••••••';
    } else {
      apiBanner.className = 'settings-api-banner';
      apiBannerIcon.textContent = '⚠️';
      apiKeyMsg.textContent = 'No API key configured — add your key below to get started.';
      apiKeyInput.placeholder = 'pa-...';
    }
  }

  if (window.vai && window.vai.isElectron) {
    // Load existing key status
    window.vai.apiKey.get().then(key => updateApiBanner(!!key, key));

    // Show/hide toggle
    let keyVisible = false;
    apiKeyToggle.addEventListener('click', async () => {
      if (!keyVisible && !apiKeyInput.value) {
        const key = await window.vai.apiKey.get();
        if (key) {
          apiKeyInput.value = key;
          apiKeyInput.type = 'text';
          apiKeyToggle.textContent = '🙈';
          keyVisible = true;
        }
      } else if (keyVisible) {
        apiKeyInput.type = 'password';
        apiKeyToggle.textContent = '👁';
        keyVisible = false;
        if (!apiKeyInput.value) {
          const key = await window.vai.apiKey.get();
          if (key) apiKeyInput.placeholder = window.vai.apiKey.mask(key);
        }
      } else {
        apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
        apiKeyToggle.textContent = apiKeyInput.type === 'password' ? '👁' : '🙈';
        keyVisible = apiKeyInput.type === 'text';
      }
    });

    // Save button
    apiKeySave.addEventListener('click', async () => {
      const key = apiKeyInput.value.trim();
      if (!key) {
        await window.vai.apiKey.delete();
        updateApiBanner(false);
        flashSaved();
        return;
      }
      try {
        await window.vai.apiKey.set(key);
        apiKeyInput.value = '';
        apiKeyInput.type = 'password';
        apiKeyToggle.textContent = '👁';
        keyVisible = false;
        updateApiBanner(true, key);
        flashSaved();
        loadConfig();
      } catch (err) {
        apiBanner.className = 'settings-api-banner';
        apiBannerIcon.textContent = '❌';
        apiKeyMsg.textContent = 'Failed to save: ' + err.message;
      }
    });

    apiKeyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') apiKeySave.click();
    });
  } else {
    apiBanner.className = 'settings-api-banner';
    apiBannerIcon.textContent = '💡';
    apiKeyMsg.textContent = 'Set VOYAGE_API_KEY environment variable, or use "vai config set key YOUR_KEY"';
    apiKeySave.style.display = 'none';
    apiKeyToggle.style.display = 'none';
    apiKeyInput.disabled = true;
    apiKeyInput.placeholder = 'Secure storage available in desktop app';
  }

  // Heatmap palette preview
  const HEATMAP_GRADIENTS = {
    viridis:  'linear-gradient(90deg, #440154, #31688e, #35b779, #fde725)',
    plasma:   'linear-gradient(90deg, #0d0887, #7e03a8, #cc4778, #f89540, #f0f921)',
    inferno:  'linear-gradient(90deg, #000004, #420a68, #932667, #dd513a, #fca50a, #fcffa4)',
    magma:    'linear-gradient(90deg, #000004, #3b0f70, #8c2981, #de4968, #fea16e, #fcfdbf)',
    cividis:  'linear-gradient(90deg, #00224e, #123570, #3b496c, #575d6d, #707173, #a5a88f, #fee838)',
    turbo:    'linear-gradient(90deg, #30123b, #4662d7, #36aaf9, #1ae4b6, #72fe5e, #c8ef34, #faba39, #f66b19, #d93806, #7a0403)',
  };
  const heatmapSel = document.getElementById('settingsHeatmap');
  const heatmapPreview = document.getElementById('heatmapPreview');
  function updateHeatmapPreview() {
    if (heatmapPreview && heatmapSel) {
      heatmapPreview.style.background = HEATMAP_GRADIENTS[heatmapSel.value] || HEATMAP_GRADIENTS.viridis;
    }
  }
  if (heatmapSel) {
    heatmapSel.value = s.heatmap || 'viridis';
    heatmapSel.addEventListener('change', () => {
      saveSetting('heatmap', heatmapSel.value);
      updateHeatmapPreview();
    });
    updateHeatmapPreview();
  }

  // Clear cache
  const clearBtn = document.getElementById('settingsClearCache');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all cached data and reset settings to defaults?')) {
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem('vai-theme');
        localStorage.removeItem('vai-embed-cache');
        location.reload();
      }
    });
  }

  // Apply saved defaults on load
  if (s.defaultModel && globalModel) {
    globalModel.value = s.defaultModel;
  }
  if (s.inputType) {
    const embedType = document.getElementById('embedInputType');
    if (embedType) embedType.value = s.inputType;
  }
}

// ── Update Checker ──
function checkForAppUpdate() {
  if (!window.vai || !window.vai.isElectron) return;

  // Show version in sidebar + settings page
  window.vai.getVersion().then(v => {
    if (!v) return;
    const appVer = typeof v === 'object' ? v.app : v;
    const cliVer = typeof v === 'object' ? v.cli : null;

    const label = document.getElementById('appVersionLabel');
    if (label && appVer) label.textContent = 'v' + appVer;

    const section = document.getElementById('settingsVersionSection');
    const appBadge = document.getElementById('settingsAppVersion');
    const cliBadge = document.getElementById('settingsCliVersion');
    if (section) section.style.display = '';
    if (appBadge && appVer) appBadge.textContent = 'v' + appVer;
    if (cliBadge && cliVer) cliBadge.textContent = 'v' + cliVer;
  });

  // Don't check more than once per hour
  const DISMISS_KEY = 'vai-update-dismissed';
  const dismissed = localStorage.getItem(DISMISS_KEY);
  if (dismissed) {
    const dismissedAt = parseInt(dismissed, 10);
    if (Date.now() - dismissedAt < 3600000) return;
  }

  // Listen for real-time update events from electron-updater
  if (window.vai.updates.onEvent) {
    window.vai.updates.onEvent((data) => {
      const banner = document.getElementById('updateBanner');
      const progressWrap = document.getElementById('updateProgress');
      const progressFill = document.getElementById('updateProgressFill');
      const progressLabel = document.getElementById('updateProgressLabel');
      const bannerText = document.getElementById('updateBannerText');
      const downloadBtn = document.getElementById('updateDownloadBtn');
      const installBtn = document.getElementById('updateInstallBtn');

      if (data.event === 'download-progress') {
        const pct = Math.round(data.percent || 0);
        progressFill.style.width = pct + '%';
        const mbTransferred = (data.transferred / 1048576).toFixed(1);
        const mbTotal = (data.total / 1048576).toFixed(1);
        progressLabel.textContent = `${pct}% (${mbTransferred}/${mbTotal} MB)`;
      }

      if (data.event === 'update-downloaded') {
        progressWrap.style.display = 'none';
        bannerText.innerHTML = `<strong>Vai v${data.latestVersion}</strong> is ready to install.`;
        bannerText.style.display = '';
        downloadBtn.style.display = 'none';
        installBtn.style.display = '';
      }

      if (data.event === 'update-error') {
        progressWrap.style.display = 'none';
        bannerText.innerHTML = `Update failed: ${data.message}. <a href="#" onclick="window.vai.updates.openRelease('https://github.com/mrlynn/voyageai-cli/releases');return false;" style="color:var(--accent);">Download manually</a>`;
        bannerText.style.display = '';
        downloadBtn.style.display = 'none';
      }
    });
  }

  window.vai.updates.check().then(result => {
    if (!result || !result.hasUpdate) return;

    const banner = document.getElementById('updateBanner');
    const versionEl = document.getElementById('updateVersion');
    const currentEl = document.getElementById('currentVersion');
    const downloadBtn = document.getElementById('updateDownloadBtn');
    const installBtn = document.getElementById('updateInstallBtn');
    const dismissBtn = document.getElementById('updateDismissBtn');
    const bannerText = document.getElementById('updateBannerText');
    const progressWrap = document.getElementById('updateProgress');

    if (!banner) return;

    versionEl.textContent = 'v' + result.latestVersion;
    currentEl.textContent = 'v' + result.currentVersion;
    banner.classList.add('show');

    downloadBtn.addEventListener('click', () => {
      // Start auto-download
      if (window.vai.updates.download) {
        downloadBtn.style.display = 'none';
        bannerText.style.display = 'none';
        progressWrap.style.display = 'flex';
        window.vai.updates.download().catch(() => {
          // Fallback to manual download
          window.vai.updates.openRelease(result.releaseUrl);
        });
      } else {
        window.vai.updates.openRelease(result.releaseUrl);
      }
    });

    installBtn.addEventListener('click', () => {
      installBtn.textContent = 'Restarting...';
      installBtn.disabled = true;
      window.vai.updates.install();
    });

    dismissBtn.addEventListener('click', () => {
      banner.classList.remove('show');
      localStorage.setItem(DISMISS_KEY, String(Date.now()));
    });
  }).catch(() => {
    // Silent fail — update check is non-critical
  });
}

// ── Onboarding Walkthrough ──
function initOnboarding() {
  const ONBOARDING_KEY = 'vai-onboarding-complete';
  const overlay = document.getElementById('onboardingOverlay');
  const welcomeWrap = document.getElementById('onboardingWelcomeWrap');
  const welcomeCard = document.getElementById('onboardingWelcomeCard');
  const tooltip = document.getElementById('onboardingTooltip');
  const spotlight = document.getElementById('onboardingSpotlight');
  const arrow = document.getElementById('onboardingArrow');
  const dotsContainer = document.getElementById('onboardingDots');
  const titleEl = document.getElementById('onboardingTitle');
  const bodyEl = document.getElementById('onboardingBody');
  const iconEl = document.getElementById('onboardingIcon');

  if (!overlay) return;

  const isElectron = !!(window.vai && window.vai.isElectron);

  const steps = [
    {
      target: null, // welcome card, no spotlight
      icon: '🚀',
      title: 'Welcome to Vai',
      body: 'Explore embeddings, build RAG pipelines, generate production code — all from one playground.',
    },
    {
      target: '[data-tab="settings"]',
      icon: '🔑',
      title: 'API Key Setup',
      body: 'First, add your <strong>Voyage AI API key</strong> in Settings. You can get one free at <strong>dash.voyageai.com</strong>.' +
        (isElectron ? '<br><br>💎 On desktop, your key is encrypted via <strong>OS keychain</strong> for secure storage.' : ''),
      arrow: 'left',
    },
    {
      target: '[data-tab="embed"]',
      icon: '⚡',
      title: 'Embed',
      body: 'Turn any text into a <strong>vector embedding</strong> — a numerical fingerprint that captures meaning. Visualize the raw vectors and explore what models produce.',
      arrow: 'left',
    },
    {
      target: '[data-tab="compare"]',
      icon: '🔥',
      title: 'Compare',
      body: 'Paste multiple texts and see a <strong>similarity heatmap</strong> — instantly discover which phrases are semantically close and which are far apart.',
      arrow: 'left',
    },
    {
      target: '[data-tab="search"]',
      icon: '🔍',
      title: 'Search & Rerank',
      body: 'Run <strong>vector search</strong> against a set of documents and optionally <strong>rerank</strong> results for higher precision. Great for building RAG pipelines.',
      arrow: 'left',
    },
    {
      target: '[data-tab="multimodal"]',
      icon: '🖼️',
      title: 'Multimodal',
      body: 'Embed <strong>images and text</strong> in the same vector space. Search images with text queries, or find similar images across your collection.',
      arrow: 'left',
    },
    {
      target: '[data-tab="generate"]',
      icon: '💻',
      title: 'Generate & Scaffold',
      body: '<strong>Generate code snippets</strong> for retrieval, ingestion, and API routes — or <strong>scaffold entire projects</strong> with Next.js, Express, or Flask.' +
        (isElectron ? ' Create projects directly on disk.' : ' Download as ZIP.'),
      arrow: 'left',
    },
    {
      target: '[data-tab="chat"]',
      icon: '💬',
      title: 'RAG Chat',
      body: '<strong>Chat with your knowledge base</strong> using retrieval-augmented generation. Voyage AI finds relevant documents, then your chosen LLM generates grounded answers with source citations.',
      arrow: 'left',
    },
    {
      target: '[data-tab="benchmark"]',
      icon: '⏱️',
      title: 'Benchmark',
      body: 'Compare model <strong>latency, throughput, and cost</strong>. Test embedding speeds, reranking quality, and quantization trade-offs.',
      arrow: 'left',
    },
    {
      target: '[data-tab="explore"]',
      icon: '💡',
      title: 'Explore & Learn',
      body: 'Dive into <strong>25 interactive explainers</strong> covering embeddings, vector search, RAG, reranking, and more. Each topic links to live demos.',
      arrow: 'left',
    },
  ];

  let currentStep = 0;
  const totalSteps = steps.length;

  function buildDots() {
    dotsContainer.innerHTML = '';
    for (let i = 1; i < totalSteps; i++) {
      const dot = document.createElement('div');
      dot.className = 'onboarding-dot';
      if (i < currentStep) dot.classList.add('completed');
      if (i === currentStep) dot.classList.add('active');
      dotsContainer.appendChild(dot);
    }
  }

  function positionTooltipNear(targetEl) {
    const step = steps[currentStep];
    const rect = targetEl.getBoundingClientRect();

    // Position spotlight over the target
    spotlight.style.display = 'block';
    const pad = 6;
    spotlight.style.left = (rect.left - pad) + 'px';
    spotlight.style.top = (rect.top - pad) + 'px';
    spotlight.style.width = (rect.width + pad * 2) + 'px';
    spotlight.style.height = (rect.height + pad * 2) + 'px';

    // Reset arrow classes
    arrow.className = 'onboarding-tooltip-arrow';

    // Position tooltip to the right of sidebar items
    if (step.arrow === 'left') {
      arrow.classList.add('left');
      tooltip.style.left = (rect.right + 16) + 'px';
      tooltip.style.top = Math.max(8, rect.top - 10) + 'px';
      tooltip.style.right = 'auto';
      tooltip.style.bottom = 'auto';
    } else {
      // Below the target
      arrow.classList.add('top');
      tooltip.style.left = Math.max(8, rect.left) + 'px';
      tooltip.style.top = (rect.bottom + 14) + 'px';
      tooltip.style.right = 'auto';
      tooltip.style.bottom = 'auto';
    }

    // Ensure tooltip doesn't overflow viewport
    requestAnimationFrame(() => {
      const tr = tooltip.getBoundingClientRect();
      if (tr.bottom > window.innerHeight - 10) {
        tooltip.style.top = Math.max(8, window.innerHeight - tr.height - 10) + 'px';
      }
      if (tr.right > window.innerWidth - 10) {
        tooltip.style.left = Math.max(8, window.innerWidth - tr.width - 10) + 'px';
      }
    });
  }

  function showStep(idx) {
    currentStep = idx;
    const step = steps[idx];

    if (idx === 0) {
      // Welcome card — centered, no spotlight
      welcomeWrap.style.display = 'flex';
      tooltip.classList.remove('visible');
      tooltip.style.display = 'none';
      spotlight.style.display = 'none';
      requestAnimationFrame(() => {
        welcomeCard.classList.add('visible');
      });
      return;
    }

    // Hide welcome card
    welcomeWrap.style.display = 'none';
    welcomeCard.classList.remove('visible');

    // Show tooltip
    tooltip.style.display = 'block';
    tooltip.classList.remove('visible');
    iconEl.textContent = step.icon;
    titleEl.textContent = step.title;
    bodyEl.innerHTML = step.body;
    buildDots();

    // Update next button text
    const nextBtn = document.getElementById('onboardingNext');
    nextBtn.textContent = (idx === totalSteps - 1) ? 'Get Started' : 'Next';

    // Find target element and position
    const targetEl = document.querySelector(step.target);
    if (targetEl) {
      positionTooltipNear(targetEl);
    }

    requestAnimationFrame(() => {
      tooltip.classList.add('visible');
    });
  }

  function finish() {
    tooltip.classList.remove('visible');
    welcomeCard.classList.remove('visible');
    spotlight.style.display = 'none';
    setTimeout(() => {
      overlay.classList.remove('active');
    }, 300);
    localStorage.setItem(ONBOARDING_KEY, 'true');
  }

  function nextStep() {
    if (currentStep < totalSteps - 1) {
      showStep(currentStep + 1);
    } else {
      finish();
    }
  }

  // Wire up buttons
  document.getElementById('onboardingWelcomeNext').addEventListener('click', nextStep);
  document.getElementById('onboardingWelcomeSkip').addEventListener('click', finish);
  document.getElementById('onboardingNext').addEventListener('click', nextStep);
  document.getElementById('onboardingSkip').addEventListener('click', finish);
  document.getElementById('onboardingBackdrop').addEventListener('click', finish);

  // "Show Welcome Tour" button in settings
  const tourBtn = document.getElementById('settingsShowTour');
  if (tourBtn) {
    tourBtn.addEventListener('click', () => {
      startOnboarding();
    });
  }

  // Auto-start on first visit
  function startOnboarding() {
    // Sync onboarding logo with current theme
    const onboardLogo = document.getElementById('onboardingLogo');
    if (onboardLogo) {
      const theme = localStorage.getItem('vai-theme') || 'dark';
      onboardLogo.src = '/icons/' + (theme === 'light' ? 'light' : 'dark') + '/64.png';
    }
    overlay.classList.add('active');
    showStep(0);
  }

  if (!localStorage.getItem(ONBOARDING_KEY)) {
    // Delay slightly so the app is fully rendered
    setTimeout(startOnboarding, 600);
  }

  // Expose for manual replay
  window.startOnboarding = startOnboarding;
}

// ── Multimodal Tab ──
let mmImageData = null; // base64 data URL of the uploaded image
let mmGalleryImages = []; // array of { dataUrl, name, size }
let mmSearchMode = 'text';
let mmSearchImageIndex = -1;

function initMultimodal() {
  const dropZone = document.getElementById('mmDropZone');
  const fileInput = document.getElementById('mmFileInput');

  // Click to browse
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) handleMultimodalImage(e.target.files[0]);
  });

  // Drag and drop
  ['dragenter', 'dragover'].forEach(evt => {
    dropZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-active');
    });
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-active');
    });
  });
  dropZone.addEventListener('drop', (e) => {
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleMultimodalImage(e.dataTransfer.files[0]);
    }
  });

  // Paste from clipboard
  document.addEventListener('paste', (e) => {
    // Only handle if multimodal tab is active
    const panel = document.getElementById('tab-multimodal');
    if (!panel || !panel.classList.contains('active')) return;
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.type.startsWith('image/')) {
        e.preventDefault();
        handleMultimodalImage(item.getAsFile());
        return;
      }
    }
  });

  // Gallery
  renderGalleryGrid();

  const galleryInput = document.getElementById('mmGalleryFileInput');
  galleryInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      addGalleryImage(e.target.files[0]);
    }
    galleryInput.value = '';
  });
}

function handleMultimodalImage(file) {
  const VALID_TYPES = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];
  if (!VALID_TYPES.includes(file.type)) {
    showError('mmError', 'Unsupported image type. Use PNG, JPEG, WebP, or GIF.');
    return;
  }
  if (file.size > 20 * 1024 * 1024) {
    showError('mmError', 'Image too large. Maximum size is 20 MB.');
    return;
  }
  hideError('mmError');

  const reader = new FileReader();
  reader.onload = (e) => {
    mmImageData = e.target.result;
    const img = document.getElementById('mmPreviewImg');
    img.src = mmImageData;

    img.onload = () => {
      const info = document.getElementById('mmFileInfo');
      const sizeStr = file.size > 1024 * 1024
        ? (file.size / (1024 * 1024)).toFixed(1) + ' MB'
        : (file.size / 1024).toFixed(0) + ' KB';
      info.textContent = `${file.name} · ${img.naturalWidth}×${img.naturalHeight} · ${sizeStr}`;
    };

    document.getElementById('mmDropZone').style.display = 'none';
    document.getElementById('mmPreview').classList.add('visible');
  };
  reader.readAsDataURL(file);
}

window.clearMultimodalImage = function() {
  mmImageData = null;
  document.getElementById('mmPreviewImg').src = '';
  document.getElementById('mmFileInfo').textContent = '';
  document.getElementById('mmPreview').classList.remove('visible');
  document.getElementById('mmDropZone').style.display = '';
  document.getElementById('mmFileInput').value = '';
};

window.doMultimodalCompare = async function() {
  hideError('mmError');
  sendTelemetry('api_call', { endpoint: 'multimodal-compare', model: document.getElementById('mmModel').value });
  const text = document.getElementById('mmText').value.trim();
  if (!mmImageData) { showError('mmError', 'Upload an image first'); return; }
  if (!text) { showError('mmError', 'Enter text to compare against the image'); return; }

  setLoading('mmCompareBtn', true);
  try {
    const model = document.getElementById('mmModel').value;
    const dimsVal = document.getElementById('mmDimensions').value;
    const body = {
      inputs: [
        { content: [{ type: 'image_base64', image_base64: mmImageData }] },
        { content: [{ type: 'text', text: text }] }
      ],
      model: model,
      input_type: 'document'
    };
    if (dimsVal) body.output_dimension = parseInt(dimsVal, 10);

    const data = await apiPost('/api/multimodal-embed', body);

    const vecA = data.data[0].embedding;
    const vecB = data.data[1].embedding;
    const cosine = cosineSim(vecA, vecB);

    // Hero display
    const cosinePct = Math.max(0, cosine * 100);
    let cosineColor;
    if (cosine > 0.7) cosineColor = 'var(--green)';
    else if (cosine > 0.4) cosineColor = 'var(--yellow)';
    else cosineColor = 'var(--red)';

    const scoreEl = document.getElementById('mmSimScore');
    scoreEl.textContent = cosine.toFixed(4);
    scoreEl.style.color = cosineColor;

    const barEl = document.getElementById('mmSimBar');
    barEl.style.width = cosinePct + '%';
    barEl.style.background = cosineColor;

    // Stats
    const usage = data.usage || {};
    const statsEl = document.getElementById('mmStats');
    statsEl.innerHTML = `
      <span class="stat"><span class="stat-label">Model</span><span class="stat-value">${data.model || model}</span></span>
      <span class="stat"><span class="stat-label">Dimensions</span><span class="stat-value">${vecA.length}</span></span>
      <span class="stat"><span class="stat-label">Text Tokens</span><span class="stat-value">${usage.text_tokens || '—'}</span></span>
      <span class="stat"><span class="stat-label">Image Pixels</span><span class="stat-value">${usage.image_pixels ? usage.image_pixels.toLocaleString() : '—'}</span></span>
      <span class="stat"><span class="stat-label">Total Tokens</span><span class="stat-value">${usage.total_tokens || '—'}</span></span>
    `;

    // Insight note
    const noteEl = document.getElementById('mmNote');
    if (cosine > 0.7) {
      noteEl.innerHTML = '💡 <strong>High similarity!</strong> The image and text are closely related in Voyage AI\'s multimodal embedding space. This means the text is a good semantic description of the image.';
    } else if (cosine > 0.4) {
      noteEl.innerHTML = '💡 <strong>Moderate similarity.</strong> The image and text share some semantic overlap. They may be related but not a direct match.';
    } else {
      noteEl.innerHTML = '💡 <strong>Low similarity.</strong> The image and text are semantically distant. Try a description that matches the image content more closely.';
    }

    document.getElementById('mmResult').classList.add('visible');
  } catch (err) {
    showError('mmError', err.message);
  } finally {
    setLoading('mmCompareBtn', false);
  }
};

// Gallery functions
function renderGalleryGrid() {
  const grid = document.getElementById('mmGalleryGrid');
  grid.innerHTML = '';

  mmGalleryImages.forEach((img, i) => {
    const slot = document.createElement('div');
    slot.className = 'mm-gallery-slot filled' + (mmSearchMode === 'image' && mmSearchImageIndex === i ? ' query-selected' : '');
    slot.innerHTML = `<img src="${img.dataUrl}" alt="${img.name}"><button class="mm-slot-remove" title="Remove">×</button>`;
    slot.querySelector('.mm-slot-remove').addEventListener('click', (e) => {
      e.stopPropagation();
      removeGalleryImage(i);
    });
    if (mmSearchMode === 'image') {
      slot.style.cursor = 'pointer';
      slot.addEventListener('click', () => selectGalleryImageAsQuery(i));
    }
    grid.appendChild(slot);
  });

  // Add empty slot if under 6
  if (mmGalleryImages.length < 6) {
    const addSlot = document.createElement('div');
    addSlot.className = 'mm-gallery-slot';
    addSlot.innerHTML = '<span class="mm-slot-add">+</span>';
    addSlot.addEventListener('click', () => {
      document.getElementById('mmGalleryFileInput').click();
    });
    grid.appendChild(addSlot);
  }
}

function addGalleryImage(file) {
  const VALID_TYPES = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];
  if (!VALID_TYPES.includes(file.type)) return;
  if (file.size > 20 * 1024 * 1024) return;
  if (mmGalleryImages.length >= 6) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    mmGalleryImages.push({ dataUrl: e.target.result, name: file.name, size: file.size });
    renderGalleryGrid();
  };
  reader.readAsDataURL(file);
}

function removeGalleryImage(index) {
  mmGalleryImages.splice(index, 1);
  if (mmSearchImageIndex === index) mmSearchImageIndex = -1;
  else if (mmSearchImageIndex > index) mmSearchImageIndex--;
  renderGalleryGrid();
  updateSearchImageLabel();
}

function selectGalleryImageAsQuery(index) {
  mmSearchImageIndex = (mmSearchImageIndex === index) ? -1 : index;
  renderGalleryGrid();
  updateSearchImageLabel();
}

function updateSearchImageLabel() {
  const label = document.getElementById('mmSearchImageLabel');
  if (mmSearchImageIndex >= 0 && mmSearchImageIndex < mmGalleryImages.length) {
    label.textContent = '✓ Image ' + (mmSearchImageIndex + 1) + ' selected as query';
    label.style.color = 'var(--accent)';
  } else {
    label.textContent = 'No image selected';
    label.style.color = 'var(--text-muted)';
  }
}

window.setMmSearchMode = function(mode) {
  mmSearchMode = mode;
  document.querySelectorAll('#mmSearchMode button').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
  document.getElementById('mmSearchTextWrap').style.display = mode === 'text' ? '' : 'none';
  document.getElementById('mmSearchImageWrap').style.display = mode === 'image' ? '' : 'none';
  renderGalleryGrid();
};

window.doMultimodalSearch = async function() {
  hideError('mmSearchError');
  sendTelemetry('api_call', { endpoint: 'multimodal-search', model: document.getElementById('mmModel').value });

  const corpusText = document.getElementById('mmCorpusText').value.trim();
  const textItems = corpusText ? corpusText.split('\n').map(t => t.trim()).filter(Boolean) : [];

  if (mmGalleryImages.length === 0 && textItems.length === 0) {
    showError('mmSearchError', 'Add at least one image or text to the corpus');
    return;
  }

  // Build query input
  let queryInput;
  if (mmSearchMode === 'text') {
    const q = document.getElementById('mmSearchQuery').value.trim();
    if (!q) { showError('mmSearchError', 'Enter a search query'); return; }
    queryInput = { content: [{ type: 'text', text: q }] };
  } else {
    if (mmSearchImageIndex < 0 || mmSearchImageIndex >= mmGalleryImages.length) {
      showError('mmSearchError', 'Select an image from the corpus to use as query');
      return;
    }
    queryInput = { content: [{ type: 'image_base64', image_base64: mmGalleryImages[mmSearchImageIndex].dataUrl }] };
  }

  const btnId = mmSearchMode === 'text' ? 'mmSearchBtn' : 'mmSearchImgBtn';
  setLoading(btnId, true);

  try {
    const model = document.getElementById('mmModel').value;
    const dimsVal = document.getElementById('mmDimensions').value;

    // Build corpus inputs
    const corpusInputs = [];
    const corpusMeta = []; // track type/content for display

    mmGalleryImages.forEach((img, i) => {
      corpusInputs.push({ content: [{ type: 'image_base64', image_base64: img.dataUrl }] });
      corpusMeta.push({ type: 'image', dataUrl: img.dataUrl, label: img.name || 'Image ' + (i + 1) });
    });

    textItems.forEach(t => {
      corpusInputs.push({ content: [{ type: 'text', text: t }] });
      corpusMeta.push({ type: 'text', label: t });
    });

    // Embed query + all corpus items in one call
    const allInputs = [queryInput, ...corpusInputs];
    const body = {
      inputs: allInputs,
      model: model,
      input_type: 'document'
    };
    if (dimsVal) body.output_dimension = parseInt(dimsVal, 10);

    const data = await apiPost('/api/multimodal-embed', body);

    const queryVec = data.data[0].embedding;
    const results = corpusMeta.map((meta, i) => {
      const vec = data.data[i + 1].embedding;
      const sim = cosineSim(queryVec, vec);
      return { ...meta, similarity: sim };
    }).sort((a, b) => b.similarity - a.similarity);

    // Render results
    const listEl = document.getElementById('mmSearchResultList');
    listEl.innerHTML = '';

    results.forEach((r, i) => {
      let simColor;
      if (r.similarity > 0.7) simColor = 'var(--green)';
      else if (r.similarity > 0.4) simColor = 'var(--yellow)';
      else simColor = 'var(--red)';

      const item = document.createElement('div');
      item.className = 'mm-result-item';

      const thumbHtml = r.type === 'image'
        ? `<img class="mm-result-thumb" src="${r.dataUrl}" alt="${r.label}">`
        : `<div class="mm-result-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--bg-surface);font-size:18px;">📝</div>`;

      item.innerHTML = `
        <div class="mm-result-rank">#${i + 1}</div>
        ${thumbHtml}
        <div class="mm-result-content">
          <div class="mm-result-text" title="${r.label.replace(/"/g, '&quot;')}">${r.label}</div>
          <div class="mm-result-type">${r.type}</div>
        </div>
        <div class="mm-result-score" style="color:${simColor}">${r.similarity.toFixed(4)}</div>
      `;
      listEl.appendChild(item);
    });

    document.getElementById('mmSearchResult').classList.add('visible');
  } catch (err) {
    showError('mmSearchError', err.message);
  } finally {
    setLoading(btnId, false);
  }
};

// ── Patch init to include benchmark setup ──
const _origInit = init;
init = async function() {
  await _origInit();
  initThemeToggle();
  buildModelCheckboxes();
  populateBenchRankSelects();
  populateQuantModelSelect();
  initCostCalculator();
  renderHistory();
  initSettings();
  initMultimodal();
  checkForAppUpdate();
  initOnboarding();
};  

// ── Start ──
init();
 
// ──  Vector Space Invaders (Easter Egg) ──    
(function initEasterEgg() {
  const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
  let konamiIdx = 0;
  let logoClicks = [];

  document.addEventListener('keydown', (e) => {
    if (document.getElementById('vsiOverlay')?.style.display === 'flex') return;
    if (e.key === KONAMI[konamiIdx]) { konamiIdx++; if (konamiIdx === KONAMI.length) { konamiIdx = 0; launchVSI(); } }
    else { konamiIdx = 0; }
  });

  const logo = document.getElementById('sidebarLogo');
  if (logo) {
    logo.addEventListener('click', () => {
      const now = Date.now();
      logoClicks.push(now);
      logoClicks = logoClicks.filter(t => now - t < 2000);
      if (logoClicks.length >= 7) { logoClicks = []; launchVSI(); }
    });
  }

  function launchVSI() {
    const overlay = document.getElementById('vsiOverlay');
    const canvas = document.getElementById('vsiCanvas');
    if (!overlay || !canvas) return;
    overlay.style.display = 'flex';
    startVSI(canvas, () => { overlay.style.display = 'none'; });
  }
})();

function startVSI(canvas, onExit) {
  const ctx = canvas.getContext('2d');
  const W = canvas.width = 600;
  const H = canvas.height = 500;

  // Helper function to draw a leaf shape
  function drawLeaf(ctx, x, y, size, color) {
    ctx.fillStyle = color;
    ctx.beginPath();
    // Leaf shape using bezier curves
    ctx.moveTo(x, y - size);
    ctx.quadraticCurveTo(x + size * 0.6, y - size * 0.3, x + size * 0.3, y + size * 0.5);
    ctx.quadraticCurveTo(x, y + size * 0.3, x, y + size);
    ctx.quadraticCurveTo(x, y + size * 0.3, x - size * 0.3, y + size * 0.5);
    ctx.quadraticCurveTo(x - size * 0.6, y - size * 0.3, x, y - size);
    ctx.fill();
    // Central vein
    ctx.strokeStyle = color === '#00ED64' ? '#00A35C' : color;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x, y - size);
    ctx.lineTo(x, y + size);
    ctx.stroke();
  }

  // Ship
  const ship = { x: W / 2, w: 40, h: 16, speed: 5 };
  const bullets = [];
  const particles = [];
  const explosionTexts = [];

  // Enemies — vectors descending
  const VECTORS = [
    '[.23,-.41]', '[.95, .12]', '[-.56,.78]',
    '[.44,-.71]', '[.01,-.99]', '[-.88,.35]',
    '[.67, .91]', '[-.12,.84]', '[.33, .33]',
    '[.77,-.64]', '[-.45,.78]', '[.91,-.42]',
  ];
  const BOSS_VEC = 'CLIP-ViT-L/14-336';

  let enemies = [];
  let wave = 1;
  let score = 0;
  let lives = 3;
  let gameOver = false;
  let bossMode = false;
  let boss = null;
  let frame = 0;
  let lastShot = 0;
  let waveQueued = false;

  const keys = {};
  const keyDown = (e) => { keys[e.key] = true; if (['ArrowLeft','ArrowRight',' ','Escape'].includes(e.key)) e.preventDefault(); if (e.key === 'Escape') { cleanup(); onExit(); } };
  const keyUp = (e) => { keys[e.key] = false; };
  document.addEventListener('keydown', keyDown);
  document.addEventListener('keyup', keyUp);

  function cleanup() { document.removeEventListener('keydown', keyDown); document.removeEventListener('keyup', keyUp); gameOver = true; }

  function spawnWave() {
    enemies = [];
    if (wave % 5 === 0) {
      // Boss wave every 5 waves
      bossMode = true;
      boss = { x: W / 2, y: 50, w: 180, h: 30, hp: 10 + wave, maxHp: 10 + wave, dx: 2, text: BOSS_VEC };
    } else {
      bossMode = false;
      boss = null;
      const rows = Math.min(3, 1 + Math.floor(wave / 2));
      const cols = Math.min(6, 3 + Math.floor(wave / 3));
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          enemies.push({
            x: 60 + c * 90,
            y: 40 + r * 40,
            w: 78, h: 22,
            hp: 1 + Math.floor(wave / 4),
            text: VECTORS[(r * cols + c) % VECTORS.length],
            dx: 1 + wave * 0.3,
            dir: 1,
          });
        }
      }
    }
  }

  function shoot() {
    if (frame - lastShot < 10) return;
    lastShot = frame;
    bullets.push({ x: ship.x, y: H - 40, dy: -7 });
  }

  function addExplosion(x, y, sim) {
    const color = sim > 0.7 ? '#00ED64' : sim > 0.4 ? '#FFC010' : '#FF6960';
    for (let i = 0; i < 8; i++) {
      const angle = (Math.PI * 2 / 8) * i + Math.random() * 0.5;
      const speed = 1.5 + Math.random() * 2;
      const isLeaf = i % 3 === 0; // Every 3rd particle is a leaf
      particles.push({ x, y, dx: Math.cos(angle) * speed, dy: Math.sin(angle) * speed, life: 30, color, isLeaf });
    }
    explosionTexts.push({ x, y, text: sim.toFixed(2), life: 40, color });
  }

  function update() {
    // Move ship
    if (keys['ArrowLeft'] || keys['a'])  ship.x = Math.max(ship.w / 2, ship.x - ship.speed);
    if (keys['ArrowRight'] || keys['d']) ship.x = Math.min(W - ship.w / 2, ship.x + ship.speed);
    if (keys[' ']) shoot();

    // Move bullets
    for (let i = bullets.length - 1; i >= 0; i--) {
      bullets[i].y += bullets[i].dy;
      if (bullets[i].y < -10) bullets.splice(i, 1);
    }

    // Boss logic
    if (bossMode && boss) {
      boss.x += boss.dx;
      if (boss.x < boss.w / 2 || boss.x > W - boss.w / 2) boss.dx *= -1;
      // Boss drops enemy vectors periodically
      if (frame % 60 === 0) {
        enemies.push({ x: boss.x, y: boss.y + 30, w: 78, h: 22, hp: 1, text: VECTORS[frame % VECTORS.length], dx: 0, dir: 0, dropping: true, dy: 2 });
      }
      // Bullet-boss collision
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        if (b.x > boss.x - boss.w / 2 && b.x < boss.x + boss.w / 2 && b.y > boss.y - boss.h / 2 && b.y < boss.y + boss.h / 2) {
          boss.hp--;
          bullets.splice(i, 1);
          const sim = 0.1 + Math.random() * 0.3;
          addExplosion(b.x, b.y, sim);
          score += 50;
          if (boss.hp <= 0) {
            addExplosion(boss.x, boss.y, 0.99);
            score += 500;
            boss = null;
            bossMode = false;
            wave++;
            waveQueued = true;
            setTimeout(() => { waveQueued = false; spawnWave(); }, 1000);
          }
        }
      }
    }

    // Move enemies
    let edgeHit = false;
    for (const e of enemies) {
      if (e.dropping) {
        e.y += e.dy || 2;
      } else {
        e.x += e.dx * e.dir;
        if (e.x < 30 || e.x > W - 30) edgeHit = true;
      }
    }
    if (edgeHit) {
      for (const e of enemies) {
        if (!e.dropping) { e.dir *= -1; e.y += 15; }
      }
    }

    // Bullet-enemy collision
    for (let i = bullets.length - 1; i >= 0; i--) {
      for (let j = enemies.length - 1; j >= 0; j--) {
        const b = bullets[i], e = enemies[j];
        if (!b) break;
        if (b.x > e.x - e.w / 2 && b.x < e.x + e.w / 2 && b.y > e.y - e.h / 2 && b.y < e.y + e.h / 2) {
          e.hp--;
          bullets.splice(i, 1);
          const sim = 0.5 + Math.random() * 0.5;
          addExplosion(b.x, b.y, sim);
          if (e.hp <= 0) {
            enemies.splice(j, 1);
            score += 100;
          }
          break;
        }
      }
    }

    // Enemy reaching bottom = lose life
    for (let i = enemies.length - 1; i >= 0; i--) {
      if (enemies[i].y > H - 50) {
        enemies.splice(i, 1);
        lives--;
        if (lives <= 0) gameOver = true;
      }
    }

    // Next wave
    if (!bossMode && enemies.length === 0 && !gameOver && !waveQueued) {
      wave++;
      waveQueued = true;
      setTimeout(() => { waveQueued = false; spawnWave(); }, 800);
    }

    // Particles
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.x += p.dx; p.y += p.dy; p.life--;
      if (p.life <= 0) particles.splice(i, 1);
    }
    for (let i = explosionTexts.length - 1; i >= 0; i--) {
      explosionTexts[i].y -= 0.5;
      explosionTexts[i].life--;
      if (explosionTexts[i].life <= 0) explosionTexts.splice(i, 1);
    }
  }

  function draw() {
    ctx.fillStyle = '#001E2B';
    ctx.fillRect(0, 0, W, H);

    // Stars
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    for (let i = 0; i < 40; i++) {
      const sx = (i * 137 + frame * 0.1) % W;
      const sy = (i * 97 + frame * 0.05) % H;
      ctx.fillRect(sx, sy, 1, 1);
    }

    // Ship (Voyage AI leaf)
    drawLeaf(ctx, ship.x, H - 32, 12, '#00ED64');
    // Ship label
    ctx.fillStyle = '#00ED64';
    ctx.font = '9px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('voyage', ship.x, H - 14);

    // Bullets (small leaf shapes)
    for (const b of bullets) {
      drawLeaf(ctx, b.x, b.y, 3, '#00ED64');
    }

    // Boss
    if (boss) {
      const hpPct = boss.hp / boss.maxHp;
      ctx.fillStyle = hpPct > 0.5 ? '#FF6960' : '#FFC010';
      ctx.strokeStyle = '#FF6960';
      ctx.lineWidth = 2;
      ctx.strokeRect(boss.x - boss.w / 2, boss.y - boss.h / 2, boss.w, boss.h);
      ctx.fillStyle = '#FF6960';
      ctx.font = 'bold 13px monospace';
      ctx.textAlign = 'center';
      ctx.fillText(boss.text, boss.x, boss.y + 5);
      // HP bar
      ctx.fillStyle = '#3D4F58';
      ctx.fillRect(boss.x - boss.w / 2, boss.y - boss.h / 2 - 8, boss.w, 4);
      ctx.fillStyle = '#FF6960';
      ctx.fillRect(boss.x - boss.w / 2, boss.y - boss.h / 2 - 8, boss.w * hpPct, 4);
    }

    // Enemies
    for (const e of enemies) {
      ctx.fillStyle = 'rgba(61,79,88,0.6)';
      ctx.fillRect(e.x - e.w / 2, e.y - e.h / 2, e.w, e.h);
      ctx.strokeStyle = '#0498EC';
      ctx.lineWidth = 1;
      ctx.strokeRect(e.x - e.w / 2, e.y - e.h / 2, e.w, e.h);
      ctx.fillStyle = '#E8EDEB';
      ctx.font = '9px monospace';
      ctx.textAlign = 'center';
      ctx.fillText(e.text, e.x, e.y + 3);
    }

    // Particles (with occasional leaf shapes)
    for (const p of particles) {
      ctx.globalAlpha = p.life / 30;
      if (p.isLeaf) {
        drawLeaf(ctx, p.x, p.y, 2, p.color);
      } else {
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
      }
    }
    ctx.globalAlpha = 1;

    // Explosion texts (similarity scores)
    for (const et of explosionTexts) {
      ctx.globalAlpha = et.life / 40;
      ctx.fillStyle = et.color;
      ctx.font = 'bold 14px monospace';
      ctx.textAlign = 'center';
      ctx.fillText(et.text, et.x, et.y);
    }
    ctx.globalAlpha = 1;

    // HUD
    ctx.fillStyle = '#E8EDEB';
    ctx.font = '13px monospace';
    ctx.textAlign = 'left';
    ctx.fillText(`SCORE: ${score}`, 12, 20);
    ctx.fillText(`WAVE: ${wave}`, 12, 38);

    // Lives (leaf icons)
    for (let i = 0; i < lives; i++) {
      drawLeaf(ctx, W - 20 - (i * 18), 15, 6, '#00ED64');
    }

    // Title with Voyage AI branding
    ctx.fillStyle = '#00ED64';
    ctx.font = 'bold 10px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('VECTOR SPACE INVADERS', W / 2, H - 4);

    // Voyage AI watermark (top right corner)
    ctx.globalAlpha = 0.3;
    drawLeaf(ctx, W - 25, 25, 8, '#00ED64');
    ctx.fillStyle = '#00ED64';
    ctx.font = 'bold 9px monospace';
    ctx.textAlign = 'right';
    ctx.fillText('VOYAGE AI', W - 38, 28);
    ctx.globalAlpha = 1;

    // Game over
    if (gameOver) {
      ctx.fillStyle = 'rgba(0,30,43,0.8)';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#00ED64';
      ctx.font = 'bold 28px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('GAME OVER', W / 2, H / 2 - 30);
      ctx.fillStyle = '#E8EDEB';
      ctx.font = '16px monospace';
      ctx.fillText(`Final Score: ${score}  |  Wave: ${wave}`, W / 2, H / 2 + 10);
      ctx.fillStyle = '#889397';
      ctx.font = '12px monospace';
      ctx.fillText('Press SPACE to play again  |  ESC to exit', W / 2, H / 2 + 40);

      if (keys[' ']) {
        // Restart
        score = 0; wave = 1; lives = 3; gameOver = false; waveQueued = false;
        enemies = []; bullets.length = 0; particles.length = 0; explosionTexts.length = 0;
        boss = null; bossMode = false; ship.x = W / 2;
        spawnWave();
      }
    }
  }

  function loop() {
    if (!document.getElementById('vsiOverlay') || document.getElementById('vsiOverlay').style.display === 'none') {
      cleanup();
      return;
    }
    frame++;
    update();
    draw();
    requestAnimationFrame(loop);
  }

  spawnWave();
  loop();
}

// ── Chat Tab ──
let chatSessionId = null;

async function loadChatConfig() {
  try {
    const res = await fetch('/api/chat/config');
    const data = await res.json();
    if (data.provider) {
      document.getElementById('chatProvider').value = data.provider;
      await chatProviderChanged(); // Populate model dropdown
      // After models load, select the configured model
      if (data.model) {
        const modelSelect = document.getElementById('chatModel');
        const exists = Array.from(modelSelect.options).some(o => o.value === data.model);
        if (exists) {
          modelSelect.value = data.model;
        }
      }
    }
    if (data.db) document.getElementById('chatDb').value = data.db;
    if (data.collection) document.getElementById('chatCollection').value = data.collection;
    if (data.chat?.maxContextDocs) document.getElementById('chatMaxDocs').value = data.chat.maxContextDocs;
    if (data.chat?.systemPrompt) document.getElementById('chatSystemPrompt').value = data.chat.systemPrompt;
    updateChatStatus();
    // Auto-open settings panel if not fully configured
    if (!data.provider || !data.db) {
      document.getElementById('chatConfigPanel').classList.add('open');
      document.getElementById('chatConfigToggle').classList.add('active');
    }
  } catch {
    // No config — open settings panel
    document.getElementById('chatConfigPanel').classList.add('open');
    document.getElementById('chatConfigToggle').classList.add('active');
  }
}

function toggleChatConfig() {
  const panel = document.getElementById('chatConfigPanel');
  const toggle = document.getElementById('chatConfigToggle');
  panel.classList.toggle('open');
  toggle.classList.toggle('active');
}

function updateChatStatus() {
  const provider = document.getElementById('chatProvider');
  const db = document.getElementById('chatDb').value;
  const collection = document.getElementById('chatCollection').value;
  const providerLabel = provider.value
    ? provider.options[provider.selectedIndex].text
    : 'No provider';
  document.getElementById('chatStatusProvider').textContent = providerLabel;
  document.getElementById('chatStatusDb').textContent =
    (db && collection) ? `${db}.${collection}` : 'No database';
}

async function chatProviderChanged() {
  updateChatStatus();
  const provider = document.getElementById('chatProvider').value;
  const modelSelect = document.getElementById('chatModel');
  
  if (!provider) {
    modelSelect.innerHTML = '<option value="">Select provider first</option>';
    return;
  }

  modelSelect.innerHTML = '<option value="">Loading models...</option>';
  modelSelect.disabled = true;

  try {
    const res = await fetch(`/api/chat/models?provider=${provider}`);
    const data = await res.json();
    const models = data.models || [];
    const defaults = { anthropic: 'claude-sonnet-4-5-20250929', openai: 'gpt-4o', ollama: 'llama3.1' };
    const defaultModel = defaults[provider];

    modelSelect.innerHTML = '';

    if (models.length === 0) {
      if (provider === 'ollama') {
        modelSelect.innerHTML = '<option value="">No models found — is Ollama running?</option>';
      } else {
        // Fallback to default
        modelSelect.innerHTML = `<option value="${defaultModel}">${defaultModel}</option>`;
      }
    } else {
      models.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        let label = m.name || m.id;
        if (m.context) label += ` (${m.context})`;
        if (m.size) label += ` — ${m.size}`;
        if (m.parameterSize) label += ` [${m.parameterSize}]`;
        if (m.quantization) label += ` ${m.quantization}`;
        opt.textContent = label;
        if (m.id === defaultModel) opt.selected = true;
        modelSelect.appendChild(opt);
      });
    }

    // Always add a custom option
    const customOpt = document.createElement('option');
    customOpt.value = '__custom__';
    customOpt.textContent = '✏️ Custom model...';
    modelSelect.appendChild(customOpt);

  } catch {
    const defaults = { anthropic: 'claude-sonnet-4-5-20250929', openai: 'gpt-4o', ollama: 'llama3.1' };
    modelSelect.innerHTML = `<option value="${defaults[provider] || ''}">${defaults[provider] || 'default'}</option>`;
  }

  modelSelect.disabled = false;
}

// Handle custom model selection
document.getElementById('chatModel')?.addEventListener('change', function() {
  if (this.value === '__custom__') {
    const custom = prompt('Enter model name:');
    if (custom) {
      const opt = document.createElement('option');
      opt.value = custom;
      opt.textContent = custom;
      // Insert before the custom option
      this.insertBefore(opt, this.lastChild);
      this.value = custom;
    } else {
      this.selectedIndex = 0;
    }
  }
});

function chatInputKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
}

function addChatMessage(role, content, sources) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `chat-message ${role}`;
  const contentSpan = document.createElement('span');
  contentSpan.className = 'chat-message-content';
  contentSpan.textContent = content;
  div.appendChild(contentSpan);

  if (sources && sources.length > 0) {
    const details = document.createElement('details');
    details.className = 'chat-sources';
    const summary = document.createElement('summary');
    summary.textContent = `${sources.length} source${sources.length > 1 ? 's' : ''}`;
    details.appendChild(summary);
    const ul = document.createElement('ul');
    sources.forEach(s => {
      const li = document.createElement('li');
      li.textContent = `${s.source} (${s.score?.toFixed(2) || 'N/A'})`;
      ul.appendChild(li);
    });
    details.appendChild(ul);
    div.appendChild(details);
  }

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const query = input.value.trim();
  if (!query) return;

  const provider = document.getElementById('chatProvider').value;
  const modelVal = document.getElementById('chatModel').value;
  const model = (modelVal && modelVal !== '__custom__') ? modelVal : undefined;
  const db = document.getElementById('chatDb').value;
  const collection = document.getElementById('chatCollection').value;
  const maxDocs = parseInt(document.getElementById('chatMaxDocs').value) || 5;
  const rerank = document.getElementById('chatRerank').checked;
  const systemPrompt = document.getElementById('chatSystemPrompt').value.trim() || undefined;

  if (!provider) {
    addChatMessage('system-msg', 'Please select an LLM provider above.');
    return;
  }
  if (!db || !collection) {
    addChatMessage('system-msg', 'Please enter a database and collection name.');
    return;
  }

  // Show user message
  addChatMessage('user', query);
  input.value = '';
  input.style.height = 'auto';

  // Show typing indicator
  const typing = document.createElement('div');
  typing.className = 'chat-typing';
  typing.textContent = 'Thinking';
  document.getElementById('chatMessages').appendChild(typing);

  // Disable input
  const sendBtn = document.getElementById('chatSendBtn');
  sendBtn.disabled = true;
  input.disabled = true;

  try {
    const res = await fetch('/api/chat/message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query, db, collection, provider, model, maxDocs, rerank, systemPrompt }),
    });

    if (!res.ok) {
      const err = await res.json();
      typing.remove();
      addChatMessage('system-msg', `Error: ${err.error || 'Request failed'}`);
      return;
    }

    // Parse SSE stream
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let assistantDiv = null;
    let fullText = '';
    let sources = [];

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      let currentEvent = null;
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          currentEvent = line.slice(7).trim();
          continue;
        }
        if (line.startsWith('data: ')) {
          const data = JSON.parse(line.slice(6));

          if (currentEvent === 'retrieval') {
            typing.textContent = `Retrieved ${data.docs?.length || 0} docs (${data.timeMs}ms)`;
          }

          if (currentEvent === 'chunk') {
            if (!assistantDiv) {
              typing.remove();
              assistantDiv = addChatMessage('assistant', '');
            }
            fullText += data.text;
            assistantDiv.querySelector('.chat-message-content').textContent = fullText;
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }

          if (currentEvent === 'done') {
            sources = data.sources || [];
            if (sources.length > 0 && assistantDiv) {
              const details = document.createElement('details');
              details.className = 'chat-sources';
              const summary = document.createElement('summary');
              summary.textContent = `${sources.length} source${sources.length > 1 ? 's' : ''}`;
              details.appendChild(summary);
              const ul = document.createElement('ul');
              sources.forEach(s => {
                const li = document.createElement('li');
                li.textContent = `${s.source} (${s.score?.toFixed(2) || 'N/A'})`;
                ul.appendChild(li);
              });
              details.appendChild(ul);
              assistantDiv.appendChild(details);
            }
          }

          if (currentEvent === 'error') {
            typing.remove();
            addChatMessage('system-msg', `Error: ${data.error}`);
          }

          currentEvent = null;
        }
      }
    }

    // Remove typing if still present
    if (typing.parentNode) typing.remove();

  } catch (err) {
    if (typing.parentNode) typing.remove();
    addChatMessage('system-msg', `Error: ${err.message}`);
  } finally {
    sendBtn.disabled = false;
    input.disabled = false;
    input.focus();
  }
}

// Auto-resize chat input
document.getElementById('chatInput')?.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Load chat config on init
loadChatConfig();

// ── Expose functions to global scope for onclick handlers ──
window.setGenerateMode = setGenerateMode;
window.copyGeneratedCode = copyGeneratedCode;
window.generateCode = generateCode;
window.updateGenComponents = updateGenComponents;
window.createScaffold = createScaffold;
window.pickScaffoldDirectory = pickScaffoldDirectory;
window.downloadScaffoldZip = downloadScaffoldZip;
window.sendChatMessage = sendChatMessage;
window.toggleChatConfig = toggleChatConfig;
window.updateChatStatus = updateChatStatus;
window.chatInputKeydown = chatInputKeydown;
window.chatProviderChanged = chatProviderChanged;

// ── Start ──
init();
})();
</script>
<!-- Cost Help Modal -->
<div class="cost-modal-overlay" id="costHelpModal">
  <div class="cost-modal">
    <button class="cost-modal-close" id="costHelpClose">&times;</button>

    <h2>📐 How the Cost Calculator Works</h2>

    <p>Voyage AI charges per <strong>million tokens</strong> processed. A token is roughly ¾ of a word.
    The calculator estimates your total embedding cost based on how many documents you embed
    and how many queries you run over time.</p>

    <h3>💡 Simple Mode</h3>
    <p>Compares the per-model query cost for a given volume. Useful for quick "which model is cheapest?" checks.</p>
    <div class="formula">
      <span class="label">Daily cost =</span><br>
      <span class="accent">tokens_per_query</span> × <span class="accent">queries_per_day</span> ÷ 1,000,000 × <span class="accent">price_per_M_tokens</span><br><br>
      <span class="label">Monthly cost =</span> daily cost × 30
    </div>

    <h3>📊 RAG Planner Mode</h3>
    <p>Models the full cost of a Retrieval-Augmented Generation (RAG) pipeline, separating
    the <strong>one-time</strong> document ingestion cost from the <strong>recurring</strong> query cost.</p>

    <div class="formula">
      <span class="label">Document embedding (one-time):</span><br>
      <span class="accent">doc_cost</span> = num_docs × tokens_per_doc ÷ 1,000,000 × <span class="accent">doc_model_price</span><br><br>
      <span class="label">Query embedding (monthly):</span><br>
      <span class="accent">query_cost/mo</span> = queries_per_month × tokens_per_query ÷ 1,000,000 × <span class="accent">query_model_price</span><br><br>
      <span class="label">Projected total:</span><br>
      <span class="accent">total</span> = doc_cost + (query_cost/mo × <span class="accent">months</span>)
    </div>

    <h3>⚖️ Three Strategies Compared</h3>
    <ul>
      <li><strong>Symmetric</strong> — same model for documents and queries. Simple but expensive at scale,
      because query-heavy workloads pay the full model price on every request.</li>
      <li><strong>Asymmetric (★ Recommended)</strong> — use a high-quality model (e.g. <code>voyage-4-large</code>)
      for documents and a cheaper model (e.g. <code>voyage-4-lite</code>) for queries.
      This works because Voyage 4 models share the same embedding space — vectors from different
      models are directly comparable.</li>
      <li><strong>Asymmetric + Local</strong> — embed documents via the API, but run queries locally using
      <code>voyage-4-nano</code> on HuggingFace (free). Query cost drops to $0.</li>
    </ul>

    <h3>🔗 Shared Embedding Space</h3>
    <p>The Voyage 4 family (<code>voyage-4-large</code>, <code>voyage-4</code>, <code>voyage-4-lite</code>,
    <code>voyage-4-nano</code>) all produce vectors in the <em>same geometric space</em>.
    A document embedded with <code>voyage-4-large</code> can be searched with a query embedded by
    <code>voyage-4-lite</code> — cosine similarity still works correctly. This is what makes
    asymmetric strategies possible.</p>

    <div class="example">
      <strong>Example:</strong> 100K docs × 500 tok = 50M doc tokens<br>
      1M queries/mo × 30 tok = 30M query tokens/mo<br><br>
      <strong>Symmetric</strong> (voyage-4-large @ $0.18/1M):<br>
      &nbsp;&nbsp;Docs: $9.00 + Queries: $5.40/mo × 12 = <strong>$73.80</strong><br><br>
      <strong>Asymmetric</strong> (large docs + lite queries @ $0.05/1M):<br>
      &nbsp;&nbsp;Docs: $9.00 + Queries: $1.50/mo × 12 = <strong>$27.00</strong><br><br>
      &nbsp;&nbsp;Savings: <strong>63%</strong> — same document quality, cheaper queries.
    </div>

    <h3>📋 Per-Model Table</h3>
    <p>The bottom table shows what it would cost to use each model symmetrically (same model for
    docs and queries). The relative bar shows cost compared to the most expensive option.
    Use this to understand the price spread across the full model lineup.</p>

    <h3>🎯 Key Assumptions</h3>
    <ul>
      <li>Token counts are estimates — actual counts depend on your text. Use <code>vai chunk --stats</code> to measure real token counts.</li>
      <li>Document embedding is a one-time cost (you embed once, search many times).</li>
      <li>Re-embedding (e.g. updated docs) is not modeled — add a buffer if your corpus changes frequently.</li>
      <li>Reranking costs are separate and not included here. Reranking is priced per query pair, not per token.</li>
    </ul>

    <p style="margin-top:20px;font-size:12px;color:var(--text-muted);">
      CLI equivalent: <code>vai estimate --docs 100K --queries 1M --doc-model voyage-4-large --query-model voyage-4-lite</code>
    </p>
  </div>
</div>
<!-- 🕹️ Vector Space Invaders -->
<div id="vsiOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,30,43,0.92);z-index:99999;align-items:center;justify-content:center;flex-direction:column;gap:12px;">
  <canvas id="vsiCanvas" width="600" height="500" style="border:1px solid #3D4F58;border-radius:8px;image-rendering:pixelated;"></canvas>
  <div style="color:#889397;font-size:11px;font-family:monospace;text-align:center;">← → move &nbsp;|&nbsp; SPACE shoot &nbsp;|&nbsp; ESC exit</div>
</div>

<!-- 🐛 Bug Reporter -->
<style>
.bug-floating-button{position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#ff6b6b,#ee5a5a);border:none;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(238,90,90,0.4);transition:all .2s;z-index:9998}
.bug-floating-button:hover{transform:scale(1.1);box-shadow:0 6px 16px rgba(238,90,90,0.5)}
.bug-reporter-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:9999}
.bug-reporter-modal{background:var(--bg-surface);border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.bug-reporter-header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border)}
.bug-reporter-header h2{flex:1;margin:0;font-size:18px;font-weight:600;color:var(--accent-text)}
.bug-reporter-header .close-btn{background:none;border:none;color:var(--text-muted);font-size:24px;cursor:pointer;padding:4px 8px;border-radius:4px}
.bug-reporter-header .close-btn:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.bug-reporter-form{padding:20px}
.bug-reporter-form .form-group{margin-bottom:16px}
.bug-reporter-form label{display:block;font-size:13px;font-weight:500;color:var(--text-muted);margin-bottom:6px}
.bug-reporter-form input,.bug-reporter-form textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-input);color:var(--text);font-size:14px;font-family:inherit}
.bug-reporter-form input:focus,.bug-reporter-form textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.bug-reporter-form textarea{resize:vertical;min-height:80px}
.bug-env-info{padding:12px;background:var(--accent-glow);border-radius:8px;font-size:12px;margin-bottom:16px;color:var(--accent)}
.bug-env-info code{color:var(--text-muted);font-size:11px}
.bug-error{padding:10px 12px;background:rgba(255,107,107,0.15);border:1px solid rgba(255,107,107,0.3);border-radius:8px;color:var(--error);font-size:13px;margin-bottom:16px}
.bug-actions{display:flex;gap:12px}
.bug-actions button{flex:1;padding:12px 16px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;border:none}
.bug-actions .primary{background:linear-gradient(135deg,var(--accent),#00c853);color:#000}
.bug-actions .primary:hover{box-shadow:0 4px 12px rgba(0,237,100,0.4)}
.bug-actions .primary:disabled{opacity:0.6;cursor:not-allowed}
.bug-actions .secondary{background:rgba(255,255,255,0.1);color:var(--text);border:1px solid var(--border)}
.bug-actions .secondary:hover{background:rgba(255,255,255,0.15)}
.bug-success{padding:40px 20px;text-align:center}
.bug-success .icon{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#00c853);color:#000;font-size:32px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px}
.bug-success h3{margin:0 0 12px;color:var(--accent-text);font-size:20px}
.bug-success p{margin:8px 0;color:var(--text-muted)}
.bug-success code{background:rgba(255,255,255,0.1);padding:4px 8px;border-radius:4px;font-size:12px;color:var(--accent)}
</style>

<button class="bug-floating-button" id="bugButton" title="Report a Bug">🐛</button>

<div class="bug-reporter-overlay" id="bugOverlay" style="display:none">
  <div class="bug-reporter-modal">
    <div class="bug-reporter-header">
      <span style="font-size:28px">🐛</span>
      <h2>Report a Bug</h2>
      <button class="close-btn" id="bugClose">×</button>
    </div>
    <div class="bug-reporter-form" id="bugForm">
      <div class="form-group">
        <label>Title *</label>
        <input type="text" id="bugTitle" placeholder="Brief description of the bug" maxlength="200">
      </div>
      <div class="form-group">
        <label>Description *</label>
        <textarea id="bugDescription" placeholder="What happened? What did you expect?" rows="4" maxlength="5000"></textarea>
      </div>
      <div class="form-group">
        <label>Steps to Reproduce</label>
        <textarea id="bugSteps" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error" rows="3" maxlength="2000"></textarea>
      </div>
      <div class="form-group">
        <label>Email (optional, for follow-up)</label>
        <input type="email" id="bugEmail" placeholder="your@email.com">
      </div>
      <div class="bug-env-info">
        <span>📋 Environment will be included:</span><br>
        <code id="bugEnvInfo">Loading...</code>
      </div>
      <div class="bug-error" id="bugError" style="display:none"></div>
      <div class="bug-actions">
        <button class="primary" id="bugSubmit">Submit Bug Report</button>
        <button class="secondary" id="bugGithub">Open GitHub Issue</button>
      </div>
    </div>
    <div class="bug-success" id="bugSuccess" style="display:none">
      <div class="icon">✓</div>
      <h3>Bug Reported!</h3>
      <p>Bug ID: <code id="bugResultId"></code></p>
      <p>Thank you for helping improve Vai!</p>
      <div class="bug-actions" style="justify-content:center;margin-top:24px">
        <button class="primary" id="bugSuccessClose">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const BUG_API = 'https://vai.mlynn.org/api/bugs';
  const GITHUB_URL = 'https://github.com/mrlynn/voyageai-cli/issues/new';
  
  function getEnv() {
    const env = { platform: navigator.platform, source: 'desktop-app' };
    if (window.electronAPI) {
      env.appVersion = window.electronAPI.appVersion || 'unknown';
      env.cliVersion = window.electronAPI.cliVersion || 'unknown';
      env.electronVersion = window.electronAPI.electronVersion || 'unknown';
    }
    env.currentScreen = document.querySelector('.tab-btn.active')?.textContent || 'unknown';
    return env;
  }
  
  function showBugReporter() {
    const env = getEnv();
    document.getElementById('bugEnvInfo').textContent = 
      `${env.platform} • App v${env.appVersion || '?'} • ${env.currentScreen}`;
    document.getElementById('bugOverlay').style.display = 'flex';
    document.getElementById('bugForm').style.display = 'block';
    document.getElementById('bugSuccess').style.display = 'none';
    document.getElementById('bugError').style.display = 'none';
    document.getElementById('bugTitle').value = '';
    document.getElementById('bugDescription').value = '';
    document.getElementById('bugSteps').value = '';
    document.getElementById('bugEmail').value = '';
  }
  
  function hideBugReporter() {
    document.getElementById('bugOverlay').style.display = 'none';
  }
  
  async function submitBug() {
    const title = document.getElementById('bugTitle').value.trim();
    const description = document.getElementById('bugDescription').value.trim();
    const steps = document.getElementById('bugSteps').value.trim();
    const email = document.getElementById('bugEmail').value.trim();
    
    if (!title || title.length < 5) {
      document.getElementById('bugError').textContent = 'Title is required (min 5 characters)';
      document.getElementById('bugError').style.display = 'block';
      return;
    }
    if (!description || description.length < 10) {
      document.getElementById('bugError').textContent = 'Description is required (min 10 characters)';
      document.getElementById('bugError').style.display = 'block';
      return;
    }
    
    document.getElementById('bugSubmit').disabled = true;
    document.getElementById('bugSubmit').textContent = 'Submitting...';
    document.getElementById('bugError').style.display = 'none';
    
    try {
      const env = getEnv();
      const res = await fetch(BUG_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title, description, stepsToReproduce: steps || null, email: email || null,
          ...env
        })
      });
      
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || `HTTP ${res.status}`);
      }
      
      const data = await res.json();
      document.getElementById('bugResultId').textContent = data.bugId;
      document.getElementById('bugForm').style.display = 'none';
      document.getElementById('bugSuccess').style.display = 'block';
    } catch (err) {
      document.getElementById('bugError').textContent = err.message;
      document.getElementById('bugError').style.display = 'block';
    } finally {
      document.getElementById('bugSubmit').disabled = false;
      document.getElementById('bugSubmit').textContent = 'Submit Bug Report';
    }
  }
  
  function openGithub() {
    const title = document.getElementById('bugTitle').value.trim() || 'Bug Report';
    const description = document.getElementById('bugDescription').value.trim();
    const steps = document.getElementById('bugSteps').value.trim();
    const env = getEnv();
    
    const body = `## Description\n${description}\n\n## Steps to Reproduce\n${steps || '1. \\n2. \\n3. '}\n\n## Environment\n- **App Version:** ${env.appVersion || 'N/A'}\n- **Platform:** ${env.platform}\n- **Screen:** ${env.currentScreen}`;
    const url = `${GITHUB_URL}?title=${encodeURIComponent('[Bug] ' + title)}&body=${encodeURIComponent(body)}&labels=bug`;
    window.open(url, '_blank');
  }
  
  // Event listeners
  document.getElementById('bugButton').addEventListener('click', showBugReporter);
  document.getElementById('bugClose').addEventListener('click', hideBugReporter);
  document.getElementById('bugOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'bugOverlay') hideBugReporter();
  });
  document.getElementById('bugSubmit').addEventListener('click', submitBug);
  document.getElementById('bugGithub').addEventListener('click', openGithub);
  document.getElementById('bugSuccessClose').addEventListener('click', hideBugReporter);
})();
</script>

</body>
</html>
