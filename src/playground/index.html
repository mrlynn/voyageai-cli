<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voyage AI Playground</title>
<link rel="icon" type="image/png" sizes="32x32" href="/icons/dark/32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/dark/16.png">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* MongoDB Design System — Dark Mode Palette (default) */
  --bg: #001E2B;            /* MDB Black */
  --bg-surface: #112733;    /* Gray Dark 4 */
  --bg-card: #1C2D38;       /* Gray Dark 3 */
  --bg-input: #112733;      /* Gray Dark 4 */
  --accent: #00ED64;        /* Green Base — interactive elements only */
  --accent-text: #FFFFFF;   /* Bright white — headings/labels in dark mode */
  --accent-dim: #00A35C;    /* Green Dark 1 */
  --accent-glow: rgba(0, 237, 100, 0.12);
  --text: #E8EDEB;          /* Gray Light 2 */
  --text-dim: #C1C7C6;      /* Gray Light 1 */
  --text-muted: #889397;    /* Gray Base */
  --border: #3D4F58;        /* Gray Dark 2 */
  --error: #FF6960;         /* Red Light 1 */
  --warning: #FFC010;       /* Yellow Base */
  --success: #00ED64;       /* Green Base */
  --red: #FF6960;           /* Red Light 1 */
  --yellow: #FFC010;        /* Yellow Base */
  --green: #00ED64;         /* Green Base */
  --blue: #0498EC;          /* Blue Light 1 (links) */
  --purple: #B45AF2;        /* Purple Base */
  --green-dark: #023430;    /* Green Dark 3 */
  --radius: 8px;
  --font: 'Euclid Circular A', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  --mono: 'Source Code Pro', 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
}

/* MongoDB Design System — Light Mode Palette */
[data-theme="light"] {
  --bg: #FFFFFF;             /* White */
  --bg-surface: #F9FBFA;    /* Gray Light 3 */
  --bg-card: #FFFFFF;        /* White */
  --bg-input: #F9FBFA;      /* Gray Light 3 */
  --accent: #00A35C;         /* Green Dark 1 — interactive elements */
  --accent-text: #001E2B;   /* MDB Black — headings/labels in light mode */
  --accent-dim: #00684A;     /* Green Dark 2 */
  --accent-glow: rgba(0, 163, 92, 0.08);
  --text: #001E2B;           /* MDB Black */
  --text-dim: #5C6C75;       /* Gray Dark 1 */
  --text-muted: #889397;     /* Gray Base */
  --border: #E8EDEB;         /* Gray Light 2 */
  --error: #DB3030;          /* Red Base */
  --warning: #944F01;        /* Yellow Dark 2 */
  --success: #00684A;        /* Green Dark 2 */
  --red: #DB3030;            /* Red Base */
  --yellow: #944F01;         /* Yellow Dark 2 */
  --green: #00684A;          /* Green Dark 2 */
  --blue: #016BF8;           /* Blue Base */
  --purple: #5E0C9E;         /* Purple Dark 2 */
  --green-dark: #023430;     /* Green Dark 3 */
}
/* Light mode shadow + card adjustments */
[data-theme="light"] .explore-card,
[data-theme="light"] .card,
[data-theme="light"] .cost-strategy,
[data-theme="light"] .cost-summary-card {
  box-shadow: 0 1px 4px rgba(0, 30, 43, 0.08);
}
[data-theme="light"] .explore-card:hover {
  box-shadow: 0 4px 16px rgba(0, 163, 92, 0.12);
}
[data-theme="light"] .cost-modal,
[data-theme="light"] .explore-modal {
  box-shadow: 0 20px 60px rgba(0, 30, 43, 0.2);
}
[data-theme="light"] .cost-modal-overlay,
[data-theme="light"] .explore-modal-overlay {
  background: rgba(0, 30, 43, 0.4);
}
[data-theme="light"] .sidebar {
  box-shadow: 1px 0 3px rgba(0, 30, 43, 0.06);
}
/* Light mode gradient overrides */
[data-theme="light"] .quant-bar-fill.storage { background: linear-gradient(90deg, #00A35C, #00ED64); }
[data-theme="light"] .quant-bar-fill.latency { background: linear-gradient(90deg, #016BF8, #0498EC); }
[data-theme="light"] .quant-meter-fill.perfect { background: linear-gradient(90deg, #00A35C, #00ED64); }
[data-theme="light"] .quant-meter-fill.good { background: linear-gradient(90deg, #944F01, #FFC010); }
[data-theme="light"] .quant-meter-fill.degraded { background: linear-gradient(90deg, #DB3030, #FF6960); }
/* Light mode button text */
[data-theme="light"] .btn { color: #FFFFFF; }
[data-theme="light"] .btn:hover { background: #00684A; }

html, body { height: 100%; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
}

/* ── Update banner ── */
.update-banner {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 8px 16px;
  background: linear-gradient(135deg, rgba(0,163,92,0.12), rgba(4,152,236,0.12));
  border-bottom: 1px solid rgba(0,237,100,0.2);
  font-size: 13px;
  color: var(--text);
  flex-shrink: 0;
}
.update-banner.show { display: flex; }
.update-banner-icon { font-size: 16px; }
.update-banner-text { flex: 1; }
.update-banner-text strong { color: var(--accent); }
.update-banner-btn {
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: var(--font);
  transition: opacity 0.15s;
}
.update-banner-btn:hover { opacity: 0.85; }
.update-banner-dismiss {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 0 4px;
}
.update-banner-dismiss:hover { color: var(--text); }
.update-progress { display: flex; align-items: center; gap: 8px; flex: 1; }
.update-progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; }
[data-theme="light"] .update-progress-bar { background: rgba(0,0,0,0.1); }
.update-progress-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s ease; width: 0%; }
.update-progress-label { font-size: 12px; font-family: var(--mono); color: var(--accent); min-width: 40px; text-align: right; }

/* ── Onboarding Walkthrough ── */
.onboarding-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 10000;
}
.onboarding-overlay.active { display: block; }
.onboarding-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  transition: opacity 0.3s;
}
.onboarding-spotlight {
  position: absolute;
  border-radius: var(--radius);
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  z-index: 10001;
  pointer-events: none;
}
.onboarding-tooltip {
  position: absolute;
  z-index: 10002;
  background: var(--bg-card);
  border: 1px solid var(--accent);
  border-radius: 12px;
  padding: 24px 28px 20px;
  width: 380px;
  max-width: 90vw;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,237,100,0.15);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
  opacity: 0;
  transform: translateY(10px);
}
.onboarding-tooltip.visible {
  opacity: 1;
  transform: translateY(0);
}
.onboarding-tooltip-arrow {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--bg-card);
  border: 1px solid var(--accent);
  transform: rotate(45deg);
}
.onboarding-tooltip-arrow.top {
  top: -7px;
  left: 30px;
  border-right: none;
  border-bottom: none;
}
.onboarding-tooltip-arrow.bottom {
  bottom: -7px;
  left: 30px;
  border-left: none;
  border-top: none;
}
.onboarding-tooltip-arrow.left {
  left: -7px;
  top: 24px;
  border-right: none;
  border-top: none;
}
.onboarding-step-icon {
  font-size: 28px;
  margin-bottom: 8px;
}
.onboarding-step-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent-text);
  margin-bottom: 6px;
}
.onboarding-step-body {
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.6;
  margin-bottom: 18px;
}
.onboarding-step-body strong { color: var(--accent); }
.onboarding-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.onboarding-dots {
  display: flex;
  gap: 6px;
}
.onboarding-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: background 0.2s;
}
.onboarding-dot.active { background: var(--accent); }
.onboarding-dot.completed { background: var(--accent-dim); }
.onboarding-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}
.onboarding-skip {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 12px;
  cursor: pointer;
  font-family: var(--font);
  padding: 6px 10px;
  border-radius: 6px;
  transition: color 0.15s;
}
.onboarding-skip:hover { color: var(--text); }
.onboarding-next {
  background: var(--accent);
  color: var(--bg);
  border: none;
  border-radius: 6px;
  padding: 8px 20px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: var(--font);
  transition: opacity 0.15s;
}
.onboarding-next:hover { opacity: 0.85; }
.onboarding-welcome-center {
  position: fixed;
  inset: 0;
  z-index: 10002;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}
.onboarding-welcome-card {
  background: var(--bg-card);
  border: 1px solid var(--accent);
  border-radius: 16px;
  padding: 40px 44px 32px;
  width: 460px;
  max-width: 90vw;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 80px rgba(0,237,100,0.08);
  pointer-events: auto;
  opacity: 0;
  transform: scale(0.95);
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
}
.onboarding-welcome-card.visible {
  opacity: 1;
  transform: scale(1);
}
.onboarding-welcome-logo {
  width: 64px;
  height: 64px;
  margin-bottom: 16px;
}
.onboarding-welcome-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent-text);
  margin-bottom: 8px;
}
.onboarding-welcome-sub {
  font-size: 14px;
  color: var(--text-dim);
  line-height: 1.6;
  margin-bottom: 28px;
}
[data-theme="light"] .onboarding-tooltip {
  box-shadow: 0 12px 40px rgba(0,30,43,0.15), 0 0 0 1px rgba(0,163,92,0.2);
}
[data-theme="light"] .onboarding-welcome-card {
  box-shadow: 0 20px 60px rgba(0,30,43,0.18), 0 0 80px rgba(0,163,92,0.06);
}
[data-theme="light"] .onboarding-backdrop {
  background: rgba(0,30,43,0.45);
}

/* ── App Shell: sidebar + content layout ── */
.app-shell {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ── Sidebar ── */
.sidebar {
  width: 220px;
  min-width: 220px;
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 100;
}

.sidebar-drag-region {
  -webkit-app-region: drag;
  height: 78px;
  min-height: 78px;
  padding: 0 16px;
  padding-top: 52px; /* Clear macOS traffic lights fully */
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-logo {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  flex-shrink: 0;
  object-fit: contain;
}

.sidebar-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--accent-text);
  white-space: nowrap;
  letter-spacing: -0.2px;
}

.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 1px;
}

.sidebar-nav-group {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.sidebar-nav-divider {
  height: 1px;
  background: var(--border);
  margin: 8px 12px;
  opacity: 0.5;
}
.sidebar-nav-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  padding: 10px 12px 4px;
}

.tab-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background: none;
  border: none;
  border-left: 3px solid transparent;
  border-radius: 0 6px 6px 0;
  color: var(--text-dim);
  padding: 10px 12px;
  font-size: 13px;
  font-weight: 500;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  text-align: left;
  position: relative;
}
.tab-btn:hover {
  color: var(--text);
  background: rgba(255,255,255,0.05);
}
.tab-btn:hover .tab-btn-icon {
  transform: scale(1.1);
}
.tab-btn.active {
  color: var(--accent);
  background: var(--accent-glow);
  border-left-color: var(--accent);
  font-weight: 600;
}
.tab-btn-icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  transition: transform 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.tab-btn-icon svg {
  width: 16px;
  height: 16px;
}
[data-theme="light"] .tab-btn:hover { background: rgba(0,30,43,0.04); }
[data-theme="light"] .tab-btn.active { background: rgba(0,163,92,0.08); }

.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sidebar-model-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.sidebar-model-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}
.nav-model-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 10px;
  border-radius: var(--radius);
  font-size: 12px;
  font-family: var(--mono);
  cursor: pointer;
  width: 100%;
}

.sidebar-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.theme-toggle {
  background: none;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.theme-toggle:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}

.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--text-muted);
  transition: background 0.3s;
}
.status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--accent-glow); }
.status-dot.error { background: var(--error); }

.status-label {
  font-size: 11px;
  color: var(--text-dim);
}

/* ── Content area ── */
.content-area {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.content-drag-region {
  -webkit-app-region: drag;
  height: 38px;
  min-height: 38px;
  flex-shrink: 0;
}

/* Main */
.main { padding: 24px; max-width: 1200px; margin: 0 auto; width: 100%; }

/* Legacy compat — hide old horizontal bar (replaced by sidebar) */
.nav { display: none; }
.tab-bar-horizontal { display: none; }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Shared Components */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--accent-text);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

textarea, input[type="text"], input[type="number"] {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 10px 14px;
  border-radius: var(--radius);
  font-family: var(--mono);
  font-size: 13px;
  resize: vertical;
  transition: border-color 0.2s;
}
textarea:focus, input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--font);
  cursor: pointer;
}
select:focus { outline: none; border-color: var(--accent); }

.btn {
  background: var(--accent);
  color: var(--green-dark);
  border: none;
  padding: 10px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.btn:hover { background: #71F6BA; transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-secondary {
  background: transparent;
  color: var(--accent);
  border: 1px solid var(--accent-dim);
}
.btn-secondary:hover { background: var(--accent-glow); }

.btn-small {
  padding: 6px 14px;
  font-size: 12px;
}

.options-row {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  margin: 12px 0;
}

.option-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.option-label {
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.error-msg {
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  color: var(--error);
  padding: 10px 14px;
  border-radius: var(--radius);
  font-size: 13px;
  margin-top: 12px;
  display: none;
}
.error-msg.visible { display: block; }

.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.result-section {
  margin-top: 16px;
  display: none;
}
.result-section.visible { display: block; }

.stat {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg-input);
  padding: 6px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  margin-right: 8px;
  margin-bottom: 8px;
}
.stat-label { color: var(--text-dim); }
.stat-value { color: var(--accent-text); font-weight: 600; font-family: var(--mono); }

.vector-preview {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  background: var(--bg-input);
  padding: 12px;
  border-radius: var(--radius);
  overflow-x: auto;
  white-space: nowrap;
  margin-top: 8px;
}

.heatmap {
  height: 24px;
  border-radius: 4px;
  margin-top: 8px;
  overflow: hidden;
  display: flex;
}
.heatmap-bar {
  flex: 1;
  min-width: 1px;
}

/* Compare tab */
.compare-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.similarity-display {
  text-align: center;
  padding: 32px 0;
}
.similarity-score {
  font-size: 72px;
  font-weight: 800;
  font-family: var(--mono);
  line-height: 1;
}
.similarity-label {
  font-size: 14px;
  color: var(--text-dim);
  margin-top: 8px;
}
.similarity-bar-outer {
  width: 100%;
  max-width: 400px;
  height: 8px;
  background: var(--bg-input);
  border-radius: 4px;
  margin: 16px auto 0;
  overflow: hidden;
}
.similarity-bar-inner {
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s ease, background 0.6s ease;
}
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 24px;
}
.metric-card {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px 16px;
  text-align: center;
  transition: border-color 0.2s;
}
.metric-card.primary {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.metric-card-value {
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
}
.metric-card-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-top: 10px;
}
.metric-card-desc {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  line-height: 1.4;
}
.metric-bar {
  width: 100%;
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  margin-top: 12px;
  overflow: hidden;
}
.metric-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s ease, background 0.6s ease;
}
.metric-note {
  text-align: center;
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 16px;
  padding: 10px 16px;
  background: var(--bg-input);
  border-radius: 8px;
  line-height: 1.6;
}

/* Search tab */
.search-results {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.search-results.single-col {
  grid-template-columns: 1fr;
}

.result-item {
  display: flex;
  gap: 12px;
  padding: 12px;
  background: var(--bg-input);
  border-radius: var(--radius);
  margin-bottom: 8px;
  border-left: 3px solid var(--border);
  transition: border-color 0.3s;
}
.result-item.moved-up { border-left-color: var(--green); }
.result-item.moved-down { border-left-color: var(--red); }

.result-rank {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-text);
  font-family: var(--mono);
  min-width: 30px;
}
.result-body { flex: 1; min-width: 0; }
.result-text {
  font-size: 13px;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.result-score-bar {
  height: 4px;
  background: var(--bg-surface);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.result-score-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--accent);
}
.result-score-text {
  font-size: 11px;
  font-family: var(--mono);
  color: var(--text-dim);
  margin-top: 4px;
}
.result-movement {
  font-size: 11px;
  font-family: var(--mono);
  margin-top: 2px;
}

/* Explore tab */
.explore-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 16px;
}

.explore-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
}
.explore-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 237, 100, 0.1);
}
.explore-card.expanded {
  border-color: var(--accent);
}

.explore-card-icon {
  font-size: 28px;
  margin-bottom: 8px;
}
.explore-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}
.explore-card-summary {
  font-size: 13px;
  color: var(--text-dim);
}
.explore-card-content {
  display: none;
}
.explore-card-actions {
  display: none;
}

/* Explore modal */
.explore-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
.explore-modal-overlay.open {
  opacity: 1;
  pointer-events: auto;
}
.explore-modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  max-width: 720px;
  width: 92%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
  animation: exploreModalIn 0.2s ease-out;
}
@keyframes exploreModalIn {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.explore-modal::-webkit-scrollbar { width: 6px; }
.explore-modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.explore-modal-header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 24px 28px 16px;
  border-bottom: 1px solid var(--border);
}
.explore-modal-icon { font-size: 32px; }
.explore-modal-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}
.explore-modal-summary {
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 2px;
}
.explore-modal-close {
  position: absolute;
  top: 16px; right: 18px;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.15s;
  z-index: 1;
}
.explore-modal-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
.explore-modal-body {
  padding: 20px 28px 24px;
  font-size: 14px;
  line-height: 1.75;
  color: var(--text);
  white-space: pre-wrap;
}
.explore-modal-links {
  margin-top: 16px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}
.explore-modal-links-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}
.explore-modal-links a {
  display: block;
  color: var(--blue);
  font-size: 12px;
  word-break: break-all;
  margin-bottom: 4px;
  text-decoration: none;
}
.explore-modal-links a:hover { text-decoration: underline; }
.explore-modal-tryit {
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}
.explore-modal-tryit-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--accent-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.explore-modal-tryit-cmd {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  background: var(--bg);
  padding: 6px 10px;
  border-radius: 5px;
  margin-bottom: 4px;
}
.explore-modal-actions {
  display: flex;
  gap: 8px;
  padding: 0 28px 24px;
}

/* Benchmark tab */
.bench-panels { display: flex; gap: 8px; margin-bottom: 16px; }
.bench-panel-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 8px 18px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.2s;
}
.bench-panel-btn:hover { color: var(--text); border-color: var(--text-dim); }
.bench-panel-btn.active { color: var(--accent); border-color: var(--accent); background: var(--accent-glow); }

.bench-view { display: none; }
.bench-view.active { display: block; }

.latency-chart { margin-top: 16px; }
.latency-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.latency-model {
  font-family: var(--mono);
  font-size: 13px;
  min-width: 170px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.latency-bar-outer {
  flex: 1;
  height: 28px;
  background: var(--bg-input);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.latency-bar-inner {
  height: 100%;
  border-radius: 4px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  display: flex;
  align-items: center;
  padding: 0 10px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--green-dark);
  font-weight: 600;
  white-space: nowrap;
}
.latency-bar-inner.running {
  background: var(--border) !important;
  width: 100% !important;
  animation: pulse-bar 1.2s ease-in-out infinite;
}
@keyframes pulse-bar {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}
.latency-stats {
  min-width: 90px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-dim);
  text-align: right;
}
.latency-badge {
  font-size: 14px;
  min-width: 20px;
  text-align: center;
}

/* Ranking diff */
.rank-comparison { margin-top: 16px; }
.rank-row {
  display: grid;
  grid-template-columns: 30px 1fr 40px 1fr;
  gap: 8px;
  align-items: start;
  margin-bottom: 8px;
  padding: 8px;
  background: var(--bg-input);
  border-radius: var(--radius);
}
.rank-num {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent-text);
  font-family: var(--mono);
  text-align: center;
}
.rank-item {
  font-size: 13px;
  padding: 6px 10px;
  border-radius: 4px;
  border-left: 3px solid var(--border);
}
.rank-item .rank-score {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 2px;
}
.rank-match { border-left-color: var(--green); }
.rank-differ { border-left-color: var(--yellow); }
.rank-arrow { text-align: center; color: var(--text-muted); font-size: 18px; padding-top: 4px; }

/* Quantization charts */
.quant-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 768px) { .quant-charts { grid-template-columns: 1fr; } }

.quant-bar-group { margin-bottom: 14px; }
.quant-bar-label {
  display: flex; justify-content: space-between; align-items: baseline;
  margin-bottom: 4px; font-size: 13px;
}
.quant-bar-label .dtype-name { color: var(--accent-text); font-weight: 600; font-family: var(--mono); }
.quant-bar-label .dtype-value { color: var(--text-dim); font-family: var(--mono); font-size: 12px; }
.quant-bar-track {
  height: 32px; background: var(--bg-input); border-radius: 6px;
  overflow: hidden; position: relative;
}
.quant-bar-fill {
  height: 100%; border-radius: 6px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
  display: flex; align-items: center; padding: 0 10px;
  font-family: var(--mono); font-size: 12px; font-weight: 600;
  color: var(--green-dark); white-space: nowrap; min-width: fit-content;
}
.quant-bar-fill.storage { background: linear-gradient(90deg, #00ED64, #71F6BA); }
.quant-bar-fill.latency { background: linear-gradient(90deg, #0498EC, #016BF8); }
.quant-bar-badge {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  font-size: 12px; color: var(--text-dim); font-family: var(--mono);
}

.quant-quality-meter { margin-bottom: 14px; }
.quant-meter-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 6px;
}
.quant-meter-header .dtype-name { color: var(--accent-text); font-weight: 600; font-family: var(--mono); font-size: 13px; }
.quant-meter-header .verdict-badge {
  font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
}
.quant-meter-header .verdict-badge.perfect { background: rgba(0,212,170,0.15); color: var(--green); }
.quant-meter-header .verdict-badge.good { background: rgba(255,217,61,0.15); color: var(--yellow); }
.quant-meter-header .verdict-badge.degraded { background: rgba(255,107,107,0.15); color: var(--red); }
.quant-meter-track {
  height: 10px; background: var(--bg-input); border-radius: 5px; overflow: hidden;
}
.quant-meter-fill {
  height: 100%; border-radius: 5px;
  transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
}
.quant-meter-fill.perfect { background: linear-gradient(90deg, #00ED64, #71F6BA); }
.quant-meter-fill.good { background: linear-gradient(90deg, #FFC010, #FFEC9E); }
.quant-meter-fill.degraded { background: linear-gradient(90deg, #FF6960, #FFCDC7); }
.quant-meter-detail { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-family: var(--mono); }

.quant-rank-cols {
  display: grid; gap: 12px;
}
.quant-rank-col-header {
  font-weight: 600; color: var(--accent-text); font-size: 13px; font-family: var(--mono);
  margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
}
.quant-rank-item {
  padding: 8px 10px; margin-bottom: 4px; border-radius: 6px;
  font-size: 12px; position: relative; border-left: 3px solid transparent;
  transition: background 0.2s;
}
.quant-rank-item:hover { background: rgba(255,255,255,0.03); }
.quant-rank-item.match { border-left-color: var(--green); background: rgba(0,212,170,0.06); }
.quant-rank-item.differ { border-left-color: var(--red); background: rgba(255,107,107,0.06); }
.quant-rank-item.baseline { border-left-color: var(--border); background: var(--bg-input); }
.quant-rank-pos {
  display: inline-block; width: 22px; height: 22px; line-height: 22px;
  text-align: center; border-radius: 50%; background: var(--bg-surface);
  color: var(--accent-text); font-weight: 700; font-size: 11px; font-family: var(--mono);
  margin-right: 8px;
}
.quant-rank-score { color: var(--text-muted); font-size: 11px; font-family: var(--mono); margin-top: 3px; }

/* Cost calculator */
.cost-controls {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px 32px;
  margin-bottom: 20px;
}
.cost-controls-full { grid-column: 1 / -1; }
.cost-slider-row {
  display: flex;
  align-items: center;
  gap: 12px;
}
.cost-slider-label {
  font-size: 12px;
  color: var(--text-dim);
  min-width: 110px;
}
.cost-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  background: var(--bg-input);
  border-radius: 3px;
  outline: none;
}
.cost-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  box-shadow: 0 0 8px var(--accent-glow);
}
.cost-slider-value {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--accent-text);
  min-width: 70px;
  text-align: right;
  font-weight: 600;
}
.cost-mode-toggle {
  display: flex;
  gap: 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  width: fit-content;
}
.cost-mode-btn {
  padding: 8px 20px;
  background: transparent;
  border: none;
  color: var(--text-dim);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: var(--mono);
}
.cost-mode-btn.active {
  background: var(--accent);
  color: var(--bg);
  font-weight: 600;
}
.cost-mode-btn:hover:not(.active) {
  background: rgba(0, 237, 100, 0.1);
  color: var(--text);
}
.cost-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  padding: 6px 10px;
  min-width: 160px;
}
.cost-select:focus { border-color: var(--accent); outline: none; }
.cost-model-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}
.cost-model-label {
  font-size: 12px;
  color: var(--text-dim);
  min-width: 110px;
}
.cost-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.cost-summary-card {
  background: var(--bg-input);
  border-radius: 8px;
  padding: 14px 16px;
  border: 1px solid var(--border);
}
.cost-summary-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.cost-summary-value {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-text);
}
.cost-summary-detail {
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 4px;
  font-family: var(--mono);
}
.cost-strategy-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
  margin-top: 16px;
}
.cost-strategy {
  background: var(--bg-input);
  border-radius: 10px;
  padding: 18px;
  border: 1px solid var(--border);
  transition: border-color 0.2s, box-shadow 0.2s;
  position: relative;
}
.cost-strategy.recommended {
  border-color: var(--accent);
  box-shadow: 0 0 16px var(--accent-glow);
}
.cost-strategy-badge {
  position: absolute;
  top: -10px;
  right: 16px;
  background: var(--accent);
  color: var(--bg);
  font-size: 10px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.cost-strategy-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
}
.cost-strategy-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 12px;
}
.cost-strategy-row-label { color: var(--text-dim); }
.cost-strategy-row-value { font-family: var(--mono); color: var(--text); font-weight: 500; }
.cost-strategy-total {
  border-top: 1px solid var(--border);
  margin-top: 10px;
  padding-top: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.cost-strategy-total-label { font-size: 13px; font-weight: 600; color: var(--text); }
.cost-strategy-total-value { font-family: var(--mono); font-size: 18px; font-weight: 700; color: var(--accent-text); }
.cost-savings {
  font-size: 11px;
  color: var(--success);
  font-weight: 600;
  margin-top: 6px;
  text-align: right;
}
.cost-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 12px;
}
.cost-table th {
  text-align: left;
  padding: 8px 12px;
  color: var(--text-dim);
  font-weight: 500;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.cost-table td {
  padding: 8px 12px;
  border-bottom: 1px solid rgba(42, 53, 80, 0.3);
  font-family: var(--mono);
}
.cost-table tr:hover { background: rgba(0, 237, 100, 0.03); }
.cost-highlight {
  color: var(--accent-text);
  font-weight: 600;
}
.cost-bar-cell { position: relative; }
.cost-bar {
  position: absolute;
  left: 0; top: 50%;
  transform: translateY(-50%);
  height: 20px;
  background: var(--accent-glow);
  border-radius: 3px;
  transition: width 0.4s ease;
}
.cost-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin: 20px 0 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.cost-tip {
  font-size: 12px;
  color: var(--text-muted);
  background: rgba(0, 237, 100, 0.05);
  border-left: 3px solid var(--accent);
  padding: 10px 14px;
  border-radius: 0 6px 6px 0;
  margin-top: 16px;
}
.cost-help-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 1.5px solid var(--accent);
  background: transparent;
  color: var(--accent);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  margin-left: 8px;
  transition: all 0.2s;
  vertical-align: middle;
  font-family: var(--mono);
  line-height: 1;
}
.cost-help-btn:hover {
  background: var(--accent);
  color: var(--bg);
  box-shadow: 0 0 10px var(--accent-glow);
}
.cost-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
.cost-modal-overlay.open {
  opacity: 1;
  pointer-events: auto;
}
.cost-modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  max-width: 680px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 32px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
}
.cost-modal::-webkit-scrollbar { width: 6px; }
.cost-modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.cost-modal-close {
  position: absolute;
  top: 14px; right: 16px;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.15s;
}
.cost-modal-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
.cost-modal h2 {
  font-size: 18px;
  color: var(--text);
  margin: 0 0 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.cost-modal h3 {
  font-size: 14px;
  color: var(--accent-text);
  margin: 22px 0 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.cost-modal p, .cost-modal li {
  font-size: 13px;
  color: var(--text-dim);
  line-height: 1.7;
}
.cost-modal ul { padding-left: 20px; margin: 6px 0; }
.cost-modal li { margin-bottom: 4px; }
.cost-modal code {
  background: var(--bg-input);
  padding: 2px 7px;
  border-radius: 4px;
  font-size: 12px;
  color: var(--accent-text);
  font-family: var(--mono);
}
.cost-modal .formula {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 18px;
  margin: 10px 0;
  font-family: var(--mono);
  font-size: 13px;
  color: var(--text);
  line-height: 1.8;
}
.cost-modal .formula .label {
  color: var(--text-muted);
  font-size: 11px;
}
.cost-modal .formula .accent { color: var(--accent); font-weight: 600; }
.cost-modal .example {
  background: rgba(0, 237, 100, 0.05);
  border-left: 3px solid var(--accent);
  border-radius: 0 8px 8px 0;
  padding: 12px 16px;
  margin: 12px 0;
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--mono);
  line-height: 1.8;
}

/* History chart */
.history-empty {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
  font-size: 14px;
}
.history-chart {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  height: 120px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.history-bar-group {
  flex: 1;
  display: flex;
  gap: 2px;
  align-items: flex-end;
  height: 100%;
  min-width: 0;
}
.history-bar {
  flex: 1;
  border-radius: 3px 3px 0 0;
  min-width: 4px;
  transition: height 0.4s ease;
  cursor: pointer;
  position: relative;
}
.history-bar:hover { opacity: 0.8; }
.history-legend {
  display: flex;
  gap: 16px;
  justify-content: center;
  margin-top: 8px;
  font-size: 12px;
  color: var(--text-dim);
}
.history-legend-dot {
  display: inline-block;
  width: 10px; height: 10px;
  border-radius: 2px;
  margin-right: 4px;
  vertical-align: middle;
}
.history-labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* About page */
.about-container { max-width: 680px; margin: 0 auto; }
.about-header { display: flex; gap: 24px; align-items: center; margin-bottom: 24px; }
.about-avatar {
  width: 120px; height: 120px;
  border-radius: 50%;
  border: 3px solid var(--accent);
  box-shadow: 0 0 20px var(--accent-glow);
  flex-shrink: 0;
}
.about-name { font-size: 24px; font-weight: 700; color: var(--text); }
.about-role { font-size: 14px; color: var(--accent-text); margin-top: 4px; }
.about-links { display: flex; gap: 12px; margin-top: 8px; }
.about-links a {
  color: var(--text-dim);
  font-size: 13px;
  text-decoration: none;
  transition: color 0.2s;
}
.about-links a:hover { color: var(--accent); }
.about-section { margin-bottom: 24px; }
.about-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.about-text { font-size: 14px; line-height: 1.8; color: var(--text); }
.about-text a { color: var(--blue); text-decoration: none; }
.about-text a:hover { text-decoration: underline; }
.about-disclaimer {
  background: rgba(255, 215, 61, 0.08);
  border: 1px solid rgba(255, 215, 61, 0.2);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-top: 24px;
}
.about-disclaimer-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--warning);
  margin-bottom: 6px;
}
.about-disclaimer-text {
  font-size: 13px;
  line-height: 1.7;
  color: var(--text-dim);
}

/* ── Page Headers ── */
.page-header {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.page-header-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--accent-text, var(--text));
  margin: 0 0 4px;
  letter-spacing: -0.3px;
}
.page-header-subtitle {
  font-size: 14px;
  color: var(--text-dim);
  margin: 0 0 6px;
  font-weight: 500;
}
.page-header-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin: 0;
  line-height: 1.5;
}

/* ── Settings page ── */
.settings-container { max-width: 640px; margin: 0 auto; }
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
[data-theme="light"] .settings-section {
  box-shadow: 0 1px 4px rgba(0,30,43,0.07);
  border-color: #DDE4E2;
}
.settings-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
/* API key alert banner */
.settings-api-banner {
  background: rgba(255,192,16,0.08);
  border: 1px solid rgba(255,192,16,0.25);
  border-radius: var(--radius);
  padding: 14px 18px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--warning);
  line-height: 1.5;
}
.settings-api-banner.success {
  background: rgba(0,237,100,0.06);
  border-color: rgba(0,237,100,0.2);
  color: var(--success);
}
[data-theme="light"] .settings-api-banner {
  background: rgba(148,79,1,0.06);
  border-color: rgba(148,79,1,0.2);
}
[data-theme="light"] .settings-api-banner.success {
  background: rgba(0,104,74,0.06);
  border-color: rgba(0,104,74,0.2);
}
.settings-api-banner-icon { font-size: 20px; flex-shrink: 0; }
/* Heatmap preview swatches */
.heatmap-preview {
  display: inline-block;
  width: 80px;
  height: 12px;
  border-radius: 3px;
  vertical-align: middle;
  margin-left: 8px;
  border: 1px solid var(--border);
}
.heatmap-opt {
  display: flex;
  align-items: center;
  gap: 6px;
}
/* Get a key link as button */
.settings-key-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  color: var(--blue);
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  padding: 4px 10px;
  border: 1px solid var(--blue);
  border-radius: 4px;
  transition: all 0.15s;
  white-space: nowrap;
}
.settings-key-link:hover {
  background: rgba(4,152,236,0.1);
  text-decoration: none;
}
/* API key field integration */
.settings-api-field {
  display: flex;
  align-items: center;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-input);
  overflow: hidden;
  transition: border-color 0.2s;
}
.settings-api-field:focus-within { border-color: var(--accent); }
.settings-api-field input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 8px 12px;
  font-size: 13px;
  font-family: var(--mono);
  color: var(--text);
  min-width: 0;
}
.settings-api-field input:focus { outline: none; }
.settings-api-field button {
  background: none;
  border: none;
  border-left: 1px solid var(--border);
  padding: 8px 10px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-dim);
  transition: all 0.15s;
  flex-shrink: 0;
}
.settings-api-field button:hover { color: var(--text); background: rgba(255,255,255,0.05); }
[data-theme="light"] .settings-api-field button:hover { background: rgba(0,0,0,0.03); }
/* Version badges */
.version-badge {
  display: inline-block;
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  background: rgba(0,237,100,0.08);
  border: 1px solid rgba(0,237,100,0.2);
  border-radius: 6px;
  padding: 4px 12px;
  letter-spacing: 0.3px;
}
[data-theme="light"] .version-badge {
  background: rgba(0,104,74,0.06);
  border-color: rgba(0,104,74,0.2);
  color: #00684A;
}
.settings-api-field .save-btn {
  color: var(--accent);
  font-size: 12px;
  font-weight: 600;
  font-family: var(--font);
  padding: 8px 14px;
}
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.settings-row:last-child { border-bottom: none; }
[data-theme="light"] .settings-row { border-bottom-color: rgba(0,0,0,0.04); }
.settings-label {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.settings-label-text {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}
.settings-label-hint {
  font-size: 12px;
  color: var(--text-muted);
}
.settings-control { flex-shrink: 0; }
.settings-select {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--mono);
  cursor: pointer;
  min-width: 180px;
}
.settings-select:focus { outline: none; border-color: var(--accent); }
.settings-input {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 13px;
  font-family: var(--mono);
  min-width: 180px;
}
.settings-input:focus { outline: none; border-color: var(--accent); }
.settings-toggle {
  position: relative;
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: background 0.2s;
  padding: 0;
}
.settings-toggle.active { background: var(--accent); }
.settings-toggle::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s;
}
.settings-toggle.active::after { transform: translateX(20px); }
.settings-saved {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: var(--success);
  opacity: 0;
  transition: opacity 0.3s;
}
.settings-saved.show { opacity: 1; }
.settings-reset-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 8px 16px;
  border-radius: var(--radius);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}
.settings-reset-btn:hover { border-color: var(--error); color: var(--error); }
.settings-toggle-vis {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 8px;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  transition: all 0.2s;
  color: var(--text-dim);
}
.settings-toggle-vis:hover { border-color: var(--accent); }
.settings-api-key-active { color: var(--success); }
.settings-api-key-missing { color: var(--warning); }
.settings-row .settings-select, .settings-row .settings-input { text-align: right; }

/* ── Multimodal Tab ── */
.mm-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.mm-drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  background: var(--bg-input);
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
}
.mm-drop-zone:hover {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.mm-drop-zone.drag-active {
  border-color: var(--accent);
  background: var(--accent-glow);
  box-shadow: 0 0 0 4px var(--accent-glow);
}
.mm-drop-zone .mm-drop-icon {
  font-size: 40px;
  opacity: 0.6;
}
.mm-drop-zone .mm-drop-text {
  color: var(--text-dim);
  font-size: 14px;
}
.mm-drop-zone .mm-drop-hint {
  color: var(--text-muted);
  font-size: 12px;
}
.mm-preview {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 16px;
}
.mm-preview.visible { display: flex; }
.mm-preview img {
  max-height: 300px;
  max-width: 100%;
  object-fit: contain;
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.mm-preview .mm-file-info {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--mono);
}
.mm-preview .mm-clear-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 6px;
  padding: 4px 14px;
  font-size: 12px;
  cursor: pointer;
  font-family: var(--font);
  transition: border-color 0.15s, color 0.15s;
}
.mm-preview .mm-clear-btn:hover {
  border-color: var(--error);
  color: var(--error);
}
.mm-gallery-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}
.mm-gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.mm-gallery-slot {
  aspect-ratio: 1;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  background: var(--bg-input);
  position: relative;
  overflow: hidden;
}
.mm-gallery-slot:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.mm-gallery-slot.filled {
  border-style: solid;
  cursor: default;
  padding: 0;
}
.mm-gallery-slot.filled img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: calc(var(--radius) - 2px);
}
.mm-gallery-slot .mm-slot-remove {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 13px;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.mm-gallery-slot.filled:hover .mm-slot-remove { display: flex; }
.mm-gallery-slot .mm-slot-add {
  font-size: 28px;
  color: var(--text-muted);
  pointer-events: none;
}
.mm-gallery-slot.query-selected {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.mm-result-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.mm-result-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: border-color 0.15s;
}
.mm-result-item:first-child {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.mm-result-item .mm-result-rank {
  font-family: var(--mono);
  font-weight: 700;
  font-size: 18px;
  color: var(--text-muted);
  min-width: 28px;
  text-align: center;
}
.mm-result-item:first-child .mm-result-rank { color: var(--accent); }
.mm-result-item .mm-result-thumb {
  width: 48px;
  height: 48px;
  border-radius: 6px;
  object-fit: cover;
  border: 1px solid var(--border);
  flex-shrink: 0;
}
.mm-result-item .mm-result-content {
  flex: 1;
  min-width: 0;
}
.mm-result-item .mm-result-text {
  font-size: 14px;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.mm-result-item .mm-result-type {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.mm-result-item .mm-result-score {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
}
.mm-search-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 12px;
}
.mm-search-row input[type="text"] {
  flex: 1;
}
.mm-search-mode {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
}
.mm-search-mode button {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 6px;
  padding: 4px 12px;
  font-size: 12px;
  cursor: pointer;
  font-family: var(--font);
  transition: all 0.15s;
}
.mm-search-mode button.active {
  border-color: var(--accent);
  color: var(--accent);
  background: var(--accent-glow);
}

@media (max-width: 768px) {
  .mm-grid { grid-template-columns: 1fr; }
  .mm-gallery-grid { grid-template-columns: repeat(3, 1fr); }
  .compare-grid, .search-results { grid-template-columns: 1fr; }
  .sidebar { width: 56px; min-width: 56px; }
  .sidebar-title, .status-label { display: none; }
  .tab-btn { justify-content: center; padding: 10px; }
  .tab-btn span:not(.tab-btn-icon) { display: none; }
  .main { padding: 16px; }
  .settings-row { flex-direction: column; align-items: flex-start; gap: 8px; }
  .settings-select, .settings-input { min-width: 100%; }
}
</style>
</head>
<body>

<!-- LeafyGreen Icon Sprites (mongodb.design) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <symbol id="lg-lightning" viewBox="0 0 16 16">
    <path d="M9.22274 1.99296C9.22274 1.49561 8.56293 1.31233 8.30107 1.73667L4.07384 8.58696C3.87133 8.91513 4.10921 9.33717 4.49748 9.33717H6.77682L6.77682 14.0066C6.77682 14.504 7.43627 14.6879 7.69813 14.2635L11.9262 7.4118C12.1288 7.08363 11.8903 6.66244 11.5021 6.66244H9.22274V1.99296Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-arrows" viewBox="0 0 16 16">
    <path d="M5 8.57279V13.4272C5 13.9565 4.39241 14.2015 4.0721 13.8014L2.12898 11.3742C1.95701 11.1594 1.95701 10.8406 2.12898 10.6258L4.0721 8.19856C4.39241 7.79846 5 8.04351 5 8.57279Z" fill="currentColor"/>
    <path d="M5 10H12.5C12.7761 10 13 10.2239 13 10.5V11.5C13 11.7761 12.7761 12 12.5 12H5V10Z" fill="currentColor"/>
    <path d="M11 7.42721V2.57279C11 2.04351 11.6076 1.79846 11.9279 2.19856L13.871 4.62577C14.043 4.84058 14.043 5.15942 13.871 5.37423L11.9279 7.80144C11.6076 8.20154 11 7.95649 11 7.42721Z" fill="currentColor"/>
    <path d="M3 4.5C3 4.22386 3.22386 4 3.5 4H11V6H3.5C3.22386 6 3 5.77614 3 5.5V4.5Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-search" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.3234 9.81874C4.07618 11.5715 6.75062 11.8398 8.78588 10.6244L12.93 14.7685C13.4377 15.2762 14.2608 15.2762 14.7685 14.7685C15.2762 14.2608 15.2762 13.4377 14.7685 12.93L10.6244 8.78588C11.8398 6.75062 11.5715 4.07619 9.81873 2.32341C7.74896 0.253628 4.39318 0.253628 2.3234 2.32341C0.253624 4.39319 0.253624 7.74896 2.3234 9.81874ZM7.98026 4.16188C9.03467 5.2163 9.03467 6.92585 7.98026 7.98026C6.92584 9.03468 5.2163 9.03468 4.16188 7.98026C3.10746 6.92585 3.10746 5.2163 4.16188 4.16188C5.2163 3.10747 6.92584 3.10747 7.98026 4.16188Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-gauge" viewBox="0 0 16 16">
    <path d="M1.041 10.2514C0.996713 10.6632 1.33666 11 1.75088 11H4.2449C4.65912 11 4.98569 10.6591 5.08798 10.2577C5.22027 9.73864 5.49013 9.25966 5.87533 8.87446C6.43906 8.31073 7.20364 7.99403 8.00088 7.99403C8.27011 7.99403 8.53562 8.03015 8.79093 8.0997L11.7818 5.10887C10.6623 4.39046 9.35172 4 8.00088 4C6.14436 4 4.36388 4.7375 3.05113 6.05025C1.91604 7.18534 1.21104 8.67012 1.041 10.2514Z" fill="currentColor"/>
    <path d="M13.2967 6.42237L10.455 9.26409C10.6678 9.56493 10.8231 9.90191 10.9138 10.2577C11.0161 10.6591 11.3426 11 11.7568 11L14.2509 11C14.6651 11 15.005 10.6632 14.9608 10.2514C14.8087 8.83759 14.229 7.50093 13.2967 6.42237Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-bulb" viewBox="0 0 16 16">
    <path d="M12.3311 8.5C12.7565 7.76457 13 6.91072 13 6C13 3.23858 10.7614 1 8 1C5.23858 1 3 3.23858 3 6C3 6.94628 3.26287 7.83117 3.71958 8.58561L5.40749 11.501C5.58628 11.8099 5.91607 12 6.27291 12H6.5V6C6.5 5.17157 7.17157 4.5 8 4.5C8.82843 4.5 9.5 5.17157 9.5 6V12H9.72368C10.0793 12 10.4082 11.8111 10.5874 11.5039L12.34 8.5H12.3311Z" fill="currentColor"/>
    <path d="M7.5 6V12H8.5V6C8.5 5.72386 8.27614 5.5 8 5.5C7.72386 5.5 7.5 5.72386 7.5 6Z" fill="currentColor"/>
    <path d="M10 14V13H6V14C6 14.5523 6.44772 15 7 15H9C9.55228 15 10 14.5523 10 14Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-info" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 15C11.866 15 15 11.866 15 8C15 4.13401 11.866 1 8 1C4.13401 1 1 4.13401 1 8C1 11.866 4.13401 15 8 15ZM9 4C9 4.55228 8.55228 5 8 5C7.44772 5 7 4.55228 7 4C7 3.44772 7.44772 3 8 3C8.55228 3 9 3.44772 9 4ZM8 6C8.55228 6 9 6.44772 9 7V11H9.5C9.77614 11 10 11.2239 10 11.5C10 11.7761 9.77614 12 9.5 12H6.5C6.22386 12 6 11.7761 6 11.5C6 11.2239 6.22386 11 6.5 11H7V7H6.5C6.22386 7 6 6.77614 6 6.5C6 6.22386 6.22386 6 6.5 6H8Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-image" viewBox="0 0 16 16">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M2 3C2 2.44772 2.44772 2 3 2H13C13.5523 2 14 2.44772 14 3V13C14 13.5523 13.5523 14 13 14H3C2.44772 14 2 13.5523 2 13V3ZM4 4V9.586L5.793 7.793C6.183 7.403 6.817 7.403 7.207 7.793L8.5 9.086L10.293 7.293C10.683 6.903 11.317 6.903 11.707 7.293L12 7.586V4H4ZM12 10.414L10.5 8.914L8.207 11.207C7.817 11.597 7.183 11.597 6.793 11.207L5.5 9.914L4 11.414V12H12V10.414ZM10 5.5C10 6.328 10.672 7 11.5 7C11.776 7 12 6.776 12 6.5V5C12 4.724 11.776 4.5 11.5 4.5H10.5C10.224 4.5 10 4.724 10 5V5.5Z" fill="currentColor"/>
  </symbol>
  <symbol id="lg-config" viewBox="0 0 16 16">
    <path d="M12.7 2.56989C12.41 2.56989 12.17 2.80989 12.17 3.09989V4.34989L11.32 3.49989C9.21 1.39989 5.75 1.51989 3.78 3.75989C2.65 5.03989 2.23 6.82989 2.68 8.48989C3.24 10.5299 4.98 12.0099 7.08 12.2299L8.1 12.3399C8.42 13.2799 9.3 13.9499 10.34 13.9499C11.65 13.9499 12.71 12.8899 12.71 11.5799C12.71 10.2699 11.65 9.20989 10.34 9.20989C9.14 9.20989 8.16 10.0999 8 11.2599L7.19 11.1799C5.53 11.0099 4.14 9.82989 3.7 8.21989C3.34 6.90989 3.67 5.48989 4.58 4.46989C6.15 2.68989 8.9 2.59989 10.57 4.26989L11.42 5.11989H10.17C9.88 5.11989 9.64 5.35989 9.64 5.64989C9.64 5.93989 9.88 6.17989 10.17 6.17989H12.71C13 6.17989 13.24 5.93989 13.24 5.64989V3.09989C13.24 2.80989 13 2.56989 12.71 2.56989H12.7ZM10.34 10.3099C11.04 10.3099 11.6 10.8799 11.6 11.5699C11.6 12.2599 11.03 12.8299 10.34 12.8299C9.65 12.8299 9.08 12.2599 9.08 11.5699C9.08 10.8799 9.65 10.3099 10.34 10.3099Z" fill="currentColor"/>
  </symbol>
</svg>

<div class="app-shell">

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-drag-region">
    <img class="sidebar-logo" id="sidebarLogo" src="/icons/dark/64.png" alt="Vai">
    <span class="sidebar-title">Vai</span>
  </div>
  <nav class="sidebar-nav">
    <div class="sidebar-nav-group">
      <div class="sidebar-nav-label">Tools</div>
      <button class="tab-btn active" data-tab="embed"><span class="tab-btn-icon"><svg><use href="#lg-lightning"/></svg></span><span>Embed</span></button>
      <button class="tab-btn" data-tab="compare"><span class="tab-btn-icon"><svg><use href="#lg-arrows"/></svg></span><span>Compare</span></button>
      <button class="tab-btn" data-tab="search"><span class="tab-btn-icon"><svg><use href="#lg-search"/></svg></span><span>Search</span></button>
      <button class="tab-btn" data-tab="multimodal"><span class="tab-btn-icon"><svg><use href="#lg-image"/></svg></span><span>Multimodal</span></button>
    </div>
    <div class="sidebar-nav-divider"></div>
    <div class="sidebar-nav-group">
      <div class="sidebar-nav-label">Resources</div>
      <button class="tab-btn" data-tab="benchmark"><span class="tab-btn-icon"><svg><use href="#lg-gauge"/></svg></span><span>Benchmark</span></button>
      <button class="tab-btn" data-tab="explore"><span class="tab-btn-icon"><svg><use href="#lg-bulb"/></svg></span><span>Explore</span></button>
      <button class="tab-btn" data-tab="about"><span class="tab-btn-icon"><svg><use href="#lg-info"/></svg></span><span>About</span></button>
    </div>
    <div class="sidebar-nav-divider"></div>
    <button class="tab-btn" data-tab="settings"><span class="tab-btn-icon"><svg><use href="#lg-config"/></svg></span><span>Settings</span></button>
  </nav>
  <div class="sidebar-footer">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:5px;">
        <div class="status-dot" id="statusDot"></div>
        <span class="status-label" id="statusLabel">Checking...</span>
      </div>
      <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">🌙</button>
    </div>
    <div id="appVersionLabel" style="font-size:10px;color:var(--text-muted);text-align:center;"></div>
  </div>
</aside>

<!-- Content -->
<div class="content-area">
  <div class="content-drag-region"></div>
  <div class="update-banner" id="updateBanner">
    <span class="update-banner-icon">🚀</span>
    <span class="update-banner-text" id="updateBannerText">
      <strong>Vai <span id="updateVersion"></span></strong> is available.
      You're on <span id="currentVersion"></span>.
    </span>
    <div class="update-progress" id="updateProgress" style="display:none;">
      <div class="update-progress-bar"><div class="update-progress-fill" id="updateProgressFill"></div></div>
      <span class="update-progress-label" id="updateProgressLabel">0%</span>
    </div>
    <button class="update-banner-btn" id="updateDownloadBtn">Download &amp; Install</button>
    <button class="update-banner-btn" id="updateInstallBtn" style="display:none;">Restart &amp; Update</button>
    <button class="update-banner-dismiss" id="updateDismissBtn" title="Dismiss">×</button>
  </div>
  <div class="main">

<!-- ========== EMBED TAB ========== -->
<div class="tab-panel active" id="tab-embed">
  <div class="page-header">
    <h2 class="page-header-title">Embed</h2>
    <p class="page-header-subtitle">Generate vector embeddings for text</p>
    <p class="page-header-hint">Paste or type text below, choose a model, and hit Embed to see the raw vectors and token usage.</p>
  </div>
  <div class="card">
    <div class="card-title">Input Text</div>
    <textarea id="embedInput" rows="5" placeholder="Enter text to embed...">MongoDB Atlas provides powerful vector search capabilities for AI applications.</textarea>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Model</span>
      <select id="embedModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Input Type</span>
      <select id="embedInputType">
        <option value="">None</option>
        <option value="query">Query</option>
        <option value="document">Document</option>
      </select>
    </div>
    <div class="option-group">
      <span class="option-label">Dimensions</span>
      <select id="embedDimensions">
        <option value="">Default</option>
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
      </select>
    </div>
    <div class="option-group">
      <span class="option-label">Output Type</span>
      <select id="embedOutputDtype">
        <option value="float">float (32-bit)</option>
        <option value="int8">int8 (4× smaller)</option>
        <option value="uint8">uint8 (4× smaller)</option>
        <option value="binary">binary (32× smaller)</option>
        <option value="ubinary">ubinary (32× smaller)</option>
      </select>
    </div>
    <button class="btn" id="embedBtn" onclick="doEmbed()">⚡ Embed</button>
  </div>

  <div class="error-msg" id="embedError"></div>

  <div class="result-section" id="embedResult">
    <div class="card">
      <div class="card-title">Result</div>
      <div id="embedStats"></div>
      <div class="vector-preview" id="embedVector"></div>
      <div style="margin-top:8px;">
        <button class="btn btn-secondary btn-small" onclick="copyVector()">📋 Copy Full Vector</button>
      </div>
      <div class="card-title" style="margin-top:16px;">Vector Heatmap</div>
      <div class="heatmap" id="embedHeatmap"></div>
    </div>
  </div>
</div>

<!-- ========== COMPARE TAB ========== -->
<div class="tab-panel" id="tab-compare">
  <div class="page-header">
    <h2 class="page-header-title">Compare</h2>
    <p class="page-header-subtitle">Visualize similarity between text pairs</p>
    <p class="page-header-hint">Enter two texts and compare their embeddings — see cosine similarity, a heatmap of vector dimensions, and a visual diff.</p>
  </div>
  <div class="compare-grid">
    <div class="card">
      <div class="card-title">Text A</div>
      <textarea id="compareA" rows="5" placeholder="Enter first text...">MongoDB is a popular NoSQL database</textarea>
    </div>
    <div class="card">
      <div class="card-title">Text B</div>
      <textarea id="compareB" rows="5" placeholder="Enter second text...">Document databases store data as JSON-like objects</textarea>
    </div>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Model</span>
      <select id="compareModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Dimensions</span>
      <select id="compareDimensions">
        <option value="">Default</option>
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
      </select>
    </div>
    <button class="btn" id="compareBtn" onclick="doCompare()">⚖️ Compare</button>
  </div>

  <div class="error-msg" id="compareError"></div>

  <div class="result-section" id="compareResult">
    <div class="card">
      <div class="similarity-display">
        <div class="similarity-score" id="simScore">—</div>
        <div class="similarity-label">Cosine Similarity</div>
        <div class="similarity-bar-outer">
          <div class="similarity-bar-inner" id="simBar" style="width:0%"></div>
        </div>
      </div>
      <div class="metrics-grid" id="metricsGrid"></div>
      <div class="metric-note" id="metricNote"></div>
      <div id="compareStats" style="text-align:center;margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- ========== SEARCH TAB ========== -->
<div class="tab-panel" id="tab-search">
  <div class="page-header">
    <h2 class="page-header-title">Rerank</h2>
    <p class="page-header-subtitle">Re-order documents by relevance to a query</p>
    <p class="page-header-hint">Enter a search query and a set of documents — the reranker scores and sorts them by semantic relevance.</p>
  </div>
  <div class="card">
    <div class="card-title">Query</div>
    <input type="text" id="searchQuery" placeholder="Enter your search query..." value="How do I build AI-powered search?">
  </div>

  <div class="card">
    <div class="card-title">Documents (one per line)</div>
    <textarea id="searchDocs" rows="8" placeholder="Enter documents, one per line...">MongoDB Atlas provides vector search capabilities
The recipe calls for two cups of flour and three eggs
Voyage AI embeddings power semantic retrieval for modern applications
Python is a popular programming language for data science
Atlas Search combines full-text and vector search in one platform
Machine learning models can be deployed at the edge
Semantic search understands meaning beyond keyword matching</textarea>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Embedding Model</span>
      <select id="searchEmbedModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Rerank Model</span>
      <select id="searchRerankModel"></select>
    </div>
    <div class="option-group">
      <span class="option-label">Top K</span>
      <select id="searchTopK">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="10">10</option>
      </select>
    </div>
    <button class="btn" id="searchBtn" onclick="doSearch(false)">🔍 Search</button>
    <button class="btn btn-secondary" id="searchRerankBtn" onclick="doSearch(true)">🔍+ Rerank</button>
  </div>

  <div class="error-msg" id="searchError"></div>

  <div class="result-section" id="searchResult">
    <div class="search-results" id="searchResultGrid"></div>
  </div>
</div>

<!-- ========== MULTIMODAL TAB ========== -->
<div class="tab-panel" id="tab-multimodal">
  <div class="page-header">
    <h2 class="page-header-title">Multimodal</h2>
    <p class="page-header-subtitle">Compare images and text in the same vector space</p>
    <p class="page-header-hint">Voyage AI's multimodal models embed images and text into a unified vector space — so you can compare them directly with cosine similarity.</p>
  </div>

  <!-- Section A: Image ↔ Text Similarity -->
  <div class="mm-grid">
    <div class="card">
      <div class="card-title">Image</div>
      <div class="mm-drop-zone" id="mmDropZone">
        <div class="mm-drop-icon">🖼️</div>
        <div class="mm-drop-text">Drop an image here or click to browse</div>
        <div class="mm-drop-hint">PNG, JPEG, WebP, GIF — max 20 MB · Paste from clipboard (⌘V)</div>
      </div>
      <input type="file" id="mmFileInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none">
      <div class="mm-preview" id="mmPreview">
        <img id="mmPreviewImg" src="" alt="Preview">
        <div class="mm-file-info" id="mmFileInfo"></div>
        <button class="mm-clear-btn" onclick="clearMultimodalImage()">✕ Clear</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Text</div>
      <textarea id="mmText" rows="8" placeholder="Describe what you see, or enter any text to compare against the image..."></textarea>
    </div>
  </div>

  <div class="options-row">
    <div class="option-group">
      <span class="option-label">Model</span>
      <select id="mmModel">
        <option value="voyage-multimodal-3.5">voyage-multimodal-3.5</option>
        <option value="voyage-multimodal-3">voyage-multimodal-3</option>
      </select>
    </div>
    <div class="option-group">
      <span class="option-label">Dimensions</span>
      <select id="mmDimensions">
        <option value="">Default</option>
        <option value="256">256</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="2048">2048</option>
      </select>
    </div>
    <button class="btn" id="mmCompareBtn" onclick="doMultimodalCompare()">🔮 Compare</button>
  </div>

  <div class="error-msg" id="mmError"></div>

  <div class="result-section" id="mmResult">
    <div class="card">
      <div class="similarity-display">
        <div class="similarity-score" id="mmSimScore">—</div>
        <div class="similarity-label">Cosine Similarity</div>
        <div class="similarity-bar-outer">
          <div class="similarity-bar-inner" id="mmSimBar" style="width:0%"></div>
        </div>
      </div>
      <div id="mmStats" style="text-align:center;margin-top:16px;"></div>
      <div class="metric-note" id="mmNote" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- Section B: Cross-Modal Gallery -->
  <div class="mm-gallery-section">
    <h3 style="color:var(--accent-text);margin-bottom:4px;">Cross-Modal Gallery</h3>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:16px;">Build a mini corpus of images and texts, then search across both modalities at once.</p>

    <div class="card">
      <div class="card-title">Image Corpus (up to 6)</div>
      <div class="mm-gallery-grid" id="mmGalleryGrid"></div>
      <input type="file" id="mmGalleryFileInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none">
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="card-title">Text Corpus (one per line)</div>
      <textarea id="mmCorpusText" rows="5" placeholder="A sunset over the ocean&#10;A cat sitting on a windowsill&#10;Abstract geometric patterns&#10;A city skyline at night"></textarea>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="card-title">Search Query</div>
      <div class="mm-search-mode" id="mmSearchMode">
        <button class="active" data-mode="text" onclick="setMmSearchMode('text')">📝 Text Query</button>
        <button data-mode="image" onclick="setMmSearchMode('image')">🖼️ Image Query</button>
      </div>
      <div id="mmSearchTextWrap">
        <div class="mm-search-row">
          <input type="text" id="mmSearchQuery" placeholder="Enter a search query...">
          <button class="btn" id="mmSearchBtn" onclick="doMultimodalSearch()">🔮 Search Corpus</button>
        </div>
      </div>
      <div id="mmSearchImageWrap" style="display:none;">
        <p style="font-size:13px;color:var(--text-dim);margin-bottom:8px;">Click an image in the corpus above to use it as the search query, then:</p>
        <div style="display:flex;gap:8px;align-items:center;">
          <span id="mmSearchImageLabel" style="font-size:13px;color:var(--text-muted);">No image selected</span>
          <button class="btn" id="mmSearchImgBtn" onclick="doMultimodalSearch()">🔮 Search Corpus</button>
        </div>
      </div>
    </div>

    <div class="error-msg" id="mmSearchError"></div>

    <div class="result-section" id="mmSearchResult">
      <div class="card">
        <div class="card-title">Search Results</div>
        <div class="mm-result-list" id="mmSearchResultList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== BENCHMARK TAB ========== -->
<div class="tab-panel" id="tab-benchmark">
  <div class="page-header">
    <h2 class="page-header-title">Benchmark</h2>
    <p class="page-header-subtitle">Compare model speed, cost, and quality</p>
    <p class="page-header-hint">Run latency tests, compare ranking accuracy, analyze quantization trade-offs, and estimate costs across models.</p>
  </div>

  <!-- Sub-panel switcher -->
  <div class="bench-panels">
    <button class="bench-panel-btn active" data-bench="latency">⚡ Latency</button>
    <button class="bench-panel-btn" data-bench="ranking">🏆 Ranking</button>
    <button class="bench-panel-btn" data-bench="quantization">⚗️ Quantization</button>
    <button class="bench-panel-btn" data-bench="cost">💰 Cost</button>
    <button class="bench-panel-btn" data-bench="history">📊 History</button>
  </div>

  <!-- ── Latency Panel ── -->
  <div class="bench-view active" id="bench-latency">
    <div class="card">
      <div class="card-title">Embedding Latency Benchmark</div>
      <textarea id="benchLatencyInput" rows="3" placeholder="Enter text to benchmark (or leave for built-in sample)..."></textarea>
      <div class="options-row">
        <div class="option-group">
          <span class="option-label">Models</span>
          <div id="benchModelChecks" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>
        <div class="option-group">
          <span class="option-label">Rounds</span>
          <select id="benchRounds">
            <option value="1">1</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
        <button class="btn" id="benchLatencyBtn" onclick="doBenchLatency()">⚡ Run Benchmark</button>
      </div>
    </div>

    <div class="error-msg" id="benchLatencyError"></div>

    <div class="result-section" id="benchLatencyResult">
      <div class="card">
        <div class="card-title">Results</div>
        <div id="benchLatencyStats"></div>
        <div class="latency-chart" id="benchLatencyChart"></div>
      </div>
    </div>
  </div>

  <!-- ── Ranking Panel ── -->
  <div class="bench-view" id="bench-ranking">
    <div class="card">
      <div class="card-title">Model Ranking Comparison</div>
      <div style="margin-bottom:12px;">
        <input type="text" id="benchRankQuery" placeholder="Search query..." value="How do I search for similar documents using embeddings?">
      </div>
      <textarea id="benchRankDocs" rows="6" placeholder="Documents (one per line)...">Vector search finds documents by computing similarity between embedding vectors in high-dimensional space.
MongoDB Atlas Vector Search lets you index and query vector embeddings alongside your operational data.
Traditional full-text search uses inverted indexes to match keyword terms in documents.
Cosine similarity measures the angle between two vectors, commonly used for semantic search.
Database sharding distributes data across multiple servers for horizontal scalability.
Embedding models convert text into dense numerical vectors that capture meaning.
Approximate nearest neighbor algorithms like HNSW enable fast similarity search at scale.
Reranking models rescore initial search results to improve relevance ordering.</textarea>
      <div class="options-row">
        <div class="option-group">
          <span class="option-label">Model A</span>
          <select id="benchRankModelA"></select>
        </div>
        <div class="option-group">
          <span class="option-label">Model B</span>
          <select id="benchRankModelB"></select>
        </div>
        <div class="option-group">
          <span class="option-label">Mode</span>
          <select id="benchRankMode">
            <option value="embed">Embedding Similarity</option>
            <option value="rerank">Reranking</option>
          </select>
        </div>
        <div class="option-group">
          <span class="option-label">Top K</span>
          <select id="benchRankTopK">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="8">8</option>
          </select>
        </div>
        <button class="btn" id="benchRankBtn" onclick="doBenchRanking()">🏆 Compare Rankings</button>
      </div>
    </div>

    <div class="error-msg" id="benchRankError"></div>

    <div class="result-section" id="benchRankResult">
      <div class="card">
        <div class="card-title">Ranking Comparison</div>
        <div id="benchRankVerdict" style="margin-bottom:12px;font-size:14px;"></div>
        <div class="rank-comparison" id="benchRankGrid"></div>
      </div>
    </div>
  </div>

  <!-- ── Quantization Panel ── -->
  <div class="bench-view" id="bench-quantization">
    <div class="card">
      <div class="card-title">Quantization Benchmark</div>
      <p style="color:var(--text-dim);font-size:13px;margin-bottom:12px;">
        Compare how different output data types (float, int8, binary) affect storage size and ranking quality.
        Embeds the same corpus with each dtype and measures the tradeoff.
      </p>
      <div class="options-row" style="flex-wrap:wrap;">
        <div class="option-group">
          <span class="option-label">Model</span>
          <select id="quantModel"></select>
        </div>
        <div class="option-group">
          <span class="option-label">Dimensions</span>
          <select id="quantDimensions">
            <option value="">Default</option>
            <option value="256">256</option>
            <option value="512">512</option>
            <option value="1024">1024</option>
            <option value="2048">2048</option>
          </select>
        </div>
        <div class="option-group">
          <span class="option-label">Data Types</span>
          <div id="quantDtypeChecks" style="display:flex;gap:8px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="float" checked style="accent-color:var(--accent);">float
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="int8" checked style="accent-color:var(--accent);">int8
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="uint8" style="accent-color:var(--accent);">uint8
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="ubinary" checked style="accent-color:var(--accent);">ubinary
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);">
              <input type="checkbox" value="binary" style="accent-color:var(--accent);">binary
            </label>
          </div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <span class="option-label">Query</span>
        <input type="text" id="quantQuery" placeholder="Search query..." value="How do I search for similar documents using embeddings?" style="width:100%;margin-bottom:8px;">
      </div>
      <div>
        <span class="option-label">Corpus (one document per line)</span>
        <textarea id="quantCorpus" rows="5" placeholder="Documents to embed...">Vector search finds documents by computing similarity between embedding vectors in high-dimensional space.
MongoDB Atlas Vector Search lets you index and query vector embeddings alongside your operational data.
Traditional full-text search uses inverted indexes to match keyword terms in documents.
Cosine similarity measures the angle between two vectors, commonly used for semantic search.
Database sharding distributes data across multiple servers for horizontal scalability.
Embedding models convert text into dense numerical vectors that capture meaning.
Approximate nearest neighbor algorithms like HNSW enable fast similarity search at scale.
Reranking models rescore initial search results to improve relevance ordering.</textarea>
      </div>
      <div style="margin-top:12px;">
        <button class="btn" id="quantBtn" onclick="doBenchQuantization()">⚗️ Run Quantization Benchmark</button>
      </div>
    </div>

    <div class="error-msg" id="quantError"></div>

    <div class="result-section" id="quantResult">
      <div class="quant-charts">
        <div class="card">
          <div class="card-title">📦 Storage per Vector</div>
          <div id="quantStorageChart"></div>
        </div>
        <div class="card">
          <div class="card-title">⏱ API Latency</div>
          <div id="quantLatencyChart"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">🎯 Ranking Quality vs Float Baseline</div>
        <div id="quantQualityMeters" style="margin-bottom:16px;"></div>
        <div id="quantRankGrid"></div>
      </div>
    </div>
  </div>

  <!-- ── Cost Panel ── -->
  <div class="bench-view" id="bench-cost">
    <div class="card">
      <div class="card-title">💰 RAG Cost Calculator <button class="cost-help-btn" id="costHelpBtn" title="How the math works">?</button></div>

      <!-- Mode toggle -->
      <div style="margin-bottom: 20px;">
        <div class="cost-mode-toggle">
          <button class="cost-mode-btn active" data-mode="simple" id="costModeSimple">Simple</button>
          <button class="cost-mode-btn" data-mode="rag" id="costModeRag">RAG Planner</button>
        </div>
      </div>

      <!-- Simple mode (query cost comparison) -->
      <div id="costSimpleMode">
        <div class="cost-controls cost-controls-full">
          <div class="cost-slider-row">
            <span class="cost-slider-label">Tokens / query</span>
            <input type="range" class="cost-slider" id="costTokens" min="50" max="5000" value="500" step="50">
            <span class="cost-slider-value" id="costTokensValue">500</span>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Queries / day</span>
            <input type="range" class="cost-slider" id="costQueries" min="10" max="500000" value="1000" step="10">
            <span class="cost-slider-value" id="costQueriesValue">1,000</span>
          </div>
        </div>
        <table class="cost-table" id="costTable">
          <thead>
            <tr>
              <th>Model</th>
              <th>Type</th>
              <th>$/1M tokens</th>
              <th>Daily Cost</th>
              <th>Monthly Cost</th>
              <th style="width:30%">Relative</th>
            </tr>
          </thead>
          <tbody id="costTableBody"></tbody>
        </table>
      </div>

      <!-- RAG Planner mode (full TCO) -->
      <div id="costRagMode" style="display:none;">
        <div class="cost-section-title">📄 Documents (one-time ingestion)</div>
        <div class="cost-controls">
          <div class="cost-slider-row">
            <span class="cost-slider-label">Documents</span>
            <input type="range" class="cost-slider" id="ragDocs" min="1000" max="10000000" value="100000" step="1000">
            <span class="cost-slider-value" id="ragDocsValue">100K</span>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Tokens / doc</span>
            <input type="range" class="cost-slider" id="ragDocTokens" min="50" max="5000" value="500" step="50">
            <span class="cost-slider-value" id="ragDocTokensValue">500</span>
          </div>
        </div>

        <div class="cost-section-title">🔍 Queries (recurring)</div>
        <div class="cost-controls">
          <div class="cost-slider-row">
            <span class="cost-slider-label">Queries / month</span>
            <input type="range" class="cost-slider" id="ragQueries" min="1000" max="50000000" value="1000000" step="1000">
            <span class="cost-slider-value" id="ragQueriesValue">1M</span>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Tokens / query</span>
            <input type="range" class="cost-slider" id="ragQueryTokens" min="10" max="500" value="30" step="5">
            <span class="cost-slider-value" id="ragQueryTokensValue">30</span>
          </div>
        </div>

        <div class="cost-section-title">⚙️ Configuration</div>
        <div class="cost-controls">
          <div class="cost-model-row">
            <span class="cost-model-label">Doc model</span>
            <select class="cost-select" id="ragDocModel"></select>
          </div>
          <div class="cost-model-row">
            <span class="cost-model-label">Query model</span>
            <select class="cost-select" id="ragQueryModel"></select>
          </div>
          <div class="cost-slider-row">
            <span class="cost-slider-label">Projection</span>
            <input type="range" class="cost-slider" id="ragMonths" min="1" max="36" value="12" step="1">
            <span class="cost-slider-value" id="ragMonthsValue">12 mo</span>
          </div>
        </div>

        <!-- Summary cards -->
        <div class="cost-summary" id="ragSummary"></div>

        <!-- Strategy comparison -->
        <div class="cost-section-title">📊 Strategy Comparison</div>
        <div class="cost-strategy-cards" id="ragStrategies"></div>

        <!-- Per-model table -->
        <div class="cost-section-title">📋 Per-Model Breakdown</div>
        <table class="cost-table" id="ragTable">
          <thead>
            <tr>
              <th>Model</th>
              <th>Doc Cost</th>
              <th>Query $/mo</th>
              <th>Total (projected)</th>
              <th style="width:25%">Relative</th>
            </tr>
          </thead>
          <tbody id="ragTableBody"></tbody>
        </table>

        <div class="cost-tip" id="ragTip"></div>
      </div>
    </div>
  </div>

  <!-- ── History Panel ── -->
  <div class="bench-view" id="bench-history">
    <div class="card">
      <div class="card-title">Benchmark History</div>
      <div id="benchHistoryContent">
        <div class="history-empty">No benchmarks recorded yet. Run a latency benchmark to start tracking.</div>
      </div>
      <div style="margin-top:12px;text-align:right;">
        <button class="btn btn-secondary btn-small" onclick="clearHistory()">🗑 Clear History</button>
      </div>
    </div>
  </div>

</div>

<!-- ========== ABOUT TAB ========== -->
<div class="tab-panel" id="tab-about">
  <div class="about-container">
    <div class="card">
      <div class="about-header">
        <img src="https://avatars.githubusercontent.com/u/192552?v=4" alt="Michael Lynn" class="about-avatar">
        <div>
          <div class="about-name">Michael Lynn</div>
          <div class="about-role">Principal Staff Developer Advocate · MongoDB</div>
          <div class="about-links">
            <a href="https://github.com/mrlynn" target="_blank" rel="noopener">🔗 GitHub</a>
            <a href="https://mlynn.org" target="_blank" rel="noopener">🌐 mlynn.org</a>
            <a href="https://www.npmjs.com/package/voyageai-cli" target="_blank" rel="noopener">📦 npm</a>
          </div>
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">About This Project</div>
        <div class="about-text">
          <strong>voyageai-cli</strong> (<code style="color:var(--accent);">vai</code>) is a community-built command-line tool for working with
          <a href="https://www.mongodb.com/docs/voyageai/" target="_blank">Voyage AI</a> embeddings, reranking, and
          <a href="https://www.mongodb.com/products/platform/atlas-vector-search" target="_blank">MongoDB Atlas Vector Search</a>.
          It was created to make it easier for developers to explore, benchmark, and integrate
          Voyage AI models into their applications — right from the terminal or this playground.
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">About Michael</div>
        <div class="about-text">
          Michael Lynn is a Principal Staff Developer Advocate at MongoDB with 25+ years in enterprise
          infrastructure and over a decade at MongoDB. He focuses on strategic developer relations,
          creating educational content around Vector Search, AI enablement, and developer tooling.
          He builds tools like this to help developers get hands-on with new technology faster.
        </div>
      </div>

      <div class="about-section">
        <div class="about-section-title">What You Can Do Here</div>
        <div class="about-text">
          <strong>⚡ Embed</strong> — Generate vector embeddings for any text<br>
          <strong>⚖️ Compare</strong> — Measure similarity with cosine, dot product &amp; euclidean distance<br>
          <strong>🔍 Search</strong> — Semantic search with optional reranking<br>
          <strong>⏱ Benchmark</strong> — Compare model latency, ranking quality, and costs<br>
          <strong>📚 Explore</strong> — Learn about embeddings, vector search, RAG, and more
        </div>
      </div>

      <div class="about-disclaimer">
        <div class="about-disclaimer-title">⚠️ Community Tool Disclaimer</div>
        <div class="about-disclaimer-text">
          This tool is <strong>not</strong> an official product of MongoDB, Inc. or Voyage AI.
          It is independently built and maintained by Michael Lynn as a community resource.
          It is not supported, endorsed, or guaranteed by either company. Use at your own discretion.
          For official documentation, visit
          <a href="https://www.mongodb.com/docs/voyageai/" target="_blank" style="color:var(--warning);">mongodb.com/docs/voyageai</a>.
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--text-muted);">
      Made with ☕ and curiosity · <a href="https://github.com/mrlynn/voyageai-cli" target="_blank" style="color:var(--text-dim);">Source on GitHub</a>
    </div>
  </div>
</div>

<!-- ========== EXPLORE TAB ========== -->
<div class="tab-panel" id="tab-explore">
  <div class="page-header">
    <h2 class="page-header-title">Explore</h2>
    <p class="page-header-subtitle">Learn embedding and vector search concepts</p>
    <p class="page-header-hint">Browse interactive explanations of key topics — from cosine similarity to quantization to RAG pipelines.</p>
  </div>
  <div style="margin-bottom:16px;">
    <input type="text" id="exploreSearch" placeholder="🔍 Search concepts..." oninput="filterExplore()" style="max-width:400px;">
  </div>
  <div class="explore-grid" id="exploreGrid"></div>
</div>

<!-- Explore Concept Modal -->
<div class="explore-modal-overlay" id="exploreModal">
  <div class="explore-modal">
    <button class="explore-modal-close" id="exploreModalClose">&times;</button>
    <div class="explore-modal-header">
      <div class="explore-modal-icon" id="exploreModalIcon"></div>
      <div>
        <div class="explore-modal-title" id="exploreModalTitle"></div>
        <div class="explore-modal-summary" id="exploreModalSummary"></div>
      </div>
    </div>
    <div class="explore-modal-body" id="exploreModalBody"></div>
    <div class="explore-modal-actions" id="exploreModalActions"></div>
  </div>
</div>

<!-- Hidden global model select (used by JS for model sync) -->
<select id="globalModel" style="display:none;"></select>

<!-- ========== SETTINGS TAB ========== -->
<div class="tab-panel" id="tab-settings">
  <div class="settings-container">
    <div class="page-header">
      <h2 class="page-header-title">Settings</h2>
      <p class="page-header-subtitle">Configure appearance, models, and API access</p>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Appearance</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Theme</span>
          <span class="settings-label-hint">Controls the color scheme of the interface</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsTheme">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Vector Heatmap Colors</span>
          <span class="settings-label-hint">Color palette for embedding visualizations</span>
        </div>
        <div class="settings-control" style="display:flex;align-items:center;gap:8px;">
          <select class="settings-select" id="settingsHeatmap">
            <option value="viridis">Viridis</option>
            <option value="plasma">Plasma</option>
            <option value="inferno">Inferno</option>
            <option value="magma">Magma</option>
            <option value="cividis">Cividis</option>
            <option value="turbo">Turbo</option>
          </select>
          <span class="heatmap-preview" id="heatmapPreview"></span>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Models</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Default Embedding Model</span>
          <span class="settings-label-hint">Pre-selected model for Embed and Compare tabs</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsDefaultModel"></select>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Default Input Type</span>
          <span class="settings-label-hint">Pre-selected input type for embedding requests</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsInputType">
            <option value="document">document</option>
            <option value="query">query</option>
          </select>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">API</div>
      <div class="settings-api-banner" id="settingsApiBanner">
        <span class="settings-api-banner-icon" id="settingsApiBannerIcon">⚠️</span>
        <span id="settingsApiKeyMsg">No API key configured — add your key below to get started.</span>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">API Key</span>
          <span class="settings-label-hint">Encrypted via OS keychain · <a href="https://dash.voyageai.com" target="_blank" class="settings-key-link">🔑 Get a key</a></span>
        </div>
        <div class="settings-control" style="min-width:260px;">
          <div class="settings-api-field">
            <input type="password" id="settingsApiKey" placeholder="pa-..." autocomplete="off" spellcheck="false">
            <button type="button" id="settingsApiKeyToggle" title="Show/hide key">👁</button>
            <button type="button" id="settingsApiKeySave" class="save-btn" title="Save key">Save</button>
          </div>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">API Base URL</span>
          <span class="settings-label-hint">Override the default endpoint (leave empty for default)</span>
        </div>
        <div class="settings-control">
          <input type="text" class="settings-input" id="settingsApiBase" placeholder="https://api.voyageai.com/v1">
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Request Timeout</span>
          <span class="settings-label-hint">Max seconds to wait for API responses</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsTimeout">
            <option value="15">15 seconds</option>
            <option value="30" selected>30 seconds</option>
            <option value="60">60 seconds</option>
            <option value="120">120 seconds</option>
          </select>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Benchmark Defaults</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Iterations per Model</span>
          <span class="settings-label-hint">Number of runs when benchmarking latency</span>
        </div>
        <div class="settings-control">
          <select class="settings-select" id="settingsBenchIter">
            <option value="3">3 runs</option>
            <option value="5" selected>5 runs</option>
            <option value="10">10 runs</option>
            <option value="20">20 runs</option>
          </select>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Show Detailed Timings</span>
          <span class="settings-label-hint">Display p50/p95/p99 in benchmark results</span>
        </div>
        <div class="settings-control">
          <button class="settings-toggle" id="settingsDetailedTimings" type="button"></button>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Help</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Welcome Tour</span>
          <span class="settings-label-hint">Replay the onboarding walkthrough</span>
        </div>
        <div class="settings-control">
          <button class="settings-reset-btn" id="settingsShowTour" style="background:var(--accent);color:var(--bg);">Show Welcome Tour</button>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Data &amp; Privacy</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Persist Embeddings Locally</span>
          <span class="settings-label-hint">Cache embedding results in browser storage to avoid re-fetching</span>
        </div>
        <div class="settings-control">
          <button class="settings-toggle active" id="settingsCacheEmbeddings" type="button"></button>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Clear Cached Data</span>
          <span class="settings-label-hint">Remove all locally stored embeddings and preferences</span>
        </div>
        <div class="settings-control">
          <button class="settings-reset-btn" id="settingsClearCache">Clear All Data</button>
        </div>
      </div>
    </div>

    <!-- Version Info (visible in Electron only) -->
    <div class="settings-section" id="settingsVersionSection" style="display:none;">
      <div class="settings-section-title">Version</div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Vai Desktop</span>
          <span class="settings-label-hint">Electron desktop application</span>
        </div>
        <div class="settings-control">
          <span class="version-badge" id="settingsAppVersion">—</span>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-label">
          <span class="settings-label-text">Vai CLI Engine</span>
          <span class="settings-label-hint">Underlying CLI powering embeddings, search &amp; reranking</span>
        </div>
        <div class="settings-control">
          <span class="version-badge" id="settingsCliVersion">—</span>
        </div>
      </div>
    </div>

    <div style="text-align:center;padding:8px 0;">
      <span class="settings-saved" id="settingsSavedMsg">✓ Saved</span>
    </div>

  </div>
</div>

</div><!-- .main -->
</div><!-- .content-area -->
</div><!-- .app-shell -->

<!-- Onboarding Walkthrough Overlay -->
<div class="onboarding-overlay" id="onboardingOverlay">
  <div class="onboarding-backdrop" id="onboardingBackdrop"></div>
  <div class="onboarding-spotlight" id="onboardingSpotlight"></div>
  <!-- Welcome card (step 0) -->
  <div class="onboarding-welcome-center" id="onboardingWelcomeWrap">
    <div class="onboarding-welcome-card" id="onboardingWelcomeCard">
      <img class="onboarding-welcome-logo" id="onboardingLogo" src="/icons/dark/64.png" alt="Vai">
      <div class="onboarding-welcome-title">Welcome to Vai</div>
      <div class="onboarding-welcome-sub">Explore embeddings, compare text similarity, and search with vector models — all from one playground.</div>
      <div class="onboarding-footer" style="justify-content:center;">
        <button class="onboarding-skip" id="onboardingWelcomeSkip">Skip tour</button>
        <button class="onboarding-next" id="onboardingWelcomeNext">Take the tour →</button>
      </div>
    </div>
  </div>
  <!-- Tooltip for steps 1-4 -->
  <div class="onboarding-tooltip" id="onboardingTooltip">
    <div class="onboarding-tooltip-arrow top" id="onboardingArrow"></div>
    <div class="onboarding-step-icon" id="onboardingIcon"></div>
    <div class="onboarding-step-title" id="onboardingTitle"></div>
    <div class="onboarding-step-body" id="onboardingBody"></div>
    <div class="onboarding-footer">
      <div class="onboarding-dots" id="onboardingDots"></div>
      <div class="onboarding-actions">
        <button class="onboarding-skip" id="onboardingSkip">Skip</button>
        <button class="onboarding-next" id="onboardingNext">Next</button>
      </div>
    </div>
  </div>
</div>

<script>
// Apply saved theme immediately to prevent flash
(function() {
  var t = localStorage.getItem('vai-theme') || 'dark';
  if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
  // Set correct logo immediately
  var logo = document.getElementById('sidebarLogo');
  if (logo) logo.src = '/icons/' + (t === 'light' ? 'light' : 'dark') + '/64.png';
})();
</script>
<script>
(function() {
'use strict';

// ── Theme Toggle ──
function initThemeToggle() {
  const toggle = document.getElementById('themeToggle');
  const saved = localStorage.getItem('vai-theme') || 'dark';
  let current = saved;

  function applyTheme(theme) {
    current = theme;
    const logo = document.getElementById('sidebarLogo');
    if (theme === 'light') {
      document.documentElement.setAttribute('data-theme', 'light');
      toggle.textContent = '☀️';
      toggle.title = 'Switch to dark mode';
      if (logo) logo.src = '/icons/light/64.png';
    } else {
      document.documentElement.removeAttribute('data-theme');
      toggle.textContent = '🌙';
      toggle.title = 'Switch to light mode';
      if (logo) logo.src = '/icons/dark/64.png';
    }
    localStorage.setItem('vai-theme', theme);
  }

  applyTheme(current);
  toggle.addEventListener('click', () => {
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    // Sync settings panel dropdown
    const themeSel = document.getElementById('settingsTheme');
    if (themeSel) themeSel.value = next;
  });
}

// ── State ──
let allModels = [];
let embedModels = [];
let rerankModels = [];
let lastEmbedding = null;

// ── Init ──
async function init() {
  setupTabs();
  await loadConfig();
  await Promise.all([loadModels(), loadConcepts()]);
  populateModelSelects();
  buildExploreCards();
}

// ── Tabs ──
function setupTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tab);
  });
  document.querySelectorAll('.tab-panel').forEach(p => {
    p.classList.toggle('active', p.id === 'tab-' + tab);
  });
}
// Expose globally so Electron main process can call it
window.switchTab = switchTab;

// ── Config ──
async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    const data = await res.json();
    const dot = document.getElementById('statusDot');
    const label = document.getElementById('statusLabel');
    if (data.hasKey) {
      dot.className = 'status-dot connected';
      label.textContent = 'Connected';
    } else {
      dot.className = 'status-dot error';
      label.textContent = 'No API Key';
    }
  } catch {
    document.getElementById('statusDot').className = 'status-dot error';
    document.getElementById('statusLabel').textContent = 'Error';
  }
}

// ── Models ──
async function loadModels() {
  try {
    const res = await fetch('/api/models');
    const data = await res.json();
    allModels = data.models || [];
    embedModels = allModels.filter(m => m.type === 'embedding');
    rerankModels = allModels.filter(m => m.type === 'reranking');
  } catch {
    console.error('Failed to load models');
  }
}

function populateModelSelects() {
  const saved = localStorage.getItem('vai-playground-model');
  const embedSelects = ['globalModel', 'embedModel', 'compareModel', 'searchEmbedModel'];
  embedSelects.forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '';
    embedModels.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name + ' — ' + m.shortFor;
      sel.appendChild(opt);
    });
    if (saved) sel.value = saved;
  });

  const rerankSel = document.getElementById('searchRerankModel');
  rerankSel.innerHTML = '';
  rerankModels.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.name;
    opt.textContent = m.name + ' — ' + m.shortFor;
    rerankSel.appendChild(opt);
  });

  // Sync global model to others
  document.getElementById('globalModel').addEventListener('change', function() {
    const v = this.value;
    localStorage.setItem('vai-playground-model', v);
    ['embedModel', 'compareModel', 'searchEmbedModel'].forEach(id => {
      document.getElementById(id).value = v;
    });
  });
}

// ── API Helpers ──
function formatBytesUI(bytes) {
  if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  if (bytes >= 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return bytes + ' B';
}

async function apiPost(url, body) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || data.detail || 'API error');
  return data;
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = '⚠ ' + msg;
  el.classList.add('visible');
}

function hideError(id) {
  document.getElementById(id).classList.remove('visible');
}

function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if (loading) {
    btn.disabled = true;
    btn._origHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span> Working...';
  } else {
    btn.disabled = false;
    btn.innerHTML = btn._origHTML || btn.innerHTML;
  }
}

// ── Embed ──
window.doEmbed = async function() {
  hideError('embedError');
  const text = document.getElementById('embedInput').value.trim();
  if (!text) { showError('embedError', 'Enter some text to embed'); return; }

  setLoading('embedBtn', true);
  try {
    const model = document.getElementById('embedModel').value;
    const inputType = document.getElementById('embedInputType').value || undefined;
    const dims = document.getElementById('embedDimensions').value;
    const dimensions = dims ? parseInt(dims, 10) : undefined;

    const outputDtype = document.getElementById('embedOutputDtype').value;
    const body = { texts: [text], model, inputType, dimensions };
    if (outputDtype && outputDtype !== 'float') body.output_dtype = outputDtype;

    const data = await apiPost('/api/embed', body);
    const emb = data.data[0].embedding;
    lastEmbedding = emb;

    // Stats
    const dtype = outputDtype || 'float';
    const bytesPerDim = (dtype === 'binary' || dtype === 'ubinary') ? 0.125 : (dtype === 'int8' || dtype === 'uint8') ? 1 : 4;
    const totalBytes = emb.length * bytesPerDim;
    const storageLine = dtype !== 'float'
      ? `<br><span style="color:var(--success)">📦 ${dtype}: ${formatBytesUI(totalBytes)}/vector (${(4 * emb.length / totalBytes).toFixed(0)}× smaller than float)</span>`
      : '';

    const statsEl = document.getElementById('embedStats');
    statsEl.innerHTML = `
      <span class="stat"><span class="stat-label">Model</span><span class="stat-value">${data.model}</span></span>
      <span class="stat"><span class="stat-label">Dimensions</span><span class="stat-value">${emb.length}</span></span>
      <span class="stat"><span class="stat-label">Tokens</span><span class="stat-value">${data.usage?.total_tokens || '—'}</span></span>
      <span class="stat"><span class="stat-label">Type</span><span class="stat-value">${dtype}</span></span>
      ${storageLine}
    `;

    // Vector preview
    const preview = emb.slice(0, 20).map(v => v.toFixed(6)).join(', ');
    document.getElementById('embedVector').textContent = `[${preview}, ... ] (${emb.length} values)`;

    // Heatmap
    buildHeatmap(emb, document.getElementById('embedHeatmap'));

    document.getElementById('embedResult').classList.add('visible');
  } catch (err) {
    showError('embedError', err.message);
  } finally {
    setLoading('embedBtn', false);
  }
};

window.copyVector = function() {
  if (!lastEmbedding) return;
  navigator.clipboard.writeText(JSON.stringify(lastEmbedding)).then(() => {
    const btn = document.querySelector('[onclick="copyVector()"]');
    const orig = btn.textContent;
    btn.textContent = '✅ Copied!';
    setTimeout(() => btn.textContent = orig, 1500);
  });
};

function buildHeatmap(vec, container) {
  container.innerHTML = '';
  // Sample down to ~200 bars for visual
  const step = Math.max(1, Math.floor(vec.length / 200));
  const sampled = [];
  for (let i = 0; i < vec.length; i += step) sampled.push(vec[i]);

  const min = Math.min(...sampled);
  const max = Math.max(...sampled);
  const range = max - min || 1;

  sampled.forEach(v => {
    const bar = document.createElement('div');
    bar.className = 'heatmap-bar';
    const norm = (v - min) / range; // 0-1
    const h = Math.round(norm * 160); // hue: 0=red, 80=yellow-green, 160=cyan/teal
    bar.style.background = `hsl(${h}, 80%, 50%)`;
    container.appendChild(bar);
  });
}

// ── Compare ──
window.doCompare = async function() {
  hideError('compareError');
  const a = document.getElementById('compareA').value.trim();
  const b = document.getElementById('compareB').value.trim();
  if (!a || !b) { showError('compareError', 'Enter text in both fields'); return; }

  setLoading('compareBtn', true);
  try {
    const model = document.getElementById('compareModel').value;
    const dims = document.getElementById('compareDimensions').value;
    const dimensions = dims ? parseInt(dims, 10) : undefined;

    const data = await apiPost('/api/similarity', { texts: [a, b], model, dimensions });

    // Get raw embeddings for all metrics
    const vecA = data.embeddings[0].embedding;
    const vecB = data.embeddings[1].embedding;

    const cosine = cosineSim(vecA, vecB);
    const dot = dotProduct(vecA, vecB);
    const euclid = euclideanDist(vecA, vecB);

    // Hero display — cosine similarity
    const cosinePct = Math.max(0, cosine * 100);
    let cosineColor;
    if (cosine > 0.7) cosineColor = 'var(--green)';
    else if (cosine > 0.4) cosineColor = 'var(--yellow)';
    else cosineColor = 'var(--red)';

    const scoreEl = document.getElementById('simScore');
    scoreEl.textContent = cosine.toFixed(4);
    scoreEl.style.color = cosineColor;

    const barEl = document.getElementById('simBar');
    barEl.style.width = cosinePct + '%';
    barEl.style.background = cosineColor;

    // Metric cards — all three
    const dotColor = dot > 0.7 ? 'var(--green)' : dot > 0.4 ? 'var(--yellow)' : 'var(--red)';
    // Euclidean: 0 = identical, ~2 = max for normalized vectors. Invert for color.
    const euclidColor = euclid < 0.6 ? 'var(--green)' : euclid < 1.0 ? 'var(--yellow)' : 'var(--red)';
    // For euclidean bar, invert: 0 dist = 100% bar, 2.0 dist = 0%
    const euclidPct = Math.max(0, Math.min(100, (1 - euclid / 2) * 100));

    const metricsEl = document.getElementById('metricsGrid');
    metricsEl.innerHTML = `
      <div class="metric-card primary">
        <div class="metric-card-value" style="color:${cosineColor}">${cosine.toFixed(4)}</div>
        <div class="metric-card-name">Cosine Similarity</div>
        <div class="metric-card-desc">Angle between vectors (−1 to 1). Standard for semantic search.</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${cosinePct}%;background:${cosineColor}"></div></div>
      </div>
      <div class="metric-card">
        <div class="metric-card-value" style="color:${dotColor}">${dot.toFixed(4)}</div>
        <div class="metric-card-name">Dot Product</div>
        <div class="metric-card-desc">Sum of element-wise products. Equals cosine for normalized vectors.</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${Math.max(0, dot * 100)}%;background:${dotColor}"></div></div>
      </div>
      <div class="metric-card">
        <div class="metric-card-value" style="color:${euclidColor}">${euclid.toFixed(4)}</div>
        <div class="metric-card-name">Euclidean Distance</div>
        <div class="metric-card-desc">Straight-line distance (0 = identical). Lower is more similar.</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${euclidPct}%;background:${euclidColor}"></div></div>
      </div>
    `;

    // Insight note
    const noteEl = document.getElementById('metricNote');
    const diff = Math.abs(cosine - dot);
    if (diff < 0.001) {
      noteEl.innerHTML = '💡 <strong>Cosine ≈ Dot Product</strong> — these vectors are L2-normalized (as Voyage AI models produce), so cosine similarity and dot product give identical results. Euclidean distance is <code>√(2 − 2·cosine)</code> for normalized vectors.';
    } else {
      noteEl.innerHTML = '💡 Cosine and dot product differ because these vectors are not perfectly L2-normalized. Atlas Vector Search uses cosine by default.';
    }

    // Stats
    const statsEl = document.getElementById('compareStats');
    statsEl.innerHTML = `
      <span class="stat"><span class="stat-label">Model</span><span class="stat-value">${data.model}</span></span>
      <span class="stat"><span class="stat-label">Dimensions</span><span class="stat-value">${vecA.length}</span></span>
      <span class="stat"><span class="stat-label">Tokens</span><span class="stat-value">${data.usage?.total_tokens || '—'}</span></span>
    `;

    document.getElementById('compareResult').classList.add('visible');
  } catch (err) {
    showError('compareError', err.message);
  } finally {
    setLoading('compareBtn', false);
  }
};

// ── Search ──
window.doSearch = async function(withRerank) {
  hideError('searchError');
  const query = document.getElementById('searchQuery').value.trim();
  const docsText = document.getElementById('searchDocs').value.trim();
  if (!query || !docsText) { showError('searchError', 'Enter a query and documents'); return; }

  const documents = docsText.split('\n').map(d => d.trim()).filter(d => d);
  if (documents.length < 2) { showError('searchError', 'Enter at least 2 documents'); return; }

  const btnId = withRerank ? 'searchRerankBtn' : 'searchBtn';
  setLoading('searchBtn', true);
  setLoading('searchRerankBtn', true);

  try {
    const embedModel = document.getElementById('searchEmbedModel').value;
    const topK = parseInt(document.getElementById('searchTopK').value, 10);

    // Embed query + docs
    const allTexts = [query, ...documents];
    const embedData = await apiPost('/api/embed', { texts: allTexts, model: embedModel });
    const vecs = embedData.data.map(d => d.embedding);
    const queryVec = vecs[0];
    const docVecs = vecs.slice(1);

    // Compute similarity
    const scores = docVecs.map((dv, i) => ({
      index: i,
      text: documents[i],
      score: cosineSim(queryVec, dv),
    }));
    scores.sort((a, b) => b.score - a.score);
    const embeddingResults = scores.slice(0, topK);

    let rerankResults = null;
    if (withRerank) {
      const rerankModel = document.getElementById('searchRerankModel').value;
      const rerankData = await apiPost('/api/rerank', { query, documents, model: rerankModel, topK });
      rerankResults = rerankData.data.map(r => ({
        index: r.index,
        text: documents[r.index],
        score: r.relevance_score,
      }));
    }

    renderSearchResults(embeddingResults, rerankResults);
    document.getElementById('searchResult').classList.add('visible');
  } catch (err) {
    showError('searchError', err.message);
  } finally {
    setLoading('searchBtn', false);
    setLoading('searchRerankBtn', false);
  }
};

function cosineSim(a, b) {
  let dot = 0, normA = 0, normB = 0;
  for (let i = 0; i < a.length; i++) {
    dot += a[i] * b[i];
    normA += a[i] * a[i];
    normB += b[i] * b[i];
  }
  return dot / (Math.sqrt(normA) * Math.sqrt(normB));
}

function dotProduct(a, b) {
  let sum = 0;
  for (let i = 0; i < a.length; i++) sum += a[i] * b[i];
  return sum;
}

function euclideanDist(a, b) {
  let sum = 0;
  for (let i = 0; i < a.length; i++) sum += (a[i] - b[i]) ** 2;
  return Math.sqrt(sum);
}

function renderSearchResults(embResults, rerankResults) {
  const grid = document.getElementById('searchResultGrid');
  grid.innerHTML = '';
  grid.className = rerankResults ? 'search-results' : 'search-results single-col';

  const maxEmbScore = Math.max(...embResults.map(r => r.score));

  // Embedding column
  const embCol = document.createElement('div');
  embCol.innerHTML = '<div class="card-title">Embedding Search</div>';
  embResults.forEach((r, i) => {
    embCol.appendChild(createResultItem(i + 1, r, maxEmbScore));
  });
  grid.appendChild(embCol);

  // Rerank column
  if (rerankResults) {
    const maxRerankScore = Math.max(...rerankResults.map(r => r.score));
    const embRankMap = {};
    embResults.forEach((r, i) => { embRankMap[r.index] = i + 1; });

    const rerankCol = document.createElement('div');
    rerankCol.innerHTML = '<div class="card-title">After Reranking</div>';
    rerankResults.forEach((r, i) => {
      const newRank = i + 1;
      const oldRank = embRankMap[r.index];
      const movement = oldRank !== undefined ? oldRank - newRank : 0;
      rerankCol.appendChild(createResultItem(newRank, r, maxRerankScore, movement));
    });
    grid.appendChild(rerankCol);
  }
}

function createResultItem(rank, result, maxScore, movement) {
  const item = document.createElement('div');
  let moveClass = '';
  if (movement > 0) moveClass = ' moved-up';
  else if (movement < 0) moveClass = ' moved-down';

  const pct = maxScore > 0 ? (result.score / maxScore * 100) : 0;
  const truncText = result.text.length > 80 ? result.text.slice(0, 77) + '...' : result.text;
  let moveHTML = '';
  if (movement !== undefined && movement !== 0) {
    const arrow = movement > 0 ? '↑' : '↓';
    const color = movement > 0 ? 'var(--green)' : 'var(--red)';
    moveHTML = `<div class="result-movement" style="color:${color}">${arrow}${Math.abs(movement)}</div>`;
  }

  item.className = 'result-item' + moveClass;
  item.innerHTML = `
    <div class="result-rank">#${rank}</div>
    <div class="result-body">
      <div class="result-text" title="${result.text.replace(/"/g, '&quot;')}">${truncText}</div>
      <div class="result-score-bar"><div class="result-score-fill" style="width:${pct}%"></div></div>
      <div class="result-score-text">${result.score.toFixed(4)}</div>
      ${moveHTML}
    </div>
  `;
  return item;
}

// ── Explore ──
// ── Explore: icons and tab mappings per concept ──
const CONCEPT_META = {
  embeddings:          { icon: '🧮', tab: 'embed' },
  reranking:           { icon: '🏆', tab: 'search' },
  'vector-search':     { icon: '🔎', tab: 'search' },
  rag:                 { icon: '🤖', tab: 'search' },
  'cosine-similarity': { icon: '📐', tab: 'compare' },
  'two-stage-retrieval': { icon: '🎯', tab: 'search' },
  'input-type':        { icon: '🏷️', tab: 'embed' },
  models:              { icon: '🧠', tab: 'embed' },
  'api-keys':          { icon: '🔑', tab: 'embed' },
  'api-access':        { icon: '🌐', tab: 'embed' },
  'batch-processing':  { icon: '📦', tab: 'embed' },
  benchmarking:        { icon: '⏱', tab: 'benchmark' },
  quantization:        { icon: '⚗️', tab: 'benchmark' },
  'mixture-of-experts': { icon: '🧩', tab: 'embed' },
  'shared-embedding-space': { icon: '🔗', tab: 'compare' },
  'rteb-benchmarks':   { icon: '📊', tab: 'benchmark' },
  'voyage-4-nano':     { icon: '🔬', tab: 'embed' },
  'rerank-eval':       { icon: '📐', tab: 'benchmark' },
  'multimodal-embeddings': { icon: '🖼️', tab: 'multimodal' },
  'cross-modal-search':    { icon: '🔀', tab: 'multimodal' },
  'modality-gap':          { icon: '🕳️', tab: 'multimodal' },
  'multimodal-rag':        { icon: '📄', tab: 'multimodal' },
};

let exploreConcepts = {};

async function loadConcepts() {
  try {
    const res = await fetch('/api/concepts');
    const data = await res.json();
    exploreConcepts = data.concepts || {};
  } catch {
    console.error('Failed to load concepts');
  }
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function buildExploreCards() {
  const grid = document.getElementById('exploreGrid');
  grid.innerHTML = '';

  for (const [key, concept] of Object.entries(exploreConcepts)) {
    const meta = CONCEPT_META[key] || { icon: '📚', tab: 'embed' };
    const card = document.createElement('div');
    card.className = 'explore-card';
    card.dataset.key = key;

    card.innerHTML = `
      <div class="explore-card-icon">${meta.icon}</div>
      <div class="explore-card-title">${escapeHtml(concept.title)}</div>
      <div class="explore-card-summary">${escapeHtml(concept.summary)}</div>
    `;
    card.addEventListener('click', () => openExploreModal(key));
    grid.appendChild(card);
  }

  // Modal close handlers
  const modal = document.getElementById('exploreModal');
  document.getElementById('exploreModalClose').addEventListener('click', closeExploreModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeExploreModal(); });
}

function openExploreModal(key) {
  const concept = exploreConcepts[key];
  if (!concept) return;
  const meta = CONCEPT_META[key] || { icon: '📚', tab: 'embed' };

  document.getElementById('exploreModalIcon').textContent = meta.icon;
  document.getElementById('exploreModalTitle').textContent = concept.title;
  document.getElementById('exploreModalSummary').textContent = concept.summary;

  // Build body: content + links + tryIt
  let bodyHtml = escapeHtml(concept.content);

  if (concept.links && concept.links.length > 0) {
    bodyHtml += '<div class="explore-modal-links">' +
      '<div class="explore-modal-links-title">Learn More</div>' +
      concept.links.map(url =>
        `<a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a>`
      ).join('') + '</div>';
  }

  if (concept.tryIt && concept.tryIt.length > 0) {
    bodyHtml += '<div class="explore-modal-tryit">' +
      '<div class="explore-modal-tryit-title">Try It</div>' +
      concept.tryIt.map(cmd =>
        `<div class="explore-modal-tryit-cmd">$ ${escapeHtml(cmd)}</div>`
      ).join('') + '</div>';
  }

  document.getElementById('exploreModalBody').innerHTML = bodyHtml;

  // Actions
  const actionsEl = document.getElementById('exploreModalActions');
  actionsEl.innerHTML = `<button class="btn btn-small" id="exploreModalTry">Try it in playground →</button>`;
  actionsEl.querySelector('#exploreModalTry').addEventListener('click', () => {
    closeExploreModal();
    if (meta.tab) switchTab(meta.tab);
  });

  document.getElementById('exploreModal').classList.add('open');
}

function closeExploreModal() {
  document.getElementById('exploreModal').classList.remove('open');
}

window.tryTopic = function(key) {
  const meta = CONCEPT_META[key];
  if (meta) switchTab(meta.tab);
};

window.filterExplore = function() {
  const q = document.getElementById('exploreSearch').value.toLowerCase().trim();
  document.querySelectorAll('#exploreGrid .explore-card').forEach(card => {
    if (!q) { card.style.display = ''; return; }
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(q) ? '' : 'none';
  });
};

// ── Benchmark: Sub-panel switching ──
document.querySelectorAll('.bench-panel-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.bench-panel-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.bench-view').forEach(v => v.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('bench-' + btn.dataset.bench).classList.add('active');
  });
});

// ── Benchmark: Model checkboxes ──
function buildModelCheckboxes() {
  const container = document.getElementById('benchModelChecks');
  container.innerHTML = '';
  const defaults = ['voyage-4-large', 'voyage-4', 'voyage-4-lite'];
  embedModels.forEach(m => {
    const label = document.createElement('label');
    label.style.cssText = 'display:flex;align-items:center;gap:4px;font-size:13px;cursor:pointer;color:var(--text);';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = m.name;
    cb.checked = defaults.includes(m.name);
    cb.style.accentColor = 'var(--accent)';
    label.appendChild(cb);
    label.appendChild(document.createTextNode(m.name));
    container.appendChild(label);
  });
}

function populateBenchRankSelects() {
  const selA = document.getElementById('benchRankModelA');
  const selB = document.getElementById('benchRankModelB');
  [selA, selB].forEach(sel => {
    sel.innerHTML = '';
    [...embedModels, ...rerankModels].forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.name;
      opt.textContent = m.name;
      sel.appendChild(opt);
    });
  });
  // Sensible defaults
  if (embedModels.length >= 2) {
    selA.value = embedModels[0].name;
    selB.value = embedModels[embedModels.length > 2 ? 2 : 1].name;
  }
}

// ── Benchmark: Latency ──
const BENCH_SAMPLE_TEXTS = [
  'MongoDB Atlas provides a fully managed cloud database service with built-in vector search capabilities.',
  'Kubernetes orchestrates containerized applications across clusters of machines for high availability.',
  'Machine learning models transform raw data into embeddings that capture semantic meaning.',
  'RESTful APIs use HTTP methods like GET, POST, PUT, and DELETE to manage resources.',
  'Natural language processing enables computers to understand and generate human language.',
];

const MODEL_COLORS = [
  '#00ED64', '#71F6BA', '#0498EC', '#B45AF2', '#FFC010',
  '#FF6960', '#B45AF2', '#FFC010', '#016BF8', '#C0FAE6',
];

window.doBenchLatency = async function() {
  hideError('benchLatencyError');
  const checks = document.querySelectorAll('#benchModelChecks input:checked');
  const models = Array.from(checks).map(c => c.value);
  if (models.length === 0) { showError('benchLatencyError', 'Select at least one model'); return; }

  const rounds = parseInt(document.getElementById('benchRounds').value, 10);
  const customText = document.getElementById('benchLatencyInput').value.trim();
  const texts = customText ? [customText] : BENCH_SAMPLE_TEXTS;

  setLoading('benchLatencyBtn', true);
  document.getElementById('benchLatencyResult').classList.add('visible');

  const chart = document.getElementById('benchLatencyChart');
  const statsEl = document.getElementById('benchLatencyStats');

  // Build placeholder bars
  chart.innerHTML = '';
  models.forEach((model, i) => {
    const row = document.createElement('div');
    row.className = 'latency-row';
    row.innerHTML = `
      <span class="latency-model">${model}</span>
      <div class="latency-bar-outer">
        <div class="latency-bar-inner running" id="bench-bar-${i}" style="background:${MODEL_COLORS[i % MODEL_COLORS.length]}"></div>
      </div>
      <span class="latency-stats" id="bench-stats-${i}">Running...</span>
      <span class="latency-badge" id="bench-badge-${i}"></span>
    `;
    chart.appendChild(row);
  });
  statsEl.innerHTML = `<span class="stat"><span class="stat-label">Texts</span><span class="stat-value">${texts.length}</span></span>
    <span class="stat"><span class="stat-label">Rounds</span><span class="stat-value">${rounds}</span></span>`;

  const results = [];

  for (let mi = 0; mi < models.length; mi++) {
    const model = models[mi];
    const latencies = [];
    let tokens = 0, dims = 0;

    for (let r = 0; r < rounds; r++) {
      try {
        const data = await apiPost('/api/benchmark/embed', { texts, model, inputType: 'document' });
        latencies.push(data.elapsed);
        tokens = data.tokens;
        dims = data.dimensions;
      } catch (err) {
        document.getElementById(`bench-stats-${mi}`).textContent = 'Error';
        document.getElementById(`bench-bar-${mi}`).classList.remove('running');
        document.getElementById(`bench-bar-${mi}`).style.width = '0%';
        break;
      }
    }

    if (latencies.length > 0) {
      const avg = latencies.reduce((a, b) => a + b, 0) / latencies.length;
      const sorted = [...latencies].sort((a, b) => a - b);
      const p50 = sorted[Math.floor(sorted.length / 2)];
      results.push({ model, avg, p50, min: sorted[0], max: sorted[sorted.length - 1], tokens, dims, idx: mi });
    }
  }

  // Animate bars to final widths
  if (results.length > 0) {
    const maxAvg = Math.max(...results.map(r => r.avg));
    const minAvg = Math.min(...results.map(r => r.avg));

    results.forEach(r => {
      const bar = document.getElementById(`bench-bar-${r.idx}`);
      const stats = document.getElementById(`bench-stats-${r.idx}`);
      const badge = document.getElementById(`bench-badge-${r.idx}`);
      bar.classList.remove('running');
      const pct = Math.max(15, (r.avg / maxAvg) * 100);
      bar.style.width = pct + '%';
      bar.textContent = r.avg.toFixed(0) + 'ms';
      stats.textContent = `p50: ${r.p50.toFixed(0)}ms`;
      stats.title = `min: ${r.min.toFixed(0)}ms, max: ${r.max.toFixed(0)}ms`;
      if (r.avg === minAvg) badge.textContent = '⚡';
    });

    // Update stats
    const fastest = results.reduce((a, b) => a.avg < b.avg ? a : b);
    const price = getModelPrice(fastest.model);
    statsEl.innerHTML += `
      <span class="stat"><span class="stat-label">Fastest</span><span class="stat-value">${fastest.model}</span></span>
      <span class="stat"><span class="stat-label">Avg</span><span class="stat-value">${fastest.avg.toFixed(0)}ms</span></span>
      <span class="stat"><span class="stat-label">Dims</span><span class="stat-value">${fastest.dims}</span></span>
      ${price ? `<span class="stat"><span class="stat-label">Price</span><span class="stat-value">${price}</span></span>` : ''}
    `;

    // Save to history
    saveBenchHistory(results, texts.length, rounds);
    renderHistory();
  }

  setLoading('benchLatencyBtn', false);
};

function getModelPrice(name) {
  const m = allModels.find(m => m.name === name);
  return m ? m.price : null;
}

function getModelPriceNum(name) {
  const m = allModels.find(m => m.name === name);
  if (!m) return null;
  const match = m.price.match(/\$([0-9.]+)\/1M/);
  return match ? parseFloat(match[1]) : null;
}

// ── Benchmark: Ranking Comparison ──
window.doBenchRanking = async function() {
  hideError('benchRankError');
  const query = document.getElementById('benchRankQuery').value.trim();
  const docsText = document.getElementById('benchRankDocs').value.trim();
  if (!query || !docsText) { showError('benchRankError', 'Enter a query and documents'); return; }

  const documents = docsText.split('\n').map(d => d.trim()).filter(Boolean);
  if (documents.length < 2) { showError('benchRankError', 'Enter at least 2 documents'); return; }

  const modelA = document.getElementById('benchRankModelA').value;
  const modelB = document.getElementById('benchRankModelB').value;
  const mode = document.getElementById('benchRankMode').value;
  const topK = parseInt(document.getElementById('benchRankTopK').value, 10);

  setLoading('benchRankBtn', true);

  try {
    let rankedA, rankedB;

    if (mode === 'embed') {
      // Embedding similarity mode
      const [dataA, dataB] = await Promise.all([
        apiPost('/api/benchmark/embed', { texts: [query, ...documents], model: modelA, inputType: 'document' }),
        apiPost('/api/benchmark/embed', { texts: [query, ...documents], model: modelB, inputType: 'document' }),
      ]);

      rankedA = rankBySimilarity(dataA.embeddings, documents, topK);
      rankedB = rankBySimilarity(dataB.embeddings, documents, topK);
    } else {
      // Rerank mode
      const [dataA, dataB] = await Promise.all([
        apiPost('/api/benchmark/rerank', { query, documents, model: modelA, topK }),
        apiPost('/api/benchmark/rerank', { query, documents, model: modelB, topK }),
      ]);

      rankedA = dataA.results.slice(0, topK).map(r => ({
        index: r.index,
        text: documents[r.index],
        score: r.relevance_score,
      }));
      rankedB = dataB.results.slice(0, topK).map(r => ({
        index: r.index,
        text: documents[r.index],
        score: r.relevance_score,
      }));
    }

    // Render comparison
    renderRankComparison(modelA, modelB, rankedA, rankedB, topK);
    document.getElementById('benchRankResult').classList.add('visible');
  } catch (err) {
    showError('benchRankError', err.message);
  } finally {
    setLoading('benchRankBtn', false);
  }
};

function rankBySimilarity(embeddings, documents, topK) {
  const queryVec = embeddings[0];
  const docVecs = embeddings.slice(1);
  const scores = docVecs.map((dv, i) => ({
    index: i,
    text: documents[i],
    score: cosineSim(queryVec, dv),
  }));
  scores.sort((a, b) => b.score - a.score);
  return scores.slice(0, topK);
}

function renderRankComparison(modelA, modelB, rankedA, rankedB, topK) {
  const grid = document.getElementById('benchRankGrid');
  const verdict = document.getElementById('benchRankVerdict');
  grid.innerHTML = '';

  // Header
  const header = document.createElement('div');
  header.className = 'rank-row';
  header.style.background = 'none';
  header.style.fontWeight = '600';
  header.style.fontSize = '13px';
  header.style.color = 'var(--accent)';
  header.innerHTML = `<div></div><div>${modelA}</div><div></div><div>${modelB}</div>`;
  grid.appendChild(header);

  const orderA = rankedA.map(r => r.index);
  const orderB = rankedB.map(r => r.index);
  let matches = 0;

  const k = Math.min(topK, rankedA.length, rankedB.length);
  for (let i = 0; i < k; i++) {
    const a = rankedA[i];
    const b = rankedB[i];
    const same = a.index === b.index;
    if (same) matches++;

    const truncA = a.text.length > 60 ? a.text.slice(0, 57) + '...' : a.text;
    const truncB = b.text.length > 60 ? b.text.slice(0, 57) + '...' : b.text;

    const row = document.createElement('div');
    row.className = 'rank-row';
    row.innerHTML = `
      <div class="rank-num">${i + 1}</div>
      <div class="rank-item ${same ? 'rank-match' : 'rank-differ'}">
        <div title="${a.text.replace(/"/g, '&quot;')}">${truncA}</div>
        <div class="rank-score">${a.score.toFixed(4)} [doc ${a.index}]</div>
      </div>
      <div class="rank-arrow">${same ? '=' : '≠'}</div>
      <div class="rank-item ${same ? 'rank-match' : 'rank-differ'}">
        <div title="${b.text.replace(/"/g, '&quot;')}">${truncB}</div>
        <div class="rank-score">${b.score.toFixed(4)} [doc ${b.index}]</div>
      </div>
    `;
    grid.appendChild(row);
  }

  // Compute overlap
  const setA = new Set(orderA.slice(0, k));
  const setB = new Set(orderB.slice(0, k));
  const overlap = [...setA].filter(x => setB.has(x)).length;
  const overlapPct = ((overlap / k) * 100).toFixed(0);
  const agreePct = ((matches / k) * 100).toFixed(0);

  if (matches === k) {
    verdict.innerHTML = `<span style="color:var(--green)">✓ Models agree on all ${k} positions — the cheaper model is likely sufficient.</span>`;
  } else if (overlap === k) {
    verdict.innerHTML = `<span style="color:var(--yellow)">⚠ Same ${k} documents in top-${k}, but in different order (${agreePct}% exact match).</span>`;
  } else {
    verdict.innerHTML = `<span style="color:var(--warning)">⚠ ${overlapPct}% overlap in top-${k} results — models see different relevance signals.</span>`;
  }
}

// ── Benchmark: Quantization ──
function populateQuantModelSelect() {
  const sel = document.getElementById('quantModel');
  sel.innerHTML = '';
  embedModels.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.name;
    opt.textContent = m.name;
    sel.appendChild(opt);
  });
  // Default to voyage-4-large if available
  const preferred = embedModels.find(m => m.name === 'voyage-4-large');
  if (preferred) sel.value = preferred.name;
}

function hammingSimUI(a, b) {
  // For binary/ubinary packed embeddings, compute agreement via dot product
  let dot = 0;
  for (let i = 0; i < a.length; i++) dot += a[i] * b[i];
  return dot;
}

window.doBenchQuantization = async function() {
  hideError('quantError');
  const model = document.getElementById('quantModel').value;
  const dimsVal = document.getElementById('quantDimensions').value;
  const dimensions = dimsVal ? parseInt(dimsVal, 10) : undefined;
  const query = document.getElementById('quantQuery').value.trim();
  const corpusText = document.getElementById('quantCorpus').value.trim();

  if (!query) { showError('quantError', 'Enter a query'); return; }
  if (!corpusText) { showError('quantError', 'Enter at least 2 documents'); return; }

  const corpus = corpusText.split('\n').map(d => d.trim()).filter(Boolean);
  if (corpus.length < 2) { showError('quantError', 'Enter at least 2 documents'); return; }

  const checks = document.querySelectorAll('#quantDtypeChecks input:checked');
  const dtypes = Array.from(checks).map(c => c.value);
  if (dtypes.length === 0) { showError('quantError', 'Select at least one data type'); return; }

  setLoading('quantBtn', true);

  try {
    const allTexts = [query, ...corpus];
    const resultsByDtype = {};

    for (const dtype of dtypes) {
      const body = { texts: allTexts, model, inputType: 'document' };
      if (dimensions) body.dimensions = dimensions;
      if (dtype !== 'float') body.output_dtype = dtype;

      const start = performance.now();
      const data = await apiPost('/api/embed', body);
      const elapsed = performance.now() - start;

      const embeddings = data.data.map(d => d.embedding);
      const queryEmbed = embeddings[0];
      const dims = embeddings[0].length;
      const isBinary = (dtype === 'binary' || dtype === 'ubinary');

      // Rank corpus documents by similarity
      const ranked = corpus.map((text, i) => {
        const docEmbed = embeddings[i + 1];
        let sim;
        if (isBinary) {
          sim = hammingSimUI(queryEmbed, docEmbed);
        } else {
          sim = cosineSim(queryEmbed, docEmbed);
        }
        return { index: i, text, similarity: sim };
      }).sort((a, b) => b.similarity - a.similarity);

      // Calculate storage
      const actualDims = isBinary ? dims * 8 : dims;
      let bytesPerVec;
      if (dtype === 'float') bytesPerVec = dims * 4;
      else if (dtype === 'int8' || dtype === 'uint8') bytesPerVec = dims * 1;
      else bytesPerVec = dims; // binary/ubinary: dims is already 1/8th

      resultsByDtype[dtype] = {
        dtype, latency: elapsed, dims, actualDims, bytesPerVec,
        tokens: data.usage?.total_tokens || 0, ranked,
      };
    }

    const completed = Object.values(resultsByDtype);
    if (completed.length === 0) {
      showError('quantError', 'No data types completed successfully');
      return;
    }

    // ── Render Charts ──
    const baseline = completed.find(r => r.dtype === 'float') || completed[0];
    const maxBytes = Math.max(...completed.map(r => r.bytesPerVec));
    const maxLatency = Math.max(...completed.map(r => r.latency));
    const DTYPE_COLORS = { float: '#00ED64', int8: '#71F6BA', uint8: '#0498EC', ubinary: '#FFC010', binary: '#FF6960' };

    // ── Storage Bar Chart ──
    let storageHTML = '';
    for (const r of completed) {
      const pct = Math.max(8, (r.bytesPerVec / maxBytes) * 100);
      const totalMB = (r.bytesPerVec * 1_000_000) / (1024 * 1024);
      const sizeStr = totalMB >= 1024 ? `${(totalMB / 1024).toFixed(1)} GB` : `${totalMB.toFixed(0)} MB`;
      const savings = r.bytesPerVec < baseline.bytesPerVec
        ? `${(baseline.bytesPerVec / r.bytesPerVec).toFixed(0)}× smaller`
        : 'baseline';
      const color = DTYPE_COLORS[r.dtype] || '#0498EC';
      storageHTML += `<div class="quant-bar-group">
        <div class="quant-bar-label">
          <span class="dtype-name">${r.dtype}</span>
          <span class="dtype-value">${formatBytesUI(r.bytesPerVec)}/vec · ${sizeStr} @ 1M</span>
        </div>
        <div class="quant-bar-track">
          <div class="quant-bar-fill storage" style="width:${pct}%;background:linear-gradient(90deg, ${color}, ${color}cc);">${savings}</div>
        </div>
      </div>`;
    }
    document.getElementById('quantStorageChart').innerHTML = storageHTML;

    // ── Latency Bar Chart ──
    let latencyHTML = '';
    const minLatency = Math.min(...completed.map(r => r.latency));
    for (const r of completed) {
      const pct = Math.max(8, (r.latency / maxLatency) * 100);
      const color = DTYPE_COLORS[r.dtype] || '#0498EC';
      const badge = r.latency === minLatency ? ' ⚡' : '';
      latencyHTML += `<div class="quant-bar-group">
        <div class="quant-bar-label">
          <span class="dtype-name">${r.dtype}</span>
          <span class="dtype-value">${r.latency.toFixed(0)}ms${badge}</span>
        </div>
        <div class="quant-bar-track">
          <div class="quant-bar-fill latency" style="width:${pct}%;background:linear-gradient(90deg, ${color}, ${color}cc);">${r.latency.toFixed(0)}ms</div>
        </div>
      </div>`;
    }
    document.getElementById('quantLatencyChart').innerHTML = latencyHTML;

    // ── Quality Meters + Ranking Grid ──
    const topK = Math.min(5, corpus.length);
    const metersEl = document.getElementById('quantQualityMeters');
    const gridEl = document.getElementById('quantRankGrid');
    gridEl.innerHTML = '';
    metersEl.innerHTML = '';

    if (completed.length >= 2 && baseline) {
      const baselineRanking = baseline.ranked.slice(0, topK).map(r => r.index);

      // Quality meters for each non-baseline dtype
      let metersHTML = '';
      for (const r of completed) {
        if (r.dtype === baseline.dtype) continue;
        const otherRanking = r.ranked.slice(0, topK).map(x => x.index);
        const overlap = baselineRanking.filter(idx => otherRanking.includes(idx)).length;
        const overlapPct = (overlap / topK) * 100;
        const exactMatch = baselineRanking.every((idx, pos) => otherRanking[pos] === idx);
        const positionMatches = baselineRanking.filter((idx, pos) => otherRanking[pos] === idx).length;
        const posMatchPct = (positionMatches / topK) * 100;

        let grade, gradeLabel, detail;
        if (exactMatch) {
          grade = 'perfect'; gradeLabel = '✓ Perfect';
          detail = `Identical ranking — all ${topK} positions match float baseline`;
        } else if (overlap === topK) {
          grade = 'good'; gradeLabel = '≈ Reordered';
          detail = `Same ${topK} documents, ${positionMatches}/${topK} in same position`;
        } else {
          grade = overlap >= topK * 0.6 ? 'good' : 'degraded';
          gradeLabel = `${overlapPct.toFixed(0)}% overlap`;
          detail = `${overlap}/${topK} documents match, ${positionMatches}/${topK} positions match`;
        }

        metersHTML += `<div class="quant-quality-meter">
          <div class="quant-meter-header">
            <span class="dtype-name">${r.dtype}</span>
            <span class="verdict-badge ${grade}">${gradeLabel}</span>
          </div>
          <div class="quant-meter-track">
            <div class="quant-meter-fill ${grade}" style="width:${exactMatch ? 100 : posMatchPct}%"></div>
          </div>
          <div class="quant-meter-detail">${detail}</div>
        </div>`;
      }
      metersEl.innerHTML = metersHTML;

      // Side-by-side ranking columns
      let rankHTML = `<div class="quant-rank-cols" style="grid-template-columns:repeat(${completed.length},1fr);">`;
      for (const r of completed) {
        rankHTML += `<div><div class="quant-rank-col-header">${r.dtype}${r === baseline ? ' (baseline)' : ''}</div>`;
        r.ranked.slice(0, topK).forEach((item, pos) => {
          const trunc = item.text.length > 55 ? item.text.slice(0, 52) + '…' : item.text;
          let cls = 'baseline';
          if (r !== baseline) {
            cls = (baseline.ranked[pos] && item.index === baseline.ranked[pos].index) ? 'match' : 'differ';
          }
          rankHTML += `<div class="quant-rank-item ${cls}" title="${item.text.replace(/"/g, '&quot;')}">
            <span class="quant-rank-pos">${pos + 1}</span>${trunc}
            <div class="quant-rank-score">${item.similarity.toFixed(4)} · doc ${item.index}</div>
          </div>`;
        });
        rankHTML += '</div>';
      }
      rankHTML += '</div>';
      gridEl.innerHTML = rankHTML;
    } else {
      metersEl.innerHTML = '<span style="color:var(--text-dim)">Select multiple data types (including float) to compare rankings.</span>';
    }

    document.getElementById('quantResult').classList.add('visible');
  } catch (err) {
    showError('quantError', err.message);
  } finally {
    setLoading('quantBtn', false);
  }
};

// ── Benchmark: Cost Calculator ──
// ── Cost Calculator: Shared Helpers ──

function costFormatDollars(n) {
  if (n === 0) return '$0.00';
  if (n < 0.01 && n > 0) return '$' + n.toFixed(4);
  if (n < 1) return '$' + n.toFixed(2);
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function costShortNum(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(n % 1e9 === 0 ? 0 : 1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(n % 1e6 === 0 ? 0 : 1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(n % 1e3 === 0 ? 0 : 1) + 'K';
  return String(n);
}

function costGetPricePerM(model) {
  const match = model.price.match(/\$([0-9.]+)\/1M/);
  return match ? parseFloat(match[1]) : null;
}

function costGetV4Models() {
  return allModels.filter(m => !m.legacy && !m.unreleased && costGetPricePerM(m) !== null);
}

// ── Cost Mode Toggle ──

let currentCostMode = 'simple';

function setCostMode(mode) {
  currentCostMode = mode;
  document.querySelectorAll('.cost-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
  document.getElementById('costSimpleMode').style.display = mode === 'simple' ? '' : 'none';
  document.getElementById('costRagMode').style.display = mode === 'rag' ? '' : 'none';
  if (mode === 'rag') updateRagCalculator();
}

// ── Simple Mode (query-only comparison) ──

function initCostCalculator() {
  // Mode toggle buttons
  document.getElementById('costModeSimple').addEventListener('click', () => setCostMode('simple'));
  document.getElementById('costModeRag').addEventListener('click', () => setCostMode('rag'));

  // Help modal
  const helpModal = document.getElementById('costHelpModal');
  document.getElementById('costHelpBtn').addEventListener('click', () => helpModal.classList.add('open'));
  document.getElementById('costHelpClose').addEventListener('click', () => helpModal.classList.remove('open'));
  helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.classList.remove('open'); });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      helpModal.classList.remove('open');
      closeExploreModal();
    }
  });

  // Simple mode sliders
  const tokSlider = document.getElementById('costTokens');
  const qSlider = document.getElementById('costQueries');
  const tokValue = document.getElementById('costTokensValue');
  const qValue = document.getElementById('costQueriesValue');

  function updateCost() {
    const tokens = parseInt(tokSlider.value, 10);
    const queries = parseInt(qSlider.value, 10);
    tokValue.textContent = tokens.toLocaleString();
    qValue.textContent = queries.toLocaleString();
    renderCostTable(tokens, queries);
  }

  tokSlider.addEventListener('input', updateCost);
  qSlider.addEventListener('input', updateCost);
  updateCost();

  // RAG mode init
  initRagCalculator();
}

function renderCostTable(tokensPerQuery, queriesPerDay) {
  const tbody = document.getElementById('costTableBody');
  tbody.innerHTML = '';

  const models = allModels.filter(m => !m.legacy && !m.unreleased);
  const rows = [];

  models.forEach(m => {
    const pricePerM = costGetPricePerM(m);
    if (pricePerM === null) return;
    const dailyTokens = tokensPerQuery * queriesPerDay;
    const dailyCost = (dailyTokens / 1_000_000) * pricePerM;
    const monthlyCost = dailyCost * 30;
    rows.push({ name: m.name, type: m.type === 'embedding' ? 'embed' : 'rerank', pricePerM, dailyCost, monthlyCost });
  });

  rows.sort((a, b) => a.monthlyCost - b.monthlyCost);
  const maxMonthly = Math.max(...rows.map(r => r.monthlyCost), 0.01);

  rows.forEach(r => {
    const tr = document.createElement('tr');
    const barPct = Math.max(2, (r.monthlyCost / maxMonthly) * 100);
    const monthlyStr = r.monthlyCost < 0.01 ? '<$0.01' : '$' + (r.monthlyCost < 1 ? r.monthlyCost.toFixed(2) : r.monthlyCost < 100 ? r.monthlyCost.toFixed(1) : r.monthlyCost.toFixed(0));
    const dailyStr = r.dailyCost < 0.01 ? '<$0.01' : '$' + r.dailyCost.toFixed(2);

    tr.innerHTML = `
      <td style="color:var(--text)">${r.name}</td>
      <td style="color:var(--text-dim)">${r.type}</td>
      <td>$${r.pricePerM.toFixed(2)}</td>
      <td>${dailyStr}</td>
      <td class="cost-highlight">${monthlyStr}</td>
      <td class="cost-bar-cell" style="position:relative;padding-left:8px;">
        <div class="cost-bar" style="width:${barPct}%;"></div>
        <span style="position:relative;z-index:1;font-size:12px;color:var(--text-dim);">${monthlyStr}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ── RAG Planner Mode (full TCO with strategies) ──

function initRagCalculator() {
  // Populate model dropdowns
  const embeddingModels = allModels.filter(m =>
    m.type === 'embedding' && !m.legacy && !m.unreleased && costGetPricePerM(m) !== null
  );

  const docSelect = document.getElementById('ragDocModel');
  const querySelect = document.getElementById('ragQueryModel');

  embeddingModels.forEach(m => {
    const pricePerM = costGetPricePerM(m);
    const opt1 = document.createElement('option');
    opt1.value = m.name;
    opt1.textContent = `${m.name} ($${pricePerM.toFixed(2)}/1M)`;
    docSelect.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = m.name;
    opt2.textContent = `${m.name} ($${pricePerM.toFixed(2)}/1M)`;
    querySelect.appendChild(opt2);
  });

  // Set defaults: voyage-4-large for docs, voyage-4-lite for queries
  docSelect.value = 'voyage-4-large';
  querySelect.value = 'voyage-4-lite';

  // Bind all sliders and selects
  const ids = ['ragDocs', 'ragDocTokens', 'ragQueries', 'ragQueryTokens', 'ragMonths'];
  ids.forEach(id => {
    document.getElementById(id).addEventListener('input', updateRagCalculator);
  });
  docSelect.addEventListener('change', updateRagCalculator);
  querySelect.addEventListener('change', updateRagCalculator);

  updateRagCalculator();
}

function updateRagCalculator() {
  const numDocs = parseInt(document.getElementById('ragDocs').value, 10);
  const docTokens = parseInt(document.getElementById('ragDocTokens').value, 10);
  const numQueries = parseInt(document.getElementById('ragQueries').value, 10);
  const queryTokens = parseInt(document.getElementById('ragQueryTokens').value, 10);
  const months = parseInt(document.getElementById('ragMonths').value, 10);
  const docModelName = document.getElementById('ragDocModel').value;
  const queryModelName = document.getElementById('ragQueryModel').value;

  // Update slider display values
  document.getElementById('ragDocsValue').textContent = costShortNum(numDocs);
  document.getElementById('ragDocTokensValue').textContent = docTokens.toLocaleString();
  document.getElementById('ragQueriesValue').textContent = costShortNum(numQueries);
  document.getElementById('ragQueryTokensValue').textContent = queryTokens.toLocaleString();
  document.getElementById('ragMonthsValue').textContent = months + ' mo';

  const docTotalTokens = numDocs * docTokens;
  const queryTotalTokensPerMonth = numQueries * queryTokens;

  // Get model prices
  const docModel = allModels.find(m => m.name === docModelName);
  const queryModel = allModels.find(m => m.name === queryModelName);
  const docPrice = docModel ? costGetPricePerM(docModel) : 0;
  const queryPrice = queryModel ? costGetPricePerM(queryModel) : 0;

  // ── Build strategies (same logic as CLI) ──
  const strategies = [];
  const v4Embedding = allModels.filter(m =>
    m.type === 'embedding' && !m.legacy && !m.unreleased &&
    (m.sharedSpace === 'voyage-4' || m.name.startsWith('voyage-4')) &&
    costGetPricePerM(m) !== null && costGetPricePerM(m) > 0
  );

  // Strategy group 1: Symmetric with each V4 model
  v4Embedding.forEach(m => {
    const price = costGetPricePerM(m);
    const docCost = (docTotalTokens / 1e6) * price;
    const queryCostPerMonth = (queryTotalTokensPerMonth / 1e6) * price;
    const totalCost = docCost + (queryCostPerMonth * months);
    strategies.push({
      name: `Symmetric: ${m.name}`,
      type: 'symmetric',
      docModel: m.name,
      queryModel: m.name,
      docCost,
      queryCostPerMonth,
      totalCost,
      months,
    });
  });

  // Strategy 2: Asymmetric — user-selected combo
  const asymDocCost = (docTotalTokens / 1e6) * docPrice;
  const asymQueryCostPerMonth = (queryTotalTokensPerMonth / 1e6) * queryPrice;
  const asymTotalCost = asymDocCost + (asymQueryCostPerMonth * months);

  // Only add if it's actually asymmetric (different models)
  if (docModelName !== queryModelName) {
    strategies.push({
      name: `Asymmetric: ${docModelName} + ${queryModelName}`,
      type: 'asymmetric',
      docModel: docModelName,
      queryModel: queryModelName,
      docCost: asymDocCost,
      queryCostPerMonth: asymQueryCostPerMonth,
      totalCost: asymTotalCost,
      months,
      recommended: true,
    });
  }

  // Strategy 3: Asymmetric with nano (local, free queries)
  strategies.push({
    name: `Asymmetric: ${docModelName} + nano (local)`,
    type: 'asymmetric-local',
    docModel: docModelName,
    queryModel: 'voyage-4-nano',
    docCost: asymDocCost,
    queryCostPerMonth: 0,
    totalCost: asymDocCost,
    months,
    localNote: 'Query cost = $0 (runs locally via HuggingFace)',
  });

  strategies.sort((a, b) => a.totalCost - b.totalCost);
  const maxCost = Math.max(...strategies.map(s => s.totalCost), 0.01);

  // ── Render summary cards ──
  const summaryEl = document.getElementById('ragSummary');
  summaryEl.innerHTML = `
    <div class="cost-summary-card">
      <div class="cost-summary-label">Document tokens</div>
      <div class="cost-summary-value">${costShortNum(docTotalTokens)}</div>
      <div class="cost-summary-detail">${costShortNum(numDocs)} docs × ${docTokens.toLocaleString()} tok</div>
    </div>
    <div class="cost-summary-card">
      <div class="cost-summary-label">Query tokens / mo</div>
      <div class="cost-summary-value">${costShortNum(queryTotalTokensPerMonth)}</div>
      <div class="cost-summary-detail">${costShortNum(numQueries)} queries × ${queryTokens} tok</div>
    </div>
    <div class="cost-summary-card">
      <div class="cost-summary-label">Best ${months}-mo total</div>
      <div class="cost-summary-value">${costFormatDollars(strategies[0].totalCost)}</div>
      <div class="cost-summary-detail">${strategies[0].name}</div>
    </div>
    <div class="cost-summary-card">
      <div class="cost-summary-label">Max potential savings</div>
      <div class="cost-summary-value" style="color:var(--success)">${maxCost > 0 ? ((1 - strategies[0].totalCost / maxCost) * 100).toFixed(0) + '%' : '0%'}</div>
      <div class="cost-summary-detail">vs ${strategies[strategies.length - 1].name.split(':')[1]?.trim() || 'most expensive'}</div>
    </div>
  `;

  // ── Render strategy cards ──
  const stratEl = document.getElementById('ragStrategies');
  stratEl.innerHTML = strategies.map(s => {
    const savings = maxCost > 0 ? ((1 - s.totalCost / maxCost) * 100) : 0;
    const savingsHtml = savings > 0 ? `<div class="cost-savings">↓ ${savings.toFixed(0)}% savings</div>` : '';
    const badgeHtml = s.recommended ? '<div class="cost-strategy-badge">★ Recommended</div>' : '';
    const localHtml = s.localNote ? `<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">⚡ ${s.localNote}</div>` : '';

    return `
      <div class="cost-strategy${s.recommended ? ' recommended' : ''}">
        ${badgeHtml}
        <div class="cost-strategy-name">${s.name}</div>
        <div class="cost-strategy-row">
          <span class="cost-strategy-row-label">Doc embedding</span>
          <span class="cost-strategy-row-value">${costFormatDollars(s.docCost)} <span style="color:var(--text-muted);font-size:11px">(one-time)</span></span>
        </div>
        <div class="cost-strategy-row">
          <span class="cost-strategy-row-label">Query cost</span>
          <span class="cost-strategy-row-value">${costFormatDollars(s.queryCostPerMonth)}/mo</span>
        </div>
        <div class="cost-strategy-total">
          <span class="cost-strategy-total-label">${s.months}-month total</span>
          <span class="cost-strategy-total-value">${costFormatDollars(s.totalCost)}</span>
        </div>
        ${savingsHtml}
        ${localHtml}
      </div>
    `;
  }).join('');

  // ── Render per-model table ──
  const ragTbody = document.getElementById('ragTableBody');
  ragTbody.innerHTML = '';

  const allEmbedding = allModels.filter(m =>
    m.type === 'embedding' && !m.legacy && !m.unreleased && costGetPricePerM(m) !== null && costGetPricePerM(m) > 0
  );

  const tableRows = allEmbedding.map(m => {
    const price = costGetPricePerM(m);
    const dCost = (docTotalTokens / 1e6) * price;
    const qCostMo = (queryTotalTokensPerMonth / 1e6) * price;
    const total = dCost + (qCostMo * months);
    return { name: m.name, dCost, qCostMo, total };
  }).sort((a, b) => a.total - b.total);

  const maxTable = Math.max(...tableRows.map(r => r.total), 0.01);

  tableRows.forEach(r => {
    const tr = document.createElement('tr');
    const barPct = Math.max(2, (r.total / maxTable) * 100);
    tr.innerHTML = `
      <td style="color:var(--text)">${r.name}</td>
      <td>${costFormatDollars(r.dCost)}</td>
      <td>${costFormatDollars(r.qCostMo)}</td>
      <td class="cost-highlight">${costFormatDollars(r.total)}</td>
      <td class="cost-bar-cell" style="position:relative;padding-left:8px;">
        <div class="cost-bar" style="width:${barPct}%;"></div>
        <span style="position:relative;z-index:1;font-size:12px;color:var(--text-dim);">${costFormatDollars(r.total)}</span>
      </td>
    `;
    ragTbody.appendChild(tr);
  });

  // ── Tip ──
  const bestSym = strategies.find(s => s.type === 'symmetric' && s.docModel === 'voyage-4-large');
  const bestAsym = strategies.find(s => s.recommended);
  const tipEl = document.getElementById('ragTip');
  if (bestSym && bestAsym && bestSym.totalCost > bestAsym.totalCost) {
    const saved = bestSym.totalCost - bestAsym.totalCost;
    const pct = ((saved / bestSym.totalCost) * 100).toFixed(0);
    tipEl.innerHTML = `💡 <strong>Asymmetric retrieval saves ${costFormatDollars(saved)} (${pct}%)</strong> over symmetric voyage-4-large — same document quality, lower query costs. The shared embedding space makes this possible. <code>vai explain shared-space</code>`;
  } else {
    tipEl.innerHTML = '💡 Try selecting different doc and query models to see asymmetric cost savings. <code>vai explain shared-space</code>';
  }
}

// ── Benchmark: History ──
const HISTORY_KEY = 'vai-bench-history';

function saveBenchHistory(results, textCount, rounds) {
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  history.push({
    timestamp: Date.now(),
    textCount,
    rounds,
    results: results.map(r => ({ model: r.model, avg: r.avg, p50: r.p50, dims: r.dims })),
  });
  // Keep last 20
  if (history.length > 20) history.splice(0, history.length - 20);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

function renderHistory() {
  const container = document.getElementById('benchHistoryContent');
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

  if (history.length === 0) {
    container.innerHTML = '<div class="history-empty">No benchmarks recorded yet. Run a latency benchmark to start tracking.</div>';
    return;
  }

  // Collect all models that appear
  const modelSet = new Set();
  history.forEach(h => h.results.forEach(r => modelSet.add(r.model)));
  const models = [...modelSet];
  const colorMap = {};
  models.forEach((m, i) => { colorMap[m] = MODEL_COLORS[i % MODEL_COLORS.length]; });

  // Find global max for scale
  const maxAvg = Math.max(...history.flatMap(h => h.results.map(r => r.avg)));

  let html = '<div class="history-chart">';
  history.forEach((h, hi) => {
    html += '<div class="history-bar-group" title="' + new Date(h.timestamp).toLocaleString() + '">';
    models.forEach(m => {
      const r = h.results.find(r => r.model === m);
      const height = r ? Math.max(4, (r.avg / maxAvg) * 100) : 0;
      const label = r ? `${m}: ${r.avg.toFixed(0)}ms` : '';
      html += `<div class="history-bar" style="height:${height}%;background:${colorMap[m]};" title="${label}"></div>`;
    });
    html += '</div>';
  });
  html += '</div>';

  // Legend
  html += '<div class="history-legend">';
  models.forEach(m => {
    html += `<span><span class="history-legend-dot" style="background:${colorMap[m]}"></span>${m}</span>`;
  });
  html += '</div>';

  // Time labels
  if (history.length > 1) {
    const first = new Date(history[0].timestamp);
    const last = new Date(history[history.length - 1].timestamp);
    html += `<div class="history-labels"><span>${first.toLocaleDateString()} ${first.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span><span>${last.toLocaleDateString()} ${last.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span></div>`;
  }

  container.innerHTML = html;
}

window.clearHistory = function() {
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
};

// ── Settings ──
const SETTINGS_KEY = 'vai-settings';

function getSettings() {
  try {
    return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
  } catch { return {}; }
}

function saveSetting(key, value) {
  const s = getSettings();
  s[key] = value;
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  flashSaved();
}

function flashSaved() {
  const el = document.getElementById('settingsSavedMsg');
  if (!el) return;
  el.classList.add('show');
  clearTimeout(el._timer);
  el._timer = setTimeout(() => el.classList.remove('show'), 1500);
}

function initSettings() {
  const s = getSettings();

  // Theme sync
  const themeSelect = document.getElementById('settingsTheme');
  const currentTheme = localStorage.getItem('vai-theme') || 'dark';
  if (themeSelect) {
    themeSelect.value = currentTheme;
    themeSelect.addEventListener('change', () => {
      const t = themeSelect.value;
      saveSetting('theme', t);
      localStorage.setItem('vai-theme', t);
      // Reuse existing applyTheme by clicking the toggle if needed
      const toggle = document.getElementById('themeToggle');
      const cur = localStorage.getItem('vai-theme');
      if (cur === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        if (toggle) { toggle.textContent = '☀️'; toggle.title = 'Switch to dark mode'; }
      } else {
        document.documentElement.removeAttribute('data-theme');
        if (toggle) { toggle.textContent = '🌙'; toggle.title = 'Switch to light mode'; }
      }
      const logo = document.getElementById('sidebarLogo');
      if (logo) logo.src = '/icons/' + (t === 'light' ? 'light' : 'dark') + '/64.png';
    });
  }

  // Heatmap palette — handled below with preview swatch

  // Default model — populate from global model select
  const settingsModel = document.getElementById('settingsDefaultModel');
  const globalModel = document.getElementById('globalModel');
  if (settingsModel && globalModel) {
    // Clone options from globalModel
    settingsModel.innerHTML = globalModel.innerHTML;
    const savedModel = s.defaultModel || globalModel.value;
    settingsModel.value = savedModel;
    settingsModel.addEventListener('change', () => {
      saveSetting('defaultModel', settingsModel.value);
      globalModel.value = settingsModel.value;
      // Update individual tab selects too
      ['embedModel', 'compareModel', 'searchEmbedModel'].forEach(id => {
        const sel = document.getElementById(id);
        if (sel) sel.value = settingsModel.value;
      });
    });
  }

  // Default input type
  const inputTypeSel = document.getElementById('settingsInputType');
  if (inputTypeSel) {
    inputTypeSel.value = s.inputType || 'document';
    inputTypeSel.addEventListener('change', () => {
      saveSetting('inputType', inputTypeSel.value);
      const embedType = document.getElementById('embedInputType');
      if (embedType) embedType.value = inputTypeSel.value;
    });
  }

  // API base URL
  const apiBaseInput = document.getElementById('settingsApiBase');
  if (apiBaseInput) {
    apiBaseInput.value = s.apiBase || '';
    apiBaseInput.addEventListener('change', () => saveSetting('apiBase', apiBaseInput.value));
  }

  // Timeout
  const timeoutSel = document.getElementById('settingsTimeout');
  if (timeoutSel) {
    timeoutSel.value = s.timeout || '30';
    timeoutSel.addEventListener('change', () => saveSetting('timeout', timeoutSel.value));
  }

  // Benchmark iterations
  const benchIterSel = document.getElementById('settingsBenchIter');
  if (benchIterSel) {
    benchIterSel.value = s.benchIter || '5';
    benchIterSel.addEventListener('change', () => saveSetting('benchIter', benchIterSel.value));
  }

  // Toggle buttons
  function initToggle(id, settingKey, defaultVal) {
    const btn = document.getElementById(id);
    if (!btn) return;
    const val = s[settingKey] !== undefined ? s[settingKey] : defaultVal;
    btn.classList.toggle('active', val);
    btn.addEventListener('click', () => {
      const isActive = btn.classList.toggle('active');
      saveSetting(settingKey, isActive);
    });
  }
  initToggle('settingsDetailedTimings', 'detailedTimings', false);
  initToggle('settingsCacheEmbeddings', 'cacheEmbeddings', true);

  // API Key (Electron only — uses safeStorage via preload bridge)
  const apiKeyInput = document.getElementById('settingsApiKey');
  const apiKeyToggle = document.getElementById('settingsApiKeyToggle');
  const apiKeySave = document.getElementById('settingsApiKeySave');
  const apiKeyMsg = document.getElementById('settingsApiKeyMsg');
  const apiBanner = document.getElementById('settingsApiBanner');
  const apiBannerIcon = document.getElementById('settingsApiBannerIcon');

  function updateApiBanner(hasKey, key) {
    if (hasKey) {
      apiBanner.className = 'settings-api-banner success';
      apiBannerIcon.textContent = '🔐';
      apiKeyMsg.textContent = 'API key stored securely in OS keychain';
      apiKeyInput.placeholder = window.vai ? window.vai.apiKey.mask(key) : '••••••••';
    } else {
      apiBanner.className = 'settings-api-banner';
      apiBannerIcon.textContent = '⚠️';
      apiKeyMsg.textContent = 'No API key configured — add your key below to get started.';
      apiKeyInput.placeholder = 'pa-...';
    }
  }

  if (window.vai && window.vai.isElectron) {
    // Load existing key status
    window.vai.apiKey.get().then(key => updateApiBanner(!!key, key));

    // Show/hide toggle
    let keyVisible = false;
    apiKeyToggle.addEventListener('click', async () => {
      if (!keyVisible && !apiKeyInput.value) {
        const key = await window.vai.apiKey.get();
        if (key) {
          apiKeyInput.value = key;
          apiKeyInput.type = 'text';
          apiKeyToggle.textContent = '🙈';
          keyVisible = true;
        }
      } else if (keyVisible) {
        apiKeyInput.type = 'password';
        apiKeyToggle.textContent = '👁';
        keyVisible = false;
        if (!apiKeyInput.value) {
          const key = await window.vai.apiKey.get();
          if (key) apiKeyInput.placeholder = window.vai.apiKey.mask(key);
        }
      } else {
        apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
        apiKeyToggle.textContent = apiKeyInput.type === 'password' ? '👁' : '🙈';
        keyVisible = apiKeyInput.type === 'text';
      }
    });

    // Save button
    apiKeySave.addEventListener('click', async () => {
      const key = apiKeyInput.value.trim();
      if (!key) {
        await window.vai.apiKey.delete();
        updateApiBanner(false);
        flashSaved();
        return;
      }
      try {
        await window.vai.apiKey.set(key);
        apiKeyInput.value = '';
        apiKeyInput.type = 'password';
        apiKeyToggle.textContent = '👁';
        keyVisible = false;
        updateApiBanner(true, key);
        flashSaved();
        loadConfig();
      } catch (err) {
        apiBanner.className = 'settings-api-banner';
        apiBannerIcon.textContent = '❌';
        apiKeyMsg.textContent = 'Failed to save: ' + err.message;
      }
    });

    apiKeyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') apiKeySave.click();
    });
  } else {
    apiBanner.className = 'settings-api-banner';
    apiBannerIcon.textContent = '💡';
    apiKeyMsg.textContent = 'Set VOYAGE_API_KEY environment variable, or use "vai config set key YOUR_KEY"';
    apiKeySave.style.display = 'none';
    apiKeyToggle.style.display = 'none';
    apiKeyInput.disabled = true;
    apiKeyInput.placeholder = 'Secure storage available in desktop app';
  }

  // Heatmap palette preview
  const HEATMAP_GRADIENTS = {
    viridis:  'linear-gradient(90deg, #440154, #31688e, #35b779, #fde725)',
    plasma:   'linear-gradient(90deg, #0d0887, #7e03a8, #cc4778, #f89540, #f0f921)',
    inferno:  'linear-gradient(90deg, #000004, #420a68, #932667, #dd513a, #fca50a, #fcffa4)',
    magma:    'linear-gradient(90deg, #000004, #3b0f70, #8c2981, #de4968, #fea16e, #fcfdbf)',
    cividis:  'linear-gradient(90deg, #00224e, #123570, #3b496c, #575d6d, #707173, #a5a88f, #fee838)',
    turbo:    'linear-gradient(90deg, #30123b, #4662d7, #36aaf9, #1ae4b6, #72fe5e, #c8ef34, #faba39, #f66b19, #d93806, #7a0403)',
  };
  const heatmapSel = document.getElementById('settingsHeatmap');
  const heatmapPreview = document.getElementById('heatmapPreview');
  function updateHeatmapPreview() {
    if (heatmapPreview && heatmapSel) {
      heatmapPreview.style.background = HEATMAP_GRADIENTS[heatmapSel.value] || HEATMAP_GRADIENTS.viridis;
    }
  }
  if (heatmapSel) {
    heatmapSel.value = s.heatmap || 'viridis';
    heatmapSel.addEventListener('change', () => {
      saveSetting('heatmap', heatmapSel.value);
      updateHeatmapPreview();
    });
    updateHeatmapPreview();
  }

  // Clear cache
  const clearBtn = document.getElementById('settingsClearCache');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all cached data and reset settings to defaults?')) {
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem('vai-theme');
        localStorage.removeItem('vai-embed-cache');
        location.reload();
      }
    });
  }

  // Apply saved defaults on load
  if (s.defaultModel && globalModel) {
    globalModel.value = s.defaultModel;
  }
  if (s.inputType) {
    const embedType = document.getElementById('embedInputType');
    if (embedType) embedType.value = s.inputType;
  }
}

// ── Update Checker ──
function checkForAppUpdate() {
  if (!window.vai || !window.vai.isElectron) return;

  // Show version in sidebar + settings page
  window.vai.getVersion().then(v => {
    if (!v) return;
    const appVer = typeof v === 'object' ? v.app : v;
    const cliVer = typeof v === 'object' ? v.cli : null;

    const label = document.getElementById('appVersionLabel');
    if (label && appVer) label.textContent = 'v' + appVer;

    const section = document.getElementById('settingsVersionSection');
    const appBadge = document.getElementById('settingsAppVersion');
    const cliBadge = document.getElementById('settingsCliVersion');
    if (section) section.style.display = '';
    if (appBadge && appVer) appBadge.textContent = 'v' + appVer;
    if (cliBadge && cliVer) cliBadge.textContent = 'v' + cliVer;
  });

  // Don't check more than once per hour
  const DISMISS_KEY = 'vai-update-dismissed';
  const dismissed = localStorage.getItem(DISMISS_KEY);
  if (dismissed) {
    const dismissedAt = parseInt(dismissed, 10);
    if (Date.now() - dismissedAt < 3600000) return;
  }

  // Listen for real-time update events from electron-updater
  if (window.vai.updates.onEvent) {
    window.vai.updates.onEvent((data) => {
      const banner = document.getElementById('updateBanner');
      const progressWrap = document.getElementById('updateProgress');
      const progressFill = document.getElementById('updateProgressFill');
      const progressLabel = document.getElementById('updateProgressLabel');
      const bannerText = document.getElementById('updateBannerText');
      const downloadBtn = document.getElementById('updateDownloadBtn');
      const installBtn = document.getElementById('updateInstallBtn');

      if (data.event === 'download-progress') {
        const pct = Math.round(data.percent || 0);
        progressFill.style.width = pct + '%';
        const mbTransferred = (data.transferred / 1048576).toFixed(1);
        const mbTotal = (data.total / 1048576).toFixed(1);
        progressLabel.textContent = `${pct}% (${mbTransferred}/${mbTotal} MB)`;
      }

      if (data.event === 'update-downloaded') {
        progressWrap.style.display = 'none';
        bannerText.innerHTML = `<strong>Vai v${data.latestVersion}</strong> is ready to install.`;
        bannerText.style.display = '';
        downloadBtn.style.display = 'none';
        installBtn.style.display = '';
      }

      if (data.event === 'update-error') {
        progressWrap.style.display = 'none';
        bannerText.innerHTML = `Update failed: ${data.message}. <a href="#" onclick="window.vai.updates.openRelease('https://github.com/mrlynn/voyageai-cli/releases');return false;" style="color:var(--accent);">Download manually</a>`;
        bannerText.style.display = '';
        downloadBtn.style.display = 'none';
      }
    });
  }

  window.vai.updates.check().then(result => {
    if (!result || !result.hasUpdate) return;

    const banner = document.getElementById('updateBanner');
    const versionEl = document.getElementById('updateVersion');
    const currentEl = document.getElementById('currentVersion');
    const downloadBtn = document.getElementById('updateDownloadBtn');
    const installBtn = document.getElementById('updateInstallBtn');
    const dismissBtn = document.getElementById('updateDismissBtn');
    const bannerText = document.getElementById('updateBannerText');
    const progressWrap = document.getElementById('updateProgress');

    if (!banner) return;

    versionEl.textContent = 'v' + result.latestVersion;
    currentEl.textContent = 'v' + result.currentVersion;
    banner.classList.add('show');

    downloadBtn.addEventListener('click', () => {
      // Start auto-download
      if (window.vai.updates.download) {
        downloadBtn.style.display = 'none';
        bannerText.style.display = 'none';
        progressWrap.style.display = 'flex';
        window.vai.updates.download().catch(() => {
          // Fallback to manual download
          window.vai.updates.openRelease(result.releaseUrl);
        });
      } else {
        window.vai.updates.openRelease(result.releaseUrl);
      }
    });

    installBtn.addEventListener('click', () => {
      installBtn.textContent = 'Restarting...';
      installBtn.disabled = true;
      window.vai.updates.install();
    });

    dismissBtn.addEventListener('click', () => {
      banner.classList.remove('show');
      localStorage.setItem(DISMISS_KEY, String(Date.now()));
    });
  }).catch(() => {
    // Silent fail — update check is non-critical
  });
}

// ── Onboarding Walkthrough ──
function initOnboarding() {
  const ONBOARDING_KEY = 'vai-onboarding-complete';
  const overlay = document.getElementById('onboardingOverlay');
  const welcomeWrap = document.getElementById('onboardingWelcomeWrap');
  const welcomeCard = document.getElementById('onboardingWelcomeCard');
  const tooltip = document.getElementById('onboardingTooltip');
  const spotlight = document.getElementById('onboardingSpotlight');
  const arrow = document.getElementById('onboardingArrow');
  const dotsContainer = document.getElementById('onboardingDots');
  const titleEl = document.getElementById('onboardingTitle');
  const bodyEl = document.getElementById('onboardingBody');
  const iconEl = document.getElementById('onboardingIcon');

  if (!overlay) return;

  const isElectron = !!(window.vai && window.vai.isElectron);

  const steps = [
    {
      target: null, // welcome card, no spotlight
      icon: '🚀',
      title: 'Welcome to Vai',
      body: 'Explore embeddings, compare text similarity, and search with vector models — all from one playground.',
    },
    {
      target: '[data-tab="settings"]',
      icon: '🔑',
      title: 'API Key Setup',
      body: 'First, add your <strong>Voyage AI API key</strong> in Settings. You can get one free at <strong>dash.voyageai.com</strong>.' +
        (isElectron ? '<br><br>💎 On desktop, your key is encrypted via <strong>OS keychain</strong> for secure storage.' : ''),
      arrow: 'left',
    },
    {
      target: '[data-tab="embed"]',
      icon: '⚡',
      title: 'Embed',
      body: 'Turn any text into a <strong>vector embedding</strong> — a numerical fingerprint that captures meaning. Visualize the raw vectors and explore what models produce.',
      arrow: 'left',
    },
    {
      target: '[data-tab="compare"]',
      icon: '🔥',
      title: 'Compare',
      body: 'Paste multiple texts and see a <strong>similarity heatmap</strong> — instantly discover which phrases are semantically close and which are far apart.',
      arrow: 'left',
    },
    {
      target: '[data-tab="search"]',
      icon: '🔍',
      title: 'Search & Rerank',
      body: 'Run <strong>vector search</strong> against a set of documents and optionally <strong>rerank</strong> results for higher precision. Great for building RAG pipelines.',
      arrow: 'left',
    },
  ];

  let currentStep = 0;
  const totalSteps = steps.length;

  function buildDots() {
    dotsContainer.innerHTML = '';
    for (let i = 1; i < totalSteps; i++) {
      const dot = document.createElement('div');
      dot.className = 'onboarding-dot';
      if (i < currentStep) dot.classList.add('completed');
      if (i === currentStep) dot.classList.add('active');
      dotsContainer.appendChild(dot);
    }
  }

  function positionTooltipNear(targetEl) {
    const step = steps[currentStep];
    const rect = targetEl.getBoundingClientRect();

    // Position spotlight over the target
    spotlight.style.display = 'block';
    const pad = 6;
    spotlight.style.left = (rect.left - pad) + 'px';
    spotlight.style.top = (rect.top - pad) + 'px';
    spotlight.style.width = (rect.width + pad * 2) + 'px';
    spotlight.style.height = (rect.height + pad * 2) + 'px';

    // Reset arrow classes
    arrow.className = 'onboarding-tooltip-arrow';

    // Position tooltip to the right of sidebar items
    if (step.arrow === 'left') {
      arrow.classList.add('left');
      tooltip.style.left = (rect.right + 16) + 'px';
      tooltip.style.top = Math.max(8, rect.top - 10) + 'px';
      tooltip.style.right = 'auto';
      tooltip.style.bottom = 'auto';
    } else {
      // Below the target
      arrow.classList.add('top');
      tooltip.style.left = Math.max(8, rect.left) + 'px';
      tooltip.style.top = (rect.bottom + 14) + 'px';
      tooltip.style.right = 'auto';
      tooltip.style.bottom = 'auto';
    }

    // Ensure tooltip doesn't overflow viewport
    requestAnimationFrame(() => {
      const tr = tooltip.getBoundingClientRect();
      if (tr.bottom > window.innerHeight - 10) {
        tooltip.style.top = Math.max(8, window.innerHeight - tr.height - 10) + 'px';
      }
      if (tr.right > window.innerWidth - 10) {
        tooltip.style.left = Math.max(8, window.innerWidth - tr.width - 10) + 'px';
      }
    });
  }

  function showStep(idx) {
    currentStep = idx;
    const step = steps[idx];

    if (idx === 0) {
      // Welcome card — centered, no spotlight
      welcomeWrap.style.display = 'flex';
      tooltip.classList.remove('visible');
      tooltip.style.display = 'none';
      spotlight.style.display = 'none';
      requestAnimationFrame(() => {
        welcomeCard.classList.add('visible');
      });
      return;
    }

    // Hide welcome card
    welcomeWrap.style.display = 'none';
    welcomeCard.classList.remove('visible');

    // Show tooltip
    tooltip.style.display = 'block';
    tooltip.classList.remove('visible');
    iconEl.textContent = step.icon;
    titleEl.textContent = step.title;
    bodyEl.innerHTML = step.body;
    buildDots();

    // Update next button text
    const nextBtn = document.getElementById('onboardingNext');
    nextBtn.textContent = (idx === totalSteps - 1) ? 'Get Started' : 'Next';

    // Find target element and position
    const targetEl = document.querySelector(step.target);
    if (targetEl) {
      positionTooltipNear(targetEl);
    }

    requestAnimationFrame(() => {
      tooltip.classList.add('visible');
    });
  }

  function finish() {
    tooltip.classList.remove('visible');
    welcomeCard.classList.remove('visible');
    spotlight.style.display = 'none';
    setTimeout(() => {
      overlay.classList.remove('active');
    }, 300);
    localStorage.setItem(ONBOARDING_KEY, 'true');
  }

  function nextStep() {
    if (currentStep < totalSteps - 1) {
      showStep(currentStep + 1);
    } else {
      finish();
    }
  }

  // Wire up buttons
  document.getElementById('onboardingWelcomeNext').addEventListener('click', nextStep);
  document.getElementById('onboardingWelcomeSkip').addEventListener('click', finish);
  document.getElementById('onboardingNext').addEventListener('click', nextStep);
  document.getElementById('onboardingSkip').addEventListener('click', finish);
  document.getElementById('onboardingBackdrop').addEventListener('click', finish);

  // "Show Welcome Tour" button in settings
  const tourBtn = document.getElementById('settingsShowTour');
  if (tourBtn) {
    tourBtn.addEventListener('click', () => {
      startOnboarding();
    });
  }

  // Auto-start on first visit
  function startOnboarding() {
    // Sync onboarding logo with current theme
    const onboardLogo = document.getElementById('onboardingLogo');
    if (onboardLogo) {
      const theme = localStorage.getItem('vai-theme') || 'dark';
      onboardLogo.src = '/icons/' + (theme === 'light' ? 'light' : 'dark') + '/64.png';
    }
    overlay.classList.add('active');
    showStep(0);
  }

  if (!localStorage.getItem(ONBOARDING_KEY)) {
    // Delay slightly so the app is fully rendered
    setTimeout(startOnboarding, 600);
  }

  // Expose for manual replay
  window.startOnboarding = startOnboarding;
}

// ── Multimodal Tab ──
let mmImageData = null; // base64 data URL of the uploaded image
let mmGalleryImages = []; // array of { dataUrl, name, size }
let mmSearchMode = 'text';
let mmSearchImageIndex = -1;

function initMultimodal() {
  const dropZone = document.getElementById('mmDropZone');
  const fileInput = document.getElementById('mmFileInput');

  // Click to browse
  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) handleMultimodalImage(e.target.files[0]);
  });

  // Drag and drop
  ['dragenter', 'dragover'].forEach(evt => {
    dropZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-active');
    });
  });
  ['dragleave', 'drop'].forEach(evt => {
    dropZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-active');
    });
  });
  dropZone.addEventListener('drop', (e) => {
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleMultimodalImage(e.dataTransfer.files[0]);
    }
  });

  // Paste from clipboard
  document.addEventListener('paste', (e) => {
    // Only handle if multimodal tab is active
    const panel = document.getElementById('tab-multimodal');
    if (!panel || !panel.classList.contains('active')) return;
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.type.startsWith('image/')) {
        e.preventDefault();
        handleMultimodalImage(item.getAsFile());
        return;
      }
    }
  });

  // Gallery
  renderGalleryGrid();

  const galleryInput = document.getElementById('mmGalleryFileInput');
  galleryInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      addGalleryImage(e.target.files[0]);
    }
    galleryInput.value = '';
  });
}

function handleMultimodalImage(file) {
  const VALID_TYPES = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];
  if (!VALID_TYPES.includes(file.type)) {
    showError('mmError', 'Unsupported image type. Use PNG, JPEG, WebP, or GIF.');
    return;
  }
  if (file.size > 20 * 1024 * 1024) {
    showError('mmError', 'Image too large. Maximum size is 20 MB.');
    return;
  }
  hideError('mmError');

  const reader = new FileReader();
  reader.onload = (e) => {
    mmImageData = e.target.result;
    const img = document.getElementById('mmPreviewImg');
    img.src = mmImageData;

    img.onload = () => {
      const info = document.getElementById('mmFileInfo');
      const sizeStr = file.size > 1024 * 1024
        ? (file.size / (1024 * 1024)).toFixed(1) + ' MB'
        : (file.size / 1024).toFixed(0) + ' KB';
      info.textContent = `${file.name} · ${img.naturalWidth}×${img.naturalHeight} · ${sizeStr}`;
    };

    document.getElementById('mmDropZone').style.display = 'none';
    document.getElementById('mmPreview').classList.add('visible');
  };
  reader.readAsDataURL(file);
}

window.clearMultimodalImage = function() {
  mmImageData = null;
  document.getElementById('mmPreviewImg').src = '';
  document.getElementById('mmFileInfo').textContent = '';
  document.getElementById('mmPreview').classList.remove('visible');
  document.getElementById('mmDropZone').style.display = '';
  document.getElementById('mmFileInput').value = '';
};

window.doMultimodalCompare = async function() {
  hideError('mmError');
  const text = document.getElementById('mmText').value.trim();
  if (!mmImageData) { showError('mmError', 'Upload an image first'); return; }
  if (!text) { showError('mmError', 'Enter text to compare against the image'); return; }

  setLoading('mmCompareBtn', true);
  try {
    const model = document.getElementById('mmModel').value;
    const dimsVal = document.getElementById('mmDimensions').value;
    const body = {
      inputs: [
        { content: [{ type: 'image_base64', image_base64: mmImageData }] },
        { content: [{ type: 'text', text: text }] }
      ],
      model: model,
      input_type: 'document'
    };
    if (dimsVal) body.output_dimension = parseInt(dimsVal, 10);

    const data = await apiPost('/api/multimodal-embed', body);

    const vecA = data.data[0].embedding;
    const vecB = data.data[1].embedding;
    const cosine = cosineSim(vecA, vecB);

    // Hero display
    const cosinePct = Math.max(0, cosine * 100);
    let cosineColor;
    if (cosine > 0.7) cosineColor = 'var(--green)';
    else if (cosine > 0.4) cosineColor = 'var(--yellow)';
    else cosineColor = 'var(--red)';

    const scoreEl = document.getElementById('mmSimScore');
    scoreEl.textContent = cosine.toFixed(4);
    scoreEl.style.color = cosineColor;

    const barEl = document.getElementById('mmSimBar');
    barEl.style.width = cosinePct + '%';
    barEl.style.background = cosineColor;

    // Stats
    const usage = data.usage || {};
    const statsEl = document.getElementById('mmStats');
    statsEl.innerHTML = `
      <span class="stat"><span class="stat-label">Model</span><span class="stat-value">${data.model || model}</span></span>
      <span class="stat"><span class="stat-label">Dimensions</span><span class="stat-value">${vecA.length}</span></span>
      <span class="stat"><span class="stat-label">Text Tokens</span><span class="stat-value">${usage.text_tokens || '—'}</span></span>
      <span class="stat"><span class="stat-label">Image Pixels</span><span class="stat-value">${usage.image_pixels ? usage.image_pixels.toLocaleString() : '—'}</span></span>
      <span class="stat"><span class="stat-label">Total Tokens</span><span class="stat-value">${usage.total_tokens || '—'}</span></span>
    `;

    // Insight note
    const noteEl = document.getElementById('mmNote');
    if (cosine > 0.7) {
      noteEl.innerHTML = '💡 <strong>High similarity!</strong> The image and text are closely related in Voyage AI\'s multimodal embedding space. This means the text is a good semantic description of the image.';
    } else if (cosine > 0.4) {
      noteEl.innerHTML = '💡 <strong>Moderate similarity.</strong> The image and text share some semantic overlap. They may be related but not a direct match.';
    } else {
      noteEl.innerHTML = '💡 <strong>Low similarity.</strong> The image and text are semantically distant. Try a description that matches the image content more closely.';
    }

    document.getElementById('mmResult').classList.add('visible');
  } catch (err) {
    showError('mmError', err.message);
  } finally {
    setLoading('mmCompareBtn', false);
  }
};

// Gallery functions
function renderGalleryGrid() {
  const grid = document.getElementById('mmGalleryGrid');
  grid.innerHTML = '';

  mmGalleryImages.forEach((img, i) => {
    const slot = document.createElement('div');
    slot.className = 'mm-gallery-slot filled' + (mmSearchMode === 'image' && mmSearchImageIndex === i ? ' query-selected' : '');
    slot.innerHTML = `<img src="${img.dataUrl}" alt="${img.name}"><button class="mm-slot-remove" title="Remove">×</button>`;
    slot.querySelector('.mm-slot-remove').addEventListener('click', (e) => {
      e.stopPropagation();
      removeGalleryImage(i);
    });
    if (mmSearchMode === 'image') {
      slot.style.cursor = 'pointer';
      slot.addEventListener('click', () => selectGalleryImageAsQuery(i));
    }
    grid.appendChild(slot);
  });

  // Add empty slot if under 6
  if (mmGalleryImages.length < 6) {
    const addSlot = document.createElement('div');
    addSlot.className = 'mm-gallery-slot';
    addSlot.innerHTML = '<span class="mm-slot-add">+</span>';
    addSlot.addEventListener('click', () => {
      document.getElementById('mmGalleryFileInput').click();
    });
    grid.appendChild(addSlot);
  }
}

function addGalleryImage(file) {
  const VALID_TYPES = ['image/png', 'image/jpeg', 'image/webp', 'image/gif'];
  if (!VALID_TYPES.includes(file.type)) return;
  if (file.size > 20 * 1024 * 1024) return;
  if (mmGalleryImages.length >= 6) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    mmGalleryImages.push({ dataUrl: e.target.result, name: file.name, size: file.size });
    renderGalleryGrid();
  };
  reader.readAsDataURL(file);
}

function removeGalleryImage(index) {
  mmGalleryImages.splice(index, 1);
  if (mmSearchImageIndex === index) mmSearchImageIndex = -1;
  else if (mmSearchImageIndex > index) mmSearchImageIndex--;
  renderGalleryGrid();
  updateSearchImageLabel();
}

function selectGalleryImageAsQuery(index) {
  mmSearchImageIndex = (mmSearchImageIndex === index) ? -1 : index;
  renderGalleryGrid();
  updateSearchImageLabel();
}

function updateSearchImageLabel() {
  const label = document.getElementById('mmSearchImageLabel');
  if (mmSearchImageIndex >= 0 && mmSearchImageIndex < mmGalleryImages.length) {
    label.textContent = '✓ Image ' + (mmSearchImageIndex + 1) + ' selected as query';
    label.style.color = 'var(--accent)';
  } else {
    label.textContent = 'No image selected';
    label.style.color = 'var(--text-muted)';
  }
}

window.setMmSearchMode = function(mode) {
  mmSearchMode = mode;
  document.querySelectorAll('#mmSearchMode button').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
  document.getElementById('mmSearchTextWrap').style.display = mode === 'text' ? '' : 'none';
  document.getElementById('mmSearchImageWrap').style.display = mode === 'image' ? '' : 'none';
  renderGalleryGrid();
};

window.doMultimodalSearch = async function() {
  hideError('mmSearchError');

  const corpusText = document.getElementById('mmCorpusText').value.trim();
  const textItems = corpusText ? corpusText.split('\n').map(t => t.trim()).filter(Boolean) : [];

  if (mmGalleryImages.length === 0 && textItems.length === 0) {
    showError('mmSearchError', 'Add at least one image or text to the corpus');
    return;
  }

  // Build query input
  let queryInput;
  if (mmSearchMode === 'text') {
    const q = document.getElementById('mmSearchQuery').value.trim();
    if (!q) { showError('mmSearchError', 'Enter a search query'); return; }
    queryInput = { content: [{ type: 'text', text: q }] };
  } else {
    if (mmSearchImageIndex < 0 || mmSearchImageIndex >= mmGalleryImages.length) {
      showError('mmSearchError', 'Select an image from the corpus to use as query');
      return;
    }
    queryInput = { content: [{ type: 'image_base64', image_base64: mmGalleryImages[mmSearchImageIndex].dataUrl }] };
  }

  const btnId = mmSearchMode === 'text' ? 'mmSearchBtn' : 'mmSearchImgBtn';
  setLoading(btnId, true);

  try {
    const model = document.getElementById('mmModel').value;
    const dimsVal = document.getElementById('mmDimensions').value;

    // Build corpus inputs
    const corpusInputs = [];
    const corpusMeta = []; // track type/content for display

    mmGalleryImages.forEach((img, i) => {
      corpusInputs.push({ content: [{ type: 'image_base64', image_base64: img.dataUrl }] });
      corpusMeta.push({ type: 'image', dataUrl: img.dataUrl, label: img.name || 'Image ' + (i + 1) });
    });

    textItems.forEach(t => {
      corpusInputs.push({ content: [{ type: 'text', text: t }] });
      corpusMeta.push({ type: 'text', label: t });
    });

    // Embed query + all corpus items in one call
    const allInputs = [queryInput, ...corpusInputs];
    const body = {
      inputs: allInputs,
      model: model,
      input_type: 'document'
    };
    if (dimsVal) body.output_dimension = parseInt(dimsVal, 10);

    const data = await apiPost('/api/multimodal-embed', body);

    const queryVec = data.data[0].embedding;
    const results = corpusMeta.map((meta, i) => {
      const vec = data.data[i + 1].embedding;
      const sim = cosineSim(queryVec, vec);
      return { ...meta, similarity: sim };
    }).sort((a, b) => b.similarity - a.similarity);

    // Render results
    const listEl = document.getElementById('mmSearchResultList');
    listEl.innerHTML = '';

    results.forEach((r, i) => {
      let simColor;
      if (r.similarity > 0.7) simColor = 'var(--green)';
      else if (r.similarity > 0.4) simColor = 'var(--yellow)';
      else simColor = 'var(--red)';

      const item = document.createElement('div');
      item.className = 'mm-result-item';

      const thumbHtml = r.type === 'image'
        ? `<img class="mm-result-thumb" src="${r.dataUrl}" alt="${r.label}">`
        : `<div class="mm-result-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--bg-surface);font-size:18px;">📝</div>`;

      item.innerHTML = `
        <div class="mm-result-rank">#${i + 1}</div>
        ${thumbHtml}
        <div class="mm-result-content">
          <div class="mm-result-text" title="${r.label.replace(/"/g, '&quot;')}">${r.label}</div>
          <div class="mm-result-type">${r.type}</div>
        </div>
        <div class="mm-result-score" style="color:${simColor}">${r.similarity.toFixed(4)}</div>
      `;
      listEl.appendChild(item);
    });

    document.getElementById('mmSearchResult').classList.add('visible');
  } catch (err) {
    showError('mmSearchError', err.message);
  } finally {
    setLoading(btnId, false);
  }
};

// ── Patch init to include benchmark setup ──
const _origInit = init;
init = async function() {
  await _origInit();
  initThemeToggle();
  buildModelCheckboxes();
  populateBenchRankSelects();
  populateQuantModelSelect();
  initCostCalculator();
  renderHistory();
  initSettings();
  initMultimodal();
  checkForAppUpdate();
  initOnboarding();
};

// ── Start ──
init();
})();
</script>
<!-- Cost Help Modal -->
<div class="cost-modal-overlay" id="costHelpModal">
  <div class="cost-modal">
    <button class="cost-modal-close" id="costHelpClose">&times;</button>

    <h2>📐 How the Cost Calculator Works</h2>

    <p>Voyage AI charges per <strong>million tokens</strong> processed. A token is roughly ¾ of a word.
    The calculator estimates your total embedding cost based on how many documents you embed
    and how many queries you run over time.</p>

    <h3>💡 Simple Mode</h3>
    <p>Compares the per-model query cost for a given volume. Useful for quick "which model is cheapest?" checks.</p>
    <div class="formula">
      <span class="label">Daily cost =</span><br>
      <span class="accent">tokens_per_query</span> × <span class="accent">queries_per_day</span> ÷ 1,000,000 × <span class="accent">price_per_M_tokens</span><br><br>
      <span class="label">Monthly cost =</span> daily cost × 30
    </div>

    <h3>📊 RAG Planner Mode</h3>
    <p>Models the full cost of a Retrieval-Augmented Generation (RAG) pipeline, separating
    the <strong>one-time</strong> document ingestion cost from the <strong>recurring</strong> query cost.</p>

    <div class="formula">
      <span class="label">Document embedding (one-time):</span><br>
      <span class="accent">doc_cost</span> = num_docs × tokens_per_doc ÷ 1,000,000 × <span class="accent">doc_model_price</span><br><br>
      <span class="label">Query embedding (monthly):</span><br>
      <span class="accent">query_cost/mo</span> = queries_per_month × tokens_per_query ÷ 1,000,000 × <span class="accent">query_model_price</span><br><br>
      <span class="label">Projected total:</span><br>
      <span class="accent">total</span> = doc_cost + (query_cost/mo × <span class="accent">months</span>)
    </div>

    <h3>⚖️ Three Strategies Compared</h3>
    <ul>
      <li><strong>Symmetric</strong> — same model for documents and queries. Simple but expensive at scale,
      because query-heavy workloads pay the full model price on every request.</li>
      <li><strong>Asymmetric (★ Recommended)</strong> — use a high-quality model (e.g. <code>voyage-4-large</code>)
      for documents and a cheaper model (e.g. <code>voyage-4-lite</code>) for queries.
      This works because Voyage 4 models share the same embedding space — vectors from different
      models are directly comparable.</li>
      <li><strong>Asymmetric + Local</strong> — embed documents via the API, but run queries locally using
      <code>voyage-4-nano</code> on HuggingFace (free). Query cost drops to $0.</li>
    </ul>

    <h3>🔗 Shared Embedding Space</h3>
    <p>The Voyage 4 family (<code>voyage-4-large</code>, <code>voyage-4</code>, <code>voyage-4-lite</code>,
    <code>voyage-4-nano</code>) all produce vectors in the <em>same geometric space</em>.
    A document embedded with <code>voyage-4-large</code> can be searched with a query embedded by
    <code>voyage-4-lite</code> — cosine similarity still works correctly. This is what makes
    asymmetric strategies possible.</p>

    <div class="example">
      <strong>Example:</strong> 100K docs × 500 tok = 50M doc tokens<br>
      1M queries/mo × 30 tok = 30M query tokens/mo<br><br>
      <strong>Symmetric</strong> (voyage-4-large @ $0.18/1M):<br>
      &nbsp;&nbsp;Docs: $9.00 + Queries: $5.40/mo × 12 = <strong>$73.80</strong><br><br>
      <strong>Asymmetric</strong> (large docs + lite queries @ $0.05/1M):<br>
      &nbsp;&nbsp;Docs: $9.00 + Queries: $1.50/mo × 12 = <strong>$27.00</strong><br><br>
      &nbsp;&nbsp;Savings: <strong>63%</strong> — same document quality, cheaper queries.
    </div>

    <h3>📋 Per-Model Table</h3>
    <p>The bottom table shows what it would cost to use each model symmetrically (same model for
    docs and queries). The relative bar shows cost compared to the most expensive option.
    Use this to understand the price spread across the full model lineup.</p>

    <h3>🎯 Key Assumptions</h3>
    <ul>
      <li>Token counts are estimates — actual counts depend on your text. Use <code>vai chunk --stats</code> to measure real token counts.</li>
      <li>Document embedding is a one-time cost (you embed once, search many times).</li>
      <li>Re-embedding (e.g. updated docs) is not modeled — add a buffer if your corpus changes frequently.</li>
      <li>Reranking costs are separate and not included here. Reranking is priced per query pair, not per token.</li>
    </ul>

    <p style="margin-top:20px;font-size:12px;color:var(--text-muted);">
      CLI equivalent: <code>vai estimate --docs 100K --queries 1M --doc-model voyage-4-large --query-model voyage-4-lite</code>
    </p>
  </div>
</div>
</body>
</html>
