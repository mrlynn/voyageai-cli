name: Publish Workflow Packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/vai-workflow-*/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 # need previous commit to detect changes

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Find changed workflow packages
        id: changed
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'packages/vai-workflow-*' \
            | cut -d/ -f1-2 | sort -u | grep '^packages/vai-workflow-' || true)
          echo "packages<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "Found changed packages:"
          echo "$CHANGED"

      - name: Publish changed packages
        if: steps.changed.outputs.packages != ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "${{ steps.changed.outputs.packages }}" | while read -r pkg; do
            [ -z "$pkg" ] && continue
            echo "üì¶ Publishing $pkg ..."
            cd "$pkg"
            # Skip if this version is already published
            NAME=$(node -p "require('./package.json').name")
            VERSION=$(node -p "require('./package.json').version")
            if npm view "$NAME@$VERSION" version 2>/dev/null; then
              echo "‚è≠Ô∏è  $NAME@$VERSION already published, skipping"
            else
              npm publish --access public
              echo "‚úÖ Published $NAME@$VERSION"
            fi
            cd "$GITHUB_WORKSPACE"
          done
